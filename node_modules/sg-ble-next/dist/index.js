const e=e=>t({path:"/device-rest/api/device/apply/v1.0/applyDeviceIdForBTSDK",data:e});function t(e){return new Promise(((t,i)=>{console.debug("post",e),wx.request({url:"https://api-r1.leshiguang.com"+e.path,method:"POST",data:e.data,header:{"content-type":"application/json","Accept-Encoding":"gzip, deflate"},success(e){console.debug("请求成功",e.data,e),t(e.data)},fail(e){console.error("请求失败",e),i(e)}})}))}function i(e){return function(e){for(var t="0123456789abcdef",i="",n=0;n<4*e.length;n++)i+=t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15);return i}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var i=1732584193,n=-271733879,d=-1732584194,h=271733878,l=0;l<e.length;l+=16){var p=i,u=n,g=d,f=h;i=s(i,n,d,h,e[l+0],7,-680876936),h=s(h,i,n,d,e[l+1],12,-389564586),d=s(d,h,i,n,e[l+2],17,606105819),n=s(n,d,h,i,e[l+3],22,-1044525330),i=s(i,n,d,h,e[l+4],7,-176418897),h=s(h,i,n,d,e[l+5],12,1200080426),d=s(d,h,i,n,e[l+6],17,-1473231341),n=s(n,d,h,i,e[l+7],22,-45705983),i=s(i,n,d,h,e[l+8],7,1770035416),h=s(h,i,n,d,e[l+9],12,-1958414417),d=s(d,h,i,n,e[l+10],17,-42063),n=s(n,d,h,i,e[l+11],22,-1990404162),i=s(i,n,d,h,e[l+12],7,1804603682),h=s(h,i,n,d,e[l+13],12,-40341101),d=s(d,h,i,n,e[l+14],17,-1502002290),i=a(i,n=s(n,d,h,i,e[l+15],22,1236535329),d,h,e[l+1],5,-165796510),h=a(h,i,n,d,e[l+6],9,-1069501632),d=a(d,h,i,n,e[l+11],14,643717713),n=a(n,d,h,i,e[l+0],20,-373897302),i=a(i,n,d,h,e[l+5],5,-701558691),h=a(h,i,n,d,e[l+10],9,38016083),d=a(d,h,i,n,e[l+15],14,-660478335),n=a(n,d,h,i,e[l+4],20,-405537848),i=a(i,n,d,h,e[l+9],5,568446438),h=a(h,i,n,d,e[l+14],9,-1019803690),d=a(d,h,i,n,e[l+3],14,-187363961),n=a(n,d,h,i,e[l+8],20,1163531501),i=a(i,n,d,h,e[l+13],5,-1444681467),h=a(h,i,n,d,e[l+2],9,-51403784),d=a(d,h,i,n,e[l+7],14,1735328473),i=r(i,n=a(n,d,h,i,e[l+12],20,-1926607734),d,h,e[l+5],4,-378558),h=r(h,i,n,d,e[l+8],11,-2022574463),d=r(d,h,i,n,e[l+11],16,1839030562),n=r(n,d,h,i,e[l+14],23,-35309556),i=r(i,n,d,h,e[l+1],4,-1530992060),h=r(h,i,n,d,e[l+4],11,1272893353),d=r(d,h,i,n,e[l+7],16,-155497632),n=r(n,d,h,i,e[l+10],23,-1094730640),i=r(i,n,d,h,e[l+13],4,681279174),h=r(h,i,n,d,e[l+0],11,-358537222),d=r(d,h,i,n,e[l+3],16,-722521979),n=r(n,d,h,i,e[l+6],23,76029189),i=r(i,n,d,h,e[l+9],4,-640364487),h=r(h,i,n,d,e[l+12],11,-421815835),d=r(d,h,i,n,e[l+15],16,530742520),i=c(i,n=r(n,d,h,i,e[l+2],23,-995338651),d,h,e[l+0],6,-198630844),h=c(h,i,n,d,e[l+7],10,1126891415),d=c(d,h,i,n,e[l+14],15,-1416354905),n=c(n,d,h,i,e[l+5],21,-57434055),i=c(i,n,d,h,e[l+12],6,1700485571),h=c(h,i,n,d,e[l+3],10,-1894986606),d=c(d,h,i,n,e[l+10],15,-1051523),n=c(n,d,h,i,e[l+1],21,-2054922799),i=c(i,n,d,h,e[l+8],6,1873313359),h=c(h,i,n,d,e[l+15],10,-30611744),d=c(d,h,i,n,e[l+6],15,-1560198380),n=c(n,d,h,i,e[l+13],21,1309151649),i=c(i,n,d,h,e[l+4],6,-145523070),h=c(h,i,n,d,e[l+11],10,-1120210379),d=c(d,h,i,n,e[l+2],15,718787259),n=c(n,d,h,i,e[l+9],21,-343485551),i=o(i,p),n=o(n,u),d=o(d,g),h=o(h,f)}return Array(i,n,d,h)}(function(e){for(var t=Array(),i=255,n=0;n<8*e.length;n+=8)t[n>>5]|=(e.charCodeAt(n/8)&i)<<n%32;return t}(e),8*e.length))}function n(e,t,i,n,s,a){return o((r=o(o(t,e),o(n,a)))<<(c=s)|r>>>32-c,i);var r,c}function s(e,t,i,s,a,r,c){return n(t&i|~t&s,e,t,a,r,c)}function a(e,t,i,s,a,r,c){return n(t&s|i&~s,e,t,a,r,c)}function r(e,t,i,s,a,r,c){return n(t^i^s,e,t,a,r,c)}function c(e,t,i,s,a,r,c){return n(i^(t|~s),e,t,a,r,c)}function o(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}let d={};var h={set(e,t){d[e]=t},get:e=>d[e]};function l(e){let t=e;t?h.set("options",t):t=h.get("options");let n=(new Date).getTime(),s=t.appKey,a=t.appSecret,r=new Array(n,s,a,"1.0"),c=((o=r).sort(),i(o.join("")).toUpperCase());var o;h.set("secretSign",`api_appKey=${s}&signSecret=${a}&api_sign=${c}&api_timestamp=${n}&api_version=1.0&associatedId=${t.associatedId}`),h.set("userId",t.userId),h.set("appId","wxe3d2a6ab8dd5b49b")}[{key:"baseUrl",defaultValue:"https://api.leshiguang.com",desc:"请求url"},{key:"secretSign",defaultValue:"2a6bfL45*2219cZi44c7f78231e3cF80ensea13072eSb672_!",desc:"ajax请求签名key"}].forEach((({key:e,defaultValue:t})=>{h.set(e,t)}));let p=console;const u="LS-BLE";var g={constructor(){this.isOtaing=!1},debugMode:()=>!0,isPrintValueChange(){return null==this.printValueChange||this.printValueChange},setOtaing(e){this.isOtaing=e},setPrintValueChange(e){this.printValueChange=e},isPrintWrite(){return null==this.printWrite||this.printWrite},setPrintWrite(e){this.printWrite=e},debug(...e){this.isOtaing||(e.unshift(m(),u),p.debug(...e))},debugValueChange(...e){this.isPrintValueChange()&&e.unshift(m(),u),this.isPrintValueChange()&&p.debug(...e)},info(...e){this.isOtaing||(e.unshift(m(),u),p.info(...e))},warn(...e){e.unshift(m(),u),p.warn(...e)},error(...e){e.unshift(m(),u),p.error(...e)},logE(...e){e.unshift(m(),u),p.error(...e)},log(...e){this.isOtaing||(e.unshift(m(),u),p.info(...e))},logIos(...e){e.unshift(m(),u),p.error(...e)},logBle(...e){e.unshift(m(),"<ble>"),p.warn(...e)},logBleError(...e){e.unshift(m(),"<ble>"),p.error(...e)},setLogger(e){p=e}};const f=e=>(e=e.toString())[1]?e:"0"+e;function m(){const e=new Date;return"["+[e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()].map(f).join(":")+"]"}class U{constructor(e,t,i,n,s){this.success=e,this.msg=t,this.value=n,this.originResponse=i,this.data=i,this.extra=s}static success(e=null,t=null,i=0){let n=new U(!0,"success",e,t,null);return n.code=i,n}static fail(e="",t=null,i=null){return new U(!1,e,t,i,null)}static failCode(e=-1,t="",i=null,n=null,s=null){let a=new U(!1,t,i,n,s);return a.code=e,a}static errorCode(e=0,t=null,i=null,n=null){let s=0===e,a=function(e){switch(e){case 0:return"成功";case 1:return"未连接";case 2:return"没有特征服务";case 3:return"超时";case 4:return"丢弃";case 13:return"用户取消了绑定";case 14:return"手环已绑定";case 5:return"设备报错";case 6:return"蓝牙库报错";case 8:return"文件不支持";case 15:return"参数错误";case 16:return"内存不足";case 9:return"电量低";case 12:return"未发现设备";case 11:return"鉴权失败";case 10:return"不支持";case 7:return"工作繁忙";case 20:return"未开启定位权限";case 21:return"没有蓝牙权限";case 25:return"为实现申请deviceId方法";default:return"未知错误"}}(e),r=new U(s,a,t,i,n);return r.code=e,r}}class w{constructor({uuid:e,isPrimary:t}){this.uuid=e.toUpperCase(),this.isPrimary=t,this.characteristics=[]}}function v(e,t){if(!e)return"";if("string"==typeof e)return e;let i=Array.prototype.map.call(new Uint8Array(e),(function(e){return("00"+e.toString(16)).slice(-2)}));if(t){let e=[];for(let t=0;t<i.length;t++)e.push(i[i.length-1-t]);return e.join("")}return i.join("")}function y(e,t){try{if("undefined"!=(i=e)&&i&&/[^\s]/.test(i)){let i=A(I(e).slice(0,t));if(i)for(;e.indexOf(i)<0&&i.length>0;)i=i.substring(0,i.length-1);return i}}catch(e){return""}var i;return""}function S(e){let t,i,n=[];for(let s=0;s<e.length;s++){t=e.charCodeAt(s),i=[];do{i.push(255&t),t>>=8}while(t);n=n.concat(i.reverse())}return n}function b(e){let t=e.toString(2);if(e<128)return e.toString(16);if(e<2048){t=("00000000000000000"+t).slice(-11);const e=parseInt("110"+t.substring(0,5),2),i=parseInt("10"+t.substring(5),2);return e.toString(16)+","+i.toString(16)}{t=("00000000000000000"+t).slice(-16);const e=parseInt("1110"+t.substring(0,4),2),i=parseInt("10"+t.substring(4,10),2),n=parseInt("10"+t.substring(10),2);return e.toString(16)+","+i.toString(16)+","+n.toString(16)}}function I(e){if(!e||0==e.length)return new ArrayBuffer(0);let t="";for(let i=0;i<e.length;i++)t+=","+b(e.charCodeAt(i));return new Uint8Array(t.match(/[\da-f]{2}/gi).map((function(e){return parseInt(e,16)}))).buffer}let D=wx.getSystemInfoSync();function T(){return D.system.indexOf("iOS")>-1}function B(e){return e.length>16?e:`0000${e}-0000-1000-8000-00805F9B34FB`}function C(e,t){return 1==(1&e>>t)}function R(e){return e&&e.length>8?e.toString().substring(4,8):e}function A(e){return k(e)}function k(e){if(!e)return"";let t=new Uint8Array(e);var i,n,s,a,r,c;for(i="",s=t.length,n=0;n<s;)switch((a=t[n++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:i+=String.fromCharCode(a);break;case 12:case 13:r=t[n++],i+=String.fromCharCode((31&a)<<6|63&r);break;case 14:r=t[n++],c=t[n++],i+=String.fromCharCode((15&a)<<12|(63&r)<<6|(63&c)<<0)}return i}function F(e){let t=Math.round(100*e);return(254<<24)+(16711680&t)+(65280&t)+(255&t)}function x(){return(new Date).getTime()/1e3}function M(){return((new Date).getTime()-12622752e5)/1e3}function L(){let e=(new Date).getTimezoneOffset();return e=Math.abs(e),e/60}function E(){let e=(new Date).getTimezoneOffset(),t=e>0;e=Math.abs(e);let i=(60*(e/60)+e%60)/15;return t&&(i=-i),i+48}function P(e,t,i,n,s,a,r=0){return new Date(`${e}/${t}/${i} ${n}:${s}:${a}`).getTime()+60*r*1e3}function O(e){return new Promise(((t,i)=>{setTimeout((()=>{t(null)}),e)}))}const H="0000180A-0000-1000-8000-00805F9B34FB",V="00002A25-0000-1000-8000-00805F9B34FB",N="00002A27-0000-1000-8000-00805F9B34FB",_="00002A26-0000-1000-8000-00805F9B34FB",W="00002A28-0000-1000-8000-00805F9B34FB",z="00002A23-0000-1000-8000-00805F9B34FB";class q{constructor(e,t,i,n){this.timeout=1e4,this.deviceId=e,this.connector=t,this.disConnector=i,this.connectMode=n,this.sid=Math.random()}async start(){this.resetTimeout();try{0===this.connectMode?(await this.connector(this.deviceId),this.callback(U.errorCode(0,"连接成功"))):(await this.disConnector(this.deviceId),this.callback(U.errorCode(0,"断开连接")))}catch(e){this.callback(e)}}resetTimeout(){this._clearTimeout();let e=this;this.timeoutId=setTimeout((()=>{e.callback(U.errorCode(3,"超时"))}),this.timeout)}_clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}callback(e){this._clearTimeout(),this.completion&&(e.sid=this.sid,this.completion(e),this.completion=null),this.isClear=!0}clear(){this.callback(U.errorCode(4)),this.isClear=!0,this._clearTimeout()}}var j=new class{constructor(){this.sessionList=new Array}connect(e,t){this.sessionList.push(this.createSession(e,0,t)),this.dispatchNextAction()}disConnect(e,t){this.sessionList.push(this.createSession(e,1,t)),this.dispatchNextAction()}connectStateChanged(e){}dispatchNextAction(){if(!this.workingSession&&this.sessionList.length>0){let e=this.sessionList[0];this.sessionList.shift(),this.workingSession=e,e.start()}else this.workingSession}cancelCurrentSession(){this.workingSession&&(this.workingSession.clear(),this.workingSession=null)}createSession(e,t,i){let n=new q(e,this.connector,this.disConnector,t),s=this;return n.completion=e=>{s.workingSession&&(s.workingSession=null),i&&i(e),s.dispatchNextAction()},n}findSession(e){let t=null;this.workingSession.deviceId===e&&(t=this.workingSession);for(let i=0;i<this.sessionList.length;i++){let n=this.sessionList[i];if(n.deviceId===e){t=n;break}}return t}clear(){try{this.workingSession&&(this.workingSession.clear(),this.workingSession=null),this.sessionList.forEach((e=>{e.callback(U.errorCode(4))})),this.sessionList.length=0}catch(e){g.warn("操作取消",e)}}};const $=new Map,Q=new Map,Z=new Map,G=new Map,J=new Map,K=new Map;function Y(e,t){Q.set(e,t)}function X(e,t){$.set(e,t)}function ee(e,t,i){let n=K.get(t);n||(n=new Map,K.set(t,n)),n.set(e,i)}class te{constructor(e){this.isConnectingAndReadDeviceInfo=!1,this.deviceInfo=new Map,this.serviceMap=new Map,this.readTimeoutMap=new Map,this.clientDataChangeListener=new Map,this.writBufferQueue=[],this.deviceId=e,this.performance={},this.isRecycle=!1,this.deviceInfoCharacteristics=[],this.setDefaultDataChange()}recycle(){this.resetState()}setDefaultDataChange(){let e=this;ee("_c",this.deviceId,(t=>{t.serviceId===H&&e.deviceInfo.set(t.characteristicId,t.value),e.clientDataChangeListener.forEach(((i,n)=>{i(t)&&e.clientDataChangeListener.delete(n)}))})),function(e,t,i){let n=J.get(t);n||(n=new Map,J.set(t,n)),n.set(e,i)}("_c",this.deviceId,(t=>{e.connected=t.connected,t.connected||e.resetState()}))}connect(e=1e4){return this.writing=!1,new Promise(((e,t)=>{let i=this;j.connect(this.deviceId,(n=>{n.success?(i.connected=!0,e(n)):(i.connected=!1,t(n))}))}))}disconnect(){let e=this.deviceId;this.connected=!1;let t=this;return this.resetState(),new Promise(((i,n)=>{j.disConnect(e,(e=>{t.connected=!1,i(U.errorCode(0))}))}))}discoverServices(e){return g.logBle("discoverServices",this.deviceId),this.performance.getServicesStart=new Date,new Promise((async(t,i)=>{0!=e&&await O(e);let n=this;wx.getBLEDeviceServices({deviceId:this.deviceId,success:async e=>{if(!e||!e.services||0===e.services.length)return g.error("获取服务为空"),void i(U.errorCode(6));let s=[];for(let t=0;t<e.services.length;t++){let i=B(e.services[t].uuid);if(-1!=i.indexOf("1801"))continue;let a=new w(e.services[t]);s.push(a),n.serviceMap.set(i,a);let r=await n.discoverCharacteristic(i);a.characteristics=r.originResponse}n.services=s,n.isServiceDiscoveredFinished=!0,t(U.success(e))},fail:e=>{g.error("获取服务失败: ",n.deviceId,e,n.services),n.disconnect(),i(U.errorCode(6))},complete:e=>{try{let e=new Date;n.performance.getServicesEnd=e,n.performance.getCharacteristicsStart=e,n.performance.getServiceTime=e.getTime()-this.performance.getServicesStart.getTime()}catch(e){}}})}))}discoverCharacteristic(e){let t=this.deviceId,i=this;return new Promise(((n,s)=>{wx.getBLEDeviceCharacteristics({deviceId:t,serviceId:e,success:t=>{g.logBle("discover char",e,t),n(U.success(t.characteristics))},fail:n=>{g.error("discover fail: ",t,e,n),i.disconnect(),s(U.errorCode(6))}})}))}enable(e,t){let i=this;return g.warn("disable ",this.deviceId,R(e),R(t)),new Promise(((n,s)=>{wx.notifyBLECharacteristicValueChange({state:!0,deviceId:this.deviceId,serviceId:e,characteristicId:t,success:i=>{g.debug("打开通道成功",e,t,i),n(U.success(i))},fail:t=>{g.error("打开通道失败:",e,this.deviceId,t),i.disconnect(),s(U.errorCode(6))}})}))}disable(e,t){let i=this;return g.warn("disable ",this.deviceId,R(e),R(t)),new Promise(((n,s)=>{wx.notifyBLECharacteristicValueChange({state:!1,deviceId:this.deviceId,serviceId:e,characteristicId:t,success:i=>{g.debug("关闭通道成功",e,t,i),n(U.success(i))},fail:e=>{g.error("disable fail: ",this.deviceId,e),i.disconnect(),s(U.errorCode(6))}})}))}read(e,t){let i=this;return new Promise(((n,s)=>{i.clearReadTimeout(t),ee(t,i.deviceId,(s=>{s.serviceId===e&&s.characteristicId===t&&(i.clearReadTimeout(t),setTimeout((()=>{n(U.success(s))}),10))}));let a=setTimeout((()=>{i.clearReadTimeout(t),s(U.errorCode(3))}),3e3);i.readTimeoutMap.set(t,a),g.warn("读数据",t),wx.readBLECharacteristicValue({deviceId:this.deviceId,serviceId:e,characteristicId:t,success:e=>{},fail:e=>{g.error("read fail: ",this.deviceId,e),i.disconnect(),s(U.errorCode(6))}})}))}writeList(e,t,i){if(i&&!(i.length<1)){for(let n=0;n<i.length;n++){let s={};s.byte=i[n],s.characteristicId=t,s.serviceId=e,this.writBufferQueue.push(s)}this.writing||this.handWriteQueue()}}handWriteQueue(){if(this.writBufferQueue.length>0){let e=this.writBufferQueue.shift();this.write(e.serviceId,e.characteristicId,e.byte).then((e=>{this.handWriteQueue()})).catch((e=>{g.error("WriteQueue error",e),this.handWriteQueue()}))}}write(e,t,i){return new Promise(((n,s)=>{this.doWxWrite(e,t,i,n,0)}))}doWxWrite(e,t,i,n,s){this.writing=!0,wx.writeBLECharacteristicValue({deviceId:this.deviceId,serviceId:e,characteristicId:t,value:i,success(e){n(U.success(e))},fail:a=>{10008===(a.errCode||a.code)&&s<3?(s>1&&g.error("write: retryCount: ",s,this.deviceId,t,a),setTimeout((()=>{this.doWxWrite(e,t,i,n,s++)}),100)):(g.error("write: ",this.deviceId,t,a),n(U.fail("write fail",a)))},complete:()=>{this.writing=!1}})}setMtu(e,t){return new Promise(((i,n)=>{if(wx.setBLEMTU)if(2===t)i(U.success({mtu:158}));else{let t=setTimeout((()=>{g.error("setBLEMTU timeout"),i(U.success({mtu:23}))}),1500);g.info("setBLEMTU ",e),wx.setBLEMTU({deviceId:this.deviceId,mtu:e,success:n=>{t&&clearTimeout(t);let s=n.mtu;s||(s=e),g.info("setBLEMTU success",n,s),i(U.success({mtu:s}))},fail:e=>{t&&clearTimeout(t),g.error("setMtu fail: ",this.deviceId,e),i(U.success({mtu:23}))}})}else g.error("setMtu fail: wx.setBLEMTU 未实现 "),i(U.success({mtu:23}))}))}async connectAndDiscoverServices(){try{return await this.connect(),await this.discoverServices(0),Promise.resolve(U.success("连接与发现服务成功"))}catch(e){return Promise.reject(U.fail("连接与发现服务失败"))}}async connectAndReadDeviceInfo(e=!0,t=!0,i=!0){if(!e&&this.isConnectingAndReadDeviceInfo&&this.deviceInfo&&this.deviceInfo.size>0)return Promise.resolve(U.success(this.deviceInfo));try{this.isConnectingAndReadDeviceInfo=!0,await this.connect(),await this.discoverServices(0);let e=H,n=this.serviceMap.get(e);if(n&&n.characteristics.length)for(let s=0;s<n.characteristics.length;s++){let a=n.characteristics[s];if(a.uuid===_||a.uuid===W||a.uuid===N)await this.read(e,a.uuid);else if(a.uuid===V&&t&&!this.deviceInfo.get(a.uuid))await this.read(e,a.uuid);else if(a.uuid===z&&i)await this.read(e,a.uuid);else{let t=this.deviceInfo.get(a.uuid);t&&0!=t.byteLength||await this.read(e,a.uuid)}}let s=this;return this.isConnectingAndReadDeviceInfo=!1,Promise.resolve(U.success(s.deviceInfo))}catch(e){return g.logBleError(e,"获取deviceInfo失败",this.deviceInfo.size),this.isConnectingAndReadDeviceInfo=!1,Promise.reject(e)}}clearReadTimeout(e){let t=this.readTimeoutMap.get(e);t&&(clearTimeout(t),this.readTimeoutMap.delete(e))}resetState(){this.connected=!1,this.isServiceDiscoveredFinished=!1,this.isConnectingAndReadDeviceInfo=!1,this.writing=!1,this.writBufferQueue.length=0,this.clientDataChangeListener.clear()}}var ie;!function(e){e[e.ALL=0]="ALL",e[e.Normal=1]="Normal"}(ie||(ie={}));let ne=new Map,se=new Map;var ae={wx:{Adapter:class{constructor(){this.available=!1,this.scanning=!1,this.scanCallbacks=new Map,this.connectStateListerner=new Map,this.connectedMap=new Map;let e=this;Y("_a",(t=>(e.available=t.available,!1===t.available&&(this.connectedMap.forEach(((t,i)=>{g.debug("设备连接",i,t),e.getClient(i).recycle()})),j.clear()),!1))),function(e,t){G.set(e,t)}("_a",(t=>{t&&t.devices&&t.devices.forEach((t=>{let i=e.getClient(t.deviceId);i.name=t.name,i.advertisementData=t,i.isSystemConnect=!1,i.services=i.advertisementData.advertisServiceUUIDs,e.callbackScanResult(i)}))})),X("_a",(t=>{t.connected?e.connectedMap.set(t.deviceId,t.connected):e.connectedMap.delete(t.deviceId)})),j.connector=e=>this.connect(e),j.disConnector=e=>this.disconnect(e)}openBLEAdapter(){return new Promise(((e,t)=>{let i=(i,n)=>{i?e(U.success()):t(U.fail("打开适配器失败",n))};wx.openBluetoothAdapter({success:()=>{g.debug("开启蓝牙适配器"),this.getBLEAdapterState(i)},fail:t=>{g.error("开启蓝牙适配器失败",t.errCode,t.errMsg),this.getBLEAdapterState((t=>{t?e(U.success()):this.reopenBLEAdapter(i)}))}})}))}closeAndReopenBLEAdapter(){this.reopenBLEAdapter((e=>{}))}startScan(e,t,i,n,s){this.scanCallbacks.set(e,n);let a=this;s===ie.ALL&&(wx.getConnectedBluetoothDevices({success(e){e.devices.forEach((async e=>{if(e.deviceId){let t=a.getClient(e.deviceId);t.name=e.name;let i=se.get(e.deviceId);if(i)t.deviceInfo=i,t.isSystemConnect=!0,n(t);else try{let i=await t.connectAndReadDeviceInfo(!1,!0);i.originResponse&&(se.set(e.deviceId,i.originResponse),t.isSystemConnect=!0,n(t))}catch(e){}}}))},services:["A500"]}),wx.getBluetoothDevices({success(e){e.devices.forEach((async e=>{if(e.deviceId){let t=a.getClient(e.deviceId);t.name=e.name,t.advertisementData=e,t.isSystemConnect=!1,t.services=t.advertisementData.advertisServiceUUIDs,a.callbackScanResult(t)}}))}})),this.scanning||0!==this.scanCallbacks.size&&(this.stopScanTime(),this.scanning=!0,this.scanTimeout=setTimeout((()=>{a.stopScan()}),6e4),wx.startBluetoothDevicesDiscovery({services:t,allowDuplicatesKey:i,success:()=>{this.scanning=!0,g.logBle("开始扫描......",JSON.stringify(e))},fail:e=>{this.scanning=!1,g.logBleError("扫描失败",JSON.stringify(e))}}))}stopScan(e){e?this.scanCallbacks.delete(e):this.scanCallbacks.clear(),g.debug("stopScan",e,this.scanCallbacks.size),this.scanCallbacks.size&&e||(this.scanning=!1,wx.stopBluetoothDevicesDiscovery({success(e){},complete:e=>{g.logBle("停止扫描",JSON.stringify(e)),this.scanning=!1}}))}getClient(e){if(!e)return g.error("wx deviceId",e),null;let t=ne.get(e);return t||(t=new te(e),ne.set(e,t)),t}reopenBLEAdapter(e){g.info("重启蓝牙适配器"),this.clear(),j.clear(),wx.closeBluetoothAdapter({success(){},complete:()=>{wx.openBluetoothAdapter({success(){},complete:()=>{this.getBLEAdapterState(e)}})}})}getBLEAdapterState(e){wx.getBluetoothAdapterState({success:t=>{this.available=t.available,e&&e(this.available,t)},fail:t=>{this.available=!1,g.error("getBluetoothAdapterState失败"),e&&e(!1,t)}})}stopScanTime(){this.scanTimeout&&(clearTimeout(this.scanTimeout),this.scanTimeout=null)}clear(){this.stopScanTime(),this.scanCallbacks.clear()}callbackScanResult(e){this.scanCallbacks.size>0&&this.scanCallbacks.forEach((t=>t&&t(e)))}connect(e){return new Promise(((t,i)=>{wx.createBLEConnection({deviceId:e,success:e=>{t(U.success(e+"连接成功"))},fail:n=>{if(-1===n.errCode||-1===n.code)return g.logBle("重复连接: ",e,n),void t(U.success(n));g.error("蓝牙连接失败: ",e,JSON.stringify(n)),i(U.errorCode(6))}})}))}disconnect(e){return g.logBle("closeBLE",e),new Promise(((t,i)=>{wx.closeBLEConnection({deviceId:e,success(i){g.logBle("成功断开蓝牙连接: ",e),t(U.errorCode(0))},fail(t){g.logBle("断开蓝牙连接失败: ",e,JSON.stringify(t)),i(U.errorCode(0))}})}))}},Client:te}};class re{constructor(e,t,i,n,s,a){this.uuid=e.toUpperCase().trim(),this.name=t,this.bind=i,this.sync=n,this.parser=s,this.dataParser=a}}let ce=new Map;function oe(e,t){ce.set(e,t)}function de(e){return ce.get(e)}const he=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];function le(e,t=0){let i=0,n=4294967295&t;if(null==e)return n;let s=new Uint8Array(e);for(i=0;i<e.byteLength;i++){let e=255&(n^s[i]);n=he[e]^n>>>8}return(4294967295&n)>>>0}function pe(e,t){if(6==e.byteLength&&6==t.byteLength){let i=new DataView(e),n=new DataView(t),s="";for(let t=0;t<e.byteLength;t++){s+=(255&(n.getUint8(t)^i.getUint8(t))).toString(16).padStart(2,"0")}return s.toLowerCase()}return""}function ue(e){if(!e||0===e.length)return new ArrayBuffer(0);let t=e.length/2;if(t<1)return new ArrayBuffer(0);let i=new ArrayBuffer(t),n=new DataView(i);for(let i=0;i<t;i++){let t=e.substr(2*i,2),s=parseInt(t,16);n.setUint8(i,s)}return n.buffer}function ge(e){if(!e||0===e.byteLength)return"";let t=new DataView(e),i="";for(let e=0;e<t.byteLength;e++)i+=t.getUint8(e).toString(16).padStart(2,"0").toUpperCase();return i}function fe(e){if(!e||0===e.byteLength)return;let t=new DataView(e),i=new ArrayBuffer(e.byteLength),n=new DataView(i);for(let i=0;i<e.byteLength;i++){let s=e.byteLength-i-1;n.setUint8(i,t.getUint8(s))}return n.buffer}function me(...e){if(!e)return new ArrayBuffer(0);let t=0;for(let i=0;i<e.length;i++)t+=e[i].byteLength;let i=new ArrayBuffer(t),n=new DataView(i),s=0;for(let i=0;i<e.length;i++){let a=e[i],r=new DataView(a);for(let e=0;e<a.byteLength&&s<t;e++)n.setUint8(s,r.getUint8(e)),s+=1}return i}class Ue{parseAdvertisementData(e,t){return{name:e.name,localName:t.localName,deviceId:e.deviceId,manufacturerData:t.advertisData,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:undefined,isSystemPaired:!1,timestamp:new Date,isRegister:!0}}parseDeviceInfo(e,t){let i=t.get(B("2A25")),n="";g.info("normal deviceId",v(i)),i&&i.byteLength>=12&&(n=A(i.slice(0,12)));let s=t.get(B("2A23"));g.info("normal deviceId",v(s));let a="";s&&s.byteLength>=6&&(a=ge(s.slice(0,6)));let r=A(t.get(B("2A24"))),c=A(t.get(B("2A26"))),o=A(t.get(B("2A28"))),d=A(t.get(B("2A27"))),h=A(t.get(B("2A29")));return{name:e.name,deviceId:e.deviceId,manufacture:h,model:r,mac:n,softwareVersion:o,hardwareVersion:d,firmwareVersion:c,lzDeviceId:a}}}function we(e,t,i){return e?(t.getUint8(i+2)<<16)+(t.getUint8(i+1)<<8)+t.getUint8(i):(t.getUint8(i)<<16)+(t.getUint8(i+1)<<8)+t.getUint8(i+2)}class ve{constructor(e,t=0){this.values=[],this.parseSize=0,this.originalBuffer=e,this.index=t,this.parseSize=0,this.dataView=new DataView(e),this.index=t}build(e){if(!this.originalBuffer||this.originalBuffer.byteLength<=0)return g.error("originalBuffer is null",this.originalBuffer),null;e||(e={});let t=this.dataView;return this.values.forEach((({byteOffset:i,method:n,key:s,size:a,parseKey:r,littleEndian:c})=>{i+=this.parseSize;try{if("getHexString"===n)e[s]=v(this.originalBuffer.slice(i,i+a));else if("getStringByParse"===n){let t=e[r];this.parseSize+=t,e[s]=A(this.originalBuffer.slice(i,i+t))}else if("getString"===n)e[s]=A(this.originalBuffer.slice(i,i+a));else if("getBuffer"===n)e[s]=this.originalBuffer.slice(i,i+a);else if("getUint8"===n)e[s]=t.getUint8(i);else if("Uint24"===n)e[s]=we(c,t,i);else if("Uint8Array"===n)e[s]=[].slice.call(new Uint8Array(this.originalBuffer.slice(i,i+a)));else if("Uint16Array"===n){let t=[].slice.call(new Uint16Array(this.originalBuffer.slice(i,i+a)));e[s]=c?t:function(e){if(e&&e.length>0){let t=[];for(let i=0;i<e.length;i++){let n=e[i];n=((255&n)<<8)+(n>>8&255),t.push(n)}return t}return[]}(t)}else if("SFloat"===n){let n=t.getUint8(i),a=((15&n)<<8)+t.getUint8(i+1),r=(240&n)>>>4,c=r;(8&r)>0&&(c=r-16);let o=Math.pow(10,c);e[s]=a*o}else if("Float"===n){let n=t.getUint8(i),a=we(c,t,i+1),r=Math.pow(10,(15&n)-16);e[s]=a*r}else e[s]=t[n](i,c)}catch(e){g.warn("reader err:"+e),g.warn(i,n,s,a,c)}})),e}getUint24(e,t=!1){return this.values.push({byteOffset:this.index,method:"Uint24",key:e,littleEndian:t}),this.index+=3,this}getSFloat(e){return this.values.push({byteOffset:this.index,method:"SFloat",key:e}),this.index+=2,this}getFloat(e,t=!1){return this.values.push({byteOffset:this.index,method:"Float",key:e,littleEndian:t}),this.index+=4,this}getUint8Array(e,t){return this.values.push({byteOffset:this.index,size:t,method:"Uint8Array",key:e}),this.index+=t,this}getUint16Array(e,t,i=!1){return this.values.push({byteOffset:this.index,size:t,method:"Uint16Array",key:e,littleEndian:i}),this.index+=t,this}getUint8(e){return this.values.push({byteOffset:this.index,method:"getUint8",key:e}),this.index++,this}getUint16(e,t=!1){return this.values.push({byteOffset:this.index,method:"getUint16",key:e,littleEndian:t}),this.index+=2,this}getUint32(e,t=!1){return this.values.push({byteOffset:this.index,method:"getUint32",key:e,littleEndian:t}),this.index+=4,this}getBuffer(e,t){return this.values.push({byteOffset:this.index,size:t,method:"getBuffer",key:e}),this.index+=t,this}getByteOffset(){return this.index}getString(e,t){return this.values.push({byteOffset:this.index,size:t,method:"getString",key:e}),this.index+=t,this}getHexString(e,t){return this.values.push({byteOffset:this.index,size:t,method:"getHexString",key:e}),this.index+=t,this}getStringSizeByParse(e,t){return this.values.push({byteOffset:this.index,parseKey:t,method:"getStringByParse",key:e}),this}getIndex(){return this.index}readUint8(){let e=this.index;return this.index+=1,this.dataView.getUint8(e)}readUint16(e=!1){let t=this.index;return this.index+=2,this.dataView.getUint16(t,e)}readInt16(e=!1){let t=this.index;return this.index+=2,this.dataView.getInt16(t,e)}readUint24(e=!1){let t=this.index;return this.index+=3,we(e,this.dataView,t)}readUint32(e=!1){let t=this.index;return this.index+=4,this.dataView.getUint32(t,e)}readInt32(e=!1){let t=this.index;return this.index+=4,this.dataView.getInt32(t,e)}readSfloat(){let e=this.index,t=this.dataView;this.index+=2;let i=t.getUint8(e),n=(240&i)>>>4,s=n;return(8&n)>0&&(s=n-16),(((15&i)<<8)+t.getUint8(e+1))*Math.pow(10,s)}readFloat(e=!1){let t=this.index;this.index+=4;let i=this.dataView.getUint8(t);return we(e,this.dataView,t+1)*Math.pow(10,(15&i)-16)}readString(e){return A(this.readBuffer(e))}readBuffer(e){let t=this.index;return this.index+=e,this.dataView.buffer.slice(t,t+e)}}class ye{constructor(){this.size=0,this.values=[]}build(){let e=new ArrayBuffer(this.size),t=new DataView(e);return this.values.forEach((({byteOffset:e,method:i,value:n,littleEndian:s,limitSize:a})=>{if("setBuffer"===i){let i=new DataView(n),s=i.byteLength;a&&(s=Math.min(a,s));for(let n=0;n<s;n++)t.setUint8(e+n,i.getUint8(n))}else"setUint8"===i?t[i](e,n):"setInt8"===i?n>0?t.setUint8(e,255&n):t.setUint8(e,n+256&255):"setUint24"===i?s?t.setUint32(e,n):t.setUint32(e,n<<8,!1):t[i](e,n,s)})),e}appendUint8(e){return this.values.push({byteOffset:this.size,method:"setUint8",value:e}),this.size++,this}appendUint16(e,t){return this.values.push({byteOffset:this.size,method:"setUint16",value:e,littleEndian:t}),this.size+=2,this}appendUint32(e,t){return this.values.push({byteOffset:this.size,method:"setUint32",value:e,littleEndian:t}),this.size+=4,this}appendBuffer(e,t){return this.values.push({byteOffset:this.size,method:"setBuffer",value:e,limitSize:t}),this.size+=t||e.byteLength,this}appendUint24(e,t){return this.values.push({byteOffset:this.size,method:"setUint24",value:e,littleEndian:t}),this.size+=3,this}appendInt8(e){return this.values.push({byteOffset:this.size,method:"setInt8",value:e}),this.size++,this}appendInt16(e,t){return this.values.push({byteOffset:this.size,method:"setInt16",value:e,littleEndian:t}),this.size+=2,this}appendFloat32(e,t){return this.values.push({byteOffset:this.size,method:"setFloat32",value:e,littleEndian:t}),this.size+=4,this}}class Se{constructor(){this.tag=4098}getBytes(){return function(){let e=new Date,t=e.getFullYear(),i=e.getMonth()+1,n=e.getDate(),s=e.getHours(),a=e.getMinutes(),r=e.getSeconds();return(new ye).appendUint8(192).appendUint8(3).appendUint8(1).appendUint8(0).appendUint16(t,!0).appendUint8(i).appendUint8(n).appendUint8(s).appendUint8(a).appendUint8(r).build()}()}}var be=[{name:"EnableCharacteristic",serviceId:B("1808"),characteristicId:B("2A18"),actionType:2},{name:"EnableCharacteristic",serviceId:B("1808"),characteristicId:B("2A34"),actionType:2},{name:"EnableCharacteristic",serviceId:B("1808"),characteristicId:B("2A52"),actionType:2},{name:"EnableCharacteristic",serviceId:B("FFF0"),characteristicId:B("FFF1"),actionType:2},{name:"SyncTime",actionType:1,pushData:e=>new Se}];class Ie{constructor(e=0,t=0){this.tag=1,this.syncType=e,this.sequence=t,this.tag=e}getBytes(){switch(this.syncType){case 0:return this.getOpcode(1,6);case 1:return this.getOpcode(1,1);case 2:return this.getOpcode(1,3,this.sequence);case 3:return this.getOpcode(4,1);case 4:return this.getOpcode(4,3,this.sequence)}}getOpcode(e,t,...i){let n=(new ye).appendUint8(e).appendUint8(t);return i&&i.length>0&&(n.appendUint8(1),i.forEach((e=>{n.appendUint16(e,!0)}))),n.build()}}var De=[{name:"EnableCharacteristic",serviceId:B("1808"),characteristicId:B("2A18"),actionType:2},{name:"EnableCharacteristic",serviceId:B("1808"),characteristicId:B("2A34"),actionType:2},{name:"EnableCharacteristic",serviceId:B("1808"),characteristicId:B("2A52"),actionType:2},{name:"EnableCharacteristic",serviceId:B("FFF0"),characteristicId:B("FFF1"),actionType:2},{name:"SyncTime",actionType:1,pushData:e=>new Se},{name:"SyncTime",actionType:1,pushData:e=>new Ie(2,e.gluSeq)}];class Te{constructor(e,t){this.buf=e,this.isClear=!1,this.timeout=5e3,this.sid=t||Math.random(),this.trySender=async(e,t)=>{try{return this.sender(e,t)}catch(e){if(this.isClear)return U.errorCode(4);this.callback(e)}}}didReceiveData(e){}start(){}resetTimeout(){this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout((()=>{this.callback(U.failCode(3,this.tag))}),this.timeout)}clear(){this.isClear=!0}callback(e){this.timeoutId&&clearTimeout(this.timeoutId),this.completion&&(e.sid=this.sid,this.completion(e),this.completion=null)}}class Be extends Te{constructor(e,t){super(e),this.needAck=!1,this.tag=t}async start(){let e=this.decodeToFrames(this.buf);if(e&&e.length<1)throw new Error("数据不能为空");g.debug("frames",e,this.mtu);let t=this.sendChar;try{for(let i=0;i<e.length;i++){let n=e[i];await this.trySender(n,t)}}catch(e){return void this.callback(U.errorCode(1,this.tag))}this.needAck?this.resetTimeout():this.callback(U.errorCode(0,this.tag))}decodeToFrames(e){let t=e.byteLength,i=Math.ceil(t/this.mtu),n=[];for(let t=0;t<i;t++){let i=t*this.mtu;n.push(e.slice(i,i+this.mtu))}return n}}class Ce extends Te{didReceiveData(e){this.receiveBuf=e.value,this.callback(U.errorCode(0,this.tag,this.receiveBuf))}start(){this.didReceiveData({value:this.buf})}checkFinished(){if(!this.receiveBuf)return!1;if(this.firstFrame.len&&this.firstFrame.len<=this.receiveBuf.byteLength)return!0;if(this.firstFrame.totalFrames){if(1==this.firstFrame.totalFrames)return!0;if(this.preFrame&&this.preFrame.index===this.firstFrame.totalFrames-1)return!0}return!1}decodeFirstFrame(e){throw new Error("如果使用默认的逻辑，则需要实现这个逻辑")}decodeOtherFrame(e){throw new Error("如果使用默认的逻辑，则需要实现这个逻辑")}}class Re{constructor(e){this.sendSessions=[],this.filterServiceIds=[],this.mtu=20,this.context=e}sendData(e,t,i,n){let s=this.createSenderSession(e,t,i);return s.sender=this.sender,s.mtu=this.mtu,s.tag=t,new Promise(((e,t)=>{s.completion=i=>{this.sendingSession=null,n&&n(i),this.tryToDispatchSession(),i.success?e(i):t(i)},this.sendSessions.push(s),this.tryToDispatchSession()}))}clear(){try{this.sendSessions.forEach((e=>{e.clear()})),this.sendSessions.length=0,this.sendingSession&&(this.sendingSession.clear(),this.sendingSession=null)}catch(e){}}updateMtu(e){this.mtu=e}didReceiveData(e){if(this.receiveringSession)this.receiveringSession.didReceiveData(e);else{this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender;let t=this;this.receiveringSession.completion=e=>{t.receiveringSession&&t.receiveringSession.sid===e.sid&&(this.receiveringSession=null),this.listener&&this.listener(e)},this.receiveringSession.start()}}createSenderSession(e,t,i){return new Be(e,t)}createReceiveSession(e){return new Ce(e)}tryToDispatchSession(){if(this.sendingSession||0===this.sendSessions.length)return void g.debug("会话全部发送完成");let e=this.sendSessions.shift();e&&(this.sendingSession=e,e.start())}}class Ae{constructor(e,t){this.dataType="GluReport",this.sequenceNumber=0,this.timestamp=0,this.glucoseData=0,this.flag_mealInfo=!1,this.cmd=t;let i=0,n=new DataView(e),s=n.getUint8(0);i+=1;let a=(1&s)>0,r=(2&s)>0,c=(8&s)>0,o=(16&s)>0,d=n.getUint16(i,!0);this.sequenceNumber=d,i+=2;let h=P(n.getUint16(i,!0),n.getUint8(i+2),n.getUint8(i+3),n.getUint8(i+4),n.getUint8(i+5),n.getUint8(i+6));if(i+=7,a){h+=60*n.getInt16(i,!0)*1e3,i+=2}if(this.timestamp=h,r){let e=function(e,t,i){let n=e.getUint16(t,i),s=n>>>12&15;return n&=4095,(2048&n)>0&&(n-=4096),(8&s)>0&&(s-=16),Math.pow(10,s)*n}(n,i,!0);this.glucoseData=1e4*e,i+=2;let t=n.getUint8(i);this.bloodInfo=t>>4&15,this.sampleLocation=15&t,i+=1}c&&(this.sensorStatus=n.getUint8(i),i+=2),0==o&&(this.flag_mealInfo=!1)}receiveContext(e){let t=new DataView(e),i=t.getUint8(0);t.getUint16(1,!0),this.flag_mealInfo=(2&i)>0,this.mealInfo=t.getUint8(3)}getData(){return this}}class ke{constructor(e){this.dataType="GluCount",this.count=e}getData(){return this}}class Fe extends Be{constructor(){super(...arguments),this.sendChar={serviceId:"0000FFF0-0000-1000-8000-00805F9B34FB",charId:"0000FFF1-0000-1000-8000-00805F9B34FB",writeType:1},this.needAck=!0}didReceiveData(e){let t=function(e){let t=new ve(e,4);return P(t.readUint16(!0),t.readUint8(),t.readUint8(),t.readUint8(),t.readUint8(),t.readUint8())}(e.value),i=new Date;Math.abs(t-i.getTime())>1e3?this.sendAck():this.callback(U.errorCode(0,this.tag))}async sendAck(){await this.trySender(this.buf,this.sendChar),this.callback(U.errorCode(0,this.tag))}}class xe extends Re{constructor(){super(...arguments),this.reportMap=new Map}didReceiveData(e){let t=e.characteristicId,i=e.value;if(t===B("FFF1"))this.sendingSession&&this.sendingSession.didReceiveData(e);else if(t===B("2A18")){let e=new Ae(i,0);this.reportMap.set(e.sequenceNumber,e)}else if(t===B("2A34")){let e=new DataView(i).getUint16(1,!0);this.reportMap.get(e).receiveContext(i)}else if(t===B("2A52")){let e=new ve(i),t=e.readUint8();switch(e.readUint8(),t){case 5:let t=e.readUint16(!0);this.listener&&this.listener(U.errorCode(0,new ke(t)));break;case 6:if(e.readUint8(),6==e.readUint8()){let e=Array.from(this.reportMap.values());this.reportMap.clear(),e.forEach((e=>{this.listener&&this.listener(U.errorCode(0,e))}))}break;default:g.warn("数据异常")}}}createSenderSession(e,t){if(4098===t)return new Fe(e,t);{let i=new Be(e,t);return i.sendChar={serviceId:"00001808-0000-1000-8000-00805F9B34FB",charId:"00002A52-0000-1000-8000-00805F9B34FB",writeType:1},i}}}var Me,Le,Ee;!function(e){e[e.flash=0]="flash",e[e.userInfo=1]="userInfo",e[e.alarm=2]="alarm",e[e.callMsg=3]="callMsg",e[e.hearRate=4]="hearRate",e[e.sedentaryReminder=5]="sedentaryReminder",e[e.lost=6]="lost",e[e.stepLength=7]="stepLength",e[e.vibration=8]="vibration",e[e.brightness=9]="brightness",e[e.hbAlarm=10]="hbAlarm",e[e.common=11]="common"}(Me||(Me={})),function(e){e[e.heartRate=1]="heartRate",e[e.sleepDetail=2]="sleepDetail",e[e.sportPace=3]="sportPace",e[e.sportHeartRate=4]="sportHeartRate",e[e.sportCalories=5]="sportCalories",e[e.silenceHeartRate=6]="silenceHeartRate",e[e.generalStepDetail=7]="generalStepDetail",e[e.dailyGeneralStepDetail=8]="dailyGeneralStepDetail",e[e.dailyGeneralHrDetail=9]="dailyGeneralHrDetail",e[e.lastCharging=10]="lastCharging",e[e.brightness=11]="brightness",e[e.dialData=12]="dialData",e[e.sportStepFreq=13]="sportStepFreq",e[e.sportPaceIn=14]="sportPaceIn",e[e.sectionHr=15]="sectionHr",e[e.dailyHour=129]="dailyHour",e[e.dailyDay=130]="dailyDay",e[e.sportReport=131]="sportReport",e[e.bloodOxygen=132]="bloodOxygen",e[e.meditation=133]="meditation",e[e.sleepQuality=134]="sleepQuality",e[e.dailyBloodOxygen=135]="dailyBloodOxygen",e[e.statusHeartRate=136]="statusHeartRate",e[e.continuousBloodOxygen=137]="continuousBloodOxygen",e[e.sleepRespiratoryQuality=138]="sleepRespiratoryQuality",e[e.pressureTest=139]="pressureTest",e[e.hearRateTest=140]="hearRateTest",e[e.stand=141]="stand",e[e.burialPointData=240]="burialPointData",e[e.burialPointDataStatistics=241]="burialPointDataStatistics",e[e.measureData=254]="measureData",e[e.all=255]="all"}(Le||(Le={})),function(e){e[e.HeartRateWarningSetting=0]="HeartRateWarningSetting",e[e.SleepBloodOxygenSetting=1]="SleepBloodOxygenSetting",e[e.SedentaryReminderSetting=2]="SedentaryReminderSetting",e[e.SleepReminderSetting=3]="SleepReminderSetting",e[e.EventReminderSetting=4]="EventReminderSetting",e[e.TimeFormatSetting=5]="TimeFormatSetting",e[e.DialTypeSetting=6]="DialTypeSetting",e[e.CustomPagesSetting=7]="CustomPagesSetting",e[e.NightModeSetting=8]="NightModeSetting",e[e.RightSwipDisplaySetting=9]="RightSwipDisplaySetting",e[e.SportHrWarnigSetting=10]="SportHrWarnigSetting",e[e.TargetSetting=11]="TargetSetting",e[e.MsgRemindSetting=12]="MsgRemindSetting",e[e.HeartRateSectionSetting=13]="HeartRateSectionSetting",e[e.FemaleHealthSetting=14]="FemaleHealthSetting",e[e.PeriodReminderSetting=15]="PeriodReminderSetting",e[e.Peirod2ReminderSetting=16]="Peirod2ReminderSetting",e[e.ReminderSetting=17]="ReminderSetting",e[e.HeartRateSwitachSetting=18]="HeartRateSwitachSetting",e[e.DrinkReminderSetting=19]="DrinkReminderSetting",e[e.GetBattery=255]="GetBattery"}(Ee||(Ee={}));const Pe="0000A500-0000-1000-8000-00805F9B34FB",Oe="0000A501-0000-1000-8000-00805F9B34FB",He="0000A502-0000-1000-8000-00805F9B34FB",Ve="0000A503-0000-1000-8000-00805F9B34FB",Ne="0000A700-0000-1000-8000-00805F9B34FB",_e="0000A701-0000-1000-8000-00805F9B34FB",We="0000FCC0-0000-1000-8000-00805F9B34FB",ze="0000FCC8-0000-1000-8000-00805F9B34FB";class qe{constructor(e,t,i){this.dataType="a5Daily",this.cmd=t;let n=new ve(e);if(27===t){n.readUint8();let e=n.readUint8(),t=[];for(let i=0;i<e;i++){let e,i=n.readUint16(),s=n.readUint24(),a=n.readUint32(),r=n.readSfloat(),c=n.readFloat(),o=n.readUint16(),d=n.readUint16(),h=n.readUint8(),l=n.readUint8()/100+1.6,p=!1;1&i&&(p=!0,e=n.readUint8()),t.push({isSilenceExist:p,step:s,utc:a,examount:r,calories:c,exerciseTime:o,distance:d,status:h,batteryVoltage:l,silenceHeartRate:e})}this.type=0,this.list=t}else{let i=e.byteLength/19,s=[];for(let e=0;e<i;e++){let e=n.readUint24(),t=n.readUint32(),i=n.readSfloat(),a=n.readFloat(),r=n.readUint16(),c=n.readUint16(),o=n.readUint8(),d=n.readUint8()/100+1.6;s.push({isSilenceExist:!1,step:e,utc:t,examount:i,calories:a,exerciseTime:r,distance:c,status:o,batteryVoltage:d})}this.list=s,81===t?(this.type=0,this.list[s.length-1]):87===t&&(this.type=1)}}}class je{constructor(e,t){this.dataType="DeviceInfo",this.cmd=t;let i=new ve(e),n=i.readBuffer(6);this.mac=ge(n),i.getString("model",5).getString("softVersion",4).getString("hardwareVersion",4).getUint8("timezone"),this.hrSwitch=i.readUint8(),2==this.hrSwitch?i.getUint32("dataSize"):i.getUint8("startHour").getUint8("startMinute").getUint8("endHour").getUint8("endMinute"),i.build(this)}}class $e{constructor(e,t){this.dataType="a5HR",this.cmd=t;let i=new ve(e);if(83==this.cmd||137==this.cmd){i.getUint32("utc").getUint8("utcOffset").getUint16("reside");let e=i.readUint16();i.getUint8Array("heartRates",e).build(this),83==this.cmd?this.type=0:this.type=3,this.utcOffset*=5}else if(115==this.cmd){i.getUint32("utc").getUint8("utcOffset").getUint16("reside");let e=i.readUint16();i.getUint8Array("heartRates",e).build(this),this.sportMode=1,this.subMode=0,this.type=2,this.utcOffset*=5}else if(229==this.cmd){i.getUint8("sportMode").getUint8("subMode").getUint32("utc").getUint8("utcOffset").getUint16("reside");let e=i.readUint16();i.getUint8Array("heartRates",e).build(this),this.type=2,this.utcOffset*=5}else if(16==this.cmd){let t=new ve(e).getUint8("type").getUint32("utc").getUint8("utcOffset").getUint16("reside"),i=t.readUint16();t.getUint8Array("heartRates",i).build(this),this.utcOffset*=5,0===this.type?this.type=0:1===this.type||5===this.type?this.type=2:this.type=3}this.heartRates||(this.heartRates=[])}merger(e){return e.heartRates.forEach((e=>{this.heartRates.push(e)})),this}}class Qe{constructor(e,t){this.dataType="PairCode",this.cmd=t,new ve(e).getString("randomCode",6).build(this)}}class Ze{constructor(e,t){this.dataType="a5Sleep",this.cmd=t;let i=new ve(e);this.utc=i.readUint32(),this.utcOffset=5*i.readUint8(),this.reside=i.readUint16(),i.readInt16();let n=e.byteLength-9,s=[];for(;n>0;){let e=i.readUint8(),t=127&e;n-=1;let a=1;for(0!=(128&e)&&n>0&&(a=i.readUint8(),n-=1);a>0;)s.push(t),a-=1}this.levelSet=s}}class Ge{constructor(e,t){this.dataType="a5SportCalories",this.cmd=t;let i=new ve(e);if(127==this.cmd){let t=e.byteLength-9;i.getUint32("utc").getUint8("utcOffset").getUint16("reside").getUint16("_count").getUint16Array("calories",t).build(this),this.sportMode=1,this.subMode=0,this.isNew=!1}else{let t=e.byteLength-11;i.getUint8("sportMode").getUint8("subMode").getUint32("utc").getUint8("utcOffset").getUint16("reside").getUint16("_count").getUint16Array("calories",t).build(this),this.isNew=!0}let n=[];for(let e=0;e<this.calories.length;e++){let t=this.calories[e];n.push(t/10)}this.calories=n,this.utcOffset*=5}}class Je{constructor(e,t){this.dataType="a5SportPace",this.cmd=t;let i=new ve(e);i.getUint8("sportMode").getUint8("subMode").getUint32("utc").getUint8("utcOffset").getUint16("reside");let n=i.readUint16();i.getUint16Array("speeds",2*n).build(this),this.utcOffset*=5}}class Ke{constructor(e,t){this.pauseUtc=e,this.reStartUtc=t}}var Ye;!function(e){e[e.step=1]="step",e[e.calories=2]="calories",e[e.distanche=4]="distanche",e[e.deepSleep=8]="deepSleep",e[e.stand=16]="stand",e[e.sportTime=32]="sportTime",e[e.laps=64]="laps"}(Ye||(Ye={}));class Xe{constructor(e,t){this.dataType="a5SportReport",this.cmd=t;let i=new ve(e);if(114==this.cmd)return void this.parseRunStateData(i);if(20===this.cmd)return i.getUint8("sportMode").getUint8("subMode").getUint32("start").getUint32("end").getUint16("sportTime").getUint32("step").getUint32("distance").getUint16("calories").getUint8("avgHr").getUint8("maxHr").getUint16("avgStepFreq").getUint8("avgStepOfFloating").getUint16("avgPace").getUint16("hrSection1TimeRatio").getUint16("hrSection2TimeRatio").getUint16("hrSection3TimeRatio").getUint16("hrSection4TimeRatio").getUint16("hrSection5TimeRatio").build(this),this.hrSection1TimeRatio*=.1,this.hrSection2TimeRatio*=.1,this.hrSection3TimeRatio*=.1,this.hrSection4TimeRatio*=.1,this.hrSection5TimeRatio*=.1,void(this.calories*=.1);let n=i.readUint8();switch(this.sportMode=n,this.subMode=i.readUint8(),n){case 1:this.parseRunData(i);break;case 3:case 24:this.parseCyclingData(i);break;case 4:this.parseSwimmingData(i);break;case 11:this.parseFootBallData(i);break;default:this.parseNormalData(i)}}parseRunStateData(e){this.sportMode=1,this.subMode=1,this.suspendTimes=e.readUint8(),e.getUint32("start");let t=[];for(let i=0;i<this.suspendTimes-1;i++){let i=e.readInt32(),n=e.readInt32();t.push(new Ke(i,n))}this.states=t,e.getUint32("end").getUint16("sportTime").getUint24("step").getUint32("calories").getUint8("maxHr").getUint8("avgHr").getUint8("maxStepFreq").getUint8("avgStepFreq").build(this)}parseRunData(e){this.flag=e.readUint32(),this.suspendTimes=e.readUint8(),e.getUint32("start");let t=[];for(let i=0;i<this.suspendTimes-1;i++){let i=e.readInt32(),n=e.readInt32();t.push(new Ke(i,n))}this.states=t,e.getUint32("end").getUint16("sportTime").getUint24("step").getFloat("calories").getUint8("maxHr").getUint8("avgHr").getUint8("maxStepFreq").getUint8("avgStepFreq").build(this)}parseCyclingData(e){this.flag=e.readUint16(),this.flag;let t=1==(this.flag>>1&1);this.suspendTimes=e.readUint8(),e.getUint32("start");let i=[];for(let t=0;t<this.suspendTimes-1;t++){let t=e.readInt32(),n=e.readInt32();i.push(new Ke(t,n))}this.states=i,e.getUint32("end").getUint16("sportTime").getUint32("calories").getUint8("maxHr").getUint8("avgHr").getUint16("maxSpeed").getUint16("avgSpeed").getUint32("distance"),t&&e.getUint8("infoOfTarget").getUint16("targetType").getUint32("targetValue"),e.build(this),this.calories=this.calories/10,this.maxSpeed=this.maxSpeed/100,this.avgSpeed=this.avgSpeed/100}parseSwimmingData(e){this.flag=e.readUint32();let t=1==(1&this.flag),i=1==(this.flag>>1&1),n=1==(this.flag>>2&1),s=1==(this.flag>>3&1),a=1==(this.flag>>4&1);e.getUint32("flag").getUint32("start").getUint32("end").getUint16("sportTime").getUint16("step").getUint32("calories"),t&&e.getUint8("distance"),i&&e.getUint8("mainStrokes"),n&&e.getUint8("avgSwolf"),s&&e.getUint8("numberOfStroke"),a&&e.getUint8("infoOfTarget").getUint16("targetType").getUint32("targetValue"),e.build(this),this.calories=this.calories/10}parseNormalData(e){this.flag=e.readUint16();let t=1==(1&this.flag),i=1==(this.flag>>1&1);this.suspendTimes=Math.min(1,e.readUint8()),e.getUint32("start");let n=[];for(let t=0;t<this.suspendTimes-1;t++){let t=e.readInt32(),i=e.readInt32();n.push(new Ke(t,i))}this.states=n,e.getUint32("end").getUint16("sportTime").getUint24("step").getUint32("calories").getUint8("maxHr").getUint8("avgHr").getUint16("maxSpeed").getUint16("avgSpeed").getUint32("distance"),t&&e.getUint8("maxStepFreq").getUint8("avgStepFreq"),i&&e.getUint8("infoOfTarget").getUint16("targetType").getUint32("targetValue"),e.build(this),this.step=(16711680&this.step)>>>16==255?0:this.step;let s=(4294901760&this.calories)>>>16==65535?0:this.calories;this.calories=s/10;let a=32768&this.maxSpeed?0:this.maxSpeed;this.maxSpeed=a/100;let r=32768&this.avgSpeed?0:this.avgSpeed;this.avgSpeed=r/100,this.distance=(4294901760&this.distance)>>>16==65535?0:this.distance}parseFootBallData(e){this.flag=e.readUint16();let t=1==(1&this.flag),i=1==(this.flag>>1&1),n=1==(this.flag>>2&1),s=1==(this.flag>>3&1);this.suspendTimes=Math.min(1,e.readUint8()),e.getUint32("start");let a=[];for(let t=0;t<this.suspendTimes-1;t++){let t=e.readInt32(),i=e.readInt32();a.push(new Ke(t,i))}this.states=a,e.getUint32("end").getUint16("sportTime").getUint24("step").getUint32("calories").getUint8("maxHr").getUint8("avgHr").getUint16("maxSpeed").getUint16("avgSpeed").getUint32("distance"),t&&e.getUint8("maxStepFreq").getUint8("avgStepFreq"),i&&e.getUint8("maxHrWhenMaxStepFreq"),n&&e.getUint8("infoOfTarget").getUint16("targetType").getUint32("targetValue"),s&&e.getUint16("sprintSpeed"),e.build(this),this.step=(16711680&this.step)>>>16==255?0:this.step;let r=(4294901760&this.calories)>>>16==65535?0:this.calories;this.calories=r/10;let c=32768&this.maxSpeed?0:this.maxSpeed;this.maxSpeed=c/100;let o=32768&this.avgSpeed?0:this.avgSpeed;this.avgSpeed=o/100,this.distance=(4294901760&this.distance)>>>16==65535?0:this.distance,s&&(this.sprintSpeed=this.sprintSpeed/100)}}class et{constructor(e,t){this.dataType="a5SportStatus",this.cmd=t,new ve(e).getUint8("function").getUint8("sportStatus").getUint8("sportMode").build(this)}}class tt{constructor(e,t,i){this.dataType="LoginReq",this.tag=t;let n=new ve(e);this.protoVersion=i;try{this.md5=n.readBuffer(16),17==e.byteLength&&(this.bindState=n.readUint8())}catch(e){}}}class it{constructor(e,t,i,n){this.tag=0,this.result=e,this.utc=t,this.timezone=i,this.platform=n}getBytes(){return(new ye).appendUint8(this.result?1:0).appendUint32(this.utc).appendUint8(this.timezone).appendUint8(this.platform).build()}}class nt{constructor(e=5){this.tag=0,this.state=e}getBytes(){return(new ye).appendUint8(this.state).build()}}class st{constructor(e,t){this.dataType="a5Step",this.cmd=t,new ve(e,0).getUint24("step",!1).getUint32("utc",!1).getSFloat("examount").getFloat("calories",!1).getUint16("exerciseTime").getUint16("distance").getUint8("status").getUint8("batteryVoltage").build(this)}}class at{constructor(e,t){this.dataType="Ack",this.cmd=t;let i=new ve(e);try{this.state=i.readUint8()}catch(e){}}}function rt(e){return parseInt(e.model)>=456||(e.model.indexOf("456")>=0||e.model.indexOf("460")>=0)}function ct(e){return e.model.indexOf("456")>=0}function ot(e){return e.model.indexOf("460")>=0}function dt(e){return rt(e)?5:3}let ht=[88,81,82,83,87,114,115,117,127,226,228,229,230,130,131,132,133,134,135,136,137,139,140,142,183,185,20,27,19,18,17,16,103,91,192],lt=[0,80,85,98,225,123,227,235];class pt extends Ce{constructor(){super(...arguments),this.isLoginReq=!1,this.pageIndex=0,this.sendChar={serviceId:Pe,charId:He,writeType:0}}didReceiveData(e){let t=new DataView(e.value);if(this.checkIsFirstFrame(t))this.firstFrame=this.decodeFirstFrame(t),this.receiveBuf=this.firstFrame.buf;else{let e=this.decodeOtherFrame(t);if(this.preFrame){if(this.preFrame.index!==e.index-1)return void this.callback(U.errorCode(5,this.tag));this.preFrame=e}else this.preFrame=e;this.receiveBuf=me(this.receiveBuf,e.buf)}this.checkFinished()?(this.receiveBuf=this.receiveBuf.slice(0,this.firstFrame.len-4),ht.indexOf(this.tag)>=0?this.sendAck():this.callback(U.errorCode(0,this.tag,this.receiveBuf,this.firstFrame.protoVersion))):this.resetTimeout()}checkIsFirstFrame(e){return 128==(128&e.getUint8(0))}decodeFirstFrame(e){let t=new ve(e.buffer);this.pageIndex=32767&t.readUint16(!1);let i=t.readUint8();t.readUint8();let n=t.readUint16(!1);i-=2,43521!=n&&(n=0,t.index-=2,i+=2),this.isLoginReq?this.tag=0:(this.tag=t.readUint8(),i-=1);let s=Math.min(i,this.mtu-t.index),a=t.readBuffer(s);return{cmd:this.tag,protoVersion:n,len:i,buf:a}}decodeOtherFrame(e){let t=new ve(e.buffer);return{index:t.readUint8(),buf:t.readBuffer(e.buffer.byteLength-1)}}async sendAck(){let e=new ye;0!=this.firstFrame.protoVersion&&e.appendUint16(this.firstFrame.protoVersion),e.appendUint8(this.tag).appendUint8(1);let t=e.build(),i=le(t),n=new ye;n.appendBuffer(t).appendUint32(i),t=n.build(),186===this.tag&&(this.pageIndex=0),e=new ye,e.appendUint8(128|this.pageIndex>>8).appendUint8(255&this.pageIndex).appendUint8(t.byteLength).appendUint8(1).appendBuffer(t);let s=e.build();await this.trySender(s,this.sendChar),this.callback(U.errorCode(0,this.tag,this.receiveBuf,this.firstFrame.protoVersion))}}class ut extends Be{constructor(){super(...arguments),this.sendChar={serviceId:Pe,charId:He,writeType:0},this.pageIndex=0,this.protoVersion=0}decodeToFrames(e){let t=e;if(0!=this.protoVersion){let e=new ye;e.appendUint16(this.protoVersion),e.appendBuffer(t),t=e.build()}let i=le(t),n=new ye;n.appendBuffer(t).appendUint32(i),t=n.build();let s=t.byteLength,a=this.mtu-4,r=new ye;r.appendUint8(128|this.pageIndex>>8).appendUint8(255&this.pageIndex).appendUint8(s).appendUint8(1);let c=[];r.appendBuffer(t.slice(0,a)),c.push(r.build());let o=this.mtu-1,d=Math.ceil((s-a)/o);for(let e=0;e<d;e++){let i=new ye,n=Math.min(s-16-o*e,o),r=o*e+a;i.appendUint8(e+2),i.appendBuffer(t.slice(r,r+n)),c.push(i.build())}return c}}class gt extends Re{constructor(){super(...arguments),this.prePageIndex=0,this.protoVersion=43521}didReceiveData(e){if(e.characteristicId==Oe)if(this.loginReqSession)this.loginReqSession.didReceiveData(e);else{let t=new pt(e.value,0);this.loginReqSession=t,t.isLoginReq=!0,t.mtu=this.mtu,t.sender=this.sender,t.completion=e=>{this.protoVersion=e.extra,this.loginReqSession&&this.loginReqSession.pageIndex?this.prePageIndex=this.loginReqSession.pageIndex:this.prePageIndex=0,this.loginReqSession=null,this.listener&&this.listener(e)},t.start()}else if(e.characteristicId==Ve){128&new DataView(e.value).getUint8(0)?(this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender,this.receiveringSession.completion=e=>{let t=this.receiveringSession;this.receiveringSession&&e.sid===this.receiveringSession.sid&&(this.receiveringSession=null),e.success&&(t.pageIndex&&(this.prePageIndex=t.pageIndex),this.listener&&this.listener(e))},this.receiveringSession.start()):this.receiveringSession?this.receiveringSession.didReceiveData(e):g.warn("抛弃未处理的数据",e.characteristicId,v(e.value))}else g.warn("未处理 cValue",e)}createSenderSession(e,t){let i=new ut(e);return i.protoVersion=this.protoVersion,rt(this.context.deviceInfo)&&225===t?i.pageIndex=0:lt.indexOf(t)>=0?i.pageIndex=this.prePageIndex:i.pageIndex=0,i}createReceiveSession(e){return new pt(e)}}class ft extends Be{constructor(){super(...arguments),this.sendChar={serviceId:Ne,charId:"0000A702-0000-1000-8000-00805F9B34FB",writeType:0},this.sendPackageChar={serviceId:Ne,charId:"0000A703-0000-1000-8000-00805F9B34FB",writeType:0},this.tag=255}async start(){this.sendHeader()}didReceiveData(e){if(e.value&&e.value.byteLength<4)return;if(this.isClear)return;let t=new ve(e.value);t.readUint16(),t.readUint8();let i=t.readUint8(),n=0;if(e.value.byteLength>4&&(n=t.readUint8()),0!=n)return g.error("ota 失败",v(e.value)),void this.handlerErrorCode(n);switch(i){case 2:this.otaParse.parseHeadAck(e.value),this.sendBlockPackage();break;case 3:let t=this.otaParse.parseDataAck(e.value);this.otaParse.checkDataFinished()?this.sendCmd(4):(this.otaParse.upgrade.onUpgradeProcess(100*t.percent),this.sendBlockPackage());break;case 4:this.sendCmd(5);break;case 5:this.sendCmd(6);break;case 6:this.callback(U.errorCode(0,this.tag));break;default:this.callback(U.errorCode(5,this.tag))}this.resetTimeout()}callback(e){this.timeoutId&&clearTimeout(this.timeoutId),this.completion&&(this.otaParse.upgrade.onUpgradeComplete(e.code,e.msg),this.completion(e),this.completion=null)}async sendHeader(){this.resetTimeout();for(let e=0;e<this.otaParse.headList.length;e++){let t=this.otaParse.headList[e];await this.trySender(t,this.sendChar)}}async sendBlockPackage(){if(this.isClear)return;let e=this.otaParse.getData();for(let t=0;t<e.length;t++){let i=e[t];await this.trySender(i,this.sendPackageChar)}this.sendBlockFinish()}async sendBlockFinish(){if(this.isClear)return;let e=this.otaParse.getBlockFinishAck();this.trySender(e,this.sendChar)}sendCmd(e){if(this.isClear)return;let t=(new ye).appendUint8(e).appendUint8(1).appendUint8(0).build();this.trySender(t,this.sendChar)}handlerErrorCode(e){switch(e){case 6:this.callback(U.errorCode(9,this.tag));break;case 4:this.callback(U.errorCode(16,this.tag));break;default:this.callback(U.errorCode(5,this.tag))}}}class mt extends Re{didReceiveData(e){this.sendingSession&&this.sendingSession.didReceiveData(e)}createSenderSession(e,t,i){let n=new ft(e);return n.otaParse=t,n}}class Ut{constructor(e,t){this.dataType="finish",this.cmd=t;let i=new ve(e);this.reportType=i.readUint8(),this.reportCmd="0x"+this.reportType.toString(16)}}class wt{constructor(e,t){this.dataType="charging",this.cmd=t,new ve(e).getUint32("utc").getUint8("startBattery").getUint32("endUtc").getUint8("endBattery").build(this)}}class vt{constructor(e,t){this.dataType="brightness",this.cmd=t,new ve(e).getUint8("brightnessInDay").getUint8("brightnessInNight").getUint8("enableInNight").getUint8("startHourInNight").getUint8("startMinuteInNight").getUint8("endHourInNight").getUint8("endMinuteInNight").build(this)}}class yt{constructor(e,t){this.dataType="sleepReport",this.cmd=t;let i=new ve(e).getUint32("sleepUtc").getUint32("awakeUtc").getUint32("durationOfAwake").getUint32("numberOfAwake").getUint32("numberOfEyeMovement").getUint32("timeOfLightSleep").getUint32("timeOfDeepSleep").getUint8("characteristicsOfSleep").getUint8("reside").getUint8("offsetOfSleepReport").getUint8("extFlag").getUint8("totalOfSleepStruct").getUint8("offsetOfSleepStruct");i.build(this);let n=i.readUint8(),s=[];for(let e=0;e<n;e++){let e=i.readUint32(),t=i.readUint32(),n=i.readUint8(),a=i.readUint32();0===a&&(a=(t-e)/60);let r={startUtc:e,endUtc:t,deep:n,duration:a};s.push(r)}this.sleepList=s;let a=this.extFlag;1==(a>>0&1)&&(this.breathScore=i.readUint8()),1==(a>>1&1)&&(this.breathLevel=i.readUint8()),1==(a>>>2&1)&&(this.sleepScore=i.readUint8())}merger(e){return e.sleepList.forEach((e=>{this.sleepList.push(e)})),this}}class St{constructor(e,t){if(this.dataType="bloodOxygen",this.cmd=t,131===t){let t=new ve(e).getUint16("reside").getUint16("offset");t.build(this);let i=t.readUint16(),n=[];for(let e=0;e<i;e++){let e=t.readUint32(),i=t.readUint8(),s=t.readUint8();n.push({utc:e,bloodOxygenValue:i,heartRate:s})}this.list=n}else if(142===t){let t=new ve(e);this.reside=t.readUint16();let i=t.readUint16(),n=t.readUint32(),s=5*t.readUint8(),a=[];for(let e=0;e<i;e++){let i=t.readUint8(),r=t.readUint8(),c=t.readUint8(),o=e*s+n;a.push({utc:o,bloodOxygenValue:r,heartRate:c,state:i})}this.list=a}else if(133===t){let t=new ve(e).getUint16("reside").getUint16("offset");t.build(this);let i=t.readUint16(),n=[];for(let e=0;e<i;e++){let e=t.readUint32(),i=t.readUint8(),s=t.readUint8();n.push({utc:e,bloodOxygenValue:i,heartRate:s})}this.list=n}}merger(e){return e.list.forEach((e=>{this.list.push(e)})),this.reside=e.reside,this.offset=e.offset,this}}class bt{constructor(e,t){this.dataType="dailReport",this.cmd=t;let i=new ve(e).getUint8("index");this.count=i.readUint8(),i.getUint8Array("list",this.count).build(this)}}class It{constructor(e,t){this.dataType="meditation",this.cmd=t;let i=new ve(e).getUint16("reside").getUint16("offset"),n=i.readUint16(),s=[];for(let e=0;e<n;e++){let e=i.readUint32(),t=i.readUint16();s.push({utc:e,duration:t})}this.list=s,i.build(this)}}class Dt{constructor(e,t){this.dataType="generalStepDetail",this.cmd=t;let i=new ve(e).getUint32("utc").getUint8("freq").getUint16("reside").getUint16("offset"),n=i.readUint16();i.getUint8Array("list",n).build(this)}}class Tt{constructor(e,t){this.dataType="dialInfo",this.tag=185,this.cmd=t,this.state=new ve(e).readUint8()}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.state).build()}}class Bt{constructor(e,t=0,i=0,n=0,s=0){this.tag=102,this.syncDataType=e,this.flag=t,this.settingType=i,this.param1=n,this.param2=s}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.syncDataType).appendUint32(this.flag).appendUint16(this.settingType).appendUint8(this.param1).appendUint8(this.param2).build()}}class Ct{constructor(e=!0,t=8,i=0,n=18,s=0,a=60,r=127,c=0,o=5,d=9,h=9){this.tag=110,this.dataType="SedentaryReminder",this.enable=e,this.startHour=t,this.startMinute=i,this.endHour=n,this.endMinute=s,this.frequency=a,this.repeatTime=r,this.vibrationType=c,this.vibrationTime=o,this.vibrationLevel1=d,this.vibrationLevel2=h}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(1).appendUint8(this.enable);return this.enable&&e.appendUint8(1).appendUint8(0).appendUint8(this.enable).appendUint8(this.startHour).appendUint8(this.startMinute).appendUint8(this.endHour).appendUint8(this.endMinute).appendUint8(this.frequency).appendUint8(this.repeatTime).appendUint8(this.vibrationTime).appendUint8(this.vibrationLevel1).appendUint8(this.vibrationLevel2),e.build()}parserBuf(e){return new ve(e).getUint8("enable").getUint8("startHour").getUint8("startMinute").getUint8("endHour").getUint8("endMinute").getUint8("frequency").getUint8("repeatTime").getUint8("vibrationTime").getUint8("vibrationLevel1").getUint8("vibrationLevel2").build(this),this}}class Rt{constructor(e){this.tag=163,this.dataType="EventReminder",this.events=e}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(this.events.length);return this.events.forEach((t=>{e.appendUint8(t.index);let i=I(y(t.desc,23));e.appendUint8(i.byteLength+1).appendBuffer(i).appendUint8(0);let n=0;n|=t.enable?1:0,t.napEnable&&(n|=2),t.lightSleepEnable&&(n|=4),t.isDelete&&(n|=128),e.appendUint8(n),t.napEnable&&t.enable&&e.appendUint8(t.napAlertTime),t.lightSleepEnable&&t.enable&&e.appendUint8(t.lightSleepAlertTime),e.appendUint8(t.hour).appendUint8(t.minute).appendUint8(t.repeatTime).appendUint8(t.vibrationType).appendUint8(t.vibrationTime).appendUint8(t.vibrationLevel1).appendUint8(t.vibrationLevel2)})),e.build()}parserBuf(e){let t=new ve(e),i=t.readUint8(),n=[];for(let e=0;e<i;e++){let e=t.readUint8(),i=t.readUint8(),s=k(t.readBuffer(i));s=y(s,i);let a=t.readUint8(),r=1==(a>>>0&1),c=1==(a>>>1&1),o=1==(a>>>2&1),d=null,h=null;c&&r&&(d=t.readUint8()),o&&r&&(h=t.readUint8());let l=t.readUint8(),p=t.readUint8(),u=t.readUint8(),g=t.readUint8(),f=t.readUint8(),m=t.readUint8(),U=t.readUint8();n.push({index:e,desc:s,enable:r,napEnable:c,lightSleepEnable:o,hour:l,minute:p,napAlertTime:d,lightSleepAlertTime:h,repeatTime:u,vibrationType:g,vibrationTime:f,vibrationLevel1:m,vibrationLevel2:U})}return this.events=n,this}merger(e){return e.events.forEach((e=>{this.events.push(e)})),this}}var At;!function(e){e[e.Temperature=1]="Temperature",e[e.Vibration=2]="Vibration",e[e.Brightness=3]="Brightness",e[e.RightSwipeDisplay=4]="RightSwipeDisplay",e[e.DistanceWeightHeightUnit=5]="DistanceWeightHeightUnit",e[e.DistanceUint=6]="DistanceUint",e[e.WeightUint=7]="WeightUint",e[e.HeightUint=8]="HeightUint",e[e.WeekFirstDay=9]="WeekFirstDay",e[e.DialDisplay=10]="DialDisplay",e[e.Time=11]="Time",e[e.LightSleepAwake=12]="LightSleepAwake",e[e.WalkStepLength=13]="WalkStepLength",e[e.RunStepLength=14]="RunStepLength",e[e.SportMainTarget=15]="SportMainTarget",e[e.SportStepTarget=16]="SportStepTarget",e[e.SportDistanceTarget=17]="SportDistanceTarget",e[e.SportCaloriesTarget=18]="SportCaloriesTarget",e[e.NightMode=19]="NightMode",e[e.NoDisturb=20]="NoDisturb",e[e.HeartRateWarning=21]="HeartRateWarning",e[e.SedentaryReminder=22]="SedentaryReminder",e[e.Language=23]="Language",e[e.SmartHeartRate=24]="SmartHeartRate",e[e.UserInfo=25]="UserInfo",e[e.BloodOxygen=32]="BloodOxygen",e[e.Remind=33]="Remind",e[e.Music=34]="Music",e[e.DrinkRemind=35]="DrinkRemind",e[e.MeditationRemind=36]="MeditationRemind",e[e.HeartRateEnable=37]="HeartRateEnable",e[e.TargetRemind=38]="TargetRemind",e[e.SleepRespiratoryQuality=39]="SleepRespiratoryQuality",e[e.FemaleHealth=40]="FemaleHealth",e[e.PeriodReminder=41]="PeriodReminder",e[e.Period2Reminder=42]="Period2Reminder",e[e.SportTarget=43]="SportTarget",e[e.ExerciseMinuteTarget=44]="ExerciseMinuteTarget",e[e.ActiveHourTarget=45]="ActiveHourTarget",e[e.CustomPage=48]="CustomPage",e[e.MainPage=49]="MainPage",e[e.DeleteDial=52]="DeleteDial",e[e.SleepPlan=53]="SleepPlan",e[e.SportTimeTarget=54]="SportTimeTarget",e[e.SportHrWarning=55]="SportHrWarning",e[e.TimeFormat=56]="TimeFormat",e[e.SleepRemind=57]="SleepRemind",e[e.HeartRateDetection=58]="HeartRateDetection"}(At||(At={}));class kt{constructor(e=[]){this.tag=251,this.dataType="SettingInfos",this.settings=e}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(this.settings.length);return this.settings.forEach((t=>{let i=this.getBytesWithItem(t);e.appendUint8(t.tag).appendUint8(i.byteLength).appendBuffer(i)})),e.build()}getBytesWithItem(e){let t=new ye;switch(e.tag){case At.Temperature:case At.Brightness:case At.Vibration:case At.BloodOxygen:case At.RightSwipeDisplay:case At.DistanceWeightHeightUnit:case At.DistanceUint:case At.WeightUint:case At.HeightUint:case At.WeekFirstDay:case At.HeartRateEnable:t.appendUint8(e.value);break;case At.SportStepTarget:case At.ActiveHourTarget:t.appendUint32(e.value);break;case At.SportTimeTarget:t.appendUint16(e.value);break;case At.NightMode:let i=e,n=i.enable?2:0;n|=i.enableImmediately?1:0,t.appendUint8(n).appendUint8(i.startHour).appendUint8(i.startMinute).appendUint8(i.endHour).appendUint8(i.endMinute);break;case At.Time:let s=e;t.appendUint32(s.utc).appendUint8(s.timezone);break;case At.DeleteDial:{let i=e;t.appendInt8(i.list.length);for(let e=0;e<i.list.length;e++){let n=i.list[e];t.appendUint8(n.dialType),t.appendUint8(n.index)}break}case At.FemaleHealth:{let i=e;t.appendUint8(i.length).appendUint8(i.period).appendUint8(i.lastBeginYear-1970).appendUint8(i.lastBeginMonth).appendUint8(i.lastBeginDay).appendUint8(i.lastEndYear-1970).appendUint8(i.lastEndMonth).appendUint8(i.lastEndDay).appendUint8(i.enable);break}case At.PeriodReminder:case At.Period2Reminder:{let i=e;t.appendUint8(i.enable).appendUint8(i.dayOfWarning).appendUint8(i.hour).appendUint8(i.minute);break}case At.SleepPlan:{let i=e;t.appendUint8(i.sleepTimeHour).appendUint8(i.sleepTimeMinute).appendUint8(i.awakeTimeHour).appendUint8(i.awakeTimeMinute).appendUint16(i.duration);break}case At.Remind:e.list.forEach((e=>{t.appendUint8(e.reminderType).appendUint8(e.enable)}));break;default:g.warn(`${e.tag} 未实现该设置信息协议`)}return t.build()}parserBuf(e){let t=new ve(e),i=t.readUint8(),n=[];for(let e=0;e<i;e++)n.push(this.parseTLV(t));return this.settings=n,this}parseTLV(e){let t,i=e.readUint8(),n=e.readUint8();switch(i){case At.Temperature:case At.Brightness:case At.Vibration:case At.BloodOxygen:case At.RightSwipeDisplay:case At.DistanceWeightHeightUnit:case At.DistanceUint:case At.WeightUint:case At.HeightUint:case At.TimeFormat:case At.WeekFirstDay:case At.HeartRateEnable:t={value:e.readUint8()};break;case At.NightMode:{let i=e.readUint8();t={enable:1==(i>>>1&1),enableImmediately:1==(i>>>0&1),startHour:e.readUint8(),startMinute:e.readUint8(),endHour:e.readUint8(),endMinute:e.readUint8()};break}case At.Time:t={utc:e.readUint32(),timezone:e.readUint8()};break;case At.HeartRateWarning:case At.SportHrWarning:t={enable:e.readUint8(),max:e.readUint8(),min:e.readUint8()};break;case At.DialDisplay:t={value:e.readUint8()};break;case At.SedentaryReminder:{let i=e.readUint8(),n=e.readUint8(),s=e.readUint8(),a=e.readUint8(),r=e.readUint8(),c=e.readUint8(),o=e.readUint8(),d={};try{d={noDisturbEnable:e.readUint8(),noDisturbStartHour:e.readUint8(),noDisturbStartMinute:e.readUint8(),noDisturbEndHour:e.readUint8(),noDisturbEndMinute:e.readUint8()}}catch(e){}t={enable:i,startHour:n,startMinute:s,endHour:a,endMinute:r,frequency:c,repeatTime:o,...d};break}case At.SleepRemind:t={enable:e.readUint8(),hour:e.readUint8(),minute:e.readUint8(),repeatTime:e.readUint8()};break;case At.CustomPage:{let i=[],s=[];for(let t=0;t<n;t++){let t=e.readUint8();0!=(128&t)?(t&=127,127===t&&(t=255),s.push(t)):(127===t&&(t=255),i.push(t))}t={pages:i,supportPages:s};break}case At.MainPage:{let i=e.readUint8(),s=[],a=[];for(let t=0;t<i;t++){let t=e.readUint8();s.push(t)}for(let t=0;t<n-i-1;t++){let t=e.readUint8();a.push(t)}t={pages:s,supportPages:a};break}case At.FemaleHealth:t={length:e.readUint8(),period:e.readUint8(),lastBeginYear:e.readUint8()+1970,lastBeginMonth:e.readUint8(),lastBeginDay:e.readUint8(),lastEndYear:e.readUint8()+1970,lastEndMonth:e.readUint8(),lastEndDay:e.readUint8(),enable:e.readUint8()};break;case At.PeriodReminder:case At.Period2Reminder:t={enable:e.readUint8(),dayOfWarning:e.readUint8(),hour:e.readUint8(),minute:e.readUint8()};break;case At.SleepPlan:t={sleepTimeHour:e.readUint8(),sleepTimeMinute:e.readUint8(),awakeTimeHour:e.readUint8(),awakeTimeMinute:e.readUint8(),duration:e.readUint16()};break;case At.Remind:{let i=n/2,s=[];for(let t=0;t<i;t++){let t=e.readUint8(),i=e.readUint8();s.push({enable:i,reminderType:t})}t={list:s};break}case At.HeartRateDetection:t={duration:e.readUint8(),level0:e.readUint8(),level1:e.readUint8(),level2:e.readUint8(),level3:e.readUint8(),level4:e.readUint8()};break;case At.DrinkRemind:t={enable:e.readUint8(),startHour:e.readUint8(),startMinute:e.readUint8(),endHour:e.readUint8(),endMinute:e.readUint8(),frequency:e.readUint8(),repeatTime:e.readUint8(),noDisturbEnable:e.readUint8(),noDisturbStartHour:e.readUint8(),noDisturbStartMinute:e.readUint8(),noDisturbEndHour:e.readUint8(),noDisturbEndMinute:e.readUint8()};default:g.error(`未实现设置信息解析协议 ${i} `)}return{tag:i,...t}}}class Ft{constructor(e,t){this.dataType="AlarmClockSwitch",this.cmd=t,new ve(e).getUint8("index").getUint8("enable").build(this)}}var xt=new class{parserBuf(e,t,i){switch(new ve(e).readUint8()){case 5:return(new Ct).parserBuf(e.slice(1));case 10:return(new Rt).parserBuf(e.slice(1));case 11:return(new kt).parserBuf(e.slice(1));case 14:return new Ft(e.slice(1),14);default:g.error("未处理的类型")}}};class Mt{constructor(e,t){this.dataType="buriedPoint",this.cmd=t;let i=new ve(e);this.style=i.readUint8()}}class Lt{constructor(e,t,i=1001){this.interval=2e4,this.actions=e,this.context=t,this.priority=i}}class Et{constructor(e,t,i=1e3){this.priority=1e3,this.interval=2e4;let n=[];this.priority=i,this.context=t,e.forEach((e=>{let t={name:"push",actionType:1,pushData:()=>e};n.push(t)})),this.actions=n}}class Pt{constructor(e,t,i,n){this.currentIndx=0,this.sid=Math.random(),this.mac=t,this.mutipAction=e,this.client=i}didReceive(e){let t=this.mutipAction.actions[this.currentIndx];if(t.await&&t.await.didReceive){let i=t.await.didReceive(e,this.mutipAction.context);return i instanceof U&&(i.success?(this._clearTimeout(),this.next()):this.callback(i),!0)}}async doAction(e){if(!this.isClear)try{if(e.when&&!1===e.when(this.mutipAction.context))return void this.next();e.await?(this.timeout=e.await.timeout||4e3,this.resetTimeout(),this.tryExcuteAction(e)):(await this.tryExcuteAction(e),this.next())}catch(e){this.callback(e)}}async tryExcuteAction(e){if(e.ignoreError&&e.ignoreError(this.mutipAction.context)){try{await this.excuteAction(e)}catch(e){g.info("忽略错误",e)}return Promise.resolve()}return await this.excuteAction(e)}async excuteAction(e){switch(e.actionType){case 0:return Promise.resolve();case 1:let t=e.pushData(this.mutipAction.context);return t instanceof Promise&&(t=await t),this.pusher(t);case 2:return this.client.enable(e.serviceId,e.characteristicId);case 3:return this.client.disable(e.serviceId,e.characteristicId);case 4:return this.client.read(e.serviceId,e.characteristicId)}}async next(){this.isClear?this.callback(U.errorCode(4)):(this.currentIndx+=1,this.checkFinish()?this.mutipAction.responseData?this.callback(this.mutipAction.responseData):this.callback(U.errorCode(0)):await this.doAction(this.mutipAction.actions[this.currentIndx]))}checkFinish(){return this.mutipAction.actions.length<=this.currentIndx}start(){this.currentIndx=0,this.doAction(this.mutipAction.actions[0])}resetTimeout(){this._clearTimeout();let e=this;this.timeoutId=setTimeout((()=>{let t=e.mutipAction.actions[e.currentIndx];t&&t.await&&t.await.onTimeout&&t.await.onTimeout(e.mutipAction.context)?e.next():e.callback(U.errorCode(3,e.mutipAction.actions))}),this.timeout)}_clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}callback(e){this._clearTimeout(),this.completion&&(e.sid=this.sid,this.completion(e),this.completion=null),this.isClear=!0}clear(){this.isClear=!0,this._clearTimeout(),this.completion=null}}class Ot{constructor(e,t){this.sessionList=new Array,this.mac=e,this.client=t}execute(e,t){e.priority>=1e3?this.sessionList.push(this.createSession(e,t)):e.priority<=0&&(this.workingSession||0!==this.sessionList.length)||this.sessionList.push(this.createSession(e,t)),this.sessionList.sort(((e,t)=>t.mutipAction.priority-e.mutipAction.priority)),this.dispatchNextAction()}didReceive(e){return!!this.workingSession&&this.workingSession.didReceive(e)}dispatchNextAction(){if(!this.workingSession&&this.sessionList.length>0){let e=this.sessionList[0];this.sessionList.shift(),this.workingSession=e,e.start()}else this.workingSession}cancelCurrentSession(){this.workingSession&&(this.workingSession.clear(),this.workingSession=null)}createSession(e,t){let i=new Pt(e,this.mac,this.client);i.pusher=this.pusher;let n=this;return i.completion=e=>{n.workingSession&&(n.workingSession=null),t&&t(e),n.dispatchNextAction()},i}stopTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}clear(){try{this.workingSession&&(this.workingSession.clear(),this.workingSession=null),this.sessionList.length=0}catch(e){g.warn("操作取消",this.mac,e)}}}class Ht{constructor(e){this.tag=248,this.dialIndex=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.dialIndex).build()}}var Vt,Nt;!function(e){e[e.didSend=1]="didSend",e[e.checked=2]="checked",e[e.checkFailed=3]="checkFailed",e[e.startInstall=4]="startInstall",e[e.installSuccess=5]="installSuccess",e[e.installFailed=6]="installFailed",e[e.cancelPush=7]="cancelPush",e[e.confirmCancelPush=8]="confirmCancelPush"}(Vt||(Vt={}));class _t{constructor(e){this.tag=250,this.pushStatus=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.pushStatus).build()}}class Wt{constructor(e){this.rspCode=0,this.dataView=new DataView(e.slice(2)),this.cmd=this.dataView.getUint8(0),this.rspCmd=this.dataView.getUint8(1),this.dataView.byteLength>2&&(this.rspCode=this.dataView.getUint8(2))}}class zt extends Wt{constructor(e){if(super(e),this.percent=0,this.currentOffset=this.dataView.getUint32(3,!1),this.dataView.byteLength>=8){let e=this.dataView.getUint16(7,!1);this.percent=e/1e4}}}class qt extends Wt{constructor(e){super(e),this.mtu=Math.max(20,this.dataView.getUint8(3)),this.maxCacheFrames=this.dataView.getUint8(4),this.startOffset=this.dataView.getUint32(5,!1),this.currentOffset=this.dataView.getUint32(9,!1),this.length=this.dataView.getUint32(13,!1)}}class jt{constructor(e,t=0){this.willSendSize=0,this.upgrade=e;let i=e.fileBuffer;this.originBuffer=i,this.size=i.byteLength,this.dataView=new DataView(i),this.mtu=20,this.otaVersion=t,i.byteLength>120?(this.isVilid=!0,this._parseHeadInfo()):(g.warn("文件不可用"),this.isVilid=!1)}getHeadData(){return this.headList}checkDataFinished(){return this.offset>=this.size-1}getData(){let e=0,t=[];for(let i=0;i<this.headAck.maxCacheFrames;i++){let n=this.offset+i*this.headAck.mtu,s=Math.min(this.mtu,this.size-n);if(s<=0||n>=this.size){g.log("发送完成了");break}e+=s;let a=this.originBuffer.slice(n,n+s);t.push(a)}return this.willSendSize=e,t}getBlockFinishAck(){let e=8;1==this.otaVersion&&(e=12);let t=le(this.originBuffer.slice(this.offset,this.offset+this.willSendSize)),i=new ye;return i.appendUint8(3).appendUint8(1).appendUint8(e).appendUint32(this.willSendSize,!1).appendUint32(t,!1),1==this.otaVersion&&i.appendUint32(this.offset,!1),this.willSendSize=0,i.build()}getCmd(e){let t=new Uint8Array(3);return t[0]=e,t[1]=1,t[2]=0,t.buffer}parseHeadAck(e){let t=new qt(e);return 0==this.otaVersion&&(t.mtu=20),this.offset=t.currentOffset,this.headAck=t,this.mtu=t.mtu,g.warn(t),this.headAck}parseDataAck(e){let t=new zt(e);return this.offset=t.currentOffset,0==this.otaVersion&&(t.percent=this.offset/this.headAck.length),t}parseAck(e){return new Wt(e)}_parseHeadInfo(){let e=Math.ceil(103/18)+1,t=[],i=0;for(let n=0;n<e;n++){let s=new ye;if(s.appendUint8(2).appendUint8(n+1),0==n)s.appendUint8(120),s.appendBuffer(this.originBuffer.slice(0,17)),i+=17;else{if(n===e-1){let e=this.originBuffer.slice(i,120);s.appendBuffer(e)}else s.appendBuffer(this.originBuffer.slice(i,i+18));i+=18}t.push(s.build())}this.offset=120,this.headList=t}}class $t{constructor(e,t){this.tag=e,this.serviceId=t}getBytes(){return(new ye).build()}}class Qt{constructor(e){this.priority=1001,this.dialPushSetting=e,255!=e.dailType?(this.fileInfo={fileBuffer:e.fileBuf,onUpgradeProcess:t=>{g.debug("progress ",t),e.onUpgradeProcess&&e.onUpgradeProcess(t)},onUpgradeComplete:(t,i)=>{e.onUpgradeComplete&&e.onUpgradeComplete(t,i)}},this.actions=this.getPushFileActions()):this.actions=this.deleteActions()}deleteActions(){let e=this;return[{name:"发送表盘数据",actionType:1,pushData:t=>e.dialPushSetting,await:{timeout:6e3,didReceive(e,t){if(249===e.cmd){return 1===e.state?U.success():U.errorCode(5)}return!0}}}]}getPushFileActions(){let e=this;return[{name:"发送表盘数据",actionType:1,pushData:t=>e.dialPushSetting,await:{timeout:8e3,didReceive(e,t){if(249===e.cmd){return 1===e.state?U.success():U.errorCode(5)}return!0}}},{name:"发送表盘文件",actionType:1,pushData(t){let i=new jt(e.fileInfo,1);return new $t(i,Ne)}},{name:"发送确认",actionType:1,pushData:e=>new _t(1),await:{timeout:3e3,didReceive(t,i){if(185===t.cmd){return 2===t.state?U.success():(e.responseData=U.errorCode(5),U.errorCode(5))}return!0}}},{name:"收到04",actionType:0,await:{timeout:8e3,didReceive(t,i){if(185===t.cmd){return 4===t.state?U.success():(e.responseData=U.errorCode(5),U.errorCode(5))}return!0}}},{name:"收到05",actionType:0,await:{timeout:8e3,didReceive(t,i){if(185===t.cmd){return 5===t.state?U.success():(e.responseData=U.errorCode(5),U.errorCode(5))}return!0}}}]}}class Zt{constructor(e,t,i){this.priority=1001,g.debug("A5GetSettingAction ",e),this.pushData=e,this.dataType=t,this.settingTag=i,this.actions=this.getActions()}getActions(){let e=this;return[{name:"获取设置项",actionType:1,pushData:t=>e.pushData,await:{timeout:14e3,didReceive(t,i){if(t.dataType===e.dataType){if("SettingInfos"!==t.dataType)return e.responseData=U.errorCode(0,t),e.responseData;{let i=t.settings[0];if(i&&i.tag===e.settingTag)return e.responseData=U.errorCode(0,t),e.responseData}}return!0}}}]}}class Gt{constructor(e){this.priority=1001,this.pushData=e,this.list=[]}get actions(){let e=this;return[{name:"",actionType:1,pushData:t=>e.pushData,await:{timeout:5e3,didReceive:(t,i)=>"EventReminder"!==t.dataType||(e.responseData=U.errorCode(0,t),e.responseData)}}]}}class Jt{constructor(e,t){this.dataType="dialDetail",this.cmd=t;let i=new ve(e);this.dialIndex=i.readUint8();let n=i.readUint8();if(n>0){let e=i.readBuffer(n);this.id=A(e)}this.dailType=i.readUint8();let s=i.readUint8();if(s>0){let e=i.readBuffer(s);this.fileName=A(e)}let a=i.readUint8();if(a>0){let e=i.readBuffer(a);this.backgroundImageName=A(e)}}}class Kt{constructor(e=Le.all){this.tag=240,this.syncDataType=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.syncDataType).appendUint32(0).build()}}class Yt{constructor(){this.priority=1001,this.list=[],this.pushData=new Kt(12);let e=this;this.dialReportActions=[{name:"发送表盘数据",actionType:1,pushData:t=>e.pushData,await:{timeout:3e3,didReceive:(t,i)=>"dailReport"!==t.dataType||(e.updateDialReport(t),U.errorCode(0))}},{name:"收到完结",actionType:0,await:{timeout:3e3,didReceive:(e,t)=>"finish"!==e.dataType||U.errorCode(0)}}]}get actions(){let e=[...this.dialReportActions];return this.dialDetailActions&&this.dialDetailActions.forEach((t=>{e.push(t)})),e}updateDialReport(e){let t=[],i=this;if(e.list.length>0)for(let n=0;n<e.list.length;n++){let s=e.list[n],a={name:"获取表盘详细数据",actionType:1,pushData:e=>new Ht(s),await:{timeout:7e3,didReceive:(t,n)=>"dialDetail"!==t.dataType||(i.list.push(t),i.responseData=U.errorCode(0,{index:e.index,list:i.list}),i.responseData)}};t.push(a)}this.dialDetailActions=t}}class Xt{constructor(e,t){this.dataType="stepFreq",this.cmd=t;let i=new ve(e).getUint8("sportMode").getUint8("subMode").getUint32("utc").getUint32("utcOffset").getUint16("reside"),n=i.readUint16();i.getUint16Array("list",n).build(this),this.utcOffset*=5}}class ei{constructor(e,t){this.dataType="stepFreq",this.cmd=t;let i=new ve(e).getUint8("sportMode").getUint8("subMode").getUint32("utc").getUint32("utcOffset").getUint16("reside"),n=i.readUint16();i.getUint16Array("list",n).build(this),this.utcOffset*=5}}class ti{constructor(e){this.priority=0,this.actions=this.getActions(e)}getActions(e){let t=[],i=this;return e.forEach((e=>{t.push({name:"sync",actionType:1,ignoreError:e=>!0,pushData:t=>new Kt(e),await:{timeout:1e4,didReceive(t,n){if("finish"===t.dataType){if(t.reportType===e)return g.info("收到测试截止符",t),i.responseData=U.errorCode(0,t),i.responseData}return!0}}})})),t}}class ii{constructor(e){this.tag=181,e?(this.age=e.age||25,this.weight=e.weight||60,this.height=e.height||175,this.gender=e.gender):(this.age=25,this.weight=60,this.height=1.75,this.gender=1)}getBytes(){let e=F(this.weight),t=F(this.height);return(new ye).appendUint8(this.tag).appendUint8(this.age).appendUint8(this.gender).appendUint32(e).appendUint32(t).build()}}!function(e){e[e.reLogin=0]="reLogin",e[e.disconnect=1]="disconnect",e[e.unbind=2]="unbind",e[e.restart=3]="restart",e[e.reset=4]="reset",e[e.close=5]="close",e[e.findBand=6]="findBand",e[e.stopFindBand=7]="stopFindBand",e[e.stopFindPhone=8]="stopFindPhone",e[e.pair=9]="pair"}(Nt||(Nt={}));class ni{constructor(e){this.tag=169,this.workState=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint32(0).appendUint8(this.workState).build()}}class si{constructor(e,t,i,n,s,a,r=0){this.tag=227,this.localRate=0,this.result=e,this.utc=t,this.timezone=i,this.platform=n,this.weight=s,this.height=a,this.localRate=r}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(this.result).appendUint32(this.utc).appendUint8(this.timezone).appendUint8(this.platform),t=F(this.weight),i=F(this.height);return e.appendUint32(t),e.appendUint32(i),e.appendUint8(this.localRate),e.build()}}class ai{constructor(){this.priority=1250,this.actions=[{name:"重新登陆",actionType:1,pushData:()=>new ni(Nt.reLogin),await:{timeout:5e3,didReceive:(e,t)=>"LoginReq"!==e.dataType||U.errorCode(0)}},{name:"绑定方式",actionType:1,pushData:e=>new nt(5),await:{timeout:6e4,didReceive(e,t){if("Ack"===e.dataType){let t=e;return 227===t.cmd&&0===t.state?U.success():1===t.state?U.errorCode(13):U.errorCode(5)}return"PairCode"!==e.dataType||U.success()}}},{name:"BindResponse",actionType:1,pushData:e=>new si(0,x(),E(),T()?1:2,1.75,60)}]}}class ri{constructor(e,t){this.dataType="standData",this.cmd=t;let i=new ve(e),n=i.readUint8();if(1===n){i.readUint8();let t=[],n=(e.byteLength-2)/8;for(let e=0;e<n;e++){let e=i.readUint32(),n=i.readUint32(),s=0;for(let e=0;e<24;e++)1==(n>>e&1)&&(s+=1);t.push({utc:e,originValue:n,duration:s})}this.list=t}else g.warn("类型未处理 tag subCmd",t,n)}}class ci{constructor(e){this.dataType="userInfo",this.tag=80,e?(this._userInfo=e,this._userInfo.weight=e.weight>0?e.weight:this._userInfo.weight,this._userInfo.weight>300&&(this._userInfo.weight=300),this._userInfo.height=e.height>0?e.height:this._userInfo.height,this._userInfo.height>3&&(this._userInfo.height=3),this._userInfo.targetStep=e.targetStep>0?e.targetStep:this._userInfo.targetStep):this._userInfo={weight:60,height:1.75,targetStep:7e3,gender:1}}getBytes(){let e=this._userInfo,t=F(e.weight),i=F(e.height),n=e.targetStep>0?1:0,s=e.targetStep,a=new ye;return a.appendUint8(this.tag).appendUint32(x(),!1).appendUint32(t).appendUint32(i).appendUint8(n).appendUint32(s).appendUint24(0).appendUint8(0).appendUint8(0).appendUint8(1).appendUint16(0).appendUint16(0),a.build()}}var oi=[{name:"ReplyReset",actionType:1,pushData:e=>new ni(Nt.reLogin),await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;return t.loginReq=e,t.cmdVersion=i.protoVersion,rt(t.deviceInfo)?t.deviceInfo.isBinded=3===i.bindState:t.deviceInfo.isBinded=!0,U.success()}return!0}}},{name:"ReplyLogin",actionType:1,pushData(e){let t=0;return t=43521==e.cmdVersion?E():L(),new it(!0,x(),t,T()?1:2)},await:{dataType:"DeviceInfo",didReceive:(e,t)=>"DeviceInfo"!==e.dataType||U.success()}},{name:"ReplyDeviceInfo",actionType:1,pushData:e=>new ci(e.userInfo)}];const di=0,hi=1,li=2,pi=7,ui=13,gi=16,fi=255;class mi{constructor(e){this.tag=126,this.pages=e}getBytes(){let e=this.pages||[],t=new ye;if(t.appendUint8(this.tag),t.appendUint8(e.length),e.length>0)for(let i=0;i<e.length;i++)t.appendUint8(e[i]);return t.build()}}class Ui{constructor(e,t){this.tag=168,this.sportHrSetting=e,this.generalHrSetting=t}getBytes(){let e=0,t=[];this.generalHrSetting&&(e|=1,t.push(this.generalHrSetting)),this.sportHrSetting&&(e|=2,t.push(this.sportHrSetting));let i=(new ye).appendUint8(this.tag).appendUint32(e);return t.forEach((e=>{i.appendUint8(e.max).appendUint8(e.min).appendUint8(e.enable)})),i.build()}}class wi{constructor(e){this.tag=184,this.events=e}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(this.events.length);return this.events.forEach((t=>{e.appendUint8(t.index).appendUint8(t.type);let i=I(y(t.desc,24));e.appendUint8(i.byteLength).appendBuffer(i).appendUint8(t.enable).appendUint8(t.hour).appendUint8(t.minute).appendUint8(t.repeatTime).appendUint8(t.vibrationType).appendUint8(t.vibrationTime).appendUint8(t.vibrationLevel1).appendUint8(t.vibrationLevel2)})),e.build()}}class vi{constructor(e=0){this.tag=121,this.timeFormat=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.timeFormat).build()}getCmd(){return 121}}class yi{constructor(e){this.priority=1050,this.context=e;let t=[new Ui({max:220-(e.userInfo&&e.userInfo.age||20),min:0,enable:!0},{max:120,min:0,enable:!1}),new kt([{tag:At.BloodOxygen,value:0}]),new Ct(!0,9,0,18,0,60,127,0,5,9,9),new wi([{index:1,type:3,desc:"",enable:!0,hour:23,minute:0,repeatTime:127,vibrationType:2,vibrationTime:60,vibrationLevel1:9,vibrationLevel2:9}]),new kt([{tag:At.NightMode,enable:!0,startHour:23,startMinute:0,endHour:7,endMinute:0}]),new vi(1),new mi([di,fi,li,hi,pi,gi,ui]),new kt([{tag:At.RightSwipeDisplay,value:di}])],i=[];t.forEach((e=>{let t={name:"push",actionType:1,pushData:()=>e};i.push(t)})),this.actions=i}}class Si extends class{constructor(){this.dataMap=new Map}updateData(e,t,i){let n=this.dataMap.get(t);if(n){let t=n.get(i);t?(t=t.merger(e),n.set(i,t)):n.set(i,e)}else n=new Map,n.set(i,e);this.dataMap.set(t,n)}getMergedDataList(e){let t=[],i=this.dataMap.get(e);if(i){for(const[e,n]of i.entries()){t.push(n);break}this.dataMap.delete(e)}return t}getMergedData(e,t){let i=this.dataMap.get(e);return i?i.get(t):null}receiveAndHandle(e,t){return!1}callbackAllData(){this.dataMap.forEach(((e,t)=>{e.forEach(((e,t)=>{this.lister(e)}))})),this.dataMap.clear()}callbackData(e){let t=this.getMergedDataList(e);t&&t.length>0&&t.forEach((e=>{this.lister(e)}))}}{receiveAndHandle(e,t){switch(e.dataType){case"EventReminder":{let t=e;return 0===t.events.length?(this.updateData(t,t.dataType,10),this.callbackAllData()):this.updateData(t,t.dataType,10),g.warn("收到 数据",e),!0}case"sleepReport":{let t=e;return this.updateData(t,t.dataType,t.sleepUtc),t.sleepList[t.sleepList.length-1].endUtc===t.awakeUtc&&this.callbackAllData(),!0}case"bloodOxygen":{let t=e;return this.updateData(t,t.dataType,133),!0}case"finish":return this.callbackAllData(),!1}return!1}}function bi(e){if(!e||0===e.byteLength)return 0;let t=new Uint8Array(e),i=0;for(let n=0;n<e.byteLength;n++)i+=t[n];return 65535&i}class Ii extends Ce{constructor(){super(...arguments),this.pageIndex=0,this.sendChar={serviceId:We,charId:"0000FCC6-0000-1000-8000-00805F9B34FB",writeType:0}}didReceiveData(e){let t=new DataView(e.value);if(this.checkIsFirstFrame(t))this.firstFrame=this.decodeFirstFrame(t),this.receiveBuf=this.firstFrame.buf;else{let e=this.decodeOtherFrame(t);if(this.preFrame){if(this.preFrame.index!==e.index-1)return void this.callback(U.errorCode(5,this.tag));this.preFrame=e}else this.preFrame=e;this.receiveBuf=me(this.receiveBuf,e.buf)}this.checkFinished()?(this.receiveBuf=this.receiveBuf.slice(0,this.firstFrame.len-2),160===this.tag?this.sendAck():this.callback(U.errorCode(0,this.tag,this.receiveBuf,this.firstFrame.protoVersion))):this.resetTimeout()}checkIsFirstFrame(e){return 1===e.getUint8(0)}decodeFirstFrame(e){let t=new ve(e.buffer);this.pageIndex=t.readUint8();let i=t.readUint8();this.tag=t.readUint8();let n=Math.min(i,e.buffer.byteLength-t.index),s=t.readBuffer(n);return{cmd:this.tag,len:i,buf:s}}decodeOtherFrame(e){let t=new ve(e.buffer);return{index:t.readUint8(),buf:t.readBuffer(e.buffer.byteLength-1)}}async sendAck(){let e=new ve(this.receiveBuf).readUint8(),t=(new ye).appendUint8(192).appendUint8(e).appendUint8(1).build(),i=bi(t),n=(new ye).appendUint8(1).appendUint8(t.byteLength+3).appendUint16(i).build();await this.trySender(n,this.sendChar),this.callback(U.errorCode(0,this.tag,this.receiveBuf,this.firstFrame.protoVersion))}}class Di extends Be{constructor(e,t){super(e,t),this.sendChar={serviceId:We,charId:"0000FCC6-0000-1000-8000-00805F9B34FB",writeType:0},this.pageIndex=0,this.protoVersion=0,this.needAck=193!=t}didReceiveData(e){let t=new ve(e.value);t.readUint8(),t.readUint8(),t.readUint8(),t.readUint8(),t.readUint8(),g.warn("收到确认帧"),this.callback(U.errorCode(0,this.tag))}decodeToFrames(e){let t=e,i=bi(t),n=new ye;n.appendBuffer(t).appendUint16(i),t=n.build();let s=t.byteLength,a=this.mtu-2,r=new ye;r.appendUint8(1).appendUint8(s);let c=[];r.appendBuffer(t.slice(0,a)),c.push(r.build());let o=this.mtu-1,d=Math.ceil((s-a)/o);for(let e=0;e<d;e++){let i=new ye,n=Math.min(s-16-this.mtu*e,o),r=o*e+a;i.appendUint8(e+2),i.appendBuffer(t.slice(r,r+n)),c.push(i.build())}return c}}class Ti extends Re{didReceiveData(e){if("0000FCCA-0000-1000-8000-00805F9B34FB"==e.characteristicId)g.warn("未处理数据",e);else if("0000FCC7-0000-1000-8000-00805F9B34FB"==e.characteristicId){let t=new DataView(e.value),i=t.getUint8(2);if(this.sendingSession&&this.sendingSession.tag===i)return void this.sendingSession.didReceiveData(e);1&t.getUint8(0)?(this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender,this.receiveringSession.completion=e=>{this.receiveringSession&&e.sid===this.receiveringSession.sid&&(this.receiveringSession=null),e.success&&this.listener&&this.listener(e)},this.receiveringSession.start()):this.receiveringSession?this.receiveringSession.didReceiveData(e):g.warn("抛弃未处理的数据",e.characteristicId,v(e.value))}else e.characteristicId===ze?this.listener&&this.listener(U.errorCode(0,64712,e.value)):g.warn("未处理 cValue",e)}createSenderSession(e,t){return new Di(e,t)}createReceiveSession(e){return new Ii(e)}}class Bi{constructor(e,t){this.tag=161,this.dataType="GetMsgDetail",this.msgType1=4;let i=new ve(e);this.msgType1=i.readUint8(),this.msgId=i.readUint32();let n=(e.byteLength-5)/3;for(let e=0;e<n&&!(e>=3);e++){let e=i.readUint8(),t=0;try{t=i.readUint16()}catch(e){}switch(e){case 2:this.sizeOfSubtitle=t;break;case 3:this.sizeOfContent=t;break;case 4:this.sizeOfContentLengthString=t;break;case 5:this.sizeOfTimeString=t}}}}class Ci{constructor(e,t,i,n,s,a,r){this.tag=193,this.msgType=4,this.serviceId=We,this.msgId=e,this.count=t,this.index=i,this.subTitleBuf=n,this.contentBuf=s,this.sizeOfContentBuf=a,this.timeBuf=r}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(this.msgType).appendUint32(this.msgId).appendUint8(this.count).appendUint8(this.index);return this.subTitleBuf&&e.appendUint8(2).appendUint16(this.subTitleBuf.byteLength).appendBuffer(this.subTitleBuf),this.contentBuf&&e.appendUint8(3).appendUint16(this.contentBuf.byteLength).appendBuffer(this.contentBuf),this.sizeOfContentBuf&&e.appendUint8(4).appendUint16(this.sizeOfContentBuf.byteLength).appendBuffer(this.sizeOfContentBuf),this.timeBuf&&e.appendUint8(5).appendUint16(this.timeBuf.byteLength).appendBuffer(this.timeBuf),e.build()}}class Ri{constructor(e){this.priority=1e3,this.actions=this.getActions(e)}getActions(e){let t=this;return[{name:"发送消息简介",actionType:1,pushData:t=>e,await:{timeout:5e3,didReceive:(e,i)=>"GetMsgDetail"!==e.dataType||(t.msgDetailReq=e,U.errorCode(0))}},{name:"发送消息详情",actionType:1,pushData(i){let n=t.msgDetailReq,s=I(e.msgInfo.content);return n.sizeOfContent&&s.byteLength>n.sizeOfContent&&(g.warn("推送消息过大"),s=s.slice(0,n.sizeOfContent)),new Ci(e.msgInfo.msgId,e.count,1,null,s)}}]}}class Ai{constructor(e,t,i){this.dataType="Battery",this.cmd=t;let n=new ve(e),s=n.readBuffer(6);if(this.mac=ge(s),g.debug("device",i),rt(i)){2===n.readUint8()?(this.battery=n.readUint8(),i.battery=this.battery):(this.ischarging=0!==n.readUint8(),i.isCharging=this.ischarging)}else{this.ischarging=0!==n.readUint8();let e=n.readUint16()/1e3;this.battery=function(e,t){let i=4.1,n=3.6;t.model&&(t.model.indexOf("407")>=0||t.model.indexOf("410")>=0?(i=3,n=2.1):t.model.indexOf("405")&&t.softwareVersion.length>=2&&(n=parseInt(t.softwareVersion.substring(1))<=59?3.64:3.55));return e<=n?0:e<i?Math.ceil((e-n)/(i-n)*100):100}(e,i),i.isCharging=this.ischarging,i.battery=this.battery}}}class ki{constructor(e,t){this.priority=1001;let i=this;this.actions=[{name:"获取设置项",actionType:4,serviceId:e,characteristicId:t,await:{timeout:3e3,didReceive:(e,t)=>"Battery"!==e.dataType||(i.responseData=U.errorCode(0,e),i.responseData)}}]}}class Fi{constructor(e,t,i){this.tag=192,this.cmd=192,this.dataType="ControlMusicAndDevice",this.workMode=e,this.switchType=t,this.vol=i}getBytes(){let e=0;return e=0===this.workMode?this.workMode:128+(127&this.vol),(new ye).appendUint8(this.tag).appendUint8(e).build()}parserBuf(e){let t=new Uint8Array(e)[0];return t>>7==1?(this.vol=127&t,this.workMode=1):(this.workMode=0,this.switchType=t),this}}class xi{constructor(e,t){this.dataType="CallControl",this.tag=160,new ve(e).getUint8("msgType").getUint8("controlType").build(this)}}class Mi{constructor(e,t){this.priority=1100,this.context=e,this.actions=this.getActions(e,t)}getActions(e,t){return[{name:"EnableCharacteristic701",serviceId:Ne,characteristicId:_e,actionType:2,when:e=>{let t=!!e.client.serviceMap.get(Ne);return t&&(t=!rt(e.deviceInfo)),t}},{name:"push",actionType:1,pushData:()=>{let i=new jt(t,function(e){return rt(e)?1:0}(e.deviceInfo));return new $t(i,Ne)}}]}}var Li=[{name:"Disable",serviceId:Pe,characteristicId:Oe,actionType:3},{name:"EnableCharacteristic503",serviceId:Pe,characteristicId:Ve,actionType:2},{name:"EnableCharacteristic701",serviceId:Ne,characteristicId:_e,actionType:2,when:e=>{let t=!!e.client.serviceMap.get(Ne);return t&&(t=rt(e.deviceInfo)),t}},{name:"EnableCharacteristicFCC8",serviceId:We,characteristicId:"0000FCC7-0000-1000-8000-00805F9B34FB",actionType:2,when:e=>!!e.client.serviceMap.get(We)},{name:"EnableCharacteristic",serviceId:Pe,characteristicId:Oe,actionType:2,await:{timeout:5e3,didReceive(e,t){if("LoginReq"===e.dataType){let i=e;return t.loginReq=e,t.cmdVersion=i.protoVersion,g.debug("onReadDeviceId",t,t.deviceInfo),t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(t.deviceInfo.lzDeviceId),void 0!==i.bindState&&ot(t.deviceInfo)&&3===i.bindState?U.errorCode(14):(g.warn("context.bindingMode",dt(t.deviceInfo),i.bindState),U.success())}return U.errorCode(5)}}},{name:"M5LoginBindResp",actionType:1,pushData(e){let t=dt(e.deviceInfo);return 5===t&&e.listeners&&e.listeners.onWaitUserSelect&&e.listeners.onWaitUserSelect(e),new nt(t)},await:{timeout:45e3,didReceive(e,t){if("Ack"===e.dataType){let t=e;return 227===t.cmd&&0===t.state?U.success():1===t.state?U.errorCode(13):U.errorCode(5)}if("PairCode"===e.dataType){let i=e;return t.ext=i,3===dt(t.deviceInfo)&&t.listeners.onInputRandomNum(i.randomCode),U.success()}return!0}}},{name:"WaitBindResp",actionType:0,when:e=>3===dt(e.deviceInfo),await:{dataType:"Ack",timeout:6e4,didReceive:(e,t)=>"Ack"!==e.dataType||(227===e.cmd?U.success():U.errorCode(5))}},{name:"BindResponse",actionType:1,pushData(e){let t=0;return t=43521==e.cmdVersion?E():L(),new si(0,x(),t,T()?1:2,e.userInfo.weight,e.userInfo.height)}},{name:"获取电量",actionType:4,serviceId:We,characteristicId:ze,await:{didReceive:(e,t)=>"Battery"!==e.dataType||U.success()}}],Ei=[{name:"Disable",serviceId:Pe,characteristicId:Oe,actionType:3},{name:"EnableCharacteristic503",serviceId:Pe,characteristicId:Ve,actionType:2},{name:"EnableCharacteristic",serviceId:We,characteristicId:"0000FCC7-0000-1000-8000-00805F9B34FB",actionType:2,when:e=>!!e.client.serviceMap.get(We)},{name:"EnableCharacteristic",serviceId:Pe,characteristicId:Oe,actionType:2,await:{dataType:"LoginReq",timeout:5e3,didReceive(e,t){if("LoginReq"===e.dataType){let i=e;return t.loginReq=e,t.cmdVersion=i.protoVersion,rt(t.deviceInfo)?t.deviceInfo.isBinded=3===i.bindState:t.deviceInfo.isBinded=!0,U.success()}return!0}}},{name:"ReplyLogin",actionType:1,pushData(e){let t=0;return t=43521==e.cmdVersion?E():L(),new it(!0,x(),t,T()?1:2)},await:{dataType:"DeviceInfo",didReceive:(e,t)=>"DeviceInfo"!==e.dataType||U.success()}},{name:"ReplyDeviceInfo",actionType:1,pushData:e=>new ci(e.userInfo)},{name:"获取电量",actionType:4,serviceId:We,characteristicId:ze,await:{didReceive:(e,t)=>"Battery"!==e.dataType||U.success()}},{name:"EnableCharacteristic701",serviceId:Ne,characteristicId:_e,actionType:2,when:e=>{let t=!!e.client.serviceMap.get(Ne);return t&&(t=rt(e.deviceInfo)),t}}];const Pi="0000A602-0000-1000-8000-00805F9B34FB",Oi="0000A610-0000-1000-8000-00805F9B34FB",Hi="0000A621-0000-1000-8000-00805F9B34FB",Vi="0000A640-0000-1000-8000-00805F9B34FB",Ni="0000AAAA-0000-1000-8000-00805F9B34FB",_i="00001880-0000-1000-8000-00805F9B34FB",Wi="00001530-1212-EFDE-1523-785FEABCD123";class zi{constructor(e){this.tag=1,this.deviceId=e}getBytes(){let e=(new ye).appendUint16(this.tag),t=ue(this.deviceId);return e.appendBuffer(t),e.appendUint8(1),e.build()}}class qi{constructor(e,t){this.dataType="RegisterResp";let i=new DataView(e);this.isSuccess=1===i.getUint8(0)}}class ji{constructor(e,t){this.dataType="apInfo",this.cmd=t;let i=new ve(e),n=i.readUint8(),s=i.readBuffer(n);this.ssid=A(s);let a=i.readBuffer(6);this.bssid=v(a);try{this.mode=i.readUint8(),this.rssi=i.readUint8(),this.connected=i.readUint8()}catch(e){}}}class $i{constructor(e,t){if(this.dataType="bloodpressure",this.cmd=t,!e)return;let i=0,n=new DataView(e);this.remainCount=n.getUint16(i),i+=2;let s=n.getUint32(i);i+=4,this.unit=1&s,this.systolic=n.getUint16(i),i+=2,this.diastolic=n.getUint16(i),i+=2,this.meanPressure=n.getUint16(i),i+=2;let a=n.getUint16(i);if(i+=2,s>>=1,C(s,0)&&(this.pulseRate=n.getUint16(i),i+=2),C(s,1)&&(this.userId=n.getUint8(i)<0?n.getUint8(i)+256:n.getUint8(i),i++),C(s,2)&&(this.utc=12622752e5+1e3*n.getUint32(i),i+=4),C(s,3)&&(this.bodyMovementDetection=C(a,0)),C(s,4)&&(this.cuffFitDetection=C(a,1)),C(s,5)&&(this.irregularPulseDetection=C(a,2)),this.pulseOut=C(a,3),C(s,6)&&(this.measurementPositionDetection=C(a,4)),this.rebind=C(a,5),this.hsd=C(a,6),C(s,7)&&(this.timeZone=n.getUint8(i),i++),C(s,8)){let t=e.slice(i,i+7);this.timeStamp=v(t),i+=7}}}class Qi{constructor(e,t){this.cmd=4098,this.dataType="configStatus",this.cmd=t,new ve(e,0).getUint8("status").build(this)}}class Zi{constructor(e,t){if(this.dataType="scale",this.cmd=t,!e)return;let i=0,n=new DataView(e);this.remainCount=n.getUint16(i),i+=2;let s=n.getUint32(i);if(i+=4,this.unit=3&s,this.weight=.01*n.getUint16(i),i+=2,s>>=2,C(s,0)&&(this.userNumber=n.getUint8(i),i++),C(s,1)&&(this.utc=n.getUint32(i),i+=4),C(s,2)&&(this.timeZone=n.getUint8(i),i++),C(s,3)){let t=e.slice(i,i+7);this.timeStamp=v(t),i+=7}C(s,4)&&(i+=2),C(s,5)&&(i+=2),C(s,6)&&(i+=2),C(s,7)&&(i+=2),C(s,8)&&(i+=2),C(s,9)&&(i+=2),C(s,10)&&(i+=2),C(s,11)&&(i+=2),C(s,12)&&(this.resistance=n.getUint16(i),i+=2),C(s,13)&&(this.realtimeDataStatus=!0),C(s,14)&&(this.heartRate=n.getUint8(i))}}class Gi{constructor(e,t){this.dataType="wifiInfo",this.cmd=t;let i=new DataView(e);this.cmd=i.getUint16(0,!0);let n=0;this.status=i.getUint8(n),n++;let s=i.getUint8(n);n++;let a=e.slice(n,n+s);n+=s,this.ssid=A(a);let r=e.slice(n,n+6);n+=6,this.bssid=v(r);let c="";c+=i.getUint8(n)+".",n++,c+=i.getUint8(n)+".",n++,c+=i.getUint8(n)+".",n++,c+=i.getUint8(n),n++,this.ip=c}}var Ji=Object.freeze({__proto__:null,ConnectWifiReq:class{constructor(e){this.tag=1,this.serviceId=Ni,this.settingInfo=e}getBytes(){let e=S(this.settingInfo.password),t=function(e){let t=0,i=e.length;if(i%2!=0)return null;i/=2;let n=[];for(let s=0;s<i;s++){let i=e.substr(t,2),s=parseInt(i,16);n.push(s),t+=2}return n}(this.settingInfo.bssid),i=e.length,n=new ArrayBuffer(4+t.length+1+1+i),s=new DataView(n),a=0;s.setUint16(a,1,!0),a+=2,s.setUint16(a,8+i,!0),a+=2;for(let e=0;e<t.length;e++)s.setUint8(e+a,t[e]);a+=t.length,s.setUint8(a,1),a++,s.setUint8(a,i),a++;for(let t=0;t<e.length;t++)s.setUint8(t+a,e[t]);return g.info("connectWifiReq",v(n),v(e)),n}},ScanWifiReq:class{constructor(e){this.serviceId=Ni,this.tag=0,this.showHidden=e||!1}getBytes(){return(new ye).appendUint16(this.tag,!0).appendUint16(2,!0).appendUint8(this.showHidden).appendUint8(1).build()}},RegisterReq:zi,ResetReq:class{constructor(){this.tag=65535,this.serviceId=_i}getBytes(){let e=new ArrayBuffer(6),t=new DataView(e);t.setUint8(0,241),t.setUint8(1,0),t.setUint8(2,9),t.setUint8(3,0);let i=new ArrayBuffer(2);new DataView(i).setUint8(0,9);let n=this.getA6CRC16(i),s=new DataView(n);return t.setUint8(4,s.getUint8(0)),t.setUint8(5,s.getUint8(1)),e}getA6CRC16(e){let t=65535,i=new DataView(e);for(let e=0;e<i.byteLength;e++){t^=i.getUint8(e);for(let e=0;e<8;e++)1&t?(t>>>=1,t^=40961):t>>>=1}let n=new ArrayBuffer(2);return new DataView(n).setUint16(0,t,!0),n}},A6HeartRateSetting:class{constructor(e){this.tag=4103,this.enable=e}getBytes(){let e=(new ye).appendUint16(this.tag);return e.appendUint8(this.enable?1:2),e.build()}},A6UnitSetting:class{constructor(e){this.tag=4100,this.unit=e}getBytes(){let e=(new ye).appendUint16(this.tag);return e.appendUint8(this.unit),e.build()}},ApInfo:ji,BPScaleData:$i,ConfigStatus:Qi,ScaleData:Zi,WifiInfo:Gi,WifiResetReq:class{constructor(){this.tag=4103,this.serviceId=Ni}getBytes(){return(new ye).appendUint16(this.tag,!0).appendUint16(0).build()}},WifiStatusReq:class{constructor(){this.tag=4102,this.serviceId=Ni}getBytes(){return(new ye).appendUint16(this.tag,!0).appendUint16(0).build()}}});class Ki{constructor(e,t){this.tag=3,this.userNumber=e,this.result=t}getBytes(){return(new ye).appendUint16(this.tag).appendUint8(this.userNumber).appendUint8(this.result).build()}}class Yi{constructor(e,t){this.dataType="BindResp";let i=new DataView(e);this.isSuccess=1===i.getUint8(0)}}class Xi{constructor(e,t){this.dataType="InitReq";let i=new ve(e);this.flag=i.readUint8(),1&this.flag&&(this.mtu=i.readUint8()),2&this.flag&&(this.slaveLatency=i.readUint8()),4&this.flag&&(this.supervisoryTimeout=i.readUint8())}}class en{constructor(e,t,i,n,s,a,r){this.tag=10,this.flag=e,this.mtu=n,this.slaveLatency=s,this.supervisoryTimeout=a,this.timezone=i,this.utc=t,this.timeStamp=r}getBytes(){let e=(new ye).appendUint16(this.tag).appendUint8(this.flag);return 1&this.flag&&e.appendUint8(this.mtu),2&this.flag&&e.appendUint8(this.slaveLatency),4&this.flag&&e.appendUint8(this.supervisoryTimeout),8&this.flag&&e.appendUint32(this.utc),16&this.flag&&e.appendInt8(this.timezone),32&this.flag&&this.timeStamp&&e.appendBuffer(this.timeStamp),e.build()}}class tn{constructor(e,t){this.dataType="LoginReq";let i=new ve(e);this.code=i.readBuffer(6),this.userNumber=i.readUint8(),this.battery=i.readUint8()}}class nn{constructor(e,t,i,n){this.tag=8,this.isSuccess=e,this.code=t,this.workType=i,this.platform=n}getBytes(){return(new ye).appendUint16(this.tag).appendUint8(this.isSuccess?1:0).appendBuffer(this.code).appendUint8(this.workType).appendUint8(this.platform).build()}}class sn{constructor(e,t){this.dataType="ScanStatus",this.cmd=t}}class an extends Ce{didReceiveData(e){g.debug("A6ReceiveSession",v(e.value),this.tag);let t=new DataView(e.value);if(this.checkIsFirstFrame(t))this.firstFrame=this.decodeFirstFrame(t),this.receiveBuf=this.firstFrame.buf;else{let e=this.decodeOtherFrame(t);if(this.preFrame){if(this.preFrame.index!==e.index-1)return void this.callback(U.errorCode(5,this.tag));this.preFrame=e}else this.preFrame=e;this.receiveBuf=me(this.receiveBuf,e.buf)}this.checkFinished()?this.sendAck():this.resetTimeout()}checkIsFirstFrame(e){return 0==(15&e.getUint8(0))}decodeFirstFrame(e){let t=new ve(e.buffer),i=t.readUint8()>>4&15;t.readUint8();let n=t.readUint16(),s=t.readBuffer(this.mtu-3);return this.tag=n,g.debug("cmd totalFrames",n,i),{cmd:n,totalFrames:i,buf:s}}decodeOtherFrame(e){let t=new ve(e.buffer),i=15&t.readUint8();return t.readUint8(),{index:i,buf:t.readBuffer(this.mtu-2)}}async sendAck(){try{let e=(new ye).appendUint8(0).appendUint8(1).appendUint8(1);await this.trySender(e.build(),this.sendChar)}catch(e){return g.error("sendAck error",e),void this.callback(U.errorCode(1,this.tag))}this.callback(U.errorCode(0,this.tag,this.receiveBuf))}}class rn extends Be{constructor(){super(...arguments),this.needSettingResultConfirm=!1,this.needAck=!0}didReceiveData(e){1===new DataView(e.value).getUint8(2)&&(this.needSettingResultConfirm?g.warn("需要等待设置的确认回包，不需要处理",this.tag):this.callback(U.errorCode(0,this.tag)))}didReceiveSettingConfrim(e){let t=new DataView(e),i=t.getUint16(0),n=t.getUint8(2);i===this.tag?1==n?this.callback(U.errorCode(0,this.tag)):this.callback(U.errorCode(5,this.tag)):g.warn("设置项命令不一致, 丢弃")}decodeToFrames(e){let t=this.mtu-2,i=e.byteLength;if(i<=t){let t=16,i=new ye;return i.appendUint8(t),i.appendUint8(e.byteLength),i.appendBuffer(e),[i.build()]}{let t=[],n=this.mtu-2,s=Math.ceil((i+4)/n),a=le(e),r=new ye;r.appendBuffer(e).appendUint32(a),r.build();for(let a=0;a<s;a++){let r=new ye,c=Math.min(i+4-this.mtu*a,this.mtu),o=n*a;r.appendUint8(s<<4+a),r.appendUint8(c),r.appendBuffer(e.slice(o,o+c)),t.push(r.build())}return t}}}class cn extends Re{didReceiveData(e){if("0000A625-0000-1000-8000-00805F9B34FB"==e.characteristicId)this.sendingSession?this.sendingSession.didReceiveData(e):g.warn("cValue数据丢弃",e);else if(e.characteristicId==Hi||"0000A620-0000-1000-8000-00805F9B34FB"==e.characteristicId){0==(15&new DataView(e.value).getUint8(0))?(this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender,this.receiveringSession.completion=e=>{if(this.receiveringSession&&this.receiveringSession.sid===e.sid&&(this.receiveringSession=null),4096===e.data||4352===e.data){if(this.sendingSession){let t=this.sendingSession;e&&e.value&&t.didReceiveSettingConfrim(e.value)}}else this.listener&&e.success&&this.listener(e)},this.receiveringSession.start()):this.receiveringSession&&this.receiveringSession.didReceiveData(e)}else e.characteristicId===Vi&&this.listener&&this.listener(U.errorCode(0,e.characteristicId,e.value))}}class on extends an{constructor(){super(...arguments),this.sendChar={serviceId:Pi,charId:"0000A622-0000-1000-8000-00805F9B34FB",writeType:0}}}class dn extends rn{constructor(){super(...arguments),this.sendChar={serviceId:Pi,charId:"0000A624-0000-1000-8000-00805F9B34FB",writeType:1}}}class hn extends cn{constructor(){super(...arguments),this.settings=[4098]}createSenderSession(e,t){let i=new dn(e);return i.needSettingResultConfirm=!1,i}createReceiveSession(e){return new on(e)}}class ln extends an{constructor(){super(...arguments),this.sendChar={serviceId:Oi,charId:"0000A622-0000-1000-8000-00805F9B34FB",writeType:0}}}class pn extends rn{constructor(){super(...arguments),this.sendChar={serviceId:Oi,charId:"0000A624-0000-1000-8000-00805F9B34FB",writeType:1}}}class un extends cn{constructor(){super(...arguments),this.settings=[4354]}createSenderSession(e,t){let i=new pn(e),n=!1;return this.settings&&this.settings.indexOf(t)>=0&&(n=!0),i.needSettingResultConfirm=n,i}createReceiveSession(e){return new ln(e)}}class gn extends Be{constructor(){super(...arguments),this.timeout=2e4,this.sendChar={serviceId:Ni,charId:"0000BBB0-0000-1000-8000-00805F9B34FB",writeType:1}}completionSession(e){0===e?this.callback(U.errorCode(0,this.tag)):this.callback(U.errorCode(5,this.tag))}}class fn extends Ce{didReceiveData(e){if(this.firstFrame)this.receiveBuf?this.receiveBuf=me(this.receiveBuf,e.value):this.receiveBuf=me(this.firstFrame.buf,e.value);else{let t=new DataView(e.value);this.firstFrame=this.decodeFirstFrame(t),this.receiveBuf=this.firstFrame.buf}if(this.checkFinished()){let e=this.receiveBuf.slice(this.firstFrame.len,this.receiveBuf.byteLength);g.debug("rest",v(e)),this.callback(U.errorCode(0,this.tag,this.receiveBuf.slice(0,this.firstFrame.len),e))}else this.resetTimeout()}decodeFirstFrame(e){let t=new ve(e.buffer),i=t.readUint16(!0),n=t.readUint16(!0),s=t.readBuffer(e.buffer.byteLength-4);return this.tag=i,g.debug("firstFrame",i,n,v(s)),{cmd:i,len:n,buf:s}}}class mn extends Re{constructor(){super(),this.mtu=20}didReceiveData(e){if(this.receiveringSession)this.receiveringSession.didReceiveData(e);else{let t=e.value;this.restBuffer&&this.restBuffer.byteLength>0&&(t=me(this.restBuffer,t),g.debug("上次剩余 ",v(this.restBuffer))),this.receiveringSession=this.createReceiveSession(t),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender,this.receiveringSession.completion=e=>{this.receiveringSession&&(this.receiveringSession=null),e.success&&this.handler(e)},this.receiveringSession.start()}}handler(e){try{let t=e.data,i=new ve(e.value);switch(e.data){case 4096:for(this.restBuffer=e.extra,g.debug("剩余 ",v(this.restBuffer)),this.listener(U.errorCode(0,t,e.value));this.restBuffer&&this.restBuffer.byteLength>4;){let e=new ve(this.restBuffer),t=e.readUint16(!0),i=e.readUint16(!0);if(!(i<this.restBuffer.byteLength-4))break;this.restBuffer=this.restBuffer.slice(4+i),this.listener(U.errorCode(0,t,e.readBuffer(i)))}return;case 4097:return this.restBuffer=null,void this.listener(U.errorCode(0,t));case 4098:return this.completionSession(1,i.readUint8()),i.index=4,void this.listener(U.errorCode(0,t,e.value));case 4099:return this.restBuffer=null,void this.completionSession(4098,i.readUint8());case 4100:return void this.completionSession(3,i.readUint8());case 4101:case 4102:case 4352:return void g.warn("未处理",t);case 1007:let n=i.readUint8();return this.completionSession(6,i.readUint8()),void(0===n&&(i.index=4,this.listener(U.errorCode(0,t,e.value))));case 1008:return this.restBuffer=null,void this.completionSession(7,i.readUint8())}}catch(t){g.warn("数据处理有问题",e)}}completionSession(e,t){if(this.sendingSession){let i=this.sendingSession;i.tag===e?i.completionSession(t):g.warn("cmd 不一致丢弃",i.tag,e)}}createSenderSession(e,t){let i=new gn(e);return i.needAck=0!==t,i}createReceiveSession(e){return new fn(e)}}class Un extends Be{constructor(){super(...arguments),this.sendChar={serviceId:_i,charId:"00001881-0000-1000-8000-00805F9B34FB",writeType:1}}}class wn extends Re{createSenderSession(e,t){return new Un(e)}}class vn extends Be{constructor(){super(...arguments),this.sendChar={serviceId:Wi,charId:"00001531-1212-EFDE-1523-785FEABCD123",writeType:0},this.sendPackageChar={serviceId:Wi,charId:"00001532-1212-EFDE-1523-785FEABCD123",writeType:0},this.numberOfpacket=6,this.tag=255}async start(){this.sendOpCode(1)}didReceiveData(e){let t=new ve(e.value),i=t.readUint8();if(17===i){let e=t.readUint32(!0);this.currentBinInfo.sendOffset=e;let i=this.otaParse.getUpgradeProgress(this.currentBinInfo.sendOffset);this.otaParse.onUpgradeProcess&&this.otaParse.onUpgradeProcess(100*i),this.currentBinInfo.sendOffset<this.currentBinInfo.frameSize&&this.sendPackage()}else if(16===i){let e=t.readUint8();if(1!=t.readUint8())return void this.callback(U.errorCode(5,this.tag));switch(e){case 1:this.sendOpCode(8);break;case 3:this.otaParse.addDoneSize(this.currentBinInfo.frameSize),this.sendOpCode(4);break;case 4:this.sendOpCode(1)}}}callback(e){this.timeoutId&&clearTimeout(this.timeoutId),this.completion&&(this.otaParse.onUpgradeComplete&&this.otaParse.onUpgradeComplete(e.code,e.msg),this.completion(e),this.completion=null)}async sendStartBin(){if(this.currentBinInfo=this.otaParse.getNextBinInfo(),this.currentBinInfo){let e=(new ye).appendUint8(1).appendUint8(this.currentBinInfo.code).build();await this.trySender(e,this.sendChar),await O(1),this.sendImageSize()}else this.sendOpCode(5),this.callback(U.errorCode(0,this.tag))}async sendImageSize(){let e=this.currentBinInfo,t=new ArrayBuffer(14),i=new DataView(t),n=0;i.setUint32(n,e.upgradeFileSize,!0),n+=4;let s=this.otaParse.model;for(let e=s.length;e<8;e++)s+=" ";s=s.substring(0,8);let a=I(s),r=new DataView(a);for(let e=0;e<4;e++)i.setUint8(e+n,r[e]);n+=4;let c=new DataView(e.version);for(let e=0;e<4;e++)i.setUint8(e+n,c.getUint8(e));n+=4,i.setUint16(n,e.crcBuffer,!0),n+=2,await this.trySender(t,this.sendPackageChar),this.resetTimeout()}async sendOpCode(e){switch(e){case 1:await this.sendStartBin();break;case 8:await this.receiptNotificationReq(),await this.sendOpCode(3),this.sendPackage();break;default:let t=(new ye).appendUint8(e).build();await this.trySender(t,this.sendChar)}}receiptNotificationReq(){let e=(new ye).appendUint8(8).appendUint16(this.numberOfpacket,!0).build();return this.trySender(e,this.sendChar)}async sendPackage(){let e=this.currentBinInfo.sendOffset;for(let t=e;t<e+this.numberOfpacket;t++){let e=this.currentBinInfo.imageList[t];e&&(this.currentBinInfo.sendOffset+=1,await this.trySender(e,this.sendPackageChar))}this.currentBinInfo.sendOffset+=e,this.resetTimeout()}}class yn extends Re{didReceiveData(e){this.sendingSession&&this.sendingSession.didReceiveData(e)}createSenderSession(e,t,i){let n=new vn(e);return n.otaParse=t,n}}const Sn=[{binInfoOffset:32,code:4},{binInfoOffset:64,code:8},{binInfoOffset:96,code:9}];class bn{constructor(e){this.onUpgradeComplete=e.onUpgradeComplete,this.onUpgradeProcess=e.onUpgradeProcess,this.model=e.model;let t=e.fileBuffer;this.binIndex=-1,this.doneFrameSize=0;let i=new DataView(t),n=0,s=t.slice(n,n+4);n+=4;let a=t.slice(n,n+4);n+=4;let r=i.getUint32(n,!1);n+=4;let c=i.getUint32(n,!1);n+=4;let o=t.slice(n,n+16),d=0,h=[];for(let e=0;e<Sn.length;e++){let i=this.createBinInfo(t,Sn[e]);i&&(h.push(i),d+=i.upgradeFileSize)}this.magic=s,this.version=a,this.size=r,this.binWithCrc12Size=d,this.binInfoList=h,this.md5=o,this.binWithCrc12FrameSize=d/20,g.info(`OTA总大小:${r} binWithCrc12Size${d} version:${v(a)} utc:${c} binInfoList size:${h.length}`)}addDoneSize(e){this.doneFrameSize+=e}getNextBinInfo(){return this.binIndex++,g.info("获取下一个固件包",this.binIndex),this.binInfoList[this.binIndex]}getUpgradeProgress(e){return(this.doneFrameSize+e)/this.binWithCrc12FrameSize}createBinInfo(e,t){let i=t.binInfoOffset,n=t.code,s=new DataView(e),a=e.slice(i,i+4),r=s.getUint32(i+4,!1),c=s.getUint32(i+8,!1);if(0===c||0===r)return g.info(`固件类型:${n} 无数据 `),null;let o=s.getUint32(i+12,!1);e.slice(i+12,i+12+4);let d=e.slice(i+16,i+16+1),h=e.slice(c,c+r),l=new ArrayBuffer(4);new DataView(l).setUint32(0,o,!0);let p=function(e,t){let i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i.buffer}(h,l);g.log("crc16小端"+v(l));let u=p.byteLength,f=[],m=0;for(;m<u-20;)f.push(p.slice(m,m+=20));u!==m&&f.push(p.slice(m,u));let U={imageList:f,upgradeFileSize:h.byteLength,sendOffset:0,frameSize:f.length,crcBuffer:o,version:a,md5:d,code:n,buf:p};return g.log(`固件类型:${n} 大小(包括crc4字节):${U.upgradeFileSize} 地址：${c}  crc:${o} frameSize: ${f.length}`),U}}class In{constructor(e,t=1){this.tag=18433,this.userNumber=e,this.result=t}getBytes(){return(new ye).appendUint16(this.tag).appendUint8(this.userNumber).appendUint8(this.result).build()}}class Dn extends In{constructor(){super(...arguments),this.tag=18433}}class Tn extends In{constructor(){super(...arguments),this.tag=18689}}var Bn=[{name:"EnableCharacteristic",serviceId:Pi,characteristicId:Hi,actionType:2,await:{timeout:1e3,onTimeout:e=>!0,didReceive(e,t){if("InitReq"===e.dataType){let i=e;return t.initReq=i,U.success()}return!0}}},{name:"InitResp",actionType:1,pushData:e=>new en(24,x(),L()),await:{timeout:1e3,onTimeout:e=>!0,didReceive(e,t){if("LoginReq"===e.dataType){let i=e;return t.loginReq=i,t.userNumber=i.userNumber,U.success()}return!0}}},{name:"LoginResp",actionType:1,when:e=>e.deviceInfo.isRegister,pushData:e=>new nn(!0,e.loginReq.code,0,T()?1:2),await:{timeout:1e3,onTimeout:e=>!0,didReceive(e,t){if("InitReq"===e.dataType){let i=e;return t.initReq=i,U.success()}return!0}}},{name:"InitResp",actionType:1,pushData:e=>new en(24,x(),L())},{name:"SyncData",actionType:1,pushData:e=>new Dn(e.userNumber)},{name:"EnableCharacteristic",serviceId:B("AAAA"),characteristicId:B("BBB1"),actionType:2,when:e=>!!e.client.serviceMap.get(B("AAAA"))},{name:"获取电量",actionType:4,serviceId:Pi,characteristicId:Vi,await:{didReceive:(e,t)=>"Battery"!==e.dataType||U.success()}}];class Cn{constructor(e,t,i){if(this.dataType="Battery",this.cmd=t,e.byteLength>=1){let t=new DataView(e);this.battery=t.getUint8(0),i.battery=this.battery}}}class Rn{constructor(e,t,i,n){this.tag=4098,this.flag=e,this.utc=t,this.timezone=i,n&&(this.timeStamp=n)}getBytes(){let e=(new ye).appendUint16(this.tag).appendUint8(this.flag);return(1&this.flag)>0&&e.appendUint32(this.utc),(2&this.flag)>0&&e.appendUint8(this.timezone),(4&this.flag)>0&&e.appendBuffer(this.timeStamp),e.build()}}class An extends Rn{constructor(){super(...arguments),this.tag=4098}}class kn extends Rn{constructor(){super(...arguments),this.tag=4354}}var Fn=[{name:"EnableCharacteristic",serviceId:Oi,characteristicId:B("A621"),actionType:2,when:e=>e.deviceInfo.isRegister,await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;t.loginReq=i;let n=t.deviceInfo.mac,s=pe(i.code,ue(n));return t.deviceInfo.updateDeviceId(s),t.userNumber=i.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(s),U.success()}}}},{name:"LoginResp",actionType:1,pushData:e=>new nn(!0,e.loginReq.code,0,T()?1:2)},{name:"SyncTime",actionType:1,pushData:e=>new kn(1,M())},{name:"SyncData",actionType:1,pushData:e=>new Tn(e.userNumber)},{name:"获取电量",actionType:4,serviceId:Oi,characteristicId:Vi,await:{didReceive:(e,t)=>"Battery"!==e.dataType||U.success()}}];var xn=[{name:"DisableCharacteristic",serviceId:B("A602"),characteristicId:B("A621"),actionType:3},{name:"EnableCharacteristic",serviceId:B("A602"),characteristicId:B("A620"),actionType:2},{name:"EnableCharacteristic",serviceId:B("A602"),characteristicId:B("A625"),actionType:2},{name:"EnableCharacteristic",serviceId:B("A602"),characteristicId:B("A621"),actionType:2,when:e=>!e.deviceInfo.isRegister},{name:"RegisterReq",actionType:1,when:e=>!e.deviceInfo.isRegister,async pushData(e){await O(300);let t=await e.listeners.onApplyRegisterId({...e});g.info("申请registerId",t);let i=new zi(t);return e.deviceInfo.updateDeviceId(t),i},await:{timeout:15e3,didReceive(e,t){if("RegisterResp"===e.dataType){return e.isSuccess?U.success():U.errorCode(5)}return!0}}},{name:"WaitLoginReq",when:e=>!e.deviceInfo.isRegister,actionType:0,await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;t.loginReq=i;let n=t.deviceInfo.mac,s=pe(i.code,ue(n));return t.deviceInfo.updateDeviceId(s),t.deviceInfo.battery=i.battery,t.userNumber=i.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(s),U.success()}return!0}}},{name:"EnableCharacteristic",serviceId:B("A602"),characteristicId:B("A621"),actionType:2,when:e=>e.deviceInfo.isRegister,await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;t.loginReq=i;let n=t.deviceInfo.mac,s=pe(i.code,ue(n));return t.deviceInfo.updateDeviceId(s),t.deviceInfo.battery=i.battery,t.userNumber=i.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(s),U.success()}return!0}}},{name:"LoginResp",actionType:1,pushData(e){e.deviceInfo.isRegister=!0;return new nn(!0,e.loginReq.code,1,T()?1:2)}},{name:"syncTime",actionType:1,pushData:e=>new An(1,x())},{name:"BindResult",actionType:1,pushData:e=>new Ki(1,1),await:{didReceive(e,t){if("BindResp"===e.dataType){return e.isSuccess?U.success():U.errorCode(5)}return!0}}}],Mn=[{name:"DisableCharacteristic",serviceId:B("A602"),characteristicId:B("A621"),actionType:3},{name:"EnableCharacteristic",serviceId:B("A602"),characteristicId:B("A620"),actionType:2},{name:"EnableCharacteristic",serviceId:B("A602"),characteristicId:B("A625"),actionType:2},{name:"EnableCharacteristic",serviceId:B("AAAA"),characteristicId:B("BBB1"),actionType:2,when:e=>!!e.client.serviceMap.get(B("AAAA"))},{name:"未注册使能",serviceId:B("A602"),characteristicId:B("A621"),actionType:2,when:e=>!e.deviceInfo.isRegister},{name:"RegisterReq",actionType:1,when:e=>!e.deviceInfo.isRegister,async pushData(e){if(await O(300),e.listeners.onApplyRegisterId){let t=await e.listeners.onApplyRegisterId({...e});g.info("申请registerId",t);let i=new zi(t);return e.deviceInfo.updateDeviceId(t),i}return Promise.reject(U.errorCode(25))},await:{timeout:15e3,didReceive(e,t){if("RegisterResp"===e.dataType){return e.isSuccess?U.success():U.errorCode(5)}return!0}}},{name:"WaitLoginReq",when:e=>!e.deviceInfo.isRegister,actionType:0,await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;t.loginReq=i;let n=t.deviceInfo.mac,s=pe(i.code,ue(n));return t.deviceInfo.updateDeviceId(s),t.deviceInfo.battery=i.battery,t.userNumber=i.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(s),U.success()}return!0}}},{name:"EnableCharacteristic",serviceId:B("A602"),characteristicId:B("A621"),actionType:2,when:e=>e.deviceInfo.isRegister,await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;t.loginReq=i;let n=t.deviceInfo.mac,s=pe(i.code,ue(n));return t.deviceInfo.updateDeviceId(s),t.userNumber=i.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(s),U.success()}return!0}}},{name:"LoginResp",actionType:1,when:e=>e.deviceInfo.isRegister,pushData:e=>(e.deviceInfo.isRegister=!0,new nn(!0,e.loginReq.code,0,T()?1:2)),await:{dataType:"InitReq",didReceive(e,t){if("InitReq"===e.dataType){let i=e;return t.initReq=i,U.success()}}}},{name:"InitResp",actionType:1,pushData:e=>new en(24,x(),L())},{name:"SyncData",actionType:1,pushData:e=>new Dn(e.userNumber)},{name:"获取电量",actionType:4,serviceId:Pi,characteristicId:Vi,await:{didReceive:(e,t)=>"Battery"!==e.dataType||U.success()}}],Ln=[{name:"DisableCharacteristic",serviceId:B("A610"),characteristicId:B("A621"),actionType:3},{name:"EnableCharacteristic",serviceId:B("A610"),characteristicId:B("A620"),actionType:2},{name:"EnableCharacteristic",serviceId:B("A610"),characteristicId:B("A625"),actionType:2},{name:"EnableCharacteristic",serviceId:B("A610"),characteristicId:B("A621"),actionType:2,when:e=>!e.deviceInfo.isRegister},{name:"RegisterReq",actionType:1,when:e=>!e.deviceInfo.isRegister,async pushData(e){await O(300);let t=await e.listeners.onApplyRegisterId({...e});g.info("申请registerId",t);let i=new zi(t);return e.deviceInfo.updateDeviceId(t),i},await:{dataType:"RegisterResp",timeout:15e3,didReceive(e,t){if("RegisterResp"===e.dataType){return e.isSuccess?U.success():U.errorCode(5)}return!0}}},{name:"WaitLoginReq",when:e=>!e.deviceInfo.isRegister,actionType:0,await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;t.loginReq=i;let n=t.deviceInfo.mac,s=pe(i.code,ue(n));return t.deviceInfo.updateDeviceId(s),t.userNumber=i.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(s),U.success()}return!0}}},{name:"EnableCharacteristic",serviceId:B("A610"),characteristicId:B("A621"),actionType:2,when:e=>e.deviceInfo.isRegister,await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;t.loginReq=i;let n=t.deviceInfo.mac,s=pe(i.code,ue(n));return t.deviceInfo.updateDeviceId(s),t.deviceInfo.battery=i.battery,t.userNumber=i.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(s),U.success()}return!0}}},{name:"LoginResp",actionType:1,pushData:e=>(e.deviceInfo.isRegister=!0,new nn(!0,e.loginReq.code,1,T()?1:2))},{name:"SyncTime",actionType:1,pushData:e=>new kn(1,M())},{name:"BindResult",actionType:1,pushData:e=>new Ki(1,1),await:{dataType:"BindResp",didReceive(e,t){if("BindResp"===e.dataType){return e.isSuccess?U.success():U.errorCode(5)}return!0}}}],En=[{name:"DisableCharacteristic",serviceId:Oi,characteristicId:B("A621"),actionType:3},{name:"EnableCharacteristic",serviceId:Oi,characteristicId:B("A620"),actionType:2},{name:"EnableCharacteristic",serviceId:Oi,characteristicId:B("A625"),actionType:2},{name:"EnableCharacteristic",serviceId:Oi,characteristicId:B("A621"),actionType:2,when:e=>e.deviceInfo.isRegister,await:{dataType:"LoginReq",didReceive(e,t){if("LoginReq"===e.dataType){let i=e;t.loginReq=i;let n=t.deviceInfo.mac,s=pe(i.code,ue(n));return t.deviceInfo.updateDeviceId(s),t.userNumber=i.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(s),U.success()}}}},{name:"LoginResp",actionType:1,pushData:e=>new nn(!0,e.loginReq.code,0,T()?1:2)},{name:"SyncTime",actionType:1,pushData:e=>new kn(1,M())},{name:"SyncData",actionType:1,pushData:e=>new Tn(e.userNumber)},{name:"获取电量",actionType:4,serviceId:Oi,characteristicId:Vi,await:{didReceive:(e,t)=>"Battery"!==e.dataType||U.success()}}];const Pn="0000FFD0-0000-1000-8000-00805F9B34FB";function On(e,...t){let i=0;if(e){let t=new DataView(e);for(let e=0;e<t.byteLength;e++)i+=t.getUint8(e)}if(t)for(let e=0;e<t.length;e++)i+=t[e];return 65535&i}class Hn{constructor(e,t){this.tag=128,this.utc=e,this.timezone=t}getBytes(){return(new ye).appendUint32(this.utc,!0).appendInt16(this.timezone,!0).build()}}var Vn=[{name:"EnableCharacteristic",serviceId:Pn,characteristicId:"0000FFD2-0000-1000-8000-00805F9B34FB",actionType:2},{name:"SyncTime",actionType:1,pushData(e){let t=x(),i=E();return new Hn(t,i)}}],Nn=[{name:"EnableCharacteristic",serviceId:Pn,characteristicId:"0000FFD2-0000-1000-8000-00805F9B34FB",actionType:2},{name:"SyncTime",actionType:1,pushData(e){let t=x(),i=E();return new Hn(t,i)}}];class _n{constructor(e,t,i){this.dataType="JumpRealtime",this.cmd=t;let n=new ve(e);n.getUint8("jumpMode").getUint16("settingContent",!0).getUint16("duration",!0).getUint16("count",!0).getUint8("groupCount").getUint8("battery"),e.byteLength>=11&&n.getUint16("validDuration",!0),n.build(this),this.freq=i?Math.max(0,60*(this.count-i.count)):0}}class Wn{constructor(e,t){this.dataType="",this.dataType=2===t?"JumpResultData":"JumpHistoryData";let i=new ve(e);i.getUint32("utc",!0).getUint8("jumpMode").getUint16("settingContent",!0).getUint16("duration",!0).getUint16("count",!0).getUint16("avgFreq",!0).getUint16("maxFreq",!0).getUint16("maxContinueCount",!0).getUint8("groupCount").build(this);let n=this.groupCount,s=[];for(let e=0;e<n+1;e++){let e=i.readUint16(!0),t=i.readUint16(!0);s.push({time:e,count:t})}this.list=s}}class zn extends Ce{constructor(){super(...arguments),this.sendChar={serviceId:Pn,charId:"0000FFD1-0000-1000-8000-00805F9B34FB",writeType:0}}didReceiveData(e){let t=new DataView(e.value);if(this.checkIsFirstFrame(t))this.firstFrame=this.decodeFirstFrame(t),this.receiveBuf=this.firstFrame.buf;else{this.resetTimeout();let e=this.decodeOtherFrame(t);if(this.preFrame){if(this.preFrame.index!==e.index-1)return void this.callback(U.errorCode(5,this.tag));this.preFrame=e}else this.preFrame=e;if(this.receiveBuf){let t=this.receiveBuf.byteLength+e.buf.byteLength;this.receiveBuf=function(e,t){let i=new ArrayBuffer(t),n=new DataView(i),s=0;return e.forEach((e=>{let i=new DataView(e);for(let a=0;a<e.byteLength&&s<t;a++)n.setUint8(s,i.getUint8(a)),s++})),i}([this.receiveBuf,e.buf],t)}else this.callback(U.errorCode(5,this.tag))}if(this.checkFinished()){if(1===this.tag)return void this.callback(U.errorCode(0,this.tag,this.receiveBuf));this.sendAck()}}checkIsFirstFrame(e){return 252===e.getUint8(0)}decodeFirstFrame(e){let t=new ve(e.buffer),i=t.readUint8(),n=t.readUint8(),s=t.readUint16(!0),a=t.readUint8(),r=t.readUint16(!0),c=t.readBuffer(this.mtu-7);return this.tag=a,{header:i,protoVersion:n,checkCode:s,cmd:a,len:r,buf:c}}decodeOtherFrame(e){let t=new ve(e.buffer);return{index:t.readUint8(),buf:t.readBuffer(this.mtu-1)}}async sendAck(){try{new ArrayBuffer(8);let e=On(null,this.tag,1),t=(new ye).appendUint8(252).appendUint8(160).appendUint16(e,!0).appendInt8(this.tag).appendUint16(1,!0).appendUint8(0);await this.trySender(t.build(),this.sendChar)}catch(e){return void this.callback(U.errorCode(1,this.tag))}this.callback(U.errorCode(0,this.tag,this.receiveBuf))}}class qn extends Be{constructor(){super(...arguments),this.sendChar={serviceId:Pn,charId:"0000FFD1-0000-1000-8000-00805F9B34FB",writeType:0}}decodeToFrames(e){let t=this.mtu-7,i=e.byteLength,n=On(e,this.tag,i),s=new ye;if(s.appendUint8(252),s.appendUint8(160),s.appendUint16(n,!0),s.appendUint8(this.tag),s.appendUint16(e.byteLength,!0),i<=t)return s.appendBuffer(e),[s.build()];{s.appendBuffer(e.slice(0,t));let n=[];n.push(s.build());let a=this.mtu-1,r=Math.ceil((i-t)/a);for(let i=0;i<r;i++){let s=new ye,r=t+a*i;s.appendUint8(i+1),s.appendBuffer(e.slice(r,r+a)),n.push(s.build())}return n}}}class jn extends Re{constructor(){super(...arguments),this.filterServiceIds=[Pn]}didReceiveData(e){252===new DataView(e.value).getUint8(0)?(this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender,this.receiveringSession.completion=e=>{this.receiveringSession&&this.receiveringSession.sid===e.sid&&(this.receiveringSession=null),this.listener&&e.success&&this.listener(e)},this.receiveringSession.start()):this.receiveringSession&&this.receiveringSession.didReceiveData(e)}createSenderSession(e){return new qn(e)}createReceiveSession(e){return new zn(e)}}class $n extends Be{constructor(){super(...arguments),this.sendChar={serviceId:"00005630-55AA-EFDE-2323-985FEABCD512",charId:"00005631-55AA-EFDE-2323-985FEABCD512",writeType:0},this.sendPackageChar={serviceId:"00005630-55AA-EFDE-2323-985FEABCD512",charId:"00005632-55AA-EFDE-2323-985FEABCD512",writeType:0},this.numberOfpacket=10,this.tag=255,this.sendOffset=0}async start(){this.sendOpCode(1)}didReceiveData(e){let t=new ve(e.value),i=t.readUint8();if(17===i){let e=t.readUint32(!0),i=e/this.otaParse.buf.byteLength;this.otaParse.onUpgradeProcess&&this.otaParse.onUpgradeProcess(100*i),this.sendOffset=e,e<this.otaParse.buf.byteLength&&this.sendPackage()}else if(16===i){let e=t.readUint8();if(1!=t.readUint8())return void this.callback(U.errorCode(5,this.tag));switch(e){case 1:this.sendOpCode(2);break;case 2:this.sendOpCode(8);break;case 3:this.sendOpCode(4);break;case 4:this.sendOpCode(5),this.callback(U.errorCode(0,this.tag))}}}callback(e){this.timeoutId&&clearTimeout(this.timeoutId),this.completion&&(this.otaParse.onUpgradeComplete&&this.otaParse.onUpgradeComplete(e.code,e.msg),this.completion(e),this.completion=null)}async sendStartBin(){let e=(new ye).appendUint8(1).appendUint8(4).build();await this.trySender(e,this.sendChar),await O(.5),this.sendImageSize()}async sendImageSize(){let e=(new ye).appendUint32(0).appendUint32(0).appendUint32(this.otaParse.buf.byteLength,!0).build();await this.trySender(e,this.sendPackageChar),this.resetTimeout()}async sendHeader(){let e=(new ye).appendInt8(2).appendUint8(0).build();await this.trySender(e,this.sendChar);let t=(new ye).appendUint16(this.otaParse.deviceType,!0).appendUint16(this.otaParse.projectNumber,!0).appendUint32(this.otaParse.version,!0).appendUint16(this.otaParse.softVersion,!0).appendUint16(this.otaParse.supportSoftDevice,!0).appendUint16(this.otaParse.firmwareCrc16,!0).build();await this.trySender(t,this.sendPackageChar);let i=(new ye).appendInt8(2).appendUint8(1).build();this.trySender(i,this.sendChar)}async sendOpCode(e){switch(e){case 1:await this.sendStartBin();break;case 2:await this.sendHeader();break;case 8:await this.receiptNotificationReq(),await this.sendOpCode(3),this.sendPackage();break;default:let t=(new ye).appendUint8(e).build();await this.trySender(t,this.sendChar)}}receiptNotificationReq(){let e=(new ye).appendUint8(8).appendUint16(this.numberOfpacket,!0).build();return this.trySender(e,this.sendChar)}async sendPackage(){let e=this.sendOffset,t=this.otaParse.buf.byteLength;for(let i=0;i<this.numberOfpacket;i++){let i=Math.min(t-e,this.mtu);if(i<=0)return;let n=this.otaParse.buf.slice(e,e+i);e+=i,await this.trySender(n,this.sendPackageChar)}this.resetTimeout()}}class Qn extends Re{didReceiveData(e){this.sendingSession&&this.sendingSession.didReceiveData(e)}createSenderSession(e,t,i){let n=new $n(e);return n.otaParse=t,n}}var Zn=[{name:"EnableCharacteristic",serviceId:B("FF00"),characteristicId:B("FF01"),actionType:2},{name:"SendVerifyCode",actionType:1,pushData:e=>({getBytes:e=>(new ye).appendUint8(163).appendUint8(159).appendUint8(220).appendUint8(231).appendUint8(87).appendUint8(140).appendUint8(86).appendUint8(153).appendUint8(36).appendUint8(170).appendUint8(210).appendUint8(175).appendUint8(250).appendUint8(147).appendUint8(60).appendUint8(158).appendUint8(15).build()}),await:{didReceive(e,t){if("VerifyCode"==e.dataType){return e?U.success():U.errorCode(11)}return!0}}},{name:"ResuestBind",actionType:1,pushData:e=>({getBytes(e){let t=new ye;return t.appendUint8(1),t.build()}}),await:{timeout:3e4,didReceive(e,t){if("Bind"==e.dataType){return e?U.success():U.errorCode(11)}return!0}}},{name:"BindCallback",actionType:1,pushData:e=>({getBytes(e){let t=new ye;return t.appendUint8(3),t.build()}}),await:{didReceive(e,t){if("DeviceInfo"==e.dataType){let i=e;return t.deviceInfo.battery=i.battery,t.deviceInfo.firmwareVersion=i.version+"",U.success()}return!0}}},{name:"SyncTime",actionType:1,pushData:e=>({getBytes(e){let t=new ye;return t.appendUint8(5),t.appendUint32((new Date).getTime()/1e3),t.build()}})},{name:"Reset1",actionType:1,pushData:e=>({getBytes:e=>(new ye).appendUint8(48).appendUint8(1).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).build()}),await:{didReceive:(e,t)=>49!==e.cmd||U.errorCode(0,e)}},{name:"Reset2",actionType:1,pushData:e=>({getBytes:e=>(new ye).appendUint8(48).appendUint8(2).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).build()}),await:{didReceive:(e,t)=>49!==e.cmd||U.errorCode(0,e)}},{name:"Reset3",actionType:1,pushData:e=>({getBytes:e=>(new ye).appendUint8(48).appendUint8(3).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).build()}),await:{didReceive:(e,t)=>49!==e.cmd||U.errorCode(0,e)}},{name:"Reset4",actionType:1,pushData:e=>({getBytes:e=>(new ye).appendUint8(48).appendUint8(4).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).appendUint8(0).build()}),await:{didReceive:(e,t)=>49!==e.cmd||U.errorCode(0,e)}}],Gn=[{name:"EnableCharacteristic",serviceId:B("FF00"),characteristicId:B("FF01"),actionType:2},{name:"SendVerifyCode",actionType:1,pushData:e=>({getBytes:e=>(new ye).appendUint8(163).appendUint8(159).appendUint8(220).appendUint8(231).appendUint8(87).appendUint8(140).appendUint8(86).appendUint8(153).appendUint8(36).appendUint8(170).appendUint8(210).appendUint8(175).appendUint8(250).appendUint8(147).appendUint8(60).appendUint8(158).appendUint8(15).build()}),await:{didReceive(e,t){if("VerifyCode"==e.dataType){return e?U.success():U.errorCode(11)}return!0}}},{name:"BindCallback",actionType:1,pushData:e=>({getBytes(e){let t=new ye;return t.appendUint8(3),t.build()}}),await:{didReceive(e,t){if("DeviceInfo"==e.dataType){let i=e;return t.deviceInfo.battery=i.battery,t.deviceInfo.firmwareVersion=i.version+"",U.success()}return!0}}},{name:"SyncTime",actionType:1,pushData:e=>({getBytes(e){let t=new ye;return t.appendUint8(5),t.appendUint32((new Date).getTime()/1e3),t.build()}})}];class Jn{constructor(e,t){this.dataType="VerifyCode",this.cmd=t;let i=new ve(e);this.result=176==i.readUint8()}}class Kn{constructor(e,t){this.dataType="Bind",this.cmd=t;let i=new ve(e);this.result=1==i.readUint8()}}class Yn extends Ce{constructor(){super(...arguments),this.sendChar={serviceId:B("FF00"),charId:B("FF01"),writeType:0}}didReceiveData(e){this.receiveBuf=e.value;let t=new DataView(e.value),i=new ve(t.buffer);if(7==i.readUint8()){let e=i.readUint8();this.tag=i.readUint8(),this.receiveBuf=i.readBuffer(e-1),this.callback(U.errorCode(0,this.tag,this.receiveBuf))}}}class Xn extends Be{constructor(){super(...arguments),this.sendChar={serviceId:B("FF00"),charId:B("FF02"),writeType:0}}decodeToFrames(e){let t=e.byteLength,i=new ye;i.appendUint8(7),i.appendUint8(t),i.appendBuffer(e);let n=i.build(),s=this.sumCode(n);return i=new ye,i.appendBuffer(n),i.appendUint8(s),[i.build()]}sumCode(e){let t=0;if(e){let i=new DataView(e);for(let e=0;e<i.byteLength;e++)t=i.getUint8(e)+t&255}return t=1+~t&255,t}}class es extends Re{didReceiveData(e){this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender,this.receiveringSession.completion=e=>{this.listener&&e.success&&this.listener(e)},this.receiveringSession.start()}createSenderSession(e){return new Xn(e)}createReceiveSession(e){return new Yn(e)}}class ts{constructor(e,t){this.dataType="FindBox",this.cmd=t,this.result=!0}}class is{constructor(e,t){this.dataType="BoxTiming",this.cmd=t;let i=new ve(e);this.result=1==i.readUint8()}}class ns{constructor(e,t){this.dataType="DeviceInfo",this.cmd=t;let i=new ve(e);this.battery=i.readUint8(),this.version=i.readUint16(),this.magic=i.readBuffer(8)}}class ss{constructor(e,t){this.dataType="SyncBoxData",this.boxDatas=[],this.dataIndex=0,this.size=0,this.finish=!1,this.parseData(e,t)}parseData(e,t){this.cmd=t;let i=new ve(e),n={},s=i.readUint8();this.size=s,console.log("size:"+this.size),n.size=this.size,n.status=i.readUint8(),n.utc=i.readInt32(),n.cellIndex=i.readUint8(),this.boxDatas.length<this.size&&this.boxDatas.push(n)}isFull(){return this.size==this.boxDatas.length}}class as{constructor(){this.tag=10}getBytes(){return(new ye).appendUint8(this.tag).build()}}class rs{constructor(e){this.priority=1001,this.syncData=null,this.dialPushSetting=e,this.actions=this.syncActions()}syncActions(){let e=this;return[{name:"同步数据",actionType:1,pushData:t=>(console.log("同步数据"),e.dialPushSetting),await:{didReceive(t,i){if(console.log("full"+t),50===t.cmd){let i=t;return!i.isFull()||(e.syncData=i,e.responseData=U.errorCode(0,t),e.responseData)}return!0}}},{when:t=>0!=e.syncData.size,name:"同步数据接受完成反馈",actionType:1,pushData:t=>({getBytes:t=>(console.log("同步数据接受完成反馈"),(new ye).appendUint8(11).appendUint8(e.syncData.size).build())})}]}}class cs{constructor(e){this.priority=1001,this.dialPushSetting=e,this.actions=this.syncActions()}syncActions(){let e=this,t=[];return this.dialPushSetting.times.length>0?this.dialPushSetting.times.forEach(((i,n)=>{t.push({name:"药盒定时"+n,actionType:1,pushData:t=>({getBytes(t){let s=new ye;s.appendBuffer(e.dialPushSetting.getBytes()),s.appendUint8(n+1);let a=60*i.hour*60+60*i.min+i.sec;if(s.appendUint8(a/65536),s.appendUint8(a%65536/256),s.appendUint8(a%256),0==e.dialPushSetting.mode){let e=0;i.weeks.forEach((t=>{e|=t})),s.appendUint8(e)}else{let t=128|127&e.dialPushSetting.interval;s.appendUint8(t)}return s.build()}}),await:{didReceive:(t,i)=>49!==t.cmd||(console.log("index:"+n+"length"+e.dialPushSetting.times.length),n==e.dialPushSetting.times.length-1?(e.responseData=U.errorCode(0,t),e.responseData):U.errorCode(0,t))}})})):t.push({name:"取消定时",actionType:1,pushData:t=>({getBytes(t){let i=new ye;return i.appendBuffer(e.dialPushSetting.getBytes()),i.appendUint8(0),i.appendUint8(0),i.appendUint8(0),i.appendUint8(0),i.appendUint8(0),i.build()}}),await:{didReceive:(e,t)=>49!==e.cmd||U.errorCode(0,e)}}),t}}let os=new class{constructor(){this.normalParser=new Ue}parseAdvertisementData(e,t){let i,n=e.name,s=t.localName,a=e.deviceId,r=t.advertisData;if(r&&r.byteLength>=6){let e=r.byteLength;i=ge(r.slice(e-6,e)).toUpperCase()}return{name:n,localName:s,deviceId:a,manufacturerData:r,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:i,isSystemPaired:!1,timestamp:new Date,isRegister:!0}}parseDeviceInfo(e,t){let i=this.normalParser.parseDeviceInfo(e,t);if(i.model&&-1!=i.model.indexOf("LS-405")){let e=ue(i.mac);e=fe(e),i.mac=ge(e)}return i.softwareVersion&&(i.softwareVersion=i.softwareVersion.substring(0,4)),i}},ds=new re(Pe,"A5",{protocolType:0,actions:Li},{protocolType:1,actions:Ei},os,new class{parseData(e,t,i){let n=e.data,s=e.value;if(g.debug("parse data ","0x"+n.toString(16),v(s),s.byteLength),t===Pe)switch(n){case 0:return new tt(s,n,e.extra);case 27:case 81:case 87:return new qe(s,n,i.deviceInfo);case 80:return new je(s,n);case 82:return new Ze(s,n);case 83:case 229:case 137:case 16:return new $e(s,n);case 84:return new st(s,n);case 114:let t=new Xe(s,n);return i.lastSportMode=t.sportMode,t;case 115:let a=new $e(s,n);return i.lastSportMode&&(a.sportMode=i.lastSportMode),a;case 123:return new Qe(s,n);case 127:let r=new Ge(s,n);return i.lastSportMode&&(r.sportMode=i.lastSportMode),r;case 230:return new Ge(s,n);case 225:case 235:return new et(s,n);case 226:let c=new Xe(s,n);return i.lastSportMode=c.sportMode,c;case 227:return new at(s,n);case 228:return new Je(s,n);case 130:return new yt(s,n);case 131:case 133:case 142:return new St(s,n);case 132:return new It(s,n);case 134:case 136:return new Dt(s,n);case 135:return new wt(s,n);case 186:return new Jt(s,n);case 139:return new Ut(s,n);case 140:return new vt(s,n);case 183:return new bt(s,n);case 185:case 249:return new Tt(s,n);case 103:return xt.parserBuf(s,n,i.deviceInfo);case 17:case 91:return new Mt(s,n);case 18:return new ei(s,n);case 19:return new Xt(s,n);case 20:return new Xe(s,n);case 88:return new ri(s,n);case 192:return(new Fi).parserBuf(s);default:g.warn("数据未处理"+n)}else if(t===We)switch(n){case 161:return new Bi(s,n);case 64712:return new Ai(s,n,i.deviceInfo);case 160:return new xi(s,n)}}createSession(e,t){return e===Pe?new gt(t):e===Ne?new mt(t):e===We?new Ti(t):void 0}tryToExchangeMutipleAction(e,t){if(249===t.tag){let e=t;return 0===e.dailType||1===e.dailType||255===e.dailType?new Qt(e):void g.warn("只能push 本地相册及云端表盘")}if(4===t.tag)return new Ri(t)}getSettingMutipleAction(e,t){switch(t){case Ee.HeartRateWarningSetting:return new Zt(new Bt(11,512),"SettingInfos",At.HeartRateWarning);case Ee.SleepBloodOxygenSetting:return new Zt(new Bt(11,256),"SettingInfos",At.BloodOxygen);case Ee.SedentaryReminderSetting:return new Zt(new Bt(11,1024),"SettingInfos",At.SedentaryReminder);case Ee.SleepReminderSetting:return new Zt(new Bt(11,1<<25),"SettingInfos",At.SleepRemind);case Ee.EventReminderSetting:return new Gt(new Bt(10));case Ee.TimeFormatSetting:return new Zt(new Bt(11,1<<24),"SettingInfos",At.TimeFormat);case Ee.DialTypeSetting:return new Yt;case Ee.CustomPagesSetting:return ct(e.deviceInfo)?new Zt(new Bt(11,1<<20),"SettingInfos",At.CustomPage):new Zt(new Bt(11,1<<21),"SettingInfos",At.CustomPage);case Ee.NightModeSetting:return new Zt(new Bt(11,16),"SettingInfos",At.NightMode);case Ee.RightSwipDisplaySetting:return new Zt(new Bt(11,64),"SettingInfos",At.RightSwipeDisplay);case Ee.SportHrWarnigSetting:return new Zt(new Bt(11,1<<23),"SettingInfos",At.SportHrWarning);case Ee.MsgRemindSetting:return new Zt(new Bt(11,0,1),"SettingInfos",At.Remind);case Ee.HeartRateSectionSetting:return new Zt(new Bt(11,1<<30),"SettingInfos",At.HeartRateDetection);case Ee.FemaleHealthSetting:return new Zt(new Bt(11,1<<27),"SettingInfos",At.FemaleHealth);case Ee.PeriodReminderSetting:return new Zt(new Bt(11,1<<28),"SettingInfos",At.PeriodReminder);case Ee.Peirod2ReminderSetting:return new Zt(new Bt(11,1<<29),"SettingInfos",At.Period2Reminder);case Ee.ReminderSetting:return new Zt(new Bt(14),"reminder",0);case Ee.HeartRateSwitachSetting:return new Zt(new Bt(11,1<<17),"SettingInfos",At.HeartRateEnable);case Ee.DrinkReminderSetting:return new Zt(new Bt(11,32768),"SettingInfos",At.DrinkRemind);case Ee.GetBattery:return new ki(We,ze);default:g.error("为实现")}}syncDataMutipleAction(e){let t=e.deviceInfo;if(rt(t)&&t.isBinded){if(ct(t))return new ti([Le.measureData]);{let e=[Le.sportReport,Le.sportHeartRate,Le.sportCalories,Le.sportPace,Le.heartRate,Le.dailyHour,Le.dailyDay,Le.dailyGeneralHrDetail,Le.bloodOxygen,Le.sleepQuality,Le.continuousBloodOxygen,Le.stand,Le.silenceHeartRate];return new ti(e)}}return null}syncUserInfoAction(e,t){let i=new ii(t);return new Et([i],{})}otaAction(e,t){return new Mi(e,t)}defaultSettingAction(e){if(ct(e.deviceInfo))return new yi(e)}reStartSyncAction(e){return new Lt(oi,e)}reStartBindAction(e){return rt(e.deviceInfo)?new ai:null}checkPushData(e,t){return 249===t.tag||4===t.tag?1:0===t.tag?2:123===t.tag?3:0}getMergeDataManager(e){return rt(e.deviceInfo)?new Si:null}}),hs=new class{parseData(e,t,i){let n=e.data,s=e.value;if(t===Ni)switch(n){case 4096:return new ji(s,n);case 4097:return new sn(s,n);case 4098:return new Qi(s,n);case 4103:return new Gi(s,n)}else switch(n){case 18434:return new Zi(s,n);case 18690:return new $i(s,n);case 2:return new qi(s,n);case 4:return new Yi(s,n);case 7:return new tn(s,n);case 9:return new Xi(s,n);case 8198:return null;case Vi:return new Cn(s,n,i.deviceInfo);default:return g.warn("未知数据, 没有处理"+n),null}}createSession(e){return e===Pi?new hn:e===Oi?new un:e===Ni?new mn:e===_i?new wn:e===Wi?new yn:void 0}otaAction(e,t){t.model=e.deviceInfo.model;let i=new bn(t),n=new $t(i,Wi);return new Et([n],e,1100)}reStartSyncAction(e){return"A6_bp"===e.deviceInfo.protoName?new Lt(Fn,e,1250):new Lt(Bn,e,1250)}getSettingMutipleAction(e,t){if(255===t)return"A6_bp"===e.deviceInfo.protoName?new ki(Oi,Vi):new ki(Pi,Vi);g.error("为实现")}bindSuccessShouldDisconnect(e){return e.deviceInfo.model.indexOf("212")>-1}},ls=new class{constructor(){this.normalParser=new Ue}parseAdvertisementData(e,t){let i,n=e.name,s=t.localName,a=e.deviceId,r=!1,c=t.advertisData;if(c&&c.byteLength>=6){let e=new DataView(c),t=c.byteLength;i=ge(c.slice(t-6,t)).toUpperCase(),r=1===e.getUint8(t-7)}return{name:n,localName:s,deviceId:a,manufacturerData:c,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:i,isSystemPaired:!1,timestamp:new Date,isRegister:r,model:s}}parseDeviceInfo(e,t){let i=this.normalParser.parseDeviceInfo(e,t),n=t.get(B("2A25"));return n.byteLength>=6&&(n=fe(n.slice(0,6)),i.mac=ge(n)),i}},ps=new re(Pi,"A6_scale",{protocolType:0,actions:xn},{protocolType:1,actions:Mn},ls,hs),us=new re(Oi,"A6_bp",{protocolType:0,actions:Ln},{protocolType:1,actions:En},ls,hs);new re("00001808-0000-1000-8000-00805F9B34FB","A8",{protocolType:0,actions:be},{protocolType:1,actions:De},new Ue,new class{parseData(e,t,i){return e.data}createSession(e){return new xe}});let gs=new re(Pn,"A7_mio",{protocolType:0,actions:Nn},{protocolType:1,actions:Vn},new class extends Ue{parseAdvertisementData(e,t){let i=e.name,n=t.localName,s=e.deviceId,a=t.advertisData;if(a&&a instanceof ArrayBuffer){let e=new ve(a);e.readUint8(),e.readUint8();let r=e.readBuffer(6);r=fe(r);let c=ge(r);return e.readUint8(),e.readUint16(!0),e.readUint32(!0),e.readUint16(!0),e.readUint16(!0),a.byteLength>=21&&e.readUint16(!0),a.byteLength>=22&&e.readUint8(),{name:i,localName:n,deviceId:s,manufacturerData:a,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:c,isSystemPaired:!1,timestamp:new Date}}return{}}parseDeviceInfo(e,t){let i=t.get(B("2A25")),n="";i&&i.byteLength>=12&&(n=A(i.slice(0,12)));let s=t.get(B("2A23")),a="";s&&(s=fe(s),a=ge(s));let r=A(t.get(B("2A24"))),c=A(t.get(B("2A26"))),o=A(t.get(B("2A28"))),d=A(t.get(B("2A27"))),h=A(t.get(B("2A29")));return{name:e.name,deviceId:e.deviceId,manufacture:h,model:r,mac:n,softwareVersion:o,hardwareVersion:d,firmwareVersion:c,serialId:a}}},new class{constructor(){this.lastRealtimeMap=new Map}parseData(e,t,i){let n=e.data,s=e.value;switch(g.debug("parse data",n,v(s)),n){case 1:let e=i.deviceInfo.mac,t=this.lastRealtimeMap.get(e),a=new _n(s,n,t);return i.deviceInfo.battery=a.battery,this.lastRealtimeMap.set(e,a),a;case 2:case 3:return new Wn(s,n);default:g.warn("未知数据, 没有处理"+n)}}createSession(e){return Pn===e?new jn:new Qn}}),fs=new re(B("FF00"),"Mcu",{protocolType:0,actions:Zn},{protocolType:1,actions:Gn},new class extends Ue{constructor(){super(...arguments),this.normalParse=new Ue}parseAdvertisementData(e,t){let i=e.name,n=t.localName,s=e.deviceId,a=t.advertisData;if(a&&a instanceof ArrayBuffer){let e=new ve(a);e.readUint16();let r=ge(e.readBuffer(6));return{name:i,localName:n,deviceId:s,manufacturerData:a,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:r,isSystemPaired:!1,timestamp:new Date,isRegister:!0,model:"PB1"}}}parseDeviceInfo(e,t){return{...this.normalParse.parseDeviceInfo(e,t),model:"PB1"}}},new class{parseData(e,t,i){let n=e.data,s=e.value;switch(g.debug("parse data",n,v(s)),n){case 164:return new Jn(s,n);case 2:return new Kn(s,n);case 4:return new ns(s,n);case 9:return new ts(s,n);case 49:return new is(s,n);case 50:this.syncData?this.syncData.parseData(s,n):this.syncData=new ss(s,n);let e=this.syncData;return this.syncData.isFull()&&(this.syncData=null),e;default:throw new Error("未知数据, 没有处理"+n)}}tryToExchangeMutipleAction(e,t){if(10===t.tag){return new rs(t)}if(48==t.tag){return new cs(t)}}checkPushData(e,t){return 10===t.tag||48==t.tag?1:0}createSession(e){if(B("FF00")===e)return new es}syncDataMutipleAction(e){return new rs(new as)}}),ms=[];function Us(e){for(let t of e){let e="";e="string"==typeof t?t.toUpperCase():t.uuid.toUpperCase();for(let t=0;t<ms.length;t++)if(e&&e.indexOf(ms[t].uuid)>-1)return ms[t]}g.error("不支持的设备",e)}function ws(){let e=[];return ms.forEach((t=>{e.push(t.uuid)})),e}var vs,ys;ms.push(ds),ms.push(ps),ms.push(us),ms.push(gs),ms.push(fs),function(e){e[e.None=0]="None",e[e.Scan=1]="Scan",e[e.Connecting=2]="Connecting",e[e.Connected=3]="Connected",e[e.Worked=4]="Worked",e[e.Disconnected=5]="Disconnected"}(vs||(vs={})),function(e){e.AdaptorState="adaptorState",e.ConnectionState="connectionState",e.DeviceFind="deviceFind",e.UpdateDeviceInfo="UpdateDeviceInfo",e.DataReport="dataReport",e.eventReport="eventReport",e.watchFaceStatus="watchFaceStatus",e.watchFaceChange="watchFaceChange",e.DeviceStateChange="deviceStateChange"}(ys||(ys={}));const Ss=new Map,bs=new Map;class Is{constructor(){this.connectStatus=vs.None,this.workMode=0,g.debug("create",this)}get isWorking(){return!(this.connectStatus>vs.Worked||this.connectStatus===vs.None)}updateDeviceInfo(e){e&&(this.name=e.name,this.deviceId=e.deviceId,this.serialId=e.serialId,this.hardwareVersion=e.hardwareVersion,this.softwareVersion=e.softwareVersion,this.firmwareVersion=e.firmwareVersion,this.updateDeviceId(e.lzDeviceId),!this.mac&&e.mac&&(this.mac=e.mac),this.localName||(this.localName=this.name),this.protoName&&this.protoName.indexOf("A6")>=0&&this.model&&0!==this.model.length||(this.model=e.model))}updateAdvertisement(e){e&&e.mac&&(this.isRegister=e.isRegister,this.mac=e.mac,this.deviceId=e.deviceId,this.localName=e.localName,this.name=this.localName,this.RSSI=e.RSSI,e.model&&(this.model=e.model))}updateDeviceId(e){e&&(this.sn=function(e){if(!e||e.length<12)return"";let t=ue(e),i=new DataView(t),n=(i.getUint8(0)<<16)+(i.getUint8(1)<<8)+i.getUint8(2),s=(i.getUint8(3)<<16)+(i.getUint8(4)<<8)+i.getUint8(5);return n.toString(10).padStart(8,"0")+s.toString(10).padStart(8,"0")}(e),this.lzDeviceId=e.toLowerCase(),this.id=e)}}function Ds(e){let t=bs.get(e.deviceId);if(t){let i=de(t.mac);if(!i){if(i=Us(e.services),!i)return g.warn("找不到对应的设置服务"),t;t.protoName=i.name,oe(t.mac,i)}if(bs.set(e.deviceId,t),e.isSystemConnect)try{let n=i.parser.parseDeviceInfo(e,e.deviceInfo);t.updateDeviceInfo(n)}catch(e){g.warn("解析设备数据出错2",e,t)}else try{let n=i.parser.parseAdvertisementData(e,e.advertisementData);t.updateAdvertisement(n)}catch(e){g.warn("解析广播数据出错",e,t)}}else{if(!e.services)return g.warn("设备services 为 null",e.deviceId),null;let t=Us(e.services);if(t){let i=new Is;if(i.deviceId=e.deviceId,e.isSystemConnect)try{let n=t.parser.parseDeviceInfo(e,e.deviceInfo);i.updateDeviceInfo(n)}catch(e){g.warn("解析设备数据出错1",e,i)}else try{let n=t.parser.parseAdvertisementData(e,e.advertisementData);i.updateAdvertisement(n)}catch(e){g.warn("解析广播数据出错",e,i)}return i.mac&&(oe(i.mac,t),i.protoName=t.name,Ss.set(i.mac,i),bs.set(e.deviceId,i)),i}g.warn("找不到对应的服务",e.deviceId)}return t}function Ts(e){let t=Ss.get(e);return t||(t=new Is,t.mac=e,Ss.set(e,t)),t}function Bs(e){return bs.get(e)}class Cs{constructor(e,t){this.sessionMap=new Map,this.mac=e,this.proto=t}async bind(e,t){if(this.isClear)return g.warn("bind 被释放了"),Promise.reject(U.errorCode(4));if(this.isWorking)return void g.warn("重复调用");this._initMergeDataManager(e),this._initMutipleActionManager(e),this.context=e,this.workMode=1,this.isWorking=!0;let i=this.proto.bind.actions,n=new Lt(i,e),s=this;this.mutipActionManager.execute(n,(i=>{i.success?(s.didBinded(e),t(s.mac,0)):(s.isWorking=!1,s.unWorked(),t(s.mac,i.code))}))}async sync(e,t){if(this.isClear)return void g.warn("sync 被释放了");if(this.isWorking)return void g.warn("重复调用");this._initMergeDataManager(e),this._initMutipleActionManager(e),this.context=e,this.workMode=0,this.isWorking=!0;let i=this.proto.sync.actions,n=new Lt(i,e),s=this;this.mutipActionManager.execute(n,(i=>{i.success?(t(s.mac,0),s.didWorked(e)):(s.isWorking=!1,s.unWorked(),t(s.mac,i.code))}))}ota(e){if(this.proto.dataParser.otaAction){let t=this.proto.dataParser.otaAction(this.context,e);if(t)return this.excuteMutipAction(t)}return e.onUpgradeComplete&&e.onUpgradeComplete(10,"不支持ota升级"),Promise.reject(U.errorCode(10))}pushSetting(e){if(this.isClear)return g.warn("pushSetting 被释放了",e),this.context.client.disconnect(),Promise.reject(U.errorCode(4));if(!this.proto.dataParser.checkPushData)return this._pushSetting(e);switch(this.proto.dataParser.checkPushData(this.context,e)){case-1:return Promise.reject(U.errorCode(15));case-2:return Promise.reject(U.errorCode(10));case 0:let t=new Et([e],{},1e3);return this.excuteMutipAction(t);case 1:if(this.proto.dataParser.tryToExchangeMutipleAction){let t=this.proto.dataParser.tryToExchangeMutipleAction(this.context,e);if(t)return this.excuteMutipAction(t)}return Promise.reject(U.errorCode(10));case 2:return this.context.userInfo||(this.context.userInfo=this.userInfo),this._reBind(this.context);default:return this._pushSetting(e)}}getSetting(e){if(this.isClear)return g.warn("getSetting 被释放了"),this.context.client.disconnect(),Promise.reject(U.errorCode(4));let t=this;if(!this.proto.dataParser.getSettingMutipleAction)return Promise.reject(U.errorCode(10));let i=this.proto.dataParser.getSettingMutipleAction(this.context,e);return i?new Promise((async(e,n)=>{try{e((await t.excuteMutipAction(i)).data)}catch(e){n(e)}})):Promise.reject(U.errorCode(10))}cancelSetting(){g.warn("cancelSetting"),this.mutipActionManager.cancelCurrentSession(),this.sessionMap.forEach(((e,t)=>{g.warn("value clear",e),e.clear()}))}excuteMutipAction(e){if(this.isClear)return g.warn("excuteMutipAction 被释放了",e),this.context.client.disconnect(),Promise.reject(U.errorCode(4));let t=this;return new Promise(((i,n)=>{t.mutipActionManager.execute(e,(e=>{e.success?i(e):n(e)}))}))}clear(){try{this.mergeDataManager&&this.mergeDataManager.callbackAllData(),this.isClear=!0,this.unWorked(),this._clearSyncTime(),this.mutipActionManager.clear(),this.isWorking=!1,this.workMode=0,this.context=null,this.mac=null,this.context=null,this.sessionMap.forEach(((e,t)=>{e.clear()})),this.sessionMap.clear()}catch(e){}}async updateUserInfo(e){if(this.userInfo=e,this.proto.dataParser.syncUserInfoAction){let t=this.proto.dataParser.syncUserInfoAction(this.context,e);if(t)return this.excuteMutipAction(t)}}async didBinded(e){if(this.isClear)return g.warn("didBinded 被释放了",e),Promise.reject(U.errorCode(4));if(e.deviceInfo.isBinded=!0,g.info("didBinded"),this.proto.dataParser.reStartSyncAction){let e=this.proto.dataParser.reStartSyncAction(this.context);if(e)try{g.info("重新同步数据"),await this.excuteMutipAction(e)}catch(t){g.warn("重新同步数据 出错了",t,e,this.mac)}}if(this.proto.dataParser.defaultSettingAction){let e=this.proto.dataParser.defaultSettingAction(this.context);if(e)try{g.info("设置默认"),await this.excuteMutipAction(e)}catch(t){g.warn("默认设置失败了",e,this.mac)}}this.didWorked(e)}async didWorked(e){if(this.isClear)return g.warn("didWorked 被释放了",e),Promise.reject(U.errorCode(4));this.workMode=0,e.deviceInfo.workMode=0,g.info("didWorked"),await this.updateUserInfo(this.userInfo),setTimeout((()=>{this._reStartSyncTime(e)}),1e3)}unWorked(){this._clearSyncTime()}getSessionManager(e,t){let i=this.proto.uuid;t&&(i=t);let n=this.sessionMap.get(i);if(!n){let t=this;n=this.proto.dataParser.createSession(i,e),n&&(n.sender=(e,i)=>t.context.client.write(i.serviceId,i.charId,e),n.listener=e=>{if(e.success)try{let n=t.proto.dataParser.parseData(e,i,t.context);t._handlerNewData(n)}catch(t){g.error("捕捉到解析失败",t,e,i)}},this.sessionMap.set(i,n))}return n||g.warn("sessionManager 创建失败",t,this.proto),n}_pushSetting(e){g.info("pushSetting",this.mac,e);let t=this.getSessionManager(this.context,e.serviceId);return t?t.sendData(e.getBytes(this.context.deviceInfo),e.tag):Promise.reject(U.errorCode(10))}_clearSyncTime(){this.syncTime&&(clearTimeout(this.syncTime),this.syncTime=null)}_reStartSyncTime(e){if(this._clearSyncTime(),this.proto&&this.proto.dataParser.syncDataMutipleAction){let t=this.proto.dataParser.syncDataMutipleAction(e);if(t){let i=this;this.excuteMutipAction(t),i.syncTime=setTimeout((()=>{try{this._reStartSyncTime(e)}catch(e){g.warn("同步数据失败",e)}}),t.interval?t.interval:2e4)}}}_reBind(e){let t=this;return new Promise((async(i,n)=>{try{let n=this.proto.dataParser.reStartBindAction(e);if(n){let s=await t.excuteMutipAction(n);return setTimeout((()=>{t.didBinded(e)})),i(s)}throw"需要实现 reStartBindAction"}catch(e){n(e)}}))}_initMutipleActionManager(e){this.mutipActionManager=new Ot(this.mac,e.client);let t=this.mac+"worker",i=this;ee(t,e.client.deviceId,(t=>{let n=i.getSessionManager(e,t.serviceId);if(n)n.didReceiveData(t);else try{let e=i.proto.dataParser.parseData(U.errorCode(0,t.characteristicId,t.value),t.serviceId,i.context);i._handlerNewData(e)}catch(e){g.error("捕捉到解析失败",e,t)}return!1})),this.mutipActionManager.pusher=e=>this._pushSetting(e)}_initMergeDataManager(e){if(this.proto.dataParser.getMergeDataManager){let t=this.proto.dataParser.getMergeDataManager(e);if(t){this.mergeDataManager=t;let e=this;t.lister=t=>{e.mutipActionManager.didReceive(t),e.lister&&e.lister(e.context.deviceInfo,t),g.info("-----mergedData",e.context.deviceInfo,t)}}}}_handlerNewData(e){if(e&&e.dataType){if(this.mergeDataManager){if(this.mergeDataManager.receiveAndHandle(e,this.context))return}this.mutipActionManager.didReceive(e),"finish"===e.dataType||(g.info("datareport",this.mac,e),this.lister&&this.lister(this.context.deviceInfo,e))}}}var Rs=new class extends class{constructor(){this.listenerMap=new Map}$on(e,t,i){this.listenerMap.has(e)||this.listenerMap.set(e,new Map),this.listenerMap.get(e).set(t,i)}$off(e,t){if(this.listenerMap.has(e)){let i=this.listenerMap.get(e);i&&i.delete(t)}}printLog(e,...t){}$emit(e,...t){if(this.printLog(e,"$emit",e,...t),this.listenerMap.has(e)){let i=this.listenerMap.get(e);for(let n of i.keys()){let s=i.get(n);try{s&&s(...t)}catch(t){g.error("$emit fail "+e+" "+t)}}}}}{constructor(){super(),this.aerobicGPSStatus=0,this.getSettingTimeout=null,this.workerMap=new Map,this.cacheWorkerHandler=new Map,this.cacheFindDeviceTimeout=new Map}init(e){if(this.options=e,function(e){let t=e=>{g.info("onBLEConnectionStateChange:",e);let t=J.get(e.deviceId);t&&t.forEach((t=>{t&&t(e)})),$.forEach((t=>{t(e)}))};e.onBLEConnectionStateChange?e.onBLEConnectionStateChange(t):wx.onBLEConnectionStateChange(t);let i=e=>{g.info("onBluetoothAdapterStateChange:",e),Q.forEach((t=>{t&&t(e)}))};e.onBluetoothAdapterStateChange?e.onBluetoothAdapterStateChange(i):wx.onBluetoothAdapterStateChange(i);let n=e=>{let t=K.get(e.deviceId);t&&t.forEach((t=>{t&&t(e)})),Z.forEach((t=>{t&&t(e)}))};e.onBLECharacteristicValueChange?e.onBLECharacteristicValueChange(n):wx.onBLECharacteristicValueChange(n);let s=e=>{G.forEach((t=>{t(e)}))};e.onBluetoothDeviceFound?e.onBluetoothDeviceFound(s):wx.onBluetoothDeviceFound(s)}(e),e.logger&&g.setLogger(e.logger),!ae[e.platform])return void g.error("暂不支持该平台: ",ae.wx,e.platform);let{Adapter:t}=ae[e.platform];return this.adapter=new t,Y("_b",(e=>{!1===e.available&&this.tryReleaseAdapter(),setTimeout((()=>{this.$emit(ys.AdaptorState,e)}),0)})),X("_b",(e=>{let t=Bs(e.deviceId);if(t&&0==e.connected){this.changeWorkState(t.mac,vs.Disconnected,!0);let e=this.workerMap.get(t.mac);e&&(e.clear(),this.workerMap.delete(t.mac))}})),this.adapter.available?Promise.resolve(U.success()):this.adapter.openBLEAdapter()}updateUserInfo(e){this.userInfo=e;let t=this.getWorkedDevice(),i=this;t&&t.length>0&&t.forEach((t=>{let n=i.workerMap.get(t.mac);n&&n.updateUserInfo(e)}))}pushSetting(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(U.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.pushSetting(t):Promise.reject(U.errorCode(1))}cancelSetting(e){g.warn("cancelSetting",e,this.workerMap),e=e.toUpperCase();let t=this.workerMap.get(e);return t?t.cancelSetting():Promise.reject(U.errorCode(1))}getSetting(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(U.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.getSetting(t):Promise.reject(U.errorCode(1))}scanDevice(e,t,i=ie.ALL){if(!this.checkBluetoothAvailable())return Promise.reject(U.errorCode(21));this.adapter.startScan(e,ws(),!0,(e=>{let i=Ds(e);i&&i.mac&&t(i)}),i)}stopScan(e){if(!this.checkBluetoothAvailable())return Promise.reject(U.errorCode(21));this.adapter.stopScan(e)}ota(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(U.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.ota(t):(t.onUpgradeComplete(1,"未连接"),Promise.reject(U.errorCode(1)))}async bind(e,t,i){if(!this.checkBluetoothAvailable())return Promise.reject(U.errorCode(21));e=e.toUpperCase();let n=this.workerMap.get(e),s=this;return n&&(n.clear(),this.workerMap.delete(e)),this.cacheWorkerHandler.set(e,i),new Promise((async(i,a)=>{try{await s.checkUserLocationAvailable();let r={...t};!r.userInfo&&this.userInfo&&(r.userInfo=this.userInfo),Ts(e).workMode=1,await this.tryToConnect(e,r);let c=de(e);n=new Cs(e,c),n.context=r,n.lister=(e,t)=>{this.$emit(ys.DataReport,e,t)},n.userInfo=this.userInfo,this.workerMap.set(e,n),n.bind(r,((e,n)=>{0!=n?(s.cancelWork(e,!0),a(U.errorCode(n))):(s.changeWorkState(e,vs.Worked,!0),i(U.errorCode(0)),c.dataParser.bindSuccessShouldDisconnect&&c.dataParser.bindSuccessShouldDisconnect(r)&&(s.cancelWork(e,!0),setTimeout((i=>{s.syncData(e,t,((e,t)=>{}))}),100)))}))}catch(e){return a(e)}}))}async syncData(e,t,i){if(!this.checkBluetoothAvailable())return i&&i(e,vs.Disconnected),Promise.reject(U.errorCode(21));e=e.toUpperCase(),this.cacheWorkerHandler.set(e,i);let n=Ts(e);if(n.connectStatus===vs.None||n.connectStatus>=vs.Disconnected){let i={...t};!i.userInfo&&this.userInfo&&(i.userInfo=this.userInfo);let n=this.workerMap.get(e);n&&(n.clear(),this.workerMap.delete(e));let s=this;try{await s.checkUserLocationAvailable(),await this.tryToConnect(e,i);let t=de(e);n=new Cs(e,t),n.context=i,n.userInfo=this.userInfo,this.workerMap.set(e,n),n.lister=(e,t)=>{s.$emit(ys.DataReport,e,t)},n.sync(i,((e,t)=>{0!=t?s.cancelWork(e,!0):s.changeWorkState(e,vs.Worked,!0)}))}catch(t){s.changeWorkState(e,vs.Disconnected,!0)}}}cancelWork(e,t=!0){let i=Ts(e=e.toUpperCase());if(1===i.workMode&&!t)return;i.workMode=0;let n=this.workerMap.get(e);if(n)if(1===n.workMode){if(!t)return}else n.clear(),this.workerMap.delete(e);if(i&&i.deviceId){this.adapter.getClient(i.deviceId).disconnect()}}getConnectionState(e){return Ts(e=e.toUpperCase()).connectStatus}getDeviceInfo(e){return Ts(e)}getWorkedDevice(){let e=[];return this.workerMap.forEach(((t,i)=>{if(!t.isClear&&t.isWorking){let t=Ts(i);t&&t.connectStatus===vs.Worked&&e.push(t)}})),e}getConnectedDevice(){let e=[];return this.workerMap.forEach(((t,i)=>{let n=Ts(i);!n||n.connectStatus!==vs.Worked&&n.connectStatus!==vs.Connected||e.push(n)})),e}disconnectDevice(e){this.adapter.getClient(e).disconnect()}changeWorkState(e,t,i=!1,n=!0){let s=Ts(e);s&&(s.connectStatus=t,n&&(this.$emit(ys.ConnectionState,e,t),this.$emit(ys.DeviceStateChange,s)));let a=this.cacheWorkerHandler.get(e);a&&(a(e,t),g.debug("callback",e,t),i&&this.cacheWorkerHandler.delete(e))}findDevice(e){let t=Ts(e=e.toUpperCase());if(t&&t.deviceId){if(this.adapter.getClient(t.deviceId).connected)return Promise.resolve(!0)}return new Promise(((i,n)=>{let s=this.cacheFindDeviceTimeout.get(e);s&&clearTimeout(s),s=setTimeout((()=>{this.stopScan(e),n(!1)}),9500),this.cacheFindDeviceTimeout.set(e,s);let a=ie.ALL;t.protoName&&"A6_scale"===t.protoName&&(g.warn("scanmode normal"),a=ie.Normal),this.adapter.startScan(e,ws(),!0,(t=>{let n=Ds(t);if(n&&n.mac&&n.mac===e){this.stopScan(e);let t=this.cacheFindDeviceTimeout.get(e);t&&(clearTimeout(t),this.cacheFindDeviceTimeout.delete(e)),i(!0)}}),a)}))}async tryToConnect(e,t){if(!this.checkBluetoothAvailable())return this.changeWorkState(e,vs.Disconnected,!0),Promise.reject(U.errorCode(21));let i=this;return new Promise((async(n,s)=>{try{i.changeWorkState(e,vs.Scan),await i.findDevice(e)}catch(t){return g.warn("未发现设备",e,t),this.changeWorkState(e,vs.Disconnected,!0),this.cancelWork(e,!0),void s(U.errorCode(12))}try{let i=Ts(e),n=this.adapter.getClient(i.deviceId);if(this.changeWorkState(e,vs.Connecting),await n.connectAndReadDeviceInfo(!0,!0),n.isSystemConnect=!0,function(e){Ds(e)}(n),t.deviceInfo=Ts(e),t.listeners&&t.listeners.onReadDeviceInfo){let e={...t.deviceInfo};t.listeners.onReadDeviceInfo(e)}t.client=n,this.changeWorkState(e,vs.Connected)}catch(t){return this.changeWorkState(e,vs.Disconnected,!0),this.cancelWork(e,!0),void s(U.errorCode(1))}if(t.listeners&&t.listeners.onDeviceAuth)try{if(!await t.listeners.onDeviceAuth({...t}))return g.warn("auth faired",t.deviceInfo),this.cancelWork(e,!0),void s(U.errorCode(11))}catch(t){return g.warn("auth faired",t),this.changeWorkState(e,vs.Disconnected,!0),this.cancelWork(e,!0),void s(U.errorCode(11))}n(U.success())}))}tryReleaseAdapter(){0===this.getConnectedDevice().length&&this.adapter.closeAndReopenBLEAdapter()}connectDevice(e){g.warn("connectDevice 弃用，外部不需要调用此方法")}bindDevice(e,t){g.warn("bindDevice 弃用，请使用bind(mac, context, callback)");let i=Bs(e);return this.bind(i.mac,t,null)}async send(e,t){let i=Bs(e);return this.pushSetting(i.mac,t)}checkBluetoothAvailable(){try{return wx.getSystemInfoSync().bluetoothEnabled&&this.adapter.available}catch(e){return!1}}checkUserLocationAvailable(){return new Promise(((e,t)=>{let{locationEnabled:i,locationAuthorized:n,platform:s}=wx.getSystemInfoSync();s.indexOf("android")>-1?i&&n?e(U.errorCode(0)):t(U.errorCode(20)):e(U.errorCode(0))}))}};function As(){this.dataStore=[],this.add=Fs,this.remove=xs,this.size=Ms,this.union=Ps,this.contains=Es,this.intersect=Os,this.subset=Hs,this.difference=Vs,this.show=Ls,this.clear=ks}function ks(){this.dataStore.length=0}function Fs(e){return this.dataStore.indexOf(e)<0&&(this.dataStore.push(e),!0)}function xs(e){var t=this.dataStore.indexOf(e);return t>-1&&(this.dataStore.splice(t,1),!0)}function Ms(){return this.dataStore.length}function Ls(){return"["+this.dataStore+"]"}function Es(e){return this.dataStore.indexOf(e)>-1}function Ps(e){for(var t=new As,i=0;i<this.dataStore.length;++i)t.add(this.dataStore[i]);for(i=0;i<e.dataStore.length;++i)t.contains(e.dataStore[i])||t.dataStore.push(e.dataStore[i]);return t}function Os(e){for(var t=new As,i=0;i<this.dataStore.length;++i)e.contains(this.dataStore[i])&&t.add(this.dataStore[i]);return t}function Hs(e){if(this.size()>e.size())return!1;for(var t in this.dataStore)if(!e.contains(t))return!1;return!0}function Vs(e){for(var t=new As,i=0;i<this.dataStore.length;++i)e.contains(this.dataStore[i])||t.add(this.dataStore[i]);return t}let Ns,_s=new As,Ws=new As,zs=new As,qs=!0,js=null,$s=!1,Qs=!1;function Zs(e,t){js=e,$s=t,Qs=!1,Rs.$on("connectionState","_monitor",((e,t)=>{console.debug("_monitor",e,t),4===t?(Ws.add(e),zs.remove(e)):3===t?(zs.add(e),Ws.remove(e)):t>=5?(Ws.remove(e),zs.remove(e)):(Ws.remove(e),zs.add(e))})),Rs.$on("adaptorState","_monitor",(e=>{console.debug("_monitor",e),e.available?!0===qs||(qs=e.available,Ks()):(qs=e.available,Ns&&clearTimeout(Ns))}))}async function Gs(e){if(Array.isArray(e))e.forEach((async e=>{await Js(e)&&_s.add(e.mac)}));else{await Js(e)&&_s.add(e.mac)}Ks()}async function Js(e){return new Promise((async(i,n)=>{let s="lsdeviceAuth."+e.mac+js,a=wx.getStorageSync(s);if(a)200===a?(console.debug("设备鉴权成功"),i(!0)):(console.debug("设备鉴权失败",a,s),n(!1));else try{let a={artifactId:"@ls/ble-next",serviceId:"device-activate",serviceVersion:"1.0",platform:3,appId:js,mac:e.mac,model:e.model},r=await(e=>t({path:"/rbac-web/auth/app",data:e}))(a),c=r.code;wx.setStorageSync(s,c),200===c?i(!0):n(!1)}catch(t){console.warn("鉴权失败",t,e),n(!1)}}))}function Ks(){if(Ns&&clearTimeout(Ns),!qs||Qs)return;Ns=setTimeout((()=>{Ns=null,Ks()}),1e4);let t=Ws.union(zs).difference(_s).dataStore;t.length>0&&$s&&t.forEach((e=>{Rs.cancelWork(e,!1)}));let i=_s.difference(Ws).dataStore;if(i.length>0){let t={onApplyRegisterId:t=>new Promise(((i,n)=>{console.log("plugin","onApplyRegisterId",t);let s=t.deviceInfo.model,a=t.deviceInfo.hardwareVersion,r=t.deviceInfo.softwareVersion,c=t.deviceInfo.mac;e({mac:c,model:s,hardwareVersion:a,softwareVersion:r}).then((e=>{200===e.code&&e.data.deviceId?i(e.data.deviceId):(n("请求third deviceId 失败"),callback({mac:c,deviceInfo:t.deviceInfo,bindState:BINDSTATE_Failure}))})).catch((e=>{n(e),callback({mac:c,deviceInfo:t.deviceInfo,bindState:BINDSTATE_Failure})}))})),onDeviceAuth:e=>(console.warn("onDeviceAuth",e.deviceInfo),Js({mac:e.deviceInfo.mac,model:e.deviceInfo.model}))},n={listeners:t};i.forEach((e=>{Rs.syncData(e,n)}))}}var Ys,Xs,ea;!function(e){e[e.all=0]="all",e[e.call=1]="call",e[e.message=2]="message",e[e.disconnect=3]="disconnect",e[e.sms=4]="sms",e[e.wx=5]="wx",e[e.qq=6]="qq",e[e.facebook=7]="facebook",e[e.twitter=8]="twitter",e[e.line=9]="line",e[e.gmail=10]="gmail",e[e.kakaoTalk=11]="kakaoTalk",e[e.whatsApp=12]="whatsApp",e[e.instragram=13]="instragram",e[e.appleMusic=14]="appleMusic",e[e.googlemaps=15]="googlemaps",e[e.likee=16]="likee",e[e.linkedln=17]="linkedln",e[e.messenger=18]="messenger",e[e.momo=19]="momo",e[e.odnoklassniki=20]="odnoklassniki",e[e.privat24=21]="privat24",e[e.vk=22]="vk",e[e.youtube=23]="youtube",e[e.youtubeMusic=24]="youtubeMusic",e[e.zoom=25]="zoom",e[e.skype=26]="skype",e[e.telegram=27]="telegram",e[e.tiktok=28]="tiktok",e[e.viber=29]="viber",e[e.letsfit=30]="letsfit",e[e.outlook=31]="outlook",e[e.calendar=32]="calendar",e[e.snapchat=33]="snapchat",e[e.missCallsReminder=34]="missCallsReminder",e[e.lifesense=35]="lifesense",e[e.zhifubao=36]="zhifubao",e[e.dingding=37]="dingding",e[e.enterpriseQQ=38]="enterpriseQQ",e[e.other=253]="other",e[e.sewellness=254]="sewellness",e[e.custom=255]="custom"}(Ys||(Ys={}));class ta{constructor(){this.QLZ_STREAMING_BUFFER=0,this.QLZ_MEMORY_SAFE=0,this.QLZ_VERSION_MAJOR=1,this.QLZ_VERSION_MINOR=5,this.QLZ_VERSION_REVISION=0,this.HASH_VALUES=4096,this.MINOFFSET=2,this.UNCONDITIONAL_MATCHLEN=6,this.UNCOMPRESSED_END=4,this.CWORD_LEN=4,this.DEFAULT_HEADERLEN=9,this.QLZ_POINTERS_1=1,this.QLZ_POINTERS_3=16}headerLen(e){return 2==(2&e[0])?9:3}sizeDecompressed(e){return 9==this.headerLen(e)?this.fast_read(e,5,4):this.fast_read(e,2,1)}sizeCompressed(e){return 9==this.headerLen(e)?this.fast_read(e,1,4):this.fast_read(e,1,1)}write_header(e,t,i,n,s){e[0]=2|(i?1:0),e[0]|=t<<2,e[0]|=64,e[0]|=0,this.fast_write(e,1,s,4),this.fast_write(e,5,n,4)}fast_write(e,t,i,n){for(let s=0;s<n;s++)e[t+s]=i>>8*s}arraycopy(e,t=0,i,n=0,s=e.length){new Uint8Array(i,n).set(new Uint8Array(e,t,s))}fast_read(e,t,i){var n=0;for(let s=0;s<i;s++)n|=(255&e[t+s])<<8*s;return n}decompress(e,t){var i,n=this.sizeDecompressed(e),s=this.headerLen(e),a=0,r=1,c=new Uint8Array(n),o=new Int32Array(4096),d=new Uint8Array(4096),h=n-this.UNCONDITIONAL_MATCHLEN-this.UNCOMPRESSED_END-1,l=-1,p=0;if(!t){var u=e[0]>>>2&3;if(1!=u&&3!=u)throw new Error("Javascript version only supports level 1 and 3");t=u}if(1!=(1&e[0])){var g=new Uint8Array(n);return this.arraycopy(e,this.headerLen(e),g,0,n),g}for(;;)if(1==r&&(r=this.fast_read(e,s,4),s+=4,a<=h&&(p=1==t?this.fast_read(e,s,3):this.fast_read(e,s,4))),1==(1&r)){var f,m,U;if(r>>>=1,1==t)m=o[i=p>>>4&4095],0!=(15&p)?(f=2+(15&p),s+=2):(f=255&Number(e[s+2]),s+=3);else 0==(3&p)?(U=(255&p)>>>2,f=3,s++):0==(2&p)?(U=(65535&p)>>>2,f=3,s+=2):0==(1&p)?(U=(65535&p)>>>6,f=3+(p>>>2&15),s+=2):3!=(127&p)?(U=p>>>7&131071,f=2+(p>>>2&31),s+=3):(U=p>>>15,f=3+(p>>>7&255),s+=4),m=Number(a-U);c[a+0]=c[m+0],c[a+1]=c[m+1],c[a+2]=c[m+2];for(var w=3;w<f;w+=1)c[a+w]=c[m+w];if(a+=f,1==t){for(p=this.fast_read(c,l+1,3);l<a-f;)l++,o[i=(p>>>12^p)&this.HASH_VALUES-1]=l,d[i]=1,p=p>>>8&65535|(255&Number(c[l+3]))<<16;p=this.fast_read(e,s,3)}else p=this.fast_read(e,s,4);l=a-1}else{if(!(a<=h)){for(;a<=n-1;)1==r&&(s+=this.CWORD_LEN,r=2147483648),c[a]=e[s],a++,s++,r>>>=1;return c}if(c[a]=e[s],a+=1,s+=1,r>>>=1,1==t){for(;l<a-3;){l++;let e=this.fast_read(c,l,3);o[i=(e>>>12^e)&this.HASH_VALUES-1]=l,d[i]=1}p=p>>8&65535|(255&Number(e[s+2]))<<16}else p=p>>8&65535|(255&Number(e[s+2]))<<16|(255&Number(e[s+3]))<<24}}compress(e,t){var i,n=0,s=this.DEFAULT_HEADERLEN+this.CWORD_LEN>>>0,a=2147483648,r=this.DEFAULT_HEADERLEN>>>0,c=new Uint8Array(e.length+400);new Uint32Array(this.HASH_VALUES);var o,d,h=new Uint8Array(this.HASH_VALUES),l=0,p=e.length-this.UNCONDITIONAL_MATCHLEN-this.UNCOMPRESSED_END-1;if(1!=t&&3!=t)throw new RuntimeException("Java version only supports level 1 and 3");if(1==t?(d=this.QLZ_POINTERS_1,i=new Uint32Array(this.HASH_VALUES*this.QLZ_POINTERS_1)):(d=this.QLZ_POINTERS_3,i=new Uint32Array(this.HASH_VALUES*this.QLZ_POINTERS_3)),0==e.length)return new ArrayBuffer(0);for(n<=p&&(l=this.fast_read(e,n,3));n<=p;){if(1==(1&a)){if(n>3*(e.length>>>2)&&s>n-(n>>>5)){o=new Uint8Array(e.length+this.DEFAULT_HEADERLEN),this.write_header(o,t,!1,e.length,e.length+this.DEFAULT_HEADERLEN);for(let t=0;t<e.length;t++)o[t+this.DEFAULT_HEADERLEN]=e[t];return o.buffer}this.fast_write(c,r,a>>>1|2147483648,4),r=s,s+=this.CWORD_LEN,a=2147483648}var u,g;l=4294967295&this.fast_read(e,n,3);var f,m=0,U=0,w=0,v=e.length-this.UNCOMPRESSED_END-n+1-1>255?255:e.length-this.UNCOMPRESSED_END-n+1-1,y=(l>>>12^l)&this.HASH_VALUES-1;for(f=h[y],m=0,g=0,U=0;U<this.QLZ_POINTERS_3&&(f>U||f<0);U++)if(u=i[y*d+U],(255&l)==(255&Number(e[u]))&&(l>>>8&255)==(255&Number(e[u+1]))&&(l>>>16&255)==(255&Number(e[u+2]))&&u<n-this.MINOFFSET){for(w=3;e[u+w]==e[n+w]&&w<v;)w++;(w>m||w==m&&u>g)&&(g=u,m=w)}if(u=g,i[y*d+(f&this.QLZ_POINTERS_3-1)]=n,f++,h[y]=f,m>=3&&n-u<131071){var S=n-u;for(let t=1;t<m;t++)i[(y=((l=this.fast_read(e,n+t,3))>>>12^l)&this.HASH_VALUES-1)*d+((f=h[y]++)&this.QLZ_POINTERS_3-1)]=n+t;n+=m,a=a>>>1|2147483648,3==m&&S<=63?(this.fast_write(c,s,S<<2,1),s++):3==m&&S<=16383?(this.fast_write(c,s,S<<2|1,2),s+=2):m<=18&&S<=1023?(this.fast_write(c,s,m-3<<2|S<<6|2,2),s+=2):m<=33?(this.fast_write(c,s,m-2<<2|S<<7|3,3),s+=3):(this.fast_write(c,s,m-3<<7|S<<15|3,4),s+=4)}else c[s]=e[n],a>>>=1,n++,s++}for(;n<=e.length-1;)1==(1&a)&&(this.fast_write(c,r,a>>>1|2147483648,4),r=s,s+=this.CWORD_LEN,a=2147483648),c[s]=e[n],n++,s++,a>>>=1;for(;1!=(1&a);)a>>>=1;return this.fast_write(c,r,a>>>1|2147483648,this.CWORD_LEN),this.write_header(c,t,!0,e.length,s),c.buffer.slice(0,s)}}function ia(e,t="",i){let n=I(t).slice(0,24),s=(new ye).appendUint32(69).appendUint32(e.byteLength).appendBuffer(n,24).build(),a=le(e),r=I("V001"),c=(new ye).appendUint8(Xs.resBinVer).appendUint16(30,!0).appendBuffer(r,4).appendUint8(49).appendUint8(48).appendUint32(2147483647,!0).appendUint32(69,!0).appendUint32(e.byteLength,!0).appendUint32(a,!0).appendUint32(1,!0).appendUint32(32,!0).build();g.debug("tlvHeader",v(c),c.byteLength);let o=le(c)>>>0,d=(new ye).appendUint32(o,!0).appendBuffer(c).appendBuffer(s).appendBuffer(e).appendBuffer(c).build(),h=d.byteLength,l=le(d),p=(new ye).appendUint8(Xs.binCfg).appendUint16(33,!0).appendUint8(1).appendUint8(0).appendUint8(49).appendUint32(2147483647,!0).appendUint16(0,!0).appendUint32(103,!0).appendUint32(h,!0).appendUint32(l,!0).appendUint32(h,!0).appendUint32(l,!0).appendUint32(7,!0).build(),u=(new ye).appendUint8(Xs.subBinDesc).appendUint16(c.byteLength+p.byteLength,!0).appendBuffer(c).appendBuffer(p).build(),f=I(i.model),m=I("H10"),U=(new ye).appendUint8(Xs.fileDesc).appendUint16(21,!0).appendUint8(1).appendBuffer(f,5).appendBuffer(m,3).appendUint32(103,!0).appendUint32(h,!0).appendUint32(l,!0).build(),w=(new ye).appendBuffer(U).appendBuffer(u).build(),y=le(w),S=(new ye).appendUint8(Xs.hdr).appendUint16(w.byteLength,!0).appendBuffer(w).build();y=le(S.slice(0,99));let b=(new ye).appendUint32(y,!0).appendBuffer(S).build();return g.debug("lsf header",b.byteLength,v(b)),me(b,d)}function na(e){if(!e)return;let t=new ta,i=new Int8Array(e);try{return t.compress(i,3)}catch(t){g.error("压缩失败",e.byteLength,t)}}function sa(e,t,i){let n=4*t,s=new ye;s.appendUint32(4+(t<<10)+(i<<21),!0);for(let a=0;a<i;a++)for(let i=0;i<t;i++){let t=n*a+4*i,r=e[t],c=e[t+1],o=e[t+2];r=aa(r,5),c=aa(c,6),o=aa(o,5),r>248&&(r=248),c>252&&(c=252),o>248&&(o=248);let d=r<<8|c<<3|o>>>3;s.appendUint16(d)}return s.build()}function aa(e,t){let i=1<<8-t,n=e/i,s=Math.floor(n);return 10*n%10>5&&(s+=1),s*i}!function(e){e[e.hdr=32]="hdr",e[e.fileDesc=1]="fileDesc",e[e.subBinDesc=34]="subBinDesc",e[e.binCfg=3]="binCfg",e[e.codeBinVer=4]="codeBinVer",e[e.resBinVer=5]="resBinVer"}(Xs||(Xs={}));!function(e){e[e.unReady=0]="unReady",e[e.unLuanch=1]="unLuanch",e[e.palying=2]="palying",e[e.pause=3]="pause"}(ea||(ea={}));var ra=Object.freeze({__proto__:null,AlarmClockSetting:class{constructor(e=!0,t=[]){this.tag=105,this.enable=e,this.alarmClocks=t}getBytes(){let e=this.alarmClocks,t=(new ye).appendUint8(this.tag).appendUint8(1).appendUint8(this.enable).appendUint8(e.length);for(let i=0;i<e.length;i++){let n=e[i];t.appendUint8(n.index).appendUint8(n.enable).appendUint8(n.hour).appendUint8(n.minute).appendUint8(n.repeatTime).appendUint8(n.vibrationType).appendUint8(n.vibrationTime).appendUint8(n.vibrationLevel1).appendUint8(n.vibrationLevel2)}return t.build()}},AntiLostSetting:class{constructor(e=!0){this.tag=111,this.enable=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.enable).build()}},AutoRecognitionSportSetting:class{constructor(e=[]){this.tag=162,this.configs=e}getBytes(){let e=(new ye).appendUint8(this.tag),t=this.configs;e.appendUint8(t.length);for(let i=0;i<t.length;i++){let n=t[i];e.appendUint8(n.sportMode),e.appendUint8(n.enable)}return e.build()}},CustomPagesSetting:mi,DialTypeSetting:class{constructor(e=1){this.tag=161,this.dialType=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.dialType).build()}},EncourageTargetSetting:class{constructor(e=!0,t=1,i=6e3){this.tag=165,this.enable=e,this.targetType=t,this.value=i}getBytes(e){if(ct(e)){let e=At.SportStepTarget;switch(this.targetType){case 1:e=At.SportStepTarget;break;case 5:e=At.ActiveHourTarget;break;case 6:e=At.SportTimeTarget;break;default:g.warn("不支持的类型",this.targetType)}return new kt([{tag:e,value:this.value}]).getBytes()}let t=(new ye).appendUint8(this.tag).appendUint8(this.enable).appendUint8(this.targetType);if(2===this.targetType)t.appendUint32(10*this.value);else t.appendUint32(this.value);return t.build()}},EventReminderSetting:Rt,HeartRateDetectSetting:class{constructor(e){this.tag=118,this.state=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.state).build()}},HeartRateSectionSetting:Ui,LanguageSetting:class{constructor(e="zh-CN"){this.tag=170,this.lang=e}getBytes(){let e=(new ye).appendUint8(this.tag),t=new Int8Array(S(this.lang)).buffer;return e.appendBuffer(t).appendUint32(0),e.build()}},MessageReminderSetting:class{constructor(e=!0,t=Ys.call,i){this.tag=106,this.enable=e,this.reminderType=t}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.reminderType).appendUint8(this.enable).appendUint8(0).appendUint8(0).appendUint8(60).appendUint8(9).appendUint8(9).build()}},NightModeSetting:class{constructor(e=!0,t=23,i=0,n=7,s=0){this.tag=119,this.enable=e,this.startHour=t,this.startMinute=i,this.endHour=n,this.endMinute=s}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.enable).appendUint8(this.startHour).appendUint8(this.startMinute).appendUint8(this.endHour).appendUint8(this.endMinute).build()}},NoDisturbSetting:class{constructor(e=!0,t=23,i=0,n=6,s,a=!0){this.tag=179,this.enable=e,this.startHour=t,this.startMinute=i,this.endHour=n,this.endMinute=s,this.isEnableRaise=a}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.enable).appendUint8(this.startHour).appendUint8(this.startMinute).appendUint8(this.endHour).appendUint8(this.endMinute).appendUint32(this.isEnableRaise,!1).appendUint32(0).build()}},PaceAndDistanceSetting:class{constructor(e,t){this.tag=171,this.pace=e,this.distance=t}getBytes(){return(new ye).appendUint8(this.tag).appendUint16(0).appendUint16(this.pace).appendUint32(this.distance).build()}},ScreenDirectionSetting:class{constructor(e=1){this.tag=125,this.orientation=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.orientation).build()}},SedentaryReminderSetting:Ct,SportControlSetting:class{constructor(e,t){this.tag=175,this.sportMode=e,this.start=t}getBytes(){return(new ye).appendUint8(this.tag).appendUint32(0).appendUint8(this.sportMode).appendUint8(!this.start).appendUint16(0).appendUint8(0).build()}getCmd(){return 175}},SportHeartRateReminderSetting:class{constructor(e,t,i){this.tag=168,this.enable=e,this.maxHr=t,this.minHr=i}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.maxHr).appendUint8(this.minHr).appendUint8(this.enable).build()}getCmd(){return 168}},SwimmingParamsSetting:class{constructor(e=25){this.tag=172,this.length=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.length).build()}getCmd(){return 172}},TimeFormatSetting:vi,WearingHabitsSetting:class{constructor(e=0){this.tag=122,this.wearingHabits=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.wearingHabits).build()}getCmd(){return 122}},WeatherSetting:class{constructor(e,t=[]){this.tag=166,this.updateTime=e,this.weathers=t}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint32(this.updateTime).appendUint8(this.weathers.length);for(let t=0;t<this.weathers.length;t++){let i=this.weathers[t];e.appendUint8(i.weatherCode).appendUint8(i.minTemperature).appendUint8(i.maxTemperature).appendUint16(i.aqi,!1)}return e.build()}getCmd(){return 166}},GpsStatusSetting:class{constructor(e){this.tag=167,this.enable=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(1).appendUint8(this.enable).appendUint32(0).appendUint16(0).appendUint8(0).build()}},SportStatusSetting:class{constructor(e,t=1){this.tag=225,this.gpsStatus=e,this.mode=t}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.mode).appendUint8(this.gpsStatus).appendUint32(0).appendUint16(0).appendUint8(0).build()}getCmd(){return 225}},RandomNumSetting:class{constructor(e){this.tag=123,this.randomNum=e}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(0);for(let t=0;t<6;t++)e.appendUint8(this.randomNum.charCodeAt(t));return e.build()}},OldMsgReminderSetting:class{constructor(e=!0,t=1,i){this.tag=161,this.enable=e,this.reminderType=t,this.appId=i}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(this.enable).appendUint8(this.reminderType),t=this.appId;if(t){e.appendUint8(t.length);let i=new Int8Array(S(t)).buffer;e.appendBuffer(i)}return e.build()}},ControlDeviceSetting:ni,HeartRateWarningSetting:Ui,MultipleSetting:kt,NewEventRemindSetting:wi,PushDialSetting:class{constructor(e,t="",i=2,n="",s="",a=0,r=0,c=new ArrayBuffer(0),o,d){this.tag=249,this.dialIndex=e,this.id=t,this.dailType=i,this.fileName=n,this.backgroundImageName=s,this.styleId=a,this.colorId=r,this.fileBuf=c,this.onUpgradeProcess=o,this.onUpgradeComplete=d}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(this.dialIndex),t=I(y(this.id,32));e.appendUint8(t.byteLength).appendBuffer(t).appendUint8(this.dailType);let i=I(y(this.fileName,32));e.appendUint8(i.byteLength).appendBuffer(i);let n=I(y(this.backgroundImageName,32));return e.appendUint8(n.byteLength).appendBuffer(n).appendUint8(this.styleId).appendUint8(this.colorId),e.build()}},DialEnableSetting:class{constructor(e,t){this.tag=247,this.dailNoList=t,this.dailIndex=e}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint8(this.dailIndex).appendUint8(this.dailNoList.length);return this.dailNoList.forEach((t=>{e.appendUint8(t)})),e.appendUint8(this.dailIndex),e.build()}},packingWatchFaceFile:function(e,t=120,i=240,n,s=90,a=180,r){let c=sa(e,t,i),o=sa(n,s,a),d=me(c,o);g.debug("bin image buf",c.byteLength,o.byteLength,d.byteLength);let h=ia(d,"WatchFace-Custom",Ts(r));return g.debug("lsf buf",h.byteLength),h},compress:function(e,t="",i){let n=I(t).slice(0,24),s=(new ye).appendUint32(69).appendUint32(e.byteLength).appendBuffer(n,24).build(),a=le(e),r=I("V001"),c=(new ye).appendUint8(Xs.resBinVer).appendUint16(30,!0).appendBuffer(r,4).appendUint8(49).appendUint8(48).appendUint32(2147483647,!0).appendUint32(69,!0).appendUint32(e.byteLength,!0).appendUint32(a,!0).appendUint32(1,!0).appendUint32(32,!0).build();g.debug("tlvHeader",v(c),c.byteLength);let o=le(c)>>>0,d=(new ye).appendUint32(o,!0).appendBuffer(c).appendBuffer(s).appendBuffer(e).appendBuffer(c).build();g.debug("tlvBin",v(d.slice(0,16)),d.byteLength);let h=e.byteLength,l=0,p=new ye,u=0;do{let t=d.slice(l,l+2048),i=na(t);i&&i.byteLength>0&&(0===u&&g.debug("zipImageBytes",e.byteLength,i.byteLength,t.byteLength,v(i)),u+=1,p.appendBuffer(i)),l+=2048}while(l<h);let f=p.build(),m=le(f);g.debug("lzobytes",f.byteLength,v(f.slice(0,32),v(f.slice(f.byteLength-16))));let U=le(e)>>>0,w=(new ye).appendUint8(Xs.binCfg).appendUint16(33,!0).appendUint8(1).appendUint8(32).appendUint8(49).appendUint32(2147483647,!0).appendUint16(8,!0).appendUint32(103,!0).appendUint32(f.byteLength,!0).appendUint32(m,!0).appendUint32(e.byteLength,!0).appendUint32(U,!0).appendUint32(7,!0).build(),y=(new ye).appendUint8(Xs.subBinDesc).appendUint16(c.byteLength+w.byteLength,!0).appendBuffer(c).appendBuffer(w).build(),S=I(i.model),b=I("H10"),D=(new ye).appendUint8(Xs.fileDesc).appendUint16(21,!0).appendUint8(1).appendBuffer(S,5).appendBuffer(b,3).appendUint32(103,!0).appendUint32(f.byteLength,!0).appendUint32(m,!0).build(),T=(new ye).appendBuffer(D).appendBuffer(y).build(),B=le(T),C=(new ye).appendUint8(Xs.hdr).appendUint16(T.byteLength,!0).appendBuffer(T).build();B=le(C.slice(0,99));let R=(new ye).appendUint32(B,!0).appendBuffer(C).build();return g.debug("lsf header",R.byteLength,v(R)),me(R,f)},unCompress:ia,LoginBindResp:nt,SportHeartRateSectionSetting:class{constructor(e=20,t,i,n,s,a){this.tag=116,this.age=e,this.level0=t,this.level1=i,this.level2=n,this.level3=s,this.level4=a}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.age).appendUint8(this.level0).appendUint8(this.level1).appendUint8(this.level2).appendUint8(this.level3).appendUint8(this.level4).appendUint8(0).build()}},HeartRateWarningCycleSetting:class{constructor(e=!0,t=0){this.tag=246,this.heartRateWaringCycle=t,this.enable=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.enable).appendUint8(this.heartRateWaringCycle).build()}},BindResp:si,ReminderSetting:class{constructor(e=[],t=4,i=!0){this.tag=254,this.dataType="reminder",this.reminderType=t,this.enable=i,this.list=e}getBytes(e){if(ot(e)){let e=(new ye).appendUint8(this.tag).appendUint8(this.reminderType).appendUint8(this.enable);return this.enable&&(this.list&&this.list.length>0?(e.appendUint8(this.list.length),this.list.forEach((t=>{e.appendUint8(t.index).appendUint8(t.enable).appendUint8(t.startHour).appendUint8(t.startMinute).appendUint8(t.endHour).appendUint8(t.endMinute).appendUint8(t.reminderMode),0===t.reminderMode?(e.appendUint8(t.reminderHour),e.appendUint8(t.reminderMinute)):e.appendUint16(t.frequency),e.appendUint8(t.repeatTime).appendUint8(t.vibrationTime).appendUint8(t.vibrationType).appendUint8(t.vibrationLevel1).appendUint8(t.vibrationLevel2).appendUint8(t.noDisturbEnable).appendUint8(t.noDisturbStartHour).appendUint8(t.noDisturbStartMinute).appendUint8(t.noDisturbEndHour).appendUint8(t.noDisturbEndMinute)}))):e.appendInt8(0)),e.build()}try{let e=this.list[0];return new Ct(e.enable,e.startHour,e.startMinute,e.endHour,e.endMinute,e.frequency,e.repeatTime,e.vibrationType,e.vibrationTime,e.vibrationLevel1,e.vibrationLevel2).getBytes()}catch(e){return}}parserBuf(e){let t=new ve(e);this.reminderType=t.readUint8(),this.enable=t.readUint8()>0;let i=t.readUint8(),n=[];for(let e=0;e<i;e++){let e=t.readUint8(),i=t.readUint8(),s=t.readUint8(),a=t.readUint8(),r=t.readUint8(),c=t.readUint8(),o=t.readUint8(),d={};if(0===o){d={frequency:t.readUint16()}}else{d={reminderHour:t.readUint8(),reminderMinute:t.readUint8()}}let h=t.readUint8(),l=t.readUint8(),p=t.readUint8(),u=t.readUint8(),g=t.readUint8(),f=t.readUint8(),m=t.readUint8(),U=t.readUint8(),w=t.readUint8(),v=t.readUint8();n.push({index:e,enable:i,startHour:s,startMinute:a,endHour:r,endMinute:c,reminderMode:o,...d,repeatTime:h,vibrationType:l,vibrationTime:p,vibrationLevel1:u,vibrationLevel2:g,noDisturbEnable:f,noDisturbStartHour:m,noDisturbStartMinute:U,noDisturbEndHour:w,noDisturbEndMinute:v})}return this.list=n,this}},MsgNotifySetting:class{constructor(e,t,i,n=0){this.serviceId=We,this.tag=4,this.msgType1=4,this.msgInfo=e,this.count=t,this.appType=i,this.msgType2=n}getBytes(){let e=(new ye).appendUint8(this.msgType1).appendUint8(this.msgType2).appendUint16(this.appType).appendUint8(this.count);e.appendUint32(this.msgInfo.msgId);let t=I(this.msgInfo.title);return e.appendUint16(t.byteLength),e.appendBuffer(t),e.build()}},CallNotifySetting:class{constructor(e,t=0){this.tag=1,this.serviceId=We,this.msgType1=1,this.msgType2=t,this.content=e}getBytes(){let e=I(this.content);return(new ye).appendUint8(this.msgType1).appendUint8(this.msgType2).appendBuffer(e).build()}},NewWeatherSetting:class{constructor(e,t=[],i=""){this.tag=49,this.utc=e,this.weathers=t,this.cityName=i}getBytes(){let e=(new ye).appendUint8(this.tag).appendUint32(this.utc).appendUint8(this.weathers.length);for(let t=0;t<this.weathers.length;t++){let i=this.weathers[t];e.appendUint8(i.weatherCode).appendInt8(i.currentTemperature||0).appendUint8(i.maxTemperature||0).appendInt8(i.minTemperature||0).appendUint8(i.windSpeed).appendUint8(i.humidity).appendUint8(i.uvIndex).appendUint16(i.aqi).appendUint8(i.sunriseHour).appendUint8(i.sunriseMinute).appendUint8(i.sunsetHour).appendUint8(i.sunsetMinute)}let t=I(this.cityName);return e.appendUint8(1).appendUint8(t.byteLength).appendBuffer(t),e.build()}getCmd(){return 166}},ControlMusicAndDeviceSettting:Fi,MusicInfoSetting:class{constructor(e){this.tag=242,this.info=e}getBytes(){let e=y(this.info.musicName,90),t=y(this.info.author||"N",90),i=y(this.info.album||"N",90),n=I(e),s=I(i),a=I(t);return(new ye).appendUint8(this.tag).appendUint8(this.info.playStatus||0).appendUint8(this.info.volLevel||0).appendUint16(this.info.playTime||0).appendUint16(this.info.duration||0).appendUint8(this.info.collectionFlag||0).appendUint8(n.byteLength).appendBuffer(n).appendUint8(a.byteLength).appendBuffer(a).appendUint8(s.byteLength).appendBuffer(s).appendUint8(0).appendUint8(this.info.maxVol||0).appendUint16(0).build()}},StepData:st,StepHistoryData:class{constructor(e,t){this.dataType="a5StepHistroy",this.cmd=t,this.list=[];let i=0;for(;i<e.byteLength;){let t=new ve(e,i).getUint24("step",!1).getUint32("utc",!1).getSFloat("examount").getFloat("calories",!1).getUint16("exerciseTime").getUint16("distance").getUint8("status").getUint8("batteryVoltage"),n=t.build();i=t.getByteOffset(),this.list.push(n)}}},DailyData:qe,HeartRateData:$e,HeartRateSectionData:class{constructor(e,t){this.dataType="a5HRSection",this.cmd=t,new ve(e).getUint32("utc").getUint16("section1Time").getUint16("section2Time").getUint16("section3Time").build(this),this.section1Time*=2,this.section2Time*=2,this.section3Time*=2}},SleepData:Ze,SportCaloriesData:Ge,SportPaceData:Je,SportReportData:Xe,SportStatusData:et,DeviceInfoData:je});var ca=Object.freeze({__proto__:null,BeginToJumpSetting:class{constructor(e,t,i,n){this.tag=129,this.jumpMode=e,this.settingContent=t,this.utc=i,this.numberOfCountdown=n}getBytes(){return(new ye).appendInt8(this.jumpMode).appendUint16(this.settingContent,!0).appendUint32(this.utc,!0).appendUint16(this.numberOfCountdown,!0).build()}},EndToJumpSetting:class{constructor(){this.tag=130}getBytes(){return(new ye).appendInt8(0).build()}},MioSyncTimeSetting:Hn,MioJumpRealtimeData:_n,MioJumpResultData:Wn});var oa=Object.freeze({__proto__:null,FindBox:class{constructor(){this.tag=8}getBytes(){return(new ye).appendUint8(this.tag).build()}},SyncBoxData:as,BoxTiming:class{constructor(e,t){this.tag=48,this.mode=0,this.times=t,this.index=e}getBytes(){return(new ye).appendUint8(this.tag).appendUint8(this.index).appendUint8(this.times.length).build()}}});const da={...ra,...Ji,...ca,...oa};let ha={appId:""};const la=0,pa=3,ua=4,ga=5,fa="adaptorState",ma="connectionState",Ua="dataReport";function wa(){if(!ha.appId||0==ha.appId.length)throw"未初始化或appId 无效"}function va(){return"1.0.12"}function ya(e){e.appKey&&e.appKey.length>0&&(e.appId=e.appKey),ha=e,Rs.init({platform:"wx",printScanResult:!1,discoverDelay:0,...e}),e.needUI?(initDeviceManager(),l(e),syncDeviceList(),Zs(e.appKey,!1)):Zs(e.appId,!0)}function Sa(e){wa(),Rs.scanDevice("startScanning",e,0)}function ba(){wa(),Rs.stopScan("startScanning")}async function Ia(t){wa();let i=t.mac,n=t.callback,s={onApplyRegisterId:t=>new Promise(((s,a)=>{console.log("plugin","onApplyRegisterId",t);let r=t.deviceInfo.model,c=t.deviceInfo.hardwareVersion,o=t.deviceInfo.softwareVersion;e({mac:i,model:r,hardwareVersion:c,softwareVersion:o}).then((e=>{200===e.code&&e.data.deviceId?s(e.data.deviceId):(a("请求third deviceId 失败"),n({mac:i,deviceInfo:t.deviceInfo,bindState:5}))})).catch((e=>{a(e),n({mac:i,deviceInfo:t.deviceInfo,bindState:5})}))})),onInputRandomNum:e=>{this.pageStatus=3,this.randomNum=e,n({mac:i,deviceInfo:La(i),bindState:0})},onReadDeviceId:e=>{},onReadDeviceInfo:e=>{},onWaitUserSelect:e=>{console.log("plugin","onWaitUserSelect")},onDeviceAuth:e=>Js({mac:i,model:e.deviceInfo.model})},a={listeners:s,userInfo:{height:170,weight:60}};Rs.bind(i,a,((e,t)=>{switch(t){case 0:case 1:case 2:case 3:break;case 4:i={mac:e},Array.isArray(i)?device.forEach((async e=>{_s.add(e.mac)})):_s.add(i.mac),Ks(),n({mac:e,deviceInfo:La(e),bindState:4});break;default:console.log("绑定状态变化",t)}var i})).catch((e=>{console.log("绑定失败",e),n({mac:i,deviceInfo:La(i),bindState:5,errorCode:e.code})}))}function Da(e){wa(),Rs.cancelWork(e.mac,!0)}function Ta(e){wa();let t={fileBuffer:e.fileBuffer,model:e.model,onUpgradeProcess:e.onUpgradeProcess,onUpgradeComplete:e.onUpgradeComplete};try{return Rs.ota(e.mac,t,null)}catch(e){console.debug("error",e)}}function Ba(e){wa(),Rs.cancelSetting(e.mac)}function Ca(e){return wa(),Rs.getConnectionState(e.mac)}function Ra(){return wa(),Rs.checkUserLocationAvailable()}function Aa(e){return wa(),Rs.pushSetting(e.mac,e.setting)}function ka(e){wa(),Rs.$on(e.eventName,e.eventKey,e.callback)}function Fa(e){Rs.$off(e.eventName,e.eventKey)}function xa(e){return wa(),Rs.getSetting(e.mac,e.settingType)}function Ma(e){return Rs.cancelSetting(e)}function La(e){return Rs.getDeviceInfo(e)}function Ea(e){return Rs.cancelWork(e,!0)}function Pa(e,t,i){return Rs.syncData(e,t,i)}function Oa(e){Gs(e)}function Ha(e){var t;t=e,_s.clear(),Gs(t)}function Va(){_s.clear(),Ks()}function Na(e){!function(e){_s.remove(e.mac),Ks()}(e)}var _a={getVersion:va,init:ya,startScanning:Sa,stopScanning:ba,bindDevice:Ia,cancelBind:Da,getConnectionState:Ca,isBluetoothAvailable:Ra,pushSetting:Aa,addMonitorDevice:Oa,setMonitorDevice:Ha,deleteAllMonitorDevice:Va,deleteMonitorDevice:Na,cancelSetting:Ma,ota:Ta,cancelOta:Ba,$on:ka,$off:Fa,settingFactory:da,getDeviceInfo:La,getSetting:xa,connectDevice:Pa,disconnect:Ea};export{Fa as $off,ka as $on,fa as AdaptorStateEventName,ga as BINDSTATE_Failure,la as BINDSTATE_InputRandomNumber,pa as BINDSTATE_InputUserNumberAndBindResult,ua as BINDSTATE_Successful,ma as ConnectionStateEventName,Ua as DataReportEventName,Oa as addMonitorDevice,Ia as bindDevice,Da as cancelBind,Ba as cancelOta,Ma as cancelSetting,Pa as connectDevice,_a as default,Va as deleteAllMonitorDevice,Na as deleteMonitorDevice,Ea as disconnect,Ca as getConnectionState,La as getDeviceInfo,xa as getSetting,va as getVersion,ya as init,Ra as isBluetoothAvailable,Ta as ota,Aa as pushSetting,Ha as setMonitorDevice,da as settingFactory,Sa as startScanning,ba as stopScanning};

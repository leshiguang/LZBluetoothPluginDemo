module.exports = (function() {
var __MODS__ = {};
var __DEFINE__ = function(modId, func, req) { var m = { exports: {}, _tempexports: {} }; __MODS__[modId] = { status: 0, func: func, req: req, m: m }; };
var __REQUIRE__ = function(modId, source) { if(!__MODS__[modId]) return require(source); if(!__MODS__[modId].status) { var m = __MODS__[modId].m; m._exports = m._tempexports; var desp = Object.getOwnPropertyDescriptor(m, "exports"); if (desp && desp.configurable) Object.defineProperty(m, "exports", { set: function (val) { if(typeof val === "object" && val !== m._exports) { m._exports.__proto__ = val.__proto__; Object.keys(val).forEach(function (k) { m._exports[k] = val[k]; }); } m._tempexports = val }, get: function () { return m._tempexports; } }); __MODS__[modId].status = 1; __MODS__[modId].func(__MODS__[modId].req, m, m.exports); } return __MODS__[modId].m.exports; };
var __REQUIRE_WILDCARD__ = function(obj) { if(obj && obj.__esModule) { return obj; } else { var newObj = {}; if(obj != null) { for(var k in obj) { if (Object.prototype.hasOwnProperty.call(obj, k)) newObj[k] = obj[k]; } } newObj.default = obj; return newObj; } };
var __REQUIRE_DEFAULT__ = function(obj) { return obj && obj.__esModule ? obj.default : obj; };
__DEFINE__(1646020212293, function(require, module, exports) {
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).RollupLearn={})}(this,(function(e){const t=e=>i({path:"/device-rest/api/device/apply/v1.0/applyDeviceIdForBTSDK",data:e});function i(e){return new Promise(((t,i)=>{console.debug("post",e),wx.request({url:"https://api-r1.leshiguang.com"+e.path,method:"POST",data:e.data,header:{"content-type":"application/json","Accept-Encoding":"gzip, deflate"},success(e){console.debug("请求成功",e.data,e),t(e.data)},fail(e){console.error("请求失败",e),i(e)}})}))}function n(e){return function(e){for(var t="0123456789abcdef",i="",n=0;n<4*e.length;n++)i+=t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15);return i}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var i=1732584193,n=-271733879,r=-1732584194,h=271733878,l=0;l<e.length;l+=16){var u=i,f=n,v=r,p=h;i=s(i,n,r,h,e[l+0],7,-680876936),h=s(h,i,n,r,e[l+1],12,-389564586),r=s(r,h,i,n,e[l+2],17,606105819),n=s(n,r,h,i,e[l+3],22,-1044525330),i=s(i,n,r,h,e[l+4],7,-176418897),h=s(h,i,n,r,e[l+5],12,1200080426),r=s(r,h,i,n,e[l+6],17,-1473231341),n=s(n,r,h,i,e[l+7],22,-45705983),i=s(i,n,r,h,e[l+8],7,1770035416),h=s(h,i,n,r,e[l+9],12,-1958414417),r=s(r,h,i,n,e[l+10],17,-42063),n=s(n,r,h,i,e[l+11],22,-1990404162),i=s(i,n,r,h,e[l+12],7,1804603682),h=s(h,i,n,r,e[l+13],12,-40341101),r=s(r,h,i,n,e[l+14],17,-1502002290),i=o(i,n=s(n,r,h,i,e[l+15],22,1236535329),r,h,e[l+1],5,-165796510),h=o(h,i,n,r,e[l+6],9,-1069501632),r=o(r,h,i,n,e[l+11],14,643717713),n=o(n,r,h,i,e[l+0],20,-373897302),i=o(i,n,r,h,e[l+5],5,-701558691),h=o(h,i,n,r,e[l+10],9,38016083),r=o(r,h,i,n,e[l+15],14,-660478335),n=o(n,r,h,i,e[l+4],20,-405537848),i=o(i,n,r,h,e[l+9],5,568446438),h=o(h,i,n,r,e[l+14],9,-1019803690),r=o(r,h,i,n,e[l+3],14,-187363961),n=o(n,r,h,i,e[l+8],20,1163531501),i=o(i,n,r,h,e[l+13],5,-1444681467),h=o(h,i,n,r,e[l+2],9,-51403784),r=o(r,h,i,n,e[l+7],14,1735328473),i=c(i,n=o(n,r,h,i,e[l+12],20,-1926607734),r,h,e[l+5],4,-378558),h=c(h,i,n,r,e[l+8],11,-2022574463),r=c(r,h,i,n,e[l+11],16,1839030562),n=c(n,r,h,i,e[l+14],23,-35309556),i=c(i,n,r,h,e[l+1],4,-1530992060),h=c(h,i,n,r,e[l+4],11,1272893353),r=c(r,h,i,n,e[l+7],16,-155497632),n=c(n,r,h,i,e[l+10],23,-1094730640),i=c(i,n,r,h,e[l+13],4,681279174),h=c(h,i,n,r,e[l+0],11,-358537222),r=c(r,h,i,n,e[l+3],16,-722521979),n=c(n,r,h,i,e[l+6],23,76029189),i=c(i,n,r,h,e[l+9],4,-640364487),h=c(h,i,n,r,e[l+12],11,-421815835),r=c(r,h,i,n,e[l+15],16,530742520),i=a(i,n=c(n,r,h,i,e[l+2],23,-995338651),r,h,e[l+0],6,-198630844),h=a(h,i,n,r,e[l+7],10,1126891415),r=a(r,h,i,n,e[l+14],15,-1416354905),n=a(n,r,h,i,e[l+5],21,-57434055),i=a(i,n,r,h,e[l+12],6,1700485571),h=a(h,i,n,r,e[l+3],10,-1894986606),r=a(r,h,i,n,e[l+10],15,-1051523),n=a(n,r,h,i,e[l+1],21,-2054922799),i=a(i,n,r,h,e[l+8],6,1873313359),h=a(h,i,n,r,e[l+15],10,-30611744),r=a(r,h,i,n,e[l+6],15,-1560198380),n=a(n,r,h,i,e[l+13],21,1309151649),i=a(i,n,r,h,e[l+4],6,-145523070),h=a(h,i,n,r,e[l+11],10,-1120210379),r=a(r,h,i,n,e[l+2],15,718787259),n=a(n,r,h,i,e[l+9],21,-343485551),i=d(i,u),n=d(n,f),r=d(r,v),h=d(h,p)}return Array(i,n,r,h)}(function(e){for(var t=Array(),i=255,n=0;n<8*e.length;n+=8)t[n>>5]|=(e.charCodeAt(n/8)&i)<<n%32;return t}(e),8*e.length))}function r(e,t,i,n,r,s){return d((o=d(d(t,e),d(n,s)))<<(c=r)|o>>>32-c,i);var o,c}function s(e,t,i,n,s,o,c){return r(t&i|~t&n,e,t,s,o,c)}function o(e,t,i,n,s,o,c){return r(t&n|i&~n,e,t,s,o,c)}function c(e,t,i,n,s,o,c){return r(t^i^n,e,t,s,o,c)}function a(e,t,i,n,s,o,c){return r(i^(t|~n),e,t,s,o,c)}function d(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}let h={};var l={set(e,t){h[e]=t},get:e=>h[e]};function u(e){let t=e;t?l.set("options",t):t=l.get("options");let i=(new Date).getTime(),r=t.appKey,s=t.appSecret,o=new Array(i,r,s,"1.0"),c=((a=o).sort(),n(a.join("")).toUpperCase());var a;l.set("secretSign",`api_appKey=${r}&signSecret=${s}&api_sign=${c}&api_timestamp=${i}&api_version=1.0&associatedId=${t.associatedId}`),l.set("userId",t.userId),l.set("appId","wxe3d2a6ab8dd5b49b")}[{key:"baseUrl",defaultValue:"https://api.leshiguang.com",desc:"请求url"},{key:"secretSign",defaultValue:"2a6bfL45*2219cZi44c7f78231e3cF80ensea13072eSb672_!",desc:"ajax请求签名key"}].forEach((({key:e,defaultValue:t})=>{l.set(e,t)}));let f=console;const v="LS-BLE";var p={constructor(){this.isOtaing=!1},debugMode:()=>!0,isPrintValueChange(){return!(!f||!f.printValueChange)||null!=this.printValueChange&&null!=this.printValueChange&&this.printValueChange},setOtaing(e){this.isOtaing=e},setPrintValueChange(e){this.printValueChange=e},isPrintWrite(){return null==this.printWrite||this.printWrite},setPrintWrite(e){this.printWrite=e},debug(...e){this.isOtaing||(e.unshift(m(),v),f.debug(...e))},debugValueChange(...e){this.isPrintValueChange()&&e.unshift(m(),v),this.isPrintValueChange()&&f.debug(...e)},info(...e){this.isOtaing||(e.unshift(m(),v),f.info(...e))},warn(...e){e.unshift(m(),v),f.warn(...e)},error(...e){e.unshift(m(),v),f.error(...e)},logE(...e){e.unshift(m(),v),f.error(...e)},log(...e){this.isOtaing||(e.unshift(m(),v),f.info(...e))},logIos(...e){e.unshift(m(),v),f.error(...e)},logBle(...e){e.unshift(m(),"<ble>"),f.warn(...e)},logBleError(...e){e.unshift(m(),"<ble>"),f.error(...e)},setLogger(e){f=e}};const g=e=>(e=e.toString())[1]?e:"0"+e;function m(){const e=new Date;return"["+[e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()].map(g).join(":")+"]"}function w(e){switch(e){case 0:return"成功";case 1:return"未连接";case 2:return"没有特征服务";case 3:return"超时";case 4:return"丢弃";case 13:return"用户取消了绑定";case 14:return"手环已绑定";case 5:return"设备报错";case 6:return"蓝牙库报错";case 8:return"文件不支持";case 15:return"参数错误";case 16:return"内存不足";case 9:return"电量低";case 12:case 19:return"未发现设备";case 11:return"鉴权失败";case 10:return"不支持";case 7:return"工作繁忙";case 30:return"写数据错误";case 20:return"未开启定位权限";case 21:return"没有蓝牙权限";case 25:return"为实现申请deviceId方法";default:return"未知错误"}}var S={success:function(e=null,t=null,i=0){return{success:!0,msg:"success",value:t,originResponse:e,data:e,code:i}},fail:function(e="",t=null,i=null){return{success:!1,msg:e,value:i,originResponse:t,data:t}},failCode:function(e=-1,t="",i=null,n=null,r=null){return{success:!1,msg:t,value:n,originResponse:i,data:i,extra:r,code:e}},errorCode:function(e=0,t=null,i=null,n=null){return{success:0===e,msg:w(e),value:i,originResponse:t,data:t,extra:n,code:e}}};class I{constructor({uuid:e,isPrimary:t}){this.uuid=e.toUpperCase(),this.isPrimary=t,this.characteristics=[]}}function C(e,t){if(!e)return"";if("string"==typeof e)return e;let i=Array.prototype.map.call(new Uint8Array(e),(function(e){return("00"+e.toString(16)).slice(-2)}));if(t){let e=[];for(let t=0;t<i.length;t++)e.push(i[i.length-1-t]);return e.join("")}return i.join("")}let y=wx.getSystemInfoSync();function k(){return y.platform.toLowerCase().indexOf("ios")>-1}function D(e){return e&&e.length>8?e.toString().substring(4,8):e}const M="0000180A-0000-1000-8000-00805F9B34FB",A="00002A25-0000-1000-8000-00805F9B34FB";var b=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((n=n.apply(e,t||[])).next())}))};class x{constructor(e,t,i,n,r){this.completion=[],this.count=1,this.deviceId=e,this.connector=t,this.disConnector=i,this.connectMode=n,this.sid=Math.random(),this.timeout=r+1e3}start(){return b(this,void 0,void 0,(function*(){this.resetTimeout();try{0===this.connectMode?(yield this.connector(this.deviceId,this.timeout-1e3),this.callback(S.errorCode(0,"连接成功3"))):(yield this.disConnector(this.deviceId),this.callback(S.errorCode(0,"断开连接")))}catch(e){this.callback(e)}}))}resetTimeout(){this._clearTimeout();let e=this;this.timeoutId=setTimeout((()=>{e.callback(S.errorCode(3,"超时"))}),this.timeout)}_clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}callback(e){this._clearTimeout(),this.completion&&(e.sid=this.sid,this.completion.forEach((t=>{t(e)})),this.completion=null),this.isClear=!0}clear(){this.disConnector(this.deviceId),this.callback(S.errorCode(4))}}var P=new class{constructor(){this.sessionList=new Array}connect(e,t,i){p.debug("deviceId",e);let n=this.findSession(e);n&&0===n.connectMode&&0===n.connectMode?n.completion.push(i):(this.sessionList.push(this.createSession(e,0,i,t)),this.dispatchNextAction())}disConnect(e,t,i){let n=this.findSession(e);n&&1===n.connectMode?n.completion.push(i):(this.sessionList.push(this.createSession(e,1,i,t)),this.dispatchNextAction())}dispatchNextAction(){if(!this.workingSession&&this.sessionList.length>0){let e=this.sessionList[0];this.sessionList.shift(),this.workingSession=e,e.start()}else this.workingSession}cancelCurrentSession(){this.workingSession&&(this.workingSession.clear(),this.workingSession=null)}createSession(e,t,i,n){let r=new x(e,this.connector,this.disConnector,t,n),s=this;return r.completion.push((e=>{s.workingSession&&(s.workingSession=null),i&&i(e),s.dispatchNextAction()})),r}findSession(e){let t=null;this.workingSession&&this.workingSession.deviceId===e&&(t=this.workingSession);for(let i=0;i<this.sessionList.length;i++){let n=this.sessionList[i];if(n.deviceId===e){t=n;break}}return t}clear(){try{this.workingSession&&(this.workingSession.clear(),this.workingSession=null),this.sessionList.forEach((e=>{e.callback(S.errorCode(4))})),this.sessionList.length=0}catch(e){p.warn("操作取消",e)}}};const B=new Map,T=new Map,W=new Map,L=new Map,E=new Map,R=new Map;var U=null,_=null;const V="ble-next";function j(e,t){T.set(e,t)}function N(e,t){B.set(e,t)}function O(e,t,i){let n=R.get(t);n||(n=new Map,R.set(t,n)),n.set(e,i)}function $(e){let t=E.get(e);t&&t.forEach((t=>{t&&t({deviceId:e,connected:!1})})),B.forEach((t=>{t({deviceId:e,connected:!1})}))}var F,z=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((n=n.apply(e,t||[])).next())}))};class K{constructor(e){this.isConnectingAndReadDeviceInfo=!1,this.deviceInfo=new Map,this.serviceMap=new Map,this.readTimeoutMap=new Map,this.clientDataChangeListener=new Map,this.writBufferQueue=[],this.deviceId=e,this.performance={},this.isRecycle=!1,this.deviceInfoCharacteristics=[],this.setDefaultDataChange()}recycle(){this.resetState()}setDefaultDataChange(){let e=this;O("_c",this.deviceId,(t=>{t.serviceId===M&&e.deviceInfo.set(t.characteristicId,t.value),e.clientDataChangeListener.forEach(((i,n)=>{i(t)&&e.clientDataChangeListener.delete(n)}))})),function(e,t,i){let n=E.get(t);n||(n=new Map,E.set(t,n)),n.set(e,i)}("_c",this.deviceId,(t=>{e.connected=t.connected,t.connected||e.resetState()}))}connect(e=1e4){return this.writing=!1,new Promise(((t,i)=>{let n=this;P.connect(this.deviceId,e,(e=>{e.success?(n.connected=!0,t(e)):(n.connected=!1,i(e))}))}))}disconnect(){let e=this.deviceId;this.connected=!1;let t=this;return this.resetState(),p.info("disconnect",this.deviceId),new Promise(((i,n)=>{P.disConnect(e,0,(e=>{t.connected=!1,i(S.errorCode(0))}))}))}discoverServices(e){return p.logBle("discoverServices",this.deviceId),this.performance.getServicesStart=new Date,new Promise(((t,i)=>z(this,void 0,void 0,(function*(){var n;0!=e&&(yield(n=e,new Promise(((e,t)=>{setTimeout((()=>{e(null)}),n)}))));let r=this;wx.getBLEDeviceServices({deviceId:this.deviceId,success:e=>z(this,void 0,void 0,(function*(){if(!e||!e.services||0===e.services.length)return p.error("获取服务为空"),r.disconnect(),r.callbackDisConnectStateChanged(),void i(S.errorCode(6));let n=[];for(let t=0;t<e.services.length;t++){let i=(s=e.services[t].uuid).length>16?s:`0000${s}-0000-1000-8000-00805F9B34FB`;if(-1!=i.indexOf("1801"))continue;let o=new I(e.services[t]);n.push(o),r.serviceMap.set(i,o);let c=yield r.discoverCharacteristic(i);o.characteristics=c.originResponse}var s;r.services=n,r.isServiceDiscoveredFinished=!0,setTimeout((()=>{t(S.success(e))}),0)})),fail:e=>{p.error("获取服务失败: ",r.deviceId,e,r.services),10006===e.code?(r.disconnect(),r.callbackDisConnectStateChanged(),i(S.errorCode(1))):i(S.errorCode(6))},complete:e=>{try{let e=new Date;r.performance.getServicesEnd=e,r.performance.getCharacteristicsStart=e,r.performance.getServiceTime=e.getTime()-this.performance.getServicesStart.getTime()}catch(e){}}})}))))}makeBluetoothPair(e){return p.debug("makeBluetoothPair",e),new Promise(((e,t)=>{if(wx.makeBluetoothPair)wx.makeBluetoothPair({deviceId:this.deviceId,success:t=>{p.debug("makeBluetoothPair success",t),e(S.success(t))},fail:e=>{p.error("makeBluetoothPair fail",e),t(S.errorCode(6,e))}});else try{wx.sendNativeEvent("makeBluetoothPair",{deviceId:this.deviceId},(i=>{p.debug("makeBluetoothPair ret",i),i&&200===i.code?e(S.success(i)):t(S.errorCode(10,i))}))}catch(e){t(S.errorCode(10,e))}}))}discoverCharacteristic(e){let t=this.deviceId,i=this;return new Promise(((n,r)=>{wx.getBLEDeviceCharacteristics({deviceId:t,serviceId:e,success:t=>{p.logBle("discover char",D(e)),n(S.success(t.characteristics))},fail:n=>{p.error("discover fail: ",t,e,n),10006===n.code?(i.disconnect(),i.callbackDisConnectStateChanged(),r(S.errorCode(1))):r(S.errorCode(6))}})}))}enable(e,t){let i=this,n=this.deviceId;return p.warn("enable ",this.deviceId,D(e),D(t)),new Promise(((r,s)=>{wx.notifyBLECharacteristicValueChange({state:!0,deviceId:n,serviceId:e,characteristicId:t,success:i=>{p.debug("打开通道成功",e,t,i),r(S.success(i))},fail:t=>{p.error("打开通道失败:",e,n,t),10006===t.code?(i.disconnect(),i.callbackDisConnectStateChanged(),s(S.errorCode(1))):s(S.errorCode(6))}})}))}disable(e,t){let i=this;return p.warn("disable ",this.deviceId,D(e),D(t)),new Promise(((n,r)=>{wx.notifyBLECharacteristicValueChange({state:!1,deviceId:this.deviceId,serviceId:e,characteristicId:t,success:e=>{n(S.success(e))},fail:e=>{p.error("disable fail: ",this.deviceId,e),10006===e.code?(i.disconnect(),i.callbackDisConnectStateChanged(),r(S.errorCode(1))):r(S.errorCode(6))}})}))}read(e,t){let i=this;return new Promise(((n,r)=>{i.clearReadTimeout(t),O(t,i.deviceId,(r=>{r.serviceId===e&&r.characteristicId===t&&(i.clearReadTimeout(t),setTimeout((()=>{n(S.success(r))}),0))}));let s=setTimeout((()=>{i.clearReadTimeout(t),r(S.errorCode(3))}),3e3);i.readTimeoutMap.set(t,s),p.warn("读数据",D(t)),wx.readBLECharacteristicValue({deviceId:this.deviceId,serviceId:e,characteristicId:t,success:e=>{},fail:e=>{p.error("read fail: ",this.deviceId,e),10006===e.code?(i.disconnect(),i.callbackDisConnectStateChanged(),r(S.errorCode(1))):r(S.errorCode(6))}})}))}writeList(e,t,i){if(i&&!(i.length<1)){for(let n=0;n<i.length;n++){let r={};r.byte=i[n],r.characteristicId=t,r.serviceId=e,this.writBufferQueue.push(r)}this.writing||this.handWriteQueue()}}handWriteQueue(){if(this.writBufferQueue.length>0){let e=this.writBufferQueue.shift();this.write(e.serviceId,e.characteristicId,e.byte).then((e=>{this.handWriteQueue()})).catch((e=>{p.error("WriteQueue error",e),this.handWriteQueue()}))}}write(e,t,i){return new Promise(((n,r)=>{this.doWxWrite(e,t,i,n,0,r)}))}doWxWrite(e,t,i,n,r,s){this.writing=!0;let o=this;e.indexOf("A700")>=0||p.isPrintValueChange()&&p.info("try write Data","["+D(t)+"]",C(i),o.deviceId),wx.writeBLECharacteristicValue({deviceId:this.deviceId,serviceId:e,characteristicId:t,value:i,success(e){n(S.success(e))},fail:c=>{10008===(c.errCode||c.code)&&r<3?(p.error("write: retryCount: ",r,o.deviceId,t,c),setTimeout((()=>{o.doWxWrite(e,t,i,n,++r,s)}),100)):(p.error("write error: ",this.deviceId,"["+D(t)+"]",c),10006===c.code?s(S.errorCode(30)):s(S.errorCode(6)))},complete:()=>{this.writing=!1}})}setMtu(e,t){return new Promise(((i,n)=>{if(wx.setBLEMTU)if(2===t)i(S.success({mtu:158}));else{let t=setTimeout((()=>{p.error("setBLEMTU timeout"),i(S.success({mtu:23}))}),1500);p.info("setBLEMTU ",e),wx.setBLEMTU({deviceId:this.deviceId,mtu:e,success:n=>{t&&clearTimeout(t);let r=n.mtu;r||(r=e),p.info("setBLEMTU success",n,r),i(S.success({mtu:r}))},fail:e=>{t&&clearTimeout(t),p.error("setMtu fail: ",this.deviceId,e),i(S.success({mtu:23}))}})}else p.error("setMtu fail: wx.setBLEMTU 未实现 "),i(S.success({mtu:23}))}))}connectAndDiscoverServices(e){return z(this,void 0,void 0,(function*(){try{return p.warn("connectAndDiscoverServices",this.deviceId),yield this.connect(e),yield this.discoverServices(0),Promise.resolve(S.success("连接与发现服务成功"))}catch(e){return p.error("connnectAndDiscoverServices",e),Promise.reject(S.fail("连接与发现服务失败"))}}))}connectAndReadDeviceInfo(e=!0,t){return z(this,void 0,void 0,(function*(){if(!e&&this.isConnectingAndReadDeviceInfo&&this.deviceInfo&&this.deviceInfo.size>0)return Promise.resolve(S.success(this.deviceInfo));this.isConnectingAndReadDeviceInfo=!0;try{yield this.connectAndDiscoverServices(1e4)}catch(e){return Promise.reject(e)}return this.readDeviceInfo(t)}))}readDeviceInfo(e){return z(this,void 0,void 0,(function*(){try{p.debug("readDeviceInfo",e);let t=M;if(e&&e.length>0){for(let i=0;i<e.length;i++){let n=e[i];yield this.read(t,n)}return this.isConnectingAndReadDeviceInfo=!1,Promise.resolve(S.success(this.deviceInfo))}if(null==e){let e=this.serviceMap.get(t);if(e&&e.characteristics)for(let i=0;i<e.characteristics.length;i++){let n=e.characteristics[i];yield this.read(t,n.uuid)}}return this.isConnectingAndReadDeviceInfo=!1,Promise.resolve(S.success(this.deviceInfo))}catch(e){return p.logBleError(e,"获取deviceInfo失败",this.deviceInfo.size),this.isConnectingAndReadDeviceInfo=!1,Promise.reject(e)}}))}clearReadTimeout(e){let t=this.readTimeoutMap.get(e);t&&(clearTimeout(t),this.readTimeoutMap.delete(e))}callbackDisConnectStateChanged(){$(this.deviceId)}resetState(){this.connected=!1,this.isServiceDiscoveredFinished=!1,this.isConnectingAndReadDeviceInfo=!1,this.writing=!1,this.writBufferQueue.length=0,this.clientDataChangeListener.clear()}}!function(e){e[e.ALL=0]="ALL",e[e.Normal=1]="Normal",e[e.ConnectAndNormal=2]="ConnectAndNormal"}(F||(F={}));let Q=new Map;const H=[],J=[],q=[];function G(e){for(let t of e){let e="";e="string"==typeof t?t.toUpperCase():t.uuid.toUpperCase();for(let t=0;t<H.length;t++)if(e&&e.indexOf(H[t].uuid)>-1)return H[t]}p.error("不支持的设备",e)}function Z(e,t){Q.set(e,t)}function X(e){return Q.get(e)}var Y=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((n=n.apply(e,t||[])).next())}))};let ee=new Map,te=new Map;var ie,ne={wx:{Adapter:class{constructor(){this.available=!1,this.scanning=!1,this.readingMac=!1,this.scanCallbacks=new Map,this.connectStateListerner=new Map,this.connectedMap=new Map,this.connectResoveMap=new Map;let e=this;j("_a",(t=>{e.available=t.available,!1===t.available&&(e.connectedMap.forEach(((t,i)=>{p.debug("设备连接",i,t);let n=e.getClient(i);$(n.deviceId),n.recycle()})),e.clear()),e.available=t.available})),P.connector=(e,t)=>this.connect(e,t),P.disConnector=e=>this.disconnect(e),function(e,t){L.set(e,t)}("_a",(t=>{t&&t.devices&&t.devices.forEach((t=>{let i=e.getClient(t.deviceId);i.name=t.name,i.advertisementData=t,i.isSystemConnect=!1,i.services=i.advertisementData.advertisServiceUUIDs,setTimeout((()=>{e.callbackScanResult(i)}),0)}))})),N("_a",(t=>{let i=t.deviceId;t.connected?(e.connectedMap.set(t.deviceId,this.getClient(i)),setTimeout((t=>{let n=e.connectResoveMap.get(i);n&&(e.connectResoveMap.delete(i),n.resolve(S.success("连接成功1")))}),2e3)):e.connectedMap.delete(t.deviceId)})),P.connector=(e,t)=>this.connect(e,t),P.disConnector=e=>this.disconnect(e)}openBLEAdapter(){return new Promise(((e,t)=>{let i=(i,n)=>{i?e(S.success()):t(S.fail("打开适配器失败",n))};wx.openBluetoothAdapter({success:()=>{p.debug("开启蓝牙适配器"),this.getBLEAdapterState(i)},fail:t=>{p.error("开启蓝牙适配器失败",t.errCode,t.errMsg),this.getBLEAdapterState((t=>{t?e(S.success()):this.reopenBLEAdapter(i)}))}})}))}startScan(e,t,i,n,r){if(!this.available)return void(this.scanning=!1);this.scanCallbacks.set(e,n);let s=this;var o;((r===F.ALL||r===F.ConnectAndNormal)&&J.length>0&&(this.readingMac||(this.readingMac=!0,wx.getConnectedBluetoothDevices({success(e){p.warn("getConnectedBluetoothDevices",e);let t=e.devices.length,i=e=>{e<=0&&(s.readingMac=!1)};for(let r=0;r<e.devices.length;r++){let o=e.devices[r];p.debug("system client",o);let c=s.getClient(o.deviceId);if(c.name=o.name,k()){let e=te.get(o.deviceId);e&&e.get(A)?(c.deviceInfo=e,c.isSystemConnect=!0,t-=1,i(t),s.callbackScanResult(c)):c.connectAndReadDeviceInfo(!1,[A]).then((e=>{e.originResponse&&(te.set(o.deviceId,e.originResponse),c.isSystemConnect=!0,t-=1,i(t),n(c))})).catch((e=>{p.warn("read mac error",e),t-=1,i(t),s.callbackScanResult(c)}))}else c.isSystemConnect=!1,t-=1,i(t),s.callbackScanResult(c)}},fail(e){s.readingMac=!1,p.warn("getConnectedBluetoothDevices error",e)},services:J}))),r===F.ALL&&wx.getBluetoothDevices({success(e){e.devices.forEach((e=>Y(this,void 0,void 0,(function*(){if(e.deviceId){let t=s.getClient(e.deviceId);if(t.name=e.name,e.advertisServiceUUIDs&&e.advertisServiceUUIDs.length>0)setTimeout((()=>{t.advertisementData=e,t.isSystemConnect=!1,t.services=e.advertisServiceUUIDs||t.advertisementData.advertisServiceUUIDs||t.services,s.callbackScanResult(t)}),1e3);else{let i=te.get(e.deviceId);i?(t.deviceInfo=i,t.isSystemConnect=!0,n(t)):k()||n(t)}}}))))}}),this.scanning&&this.available)?p.debug("正在搜索中"):0!==this.scanCallbacks.size?(this.stopScanTime(),this.scanning=!0,this.scanTimeout=setTimeout((()=>{s.stopScan()}),6e4),(o={services:t,allowDuplicatesKey:i,success:()=>{this.scanning=!0,p.logBle("开始扫描......",JSON.stringify(e))},fail:e=>{this.scanning=!1,p.logBleError("扫描失败",JSON.stringify(e))}}).unikey=V,U?U(o):wx.startBluetoothDevicesDiscovery(o)):p.debug("没有回调")}stopScan(e){var t;e?this.scanCallbacks.delete(e):this.scanCallbacks.clear(),p.debug("stopScan",e,this.scanCallbacks.size),e||(p.debug("stopScan all",e,this.scanCallbacks.size),this.scanning=!1,this.readingMac=!1,(t={success(e){},complete:e=>{p.logBle("停止扫描",JSON.stringify(e)),this.scanning=!1}}).unikey=V,_?_(t):wx.stopBluetoothDevicesDiscovery(t))}getClient(e){if(!e)return p.error("wx deviceId",e),null;let t=ee.get(e);return t||(t=new K(e),ee.set(e,t)),t}reopenBLEAdapter(e){p.info("重启蓝牙适配器"),this.clear(),P.clear(),wx.closeBluetoothAdapter({success(){},complete:()=>{wx.openBluetoothAdapter({success(){},complete:()=>{p.info("重启完成"),this.getBLEAdapterState(e)}})}})}getBLEAdapterState(e){wx.getBluetoothAdapterState({success:t=>{this.available=t.available,e&&e(this.available,t)},fail:t=>{this.available=!1,p.error("getBluetoothAdapterState失败",t),e&&e(!1,t)}})}stopScanTime(){this.scanTimeout&&(clearTimeout(this.scanTimeout),this.scanTimeout=null)}clear(){this.scanning=!1,this.stopScanTime(),this.readingMac=!1,this.scanCallbacks.clear()}callbackScanResult(e){this.scanCallbacks.size>0&&this.scanCallbacks.forEach((t=>t&&t(e)))}connect(e,t=1e4){return p.warn("createBLEConnection",e,t),this.available?new Promise(((i,n)=>{let r=this;this.connectResoveMap.set(e,{resolve:i,reject:n}),wx.createBLEConnection({deviceId:e,timeout:t,success:t=>{r.connectResoveMap.delete(e),p.warn("connect success1"),i(S.success("连接成功2"))},fail:t=>{if(-1===t.errCode||-1===t.code)return p.logBle("重复连接: ",e,t),r.connectResoveMap.delete(e),void i(S.success(t));p.error("蓝牙连接失0: ",e,JSON.stringify(t)),r.connectResoveMap.delete(e),wx.closeBLEConnection({deviceId:e,success(e){setTimeout((e=>{n(S.errorCode(6))}),0)},fail(e){setTimeout((e=>{n(S.errorCode(6))}),0)}})}})})):Promise.reject(S.errorCode(21))}disconnect(e){return p.warn("closeBLE",e),this.available?(this.connectResoveMap.delete(e),new Promise(((t,i)=>{wx.closeBLEConnection({deviceId:e,success(e){t(S.errorCode(0))},fail(e){i(S.errorCode(0))}})}))):Promise.reject(S.errorCode(21))}},Client:K}};function re(e){if(!e||e.length<12)return"";let t=function(e){if(!e||0===e.length)return new ArrayBuffer(0);let t=e.length/2;if(t<1)return new ArrayBuffer(0);let i=new ArrayBuffer(t),n=new DataView(i);for(let i=0;i<t;i++){let t=e.substr(2*i,2),r=parseInt(t,16);n.setUint8(i,r)}return n.buffer}(e),i=new DataView(t),n=(i.getUint8(0)<<16)+(i.getUint8(1)<<8)+i.getUint8(2),r=(i.getUint8(3)<<16)+(i.getUint8(4)<<8)+i.getUint8(5);return n.toString(10).padStart(8,"0")+r.toString(10).padStart(8,"0")}!function(e){e[e.None=0]="None",e[e.Scan=1]="Scan",e[e.Connecting=2]="Connecting",e[e.Connected=3]="Connected",e[e.Worked=4]="Worked",e[e.Disconnected=5]="Disconnected"}(ie||(ie={}));const se=new Map,oe=new Map;class ce{constructor(){this.connectStatus=ie.None,this.workMode=0}get isWorking(){return!(this.connectStatus>ie.Worked||this.connectStatus===ie.None)}updateDeviceInfo(e){e&&(this.name=e.name,this.deviceId=e.deviceId,e.serialId&&(this.serialId=e.serialId),e.hardwareVersion&&(this.hardwareVersion=e.hardwareVersion),e.softwareVersion&&(this.softwareVersion=e.softwareVersion),e.firmwareVersion&&(this.firmwareVersion=e.firmwareVersion),this.updateDeviceId(e.lzDeviceId),!this.mac&&e.mac&&(this.mac=e.mac),this.localName||(this.localName=this.name),e.model&&(this.protoName&&this.protoName.indexOf("A6")>=0&&this.model&&0!==this.model.length||(this.model=e.model)),this.mac&&se.set(this.mac,this))}updateAdvertisement(e){e&&e.mac&&(this.isRegister=e.isRegister,this.mac=e.mac,this.deviceId=e.deviceId,this.localName=e.localName,this.name=this.localName,this.RSSI=e.RSSI,e.model&&(this.model=e.model),this.mac&&se.set(this.mac,this))}updateDeviceId(e){e&&(this.sn=re(e),this.lzDeviceId=e.toLowerCase(),this.id=e,this.mac&&se.set(this.mac,this))}updateBleDeviceId(e){e&&(this.deviceId=e,this.mac&&(se.set(this.mac,this),oe.set(e,this)))}updateClient(e){if(this.deviceId=e.deviceId,this.name=e.name,this.mac){let t=X(this.mac);t||(t=G(e.services),t?Z(this.mac,t):p.error("proto 为nil",e.services)),this.protoName=t.name,se.set(this.mac,this),oe.set(e.deviceId,this)}}updateA5DeviceInfo(e){this.model=e.model,this.softwareVersion=e.softVersion,this.hardwareVersion=e.hardwareVersion,this.mac&&se.set(this.mac,this)}updateConnectStatus(e,t){p.info("更新状态",e,this.mac,t),this.connectStatus!=e&&(this.connectStatus=e),this.mac&&se.set(this.mac,this)}}function ae(e,t){let i=oe.get(e.deviceId);if(i){let t=X(i.mac);if(!t){if(t=G(e.services),!t)return p.warn("找不到对应的设置服务",e.deviceId,e.name),i;i.protoName=t.name,Z(i.mac,t)}if(oe.set(e.deviceId,i),e.isSystemConnect)try{let n=t.parser.parseDeviceInfo(e,e.deviceInfo);i.updateDeviceInfo(n)}catch(e){p.warn("解析设备数据出错2",e,i)}else try{let n=t.parser.parseAdvertisementData(e,e.advertisementData);i.updateAdvertisement(n)}catch(e){p.warn("解析广播数据出错",e,i)}}else{if(!e.services)return null;let t=G(e.services);if(t){let i=new ce;if(i.deviceId=e.deviceId,e.isSystemConnect)try{let n=t.parser.parseDeviceInfo(e,e.deviceInfo);i.updateDeviceInfo(n)}catch(e){p.warn("解析设备数据出错1",e,i)}else try{let n=t.parser.parseAdvertisementData(e,e.advertisementData);i.updateAdvertisement(n)}catch(e){p.warn("解析广播数据出错",e,i)}return p.debug("create new lzDevice",i.mac,i),i.mac&&(Z(i.mac,t),i.protoName=t.name,se.set(i.mac,i),oe.set(e.deviceId,i)),i}p.warn("找不到对应的服务",e.deviceId,e.name)}return i}function de(e){let t=se.get(e);return t||(t=new ce,p.debug("create new lzDevice ------",t.mac,t),t.mac=e,se.set(e,t)),t}function he(e){return oe.get(e)}var le=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((n=n.apply(e,t||[])).next())}))};class ue{constructor(e,t,i=1001,n=100){this.actions=e,this.context=t,this.priority=i,this.id=n}}class fe{constructor(e,t,i=1e3,n=200){this.priority=1e3;let r=[];this.priority=i,this.context=t,this.id=n,e.forEach((e=>{let t={name:"push",actionType:1,pushData:()=>e};r.push(t)})),this.actions=r}}class ve{constructor(e,t,i){this.currentIndx=0,this.isClear=!1,this.sid=Math.random(),this.mac=t,this.mutipAction=e,this.client=i}didReceive(e){let t=this.mutipAction.actions[this.currentIndx];if(t.await&&t.await.didReceive){let i=t.await.didReceive(e,this.mutipAction.context);const n=typeof i;return"function"===n||i&&"object"===n?(i.success?(this._clearTimeout(),this.next()):this.callback(i),!0):(i&&this.resetTimeout(),!1)}}doAction(e){return le(this,void 0,void 0,(function*(){if(!this.isClear)try{if(e.when&&!1===e.when(this.mutipAction.context))return void this.next();e.await?(this.timeout=e.await.timeout||4e3,this.resetTimeout(),this.tryExcuteAction(e)):(this._clearTimeout(),yield this.tryExcuteAction(e),this.next())}catch(e){this.callback(e)}}))}tryExcuteAction(e){return le(this,void 0,void 0,(function*(){if(e.ignoreError&&e.ignoreError(this.mutipAction.context)){try{yield this.excuteAction(e)}catch(e){p.info("忽略错误",e)}return Promise.resolve()}return this.excuteAction(e)}))}excuteAction(e){return le(this,void 0,void 0,(function*(){switch(e.actionType){case 0:return Promise.resolve();case 1:let t=e.pushData(this.mutipAction.context);return t instanceof Promise&&(t=yield t),this.pusher(t);case 2:return this.client.enable(e.serviceId,e.characteristicId);case 3:return this.client.disable(e.serviceId,e.characteristicId);case 4:return this.client.read(e.serviceId,e.characteristicId)}}))}next(){return le(this,void 0,void 0,(function*(){if(this.isClear)return p.warn("已经释放"),void this.callback(S.errorCode(4));this.currentIndx+=1,this.checkFinish()?this.mutipAction.responseData?this.callback(this.mutipAction.responseData):this.callback(S.errorCode(0,this.mutipAction.id)):yield this.doAction(this.mutipAction.actions[this.currentIndx])}))}checkFinish(){return this.mutipAction.actions.length<=this.currentIndx}start(){this.currentIndx=0;try{this.doAction(this.mutipAction.actions[0])}catch(e){this.callback(S.errorCode(5))}}resetTimeout(){this._clearTimeout();let e=this;this.timeoutId=setTimeout((()=>{let t=e.mutipAction.actions[e.currentIndx];p.debug("timeout ",t.name),t&&t.await&&t.await.onTimeout&&t.await.onTimeout(e.mutipAction.context)?e.next():e.callback(S.errorCode(3,e.mutipAction.actions))}),this.timeout)}_clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}callback(e){e.originResponse=this.mutipAction.id,this._clearTimeout(),this.completion&&(e.sid=this.sid,this.completion(e),this.completion=null),this.isClear=!0}clear(){this.isClear=!0,this.callback(S.errorCode(1))}}class pe{constructor(e,t){this.sessionList=new Array,this.sessionMap=new Map,this.workingSessionMap=new Map,this.mac=e,this.client=t}execute(e,t){let i=this.getSessionList(e.serviceId),n=this.getWorkingSession(e.serviceId);if(n&&n.mutipAction.id===e.id&&e.priority<=0)t&&t(S.errorCode(4));else{for(let t=0;t<i.length;t++){if(i[t].mutipAction.id===e.id){this.sessionList.splice(t,1);break}}i.push(this.createSession(e,t)),this.sessionList.sort(((e,t)=>t.mutipAction.priority-e.mutipAction.priority)),this.dispatchNextAction(e.serviceId)}}didReceive(e){return this.workingSession&&this.workingSession.didReceive(e),this.workingSessionMap.forEach(((t,i)=>{try{t.didReceive(e)}catch(e){p.error("error",e)}})),!0}dispatchNextAction(e){let t=this.getWorkingSession(e),i=this.getSessionList(e);if(!t||!1!==t.isClear)if(i.length>0){let t=i[0];i.shift(),e&&e.length>0?this.workingSessionMap.set(e,t):this.workingSession=t,t.start()}else p.debug("没有工作了",this.mac)}getSessionList(e){if(e&&e.length>0){let t=this.sessionMap.get(e);return t||(t=[],this.sessionMap.set(e,t),t)}return this.sessionList}getWorkingSession(e){return e&&e.length>0?this.workingSessionMap.get(e):this.workingSession}cancelCurrentSession(){this.workingSessionMap.forEach(((e,t)=>{e.clear()})),this.workingSessionMap.clear(),this.workingSession&&(this.workingSession.clear(),this.workingSession=null)}deleteWorkingSession(e){e&&e.length>0?this.workingSessionMap.delete(e):this.workingSession=null}createSession(e,t){let i=new ve(e,this.mac,this.client);i.pusher=this.pusher;let n=this,r=e.serviceId;return i.completion=e=>{n.deleteWorkingSession(r),t&&t(e),n.dispatchNextAction(r)},i}stopTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}clear(){try{this.workingSession&&(this.workingSession.clear(),this.workingSession=null),this.workingSessionMap.forEach(((e,t)=>{e.clear()})),this.workingSessionMap.clear(),this.sessionMap.clear(),this.sessionList.length=0}catch(e){p.warn("操作取消",this.mac,e)}}}var ge=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((n=n.apply(e,t||[])).next())}))};class me{constructor(e,t,i){this.isOtaing=!1,this.sessionMap=new Map,this.mac=e,this.proto=t,this.context=i}bind(e,t){return ge(this,void 0,void 0,(function*(){if(this.isClear)return p.warn("bind 被释放了"),Promise.reject(S.errorCode(4));if(this.isWorking)return void p.warn("重复调用");this.context=e,this._initMutipleActionManager(e),this.workMode=1,this.isWorking=!0;let i=this.proto.bind.actions,n=new ue(i,e,1250),r=this;this.mutipActionManager.execute(n,(i=>{i.success?(r.didBinded(e),t(r.mac,0)):(r.isWorking=!1,r.workStateChanged&&this.workStateChanged(i),r.unWorked(),t(r.mac,i.code))}))}))}sync(e,t){return ge(this,void 0,void 0,(function*(){if(this.isClear)return void p.warn("sync 被释放了");if(this.isWorked){if(this.proto&&this.proto.dataParser.syncDataMutipleAction&&this.proto.dataParser.shouldIntervalSyncData){let e=this.proto.dataParser.syncDataMutipleAction(this.context),t=this.proto.dataParser.shouldIntervalSyncData(this.context);e&&!t&&this.excuteMutipAction(e)}return}p.info("sync",this.mac),this._initMutipleActionManager(e),this.workMode=0,this.isWorking=!0;let i=this.proto.sync.actions,n=new ue(i,e,1250),r=this;this.mutipActionManager.execute(n,(i=>{i.success?(r.didWorked(e),t(r.mac,0)):(r.isWorking=!1,r.workStateChanged&&r.workStateChanged(i),r.unWorked(),t(r.mac,i.code))}))}))}ota(e){if(this.proto.dataParser.otaAction){let t=this,i=e.onUpgradeComplete,n=(e,n)=>{p.debug("ota 完成"),t.isOtaing=!1,i&&i(e,n)};e.onUpgradeComplete=n;let r=this.proto.dataParser.otaAction(this.context,e);if(r)return this.isOtaing=!0,this.excuteMutipAction(r)}return e.onUpgradeComplete&&e.onUpgradeComplete(10,"不支持ota升级"),Promise.reject(S.errorCode(10))}pushSetting(e){if(this.isClear)return p.warn("pushSetting 被释放了",e),this._disconnect(),Promise.reject(S.errorCode(4));if(!this.proto.dataParser.checkPushData)return this._pushSetting(e);switch(this.proto.dataParser.checkPushData(this.context,e)){case-1:return Promise.reject(S.errorCode(15));case-2:return Promise.reject(S.errorCode(10));case 0:let t=new fe([e],{},1e3);return this.excuteMutipAction(t);case 1:if(this.proto.dataParser.tryToExchangeMutipleAction){let t=this.proto.dataParser.tryToExchangeMutipleAction(this.context,e);if(t)return this.excuteMutipAction(t)}return Promise.reject(S.errorCode(10));case 2:return this.context.userInfo||(this.context.userInfo=this.userInfo),this._reBind(this.context);default:return this._pushSetting(e)}}getSetting(e){if(this.isClear)return p.warn("getSetting 被释放了"),Promise.reject(S.errorCode(4));let t=this;if(!this.proto.dataParser.getSettingMutipleAction)return Promise.reject(S.errorCode(10));let i=this.proto.dataParser.getSettingMutipleAction(this.context,e);return i?new Promise(((e,n)=>ge(this,void 0,void 0,(function*(){try{let n=yield t.excuteMutipAction(i);e(n.data)}catch(e){n(e)}})))):Promise.reject(S.errorCode(10))}cancelSetting(){p.warn("cancelSetting"),this.isOtaing&&(this._disconnect(),p.info("Ota中取消操作，直接中断连接")),this.mutipActionManager.cancelCurrentSession(),this.sessionMap.forEach(((e,t)=>{p.warn("value clear",e.context.deviceInfo.mac),e.clear()}))}excuteMutipAction(e){if(this.isClear)return p.warn("excuteMutipAction 被释放了",e),this._disconnect(),Promise.reject(S.errorCode(4));let t=this;return new Promise(((i,n)=>{t.mutipActionManager.execute(e,(e=>{e.success?i(e):n(e)}))}))}clear(){try{this.mergeDataManager&&this.mergeDataManager.callbackAllData(),this.isClear=!0,this.unWorked(),this._clearSyncTime(),this.mutipActionManager.clear(),this.isWorking=!1,this.isWorked=!1,this.workMode=0,this.sessionMap.forEach(((e,t)=>{e.clear()})),this.sessionMap.clear()}catch(e){}}updateUserInfo(e){return ge(this,void 0,void 0,(function*(){if(this.userInfo=e,this.proto.dataParser.syncUserInfoAction){let t=this.proto.dataParser.syncUserInfoAction(this.context,e);if(t)return this.excuteMutipAction(t)}}))}didBinded(e){return ge(this,void 0,void 0,(function*(){if(this.isClear)return p.warn("didBinded 被释放了",e),Promise.reject(S.errorCode(4));if(e.deviceInfo.isBinded=!0,p.info("didBinded"),this.proto.dataParser.reStartSyncAction){let e=this.proto.dataParser.reStartSyncAction(this.context);if(e)try{p.info("重新同步数据"),yield this.excuteMutipAction(e)}catch(t){return p.warn("重新同步数据 出错了",t,e,this.mac),void(this.workStateChanged&&this.workStateChanged(t))}}if(this.proto.dataParser.defaultSettingAction){let e=this.proto.dataParser.defaultSettingAction(this.context);if(e)try{p.info("设置默认"),yield this.excuteMutipAction(e)}catch(t){return p.warn("默认设置失败了",e,this.mac),void(this.workStateChanged&&this.workStateChanged(t))}}this.didWorked(e)}))}didWorked(e){return ge(this,void 0,void 0,(function*(){if(this.isClear)return p.warn("didWorked 被释放了",e),Promise.reject(S.errorCode(4));if(this.isWorked=!0,this._initMergeDataManager(e),this.workMode=0,e.deviceInfo.workMode=0,this.proto.dataParser.workedDefaultAction){let e=this.proto.dataParser.workedDefaultAction(this.context);if(e)try{yield this.excuteMutipAction(e)}catch(t){p.warn("默认设置失败了",e,this.mac)}}if(this.proto&&this.proto.dataParser.makeBluetoothPairPin){let t=this.proto.dataParser.makeBluetoothPairPin(e);if(null!=t&&null!=t)try{yield this.context.client.makeBluetoothPair(t)}catch(e){p.error("配对失败",e)}p.warn("pin",t)}try{this.updateUserInfo(this.userInfo)}catch(e){p.warn("同步用户信息失败",e)}p.info("didWorked"),this.workStateChanged&&this.workStateChanged(S.errorCode(0)),setTimeout((()=>{this._reStartSyncTime(e)}),1e3)}))}unWorked(){this._clearSyncTime()}disconnect(){this._disconnect()}getSessionManager(e,t){let i=this.proto.uuid;t&&(i=t);let n=this.sessionMap.get(i);if(!n){let t=this;n=this.proto.dataParser.createSession(i,e),n&&(n.sender=(t,i)=>e.client.write(i.serviceId,i.charId,t),n.listener=n=>{if(n.success)try{let r=t.proto.dataParser.parseData(n,i,e);t._handlerNewData(r)}catch(e){p.error("捕捉到解析失败",e,n,i)}},this.sessionMap.set(i,n))}return n}_pushSetting(e){p.info("pushSetting",this.mac,e);let t=this.getSessionManager(this.context,e.serviceId);return t?t.sendData(e.getBytes(this.context.deviceInfo),e.tag):Promise.reject(S.errorCode(10))}_clearSyncTime(){this.syncTime&&(clearInterval(this.syncTime),this.syncTime=null)}_reStartSyncTime(e){if(this._clearSyncTime(),this.isClear)p.warn("_reStartSyncTime 已经被释放");else if(this.proto&&this.proto.dataParser.syncDataMutipleAction&&this.proto.dataParser.shouldIntervalSyncData){let t=this.proto.dataParser.syncDataMutipleAction(e),i=this.proto.dataParser.shouldIntervalSyncData(e);if(t){let n=this;this.excuteMutipAction(t),i&&(n.syncTime=setInterval((()=>{try{n.excuteMutipAction(t)}catch(e){p.warn("同步数据失败",e)}}),this.proto.dataParser.loopTime&&this.proto.dataParser.loopTime(e)||2e4))}}}_reBind(e){let t=this;return new Promise(((i,n)=>ge(this,void 0,void 0,(function*(){try{let n=this.proto.dataParser.reStartBindAction(e);if(n){let r=yield t.excuteMutipAction(n);return setTimeout((()=>{t.didBinded(e)})),i(r)}throw"需要实现 reStartBindAction"}catch(e){n(e)}}))))}_initMutipleActionManager(e){this.mutipActionManager=new pe(this.mac,e.client);let t=this.mac+"worker",i=this;O(t,e.client.deviceId,(t=>{if(t.serviceId===M)return;let n=i.getSessionManager(e,t.serviceId);if(n)n.didReceiveData(t);else try{let n=i.proto.dataParser.parseData(S.errorCode(0,t.characteristicId,t.value),t.serviceId,e);i._handlerNewData(n)}catch(e){p.error("捕捉到解析失败",e,t)}return!1})),this.mutipActionManager.pusher=e=>this._pushSetting(e)}_initMergeDataManager(e){if(this.proto.dataParser.getMergeDataManager){let t=this.proto.dataParser.getMergeDataManager(e);if(t){this.mergeDataManager=t;let e=this;t.lister=t=>{e.mutipActionManager.didReceive(t),e.lister&&e.lister(e.context.deviceInfo,t),p.info("data merged",e.context.deviceInfo,t)}}}}_handlerNewData(e){return ge(this,void 0,void 0,(function*(){if(e&&e.dataType){if(this.proto.dataParser.shouldSendConform){let t=this.proto.dataParser.shouldSendConform(this.context,e);if(t)try{yield this._pushSetting(t)}catch(e){return void p.error("发送确认数据 error",e)}}if(this.mergeDataManager){if(this.mergeDataManager.receiveAndHandle(e,this.context))return}this.mutipActionManager.didReceive(e),"finish"===e.dataType||(p.info("data",this.mac,e),this.lister&&this.lister(this.context.deviceInfo,e))}}))}_disconnect(){if(this.proto.dataParser.disConnect)try{let e=this.proto.dataParser.disConnect(this.context);if(e){let t=this;t.mutipActionManager.execute(e,(e=>{})),setTimeout((()=>{t.context.client.disconnect(),t.context.deviceInfo.updateConnectStatus(ie.Disconnected,"_disconnect1")}),0)}else this.context.client.disconnect(),this.context.deviceInfo.updateConnectStatus(ie.Disconnected,"_disconnect2")}catch(e){p.warn("断开蓝牙失败",e)}else this.context.client.disconnect(),this.context.deviceInfo.updateConnectStatus(ie.Disconnected,"_disconnect3")}}var we=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((n=n.apply(e,t||[])).next())}))};var Se=new class extends class{constructor(){this.listenerMap=new Map}$on(e,t,i){this.listenerMap.has(e)||this.listenerMap.set(e,new Map),this.listenerMap.get(e).set(t,i)}$off(e,t){if(this.listenerMap.has(e)){let i=this.listenerMap.get(e);i&&i.delete(t)}}printLog(e,...t){}$emit(e,...t){if(this.printLog(e,"$emit",e,...t),this.listenerMap.has(e)){let i=this.listenerMap.get(e);for(let n of i.keys()){let r=i.get(n);try{r&&r(...t)}catch(t){p.error("$emit fail "+e+" "+t)}}}}}{constructor(){super(),this.aerobicGPSStatus=0,this.getSettingTimeout=null,this.workerMap=new Map,this.cacheWorkerHandler=new Map,this.cacheFindDeviceTimeout=new Map,this.syncedDevice=new Map,this.errorCache=new Map,this.connectingDeviceMap=new Map}init(e){if(this.options=e,function(e){let t=e=>{p.info("onBLEConnectionStateChange:",e);let t=E.get(e.deviceId);t&&t.forEach((t=>{t&&t(e)})),B.forEach((t=>{t(e)}))};e.onBLEConnectionStateChange?e.onBLEConnectionStateChange(t):wx.onBLEConnectionStateChange(t);let i=e=>{p.info("onBluetoothAdapterStateChange:",e),T.forEach((t=>{t&&t(e)}))};e.onBluetoothAdapterStateChange?e.onBluetoothAdapterStateChange(i):wx.onBluetoothAdapterStateChange(i);let n=e=>{p.isPrintValueChange()&&p.info("Frame Data","["+D(e.characteristicId)+"]",C(e.value),e.deviceId);let t=R.get(e.deviceId);t&&t.forEach((t=>{t&&t(e)})),W.forEach((t=>{t&&t(e)}))};e.onBLECharacteristicValueChange?e.onBLECharacteristicValueChange(n):wx.onBLECharacteristicValueChange(n);let r=e=>{L.forEach((t=>{t(e)}))};e.onBluetoothDeviceFound?e.onBluetoothDeviceFound(r):wx.onBluetoothDeviceFound(r),U=e.startBluetoothDevicesDiscovery,_=e.stopBluetoothDevicesDiscovery}(e),e.logger&&p.setLogger(e.logger),!ne[e.platform])return void p.error("暂不支持该平台: ",ne.wx,e.platform);p.info("init 0.4.19");let{Adapter:t}=ne[e.platform];this.adapter=new t;let i=this;return j("_b",(e=>{!1===e.available&&(this.tryReleaseAdapter(),this.connectingDeviceMap.forEach(((e,t)=>{i.changeWorkState(t,ie.Disconnected,!0,!0)}))),setTimeout((()=>{this.$emit("adaptorState",e)}),0)})),N("_b",(e=>{let t=he(e.deviceId);if(t&&0==e.connected&&t.connectStatus!=ie.Scan&&t.connectStatus!=ie.Connecting){this.changeWorkState(t.mac,ie.Disconnected,!0);let e=this.workerMap.get(t.mac);e&&(e.clear(),this.workerMap.delete(t.mac))}})),this.adapter.available?Promise.resolve(S.success()):this.adapter.openBLEAdapter()}updateUserInfo(e){this.userInfo=e;let t=this.getWorkedDevice(),i=this;t&&t.length>0&&t.forEach((t=>{let n=i.workerMap.get(t.mac);n&&n.updateUserInfo(e)}))}pushSetting(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.pushSetting(t):Promise.reject(S.errorCode(1))}cancelSetting(e){p.warn("cancelSetting",e,this.workerMap),e=e.toUpperCase();let t=this.workerMap.get(e);return t?t.cancelSetting():Promise.reject(S.errorCode(1))}getSetting(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.getSetting(t):Promise.reject(S.errorCode(1))}scanDevice(e,t,i=F.ALL){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));this.adapter.startScan(e,q,!0,(e=>{let i=ae(e);i&&i.mac&&t(i)}),F.ALL)}stopScan(e){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));this.adapter.stopScan(e)}ota(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.ota(t):(t.onUpgradeComplete(1,"未连接"),Promise.reject(S.errorCode(1)))}bind(e,t,i){return we(this,void 0,void 0,(function*(){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));e=e.toUpperCase();let n=this.workerMap.get(e),r=this;return n&&(n.clear(),this.workerMap.delete(e)),this.cacheWorkerHandler.set(e,i),new Promise(((i,s)=>we(this,void 0,void 0,(function*(){try{yield r.checkUserLocationAvailable();let o=Object.assign({},t);!o.userInfo&&this.userInfo&&(o.userInfo=this.userInfo),o.isSyncData=!1,de(e).workMode=1,yield this.tryToConnect(e,o);let c=X(e);n=new me(e,c,o),n.lister=(e,t)=>{this.$emit("dataReport",e,t)},n.workStateChanged=t=>{t&&t.success?r.changeWorkState(e,ie.Worked,!0):(r.changeWorkState(e,ie.Disconnected,!0),r.cancelWork(e,!0))},n.userInfo=this.userInfo,this.workerMap.set(e,n),n.bind(o,((t,n)=>{0!=n?s(S.errorCode(n)):c.dataParser.bindSuccessShouldDisconnect&&c.dataParser.bindSuccessShouldDisconnect(o)?(r.changeWorkState(e,ie.Worked,!0),setTimeout((t=>{r.cancelWork(e,!0),r.syncData(e,o,((e,t)=>{}))}),100),i(S.errorCode(0))):i(S.errorCode(0))}))}catch(e){return s(e)}}))))}))}syncData(e,t,i){return we(this,void 0,void 0,(function*(){if(!this.checkBluetoothAvailable())return i&&i(e,ie.Disconnected),Promise.reject(S.errorCode(21));e=e.toUpperCase(),this.cacheWorkerHandler.set(e,i);let n=de(e);if(n.connectStatus===ie.None||n.connectStatus>=ie.Disconnected){this.changeWorkState(e,ie.Scan);let i=Object.assign({},t);!i.userInfo&&this.userInfo&&(i.userInfo=this.userInfo);let n=this.errorCache.get(e);i.isSyncData=!0,n&&(i.preErrorCode=n);let r=this.workerMap.get(e);r&&(r.clear(),this.workerMap.delete(e));let s=this;try{yield s.tryToConnect(e,i);let t=X(e);r=new me(e,t,i),r.userInfo=s.userInfo,s.workerMap.set(e,r),r.lister=(e,t)=>{s.$emit("dataReport",e,t)},r.workStateChanged=t=>{t&&t.success?s.changeWorkState(e,ie.Worked,!0):(s.changeWorkState(e,ie.Disconnected,!0),s.cancelWork(e,!0))},r.sync(i,((e,t)=>{0===t&&s.syncedDevice.set(e,i.deviceInfo),s.errorCache.set(e,t)}))}catch(t){p.error("尝试去连接的时候出现了错误",t,e)}}}))}cancelWork(e,t=!0){let i=de(e=e.toUpperCase());if(p.info("cancelWork",e,t,i),1===i.workMode&&!t)return;i.workMode=0;let n=this.workerMap.get(e);if(n&&(n.clear(),this.workerMap.delete(e)),i&&i.deviceId){this.adapter.getClient(i.deviceId).disconnect()}i.updateConnectStatus(ie.Disconnected,"cancelWork")}getConnectionState(e){return de(e=e.toUpperCase()).connectStatus}getDeviceInfo(e){return de(e)}getWorkedDevice(){let e=[];return this.workerMap.forEach(((t,i)=>{if(!t.isClear&&t.isWorking){let t=de(i);t&&t.connectStatus===ie.Worked&&e.push(t)}})),e}getConnectedDevice(){let e=[];return this.workerMap.forEach(((t,i)=>{let n=de(i);n&&n.connectStatus===ie.Worked&&e.push(n)})),e}disconnectDevice(e){p.info("disconnectDevice",e),this.adapter.getClient(e).disconnect();let t=he(e);t&&t.updateConnectStatus(ie.Disconnected,"disconnectDevice")}changeWorkState(e,t,i=!1,n=!0){let r=de(e);r&&(t!=ie.None&&t!=ie.Disconnected?this.connectingDeviceMap.set(e,r):this.connectingDeviceMap.delete(e),r.updateConnectStatus(t,"changeWorkState"),n&&(p.info("changeWorkState",e,t,r),this.$emit("connectionState",e,t),this.$emit("deviceStateChange",r)));let s=this.cacheWorkerHandler.get(e);s&&(s(e,t),i&&this.cacheWorkerHandler.delete(e))}findDevice(e,t=F.ALL,i=15){let n=de(e=e.toUpperCase());if(n&&n.deviceId){let e=this.adapter.getClient(n.deviceId);if(e.connected)return p.debug("发现已连接设备",e),Promise.resolve(!0)}let r=this;return new Promise(((n,s)=>{let o=r.cacheFindDeviceTimeout.get(e);if(o&&clearTimeout(o),o=setTimeout((()=>{p.debug("超时搜索"),r.stopScan(e),s(!1)}),i),r.cacheFindDeviceTimeout.set(e,o),!r.adapter.available)return p.warn("蓝牙不可用，无法扫描"),Promise.reject(S.fail("蓝牙不可用，无法扫描"));this.adapter.startScan(e,q,!0,(t=>{let i=ae(t);if(i&&i.mac===e){p.debug("搜索到设备",i,t),r.stopScan(e);let s=this.cacheFindDeviceTimeout.get(e);return s&&(clearTimeout(s),r.cacheFindDeviceTimeout.delete(e)),void n(!0)}}),t)}))}tryToConnect(e,t,i=1){return we(this,void 0,void 0,(function*(){if(!this.adapter.available)return p.debug("try To Connect failed"),this.changeWorkState(e,ie.Disconnected,!0),Promise.reject(S.errorCode(21));let n=this;return p.debug("try To Connect",i),new Promise(((r,s)=>we(this,void 0,void 0,(function*(){let o,c,a=!1,d=!0;if(!a){try{p.debug("搜索设备",e),k()?yield n.findDevice(e,F.ALL,t.searchTimeout||15e3):yield n.findDevice(e,F.Normal,t.searchTimeout||15e3),o=de(e),c=n.adapter.getClient(o.deviceId)}catch(t){return p.warn("未发现设备",e,t),n.changeWorkState(e,ie.Disconnected,!0),n.cancelWork(e,!0),d=!1,void s(S.errorCode(12))}if(!d)return;try{p.debug("搜索后连接",e),n.changeWorkState(e,ie.Connecting),yield c.connectAndDiscoverServices(t.connectTimeout||16e3),o.updateClient(c),a=!0}catch(t){p.warn("搜索后连接 error",t,e,i),d=!1,n.changeWorkState(e,ie.Disconnected,!0),n.cancelWork(e,!0),s(S.errorCode(1))}}if(d){try{p.debug("更新设备信息",e);let i=X(e),r=null;if(i.dataParser.deviceInfoCharacteristics&&(r=i.dataParser.deviceInfoCharacteristics(t)),yield c.readDeviceInfo(r),c.isSystemConnect=!0,function(e,t){ae(e)}(c),t.deviceInfo=de(e),t.listeners&&t.listeners.onReadDeviceInfo){let e=Object.assign({},t.deviceInfo);t.listeners.onReadDeviceInfo(e)}t.client=c,n.changeWorkState(e,ie.Connected)}catch(t){p.debug("更新设备信息 error",t,e),n.changeWorkState(e,ie.Disconnected,!0),n.cancelWork(e,!0),d=!1,s(S.errorCode(1))}if(d){if(t.listeners&&t.listeners.onDeviceAuth)try{if(!(yield t.listeners.onDeviceAuth(Object.assign({},t))))return n.changeWorkState(e,ie.Disconnected,!0),n.cancelWork(e,!0),d=!1,void s(S.errorCode(11))}catch(t){return n.changeWorkState(e,ie.Disconnected,!0),n.cancelWork(e,!0),d=!1,void s(S.errorCode(11))}d&&r(S.success())}}}))))}))}tryReleaseAdapter(){return new Promise(((e,t)=>{this.adapter.reopenBLEAdapter(((i,n)=>{i?e(S.errorCode(0)):t(S.errorCode(6))}))}))}connectDevice(e){p.warn("connectDevice 弃用，外部不需要调用此方法")}bindDevice(e,t){p.warn("bindDevice 弃用，请使用bind(mac, context, callback)");let i=he(e);return this.bind(i.mac,t,null)}send(e,t){return we(this,void 0,void 0,(function*(){let i=he(e);return this.pushSetting(i.mac,t)}))}checkBluetoothAvailable(){return this.adapter.available}checkUserLocationAvailable(){return new Promise(((e,t)=>{let{locationEnabled:i,locationAuthorized:n,platform:r}=wx.getSystemInfoSync();r.indexOf("android")>-1?i&&n?e(S.errorCode(0)):t(S.errorCode(20)):e(S.errorCode(0))}))}};function Ie(){this.dataStore=[],this.add=ye,this.remove=ke,this.size=De,this.union=be,this.contains=Ae,this.intersect=xe,this.subset=Pe,this.difference=Be,this.show=Me,this.clear=Ce}function Ce(){this.dataStore.length=0}function ye(e){return this.dataStore.indexOf(e)<0&&(this.dataStore.push(e),!0)}function ke(e){var t=this.dataStore.indexOf(e);return t>-1&&(this.dataStore.splice(t,1),!0)}function De(){return this.dataStore.length}function Me(){return"["+this.dataStore+"]"}function Ae(e){return this.dataStore.indexOf(e)>-1}function be(e){for(var t=new Ie,i=0;i<this.dataStore.length;++i)t.add(this.dataStore[i]);for(i=0;i<e.dataStore.length;++i)t.contains(e.dataStore[i])||t.dataStore.push(e.dataStore[i]);return t}function xe(e){for(var t=new Ie,i=0;i<this.dataStore.length;++i)e.contains(this.dataStore[i])&&t.add(this.dataStore[i]);return t}function Pe(e){if(this.size()>e.size())return!1;for(var t in this.dataStore)if(!e.contains(t))return!1;return!0}function Be(e){for(var t=new Ie,i=0;i<this.dataStore.length;++i)e.contains(this.dataStore[i])||t.add(this.dataStore[i]);return t}var Te=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((n=n.apply(e,t||[])).next())}))};let We,Le=new Ie,Ee=new Ie,Re=new Ie,Ue=!0,_e=null,Ve=!1,je=!0;function Ne(e,t){_e=e,je=t,Ve=!1,Se.$on("connectionState","_monitor",((e,t)=>{4===t?(Ee.add(e),Re.remove(e)):3===t?(Re.add(e),Ee.remove(e)):t>=5?(Ee.remove(e),Re.remove(e)):(Ee.remove(e),Re.add(e))})),Se.$on("adaptorState","_monitor",(e=>{e.available?!0===Ue||(Ue=e.available,He()):(Ue=e.available,We&&clearTimeout(We))}))}function Oe(e){return Te(this,void 0,void 0,(function*(){if(Array.isArray(e))e.forEach((e=>Te(this,void 0,void 0,(function*(){(yield Qe(e))&&Le.add(e.mac)}))));else{(yield Qe(e))&&Le.add(e.mac)}He()}))}function $e(e){Le.clear(),Oe(e)}function Fe(e){Array.isArray(e)?device.forEach((e=>Te(this,void 0,void 0,(function*(){Le.add(e.mac)})))):Le.add(e.mac),He()}function ze(e){Le.remove(e.mac),He()}function Ke(){Le.clear(),He()}function Qe(e){return Te(this,void 0,void 0,(function*(){return new Promise(((t,n)=>Te(this,void 0,void 0,(function*(){let r="lsdeviceAuth."+e.mac+_e,s=wx.getStorageSync(r);if(s)200===s?(console.debug("设备鉴权成功"),t(!0)):(console.debug("设备鉴权失败",s,r),n(!1));else try{let s={artifactId:"@ls/ble-next",serviceId:"device-activate",serviceVersion:"1.0",platform:3,appId:_e,mac:e.mac,model:e.model},o=yield(e=>i({path:"/rbac-web/auth/app",data:e}))(s),c=o.code;wx.setStorageSync(r,c),200===c?t(!0):n(!1)}catch(t){console.warn("鉴权失败",t,e),n(!1)}}))))}))}function He(){if(We&&clearTimeout(We),!Ue||Ve)return;if(We=setTimeout((()=>{We=null,He()}),1e4),je){let e=Ee.union(Re).difference(Le).dataStore;e.length>0&&e.forEach((e=>{Se.cancelWork(e,!1)}))}let e=Le.difference(Ee).dataStore;if(console.debug("needToConnect",e),e.length>0){let i={onApplyRegisterId:e=>new Promise(((i,n)=>{console.log("plugin","onApplyRegisterId",e);let r=e.deviceInfo.model,s=e.deviceInfo.hardwareVersion,o=e.deviceInfo.softwareVersion,c=e.deviceInfo.mac;t({mac:c,model:r,hardwareVersion:s,softwareVersion:o}).then((t=>{200===t.code&&t.data.deviceId?i(t.data.deviceId):(n("请求third deviceId 失败"),callback({mac:c,deviceInfo:e.deviceInfo,bindState:BINDSTATE_Failure}))})).catch((t=>{n(t),callback({mac:c,deviceInfo:e.deviceInfo,bindState:BINDSTATE_Failure})}))})),onDeviceAuth:e=>(console.warn("onDeviceAuth",e.deviceInfo),Qe({mac:e.deviceInfo.mac,model:e.deviceInfo.model}))},n={listeners:i};e.forEach((e=>{Se.syncData(e,n)}))}}module.exports={monitorInit:Ne,addMonitorDevice:Oe,setMonitorDevice:$e,setMonitorDeviceWithoutAuth:function(e){Le.clear(),Fe(e)},addMonitorDeviceWithoutAuth:Fe,deleteMonitorDevice:ze,deleteAllMonitorDevice:Ke,deviceAuthing:Qe};var Je=function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((n=n.apply(e,t||[])).next())}))};let qe={appId:""};function Ge(){if(!qe.appId||0==qe.appId.length)throw"未初始化或appId 无效"}function Ze(){return"1.0.12"}function Xe(e){e.appKey&&e.appKey.length>0&&(e.appId=e.appKey),qe=e,Se.init(Object.assign({platform:"wx",printScanResult:!1,discoverDelay:0},e)),e.needUI?(u(e),Ne(e.appKey,!1)):Ne(e.appId,!0)}function Ye(e){Ge(),Se.scanDevice("startScanning",e,0)}function et(){Ge(),Se.stopScan("startScanning")}function tt(e){return Je(this,void 0,void 0,(function*(){Ge();let i=e.mac,n=e.callback,r={onApplyRegisterId:e=>new Promise(((r,s)=>{console.log("plugin","onApplyRegisterId",e);let o=e.deviceInfo.model,c=e.deviceInfo.hardwareVersion,a=e.deviceInfo.softwareVersion;t({mac:i,model:o,hardwareVersion:c,softwareVersion:a}).then((t=>{200===t.code&&t.data.deviceId?r(t.data.deviceId):(s("请求third deviceId 失败"),n({mac:i,deviceInfo:e.deviceInfo,bindState:5}))})).catch((t=>{s(t),n({mac:i,deviceInfo:e.deviceInfo,bindState:5})}))})),onInputRandomNum:e=>{this.pageStatus=3,this.randomNum=e,n({mac:i,deviceInfo:ut(i),bindState:0})},onReadDeviceId:e=>{},onReadDeviceInfo:e=>{},onWaitUserSelect:e=>{console.log("plugin","onWaitUserSelect")},onDeviceAuth:e=>Qe({mac:i,model:e.deviceInfo.model})},s={listeners:r,userInfo:{height:170,weight:60}};Se.bind(i,s,((e,t)=>{switch(t){case 0:case 1:case 2:case 3:break;case 4:Fe({mac:e}),n({mac:e,deviceInfo:ut(e),bindState:4});break;default:console.log("绑定状态变化",t)}})).catch((e=>{console.log("绑定失败",e),n({mac:i,deviceInfo:ut(i),bindState:5,errorCode:e.code})}))}))}function it(e){Ge(),Se.cancelWork(e.mac,!0)}function nt(e){Ge();let t={fileBuffer:e.fileBuffer,model:e.model,onUpgradeProcess:e.onUpgradeProcess,onUpgradeComplete:e.onUpgradeComplete};try{return Se.ota(e.mac,t)}catch(e){console.debug("error",e)}}function rt(e){Ge(),Se.cancelSetting(e.mac)}function st(e){return Ge(),Se.getConnectionState(e.mac)}function ot(){return Ge(),Se.checkBluetoothAvailable()}function ct(e){return Ge(),Se.pushSetting(e.mac,e.setting)}function at(e){Ge(),Se.$on(e.eventName,e.eventKey,e.callback)}function dt(e){Se.$off(e.eventName,e.eventKey)}function ht(e){return Ge(),Se.getSetting(e.mac,e.settingType)}function lt(e){return Se.cancelSetting(e)}function ut(e){return Se.getDeviceInfo(e)}function ft(e){return Se.cancelWork(e,!0)}function vt(e,t,i){return Se.syncData(e,t,i)}function pt(e){Oe(e)}function gt(e){$e(e)}function mt(){Ke()}function wt(e){ze(e)}function St(e){!function(e){q.push(e.uuid),e.serviceId&&!0===e.serviceId&&J.push(e.uuid),H.push(e)}(e)}function It(e,t=null,i=null,n=null){return S.errorCode(e,t,i,n)}function Ct(...e){return p.debug(...e)}function yt(...e){return p.info(...e)}function kt(...e){return p.warn(...e)}function Dt(...e){return p.error(...e)}var Mt={getVersion:Ze,init:Xe,startScanning:Ye,stopScanning:et,bindDevice:tt,cancelBind:it,getConnectionState:st,isBluetoothAvailable:ot,pushSetting:ct,addMonitorDevice:pt,setMonitorDevice:gt,deleteAllMonitorDevice:mt,deleteMonitorDevice:wt,cancelSetting:lt,ota:nt,cancelOta:rt,$on:at,$off:dt,getDeviceInfo:ut,getSetting:ht,connectDevice:vt,disconnect:ft,regist:St,errorCode:It,Logger:{errorCode:It,debug:Ct,warn:kt,info:yt,error:Dt}};module.exports={getVersion:Ze,init:Xe,startScanning:Ye,stopScanning:et,bindDevice:tt,cancelBind:it,getConnectionState:st,isBluetoothAvailable:ot,pushSetting:ct,addMonitorDevice:pt,setMonitorDevice:gt,deleteAllMonitorDevice:mt,deleteMonitorDevice:wt,cancelSetting:lt,ota:nt,cancelOta:rt,$on:at,$off:dt,getDeviceInfo:ut,getSetting:ht,connectDevice:vt,disconnect:ft,regist:St,errorCode:It,Logger:{errorCode:It,debug:Ct,warn:kt,info:yt,error:Dt}},e.$off=dt,e.$on=at,e.addMonitorDevice=pt,e.bindDevice=tt,e.cancelBind=it,e.cancelOta=rt,e.cancelSetting=lt,e.connectDevice=vt,e.debug=Ct,e.default=Mt,e.deleteAllMonitorDevice=mt,e.deleteMonitorDevice=wt,e.disconnect=ft,e.error=Dt,e.errorCode=It,e.getConnectionState=st,e.getDeviceInfo=ut,e.getSetting=ht,e.getVersion=Ze,e.info=yt,e.init=Xe,e.isBluetoothAvailable=ot,e.ota=nt,e.pushSetting=ct,e.regist=St,e.setMonitorDevice=gt,e.startScanning=Ye,e.stopScanning=et,e.warn=kt,Object.defineProperty(e,"__esModule",{value:!0})}));

}, function(modId) {var map = {}; return __REQUIRE__(map[modId], modId); })
return __REQUIRE__(1646020212293);
})()
//miniprogram-npm-outsideDeps=[]
//# sourceMappingURL=index.js.map
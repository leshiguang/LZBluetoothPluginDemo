module.exports = (function() {
var __MODS__ = {};
var __DEFINE__ = function(modId, func, req) { var m = { exports: {}, _tempexports: {} }; __MODS__[modId] = { status: 0, func: func, req: req, m: m }; };
var __REQUIRE__ = function(modId, source) { if(!__MODS__[modId]) return require(source); if(!__MODS__[modId].status) { var m = __MODS__[modId].m; m._exports = m._tempexports; var desp = Object.getOwnPropertyDescriptor(m, "exports"); if (desp && desp.configurable) Object.defineProperty(m, "exports", { set: function (val) { if(typeof val === "object" && val !== m._exports) { m._exports.__proto__ = val.__proto__; Object.keys(val).forEach(function (k) { m._exports[k] = val[k]; }); } m._tempexports = val }, get: function () { return m._tempexports; } }); __MODS__[modId].status = 1; __MODS__[modId].func(__MODS__[modId].req, m, m.exports); } return __MODS__[modId].m.exports; };
var __REQUIRE_WILDCARD__ = function(obj) { if(obj && obj.__esModule) { return obj; } else { var newObj = {}; if(obj != null) { for(var k in obj) { if (Object.prototype.hasOwnProperty.call(obj, k)) newObj[k] = obj[k]; } } newObj.default = obj; return newObj; } };
var __REQUIRE_DEFAULT__ = function(obj) { return obj && obj.__esModule ? obj.default : obj; };
__DEFINE__(1646653978715, function(require, module, exports) {
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).RollupLearn={})}(this,(function(e){const t=e=>i({path:"/device-rest/api/device/apply/v1.0/applyDeviceIdForBTSDK",data:e});function i(e){return new Promise(((t,i)=>{console.debug("post",e),wx.request({url:"https://api-r1.leshiguang.com"+e.path,method:"POST",data:e.data,header:{"content-type":"application/json","Accept-Encoding":"gzip, deflate"},success(e){console.debug("请求成功",e.data,e),t(e.data)},fail(e){console.error("请求失败",e),i(e)}})}))}function n(e){return function(e){for(var t="0123456789abcdef",i="",n=0;n<4*e.length;n++)i+=t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15);return i}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var i=1732584193,n=-271733879,r=-1732584194,h=271733878,l=0;l<e.length;l+=16){var u=i,f=n,p=r,g=h;i=s(i,n,r,h,e[l+0],7,-680876936),h=s(h,i,n,r,e[l+1],12,-389564586),r=s(r,h,i,n,e[l+2],17,606105819),n=s(n,r,h,i,e[l+3],22,-1044525330),i=s(i,n,r,h,e[l+4],7,-176418897),h=s(h,i,n,r,e[l+5],12,1200080426),r=s(r,h,i,n,e[l+6],17,-1473231341),n=s(n,r,h,i,e[l+7],22,-45705983),i=s(i,n,r,h,e[l+8],7,1770035416),h=s(h,i,n,r,e[l+9],12,-1958414417),r=s(r,h,i,n,e[l+10],17,-42063),n=s(n,r,h,i,e[l+11],22,-1990404162),i=s(i,n,r,h,e[l+12],7,1804603682),h=s(h,i,n,r,e[l+13],12,-40341101),r=s(r,h,i,n,e[l+14],17,-1502002290),i=a(i,n=s(n,r,h,i,e[l+15],22,1236535329),r,h,e[l+1],5,-165796510),h=a(h,i,n,r,e[l+6],9,-1069501632),r=a(r,h,i,n,e[l+11],14,643717713),n=a(n,r,h,i,e[l+0],20,-373897302),i=a(i,n,r,h,e[l+5],5,-701558691),h=a(h,i,n,r,e[l+10],9,38016083),r=a(r,h,i,n,e[l+15],14,-660478335),n=a(n,r,h,i,e[l+4],20,-405537848),i=a(i,n,r,h,e[l+9],5,568446438),h=a(h,i,n,r,e[l+14],9,-1019803690),r=a(r,h,i,n,e[l+3],14,-187363961),n=a(n,r,h,i,e[l+8],20,1163531501),i=a(i,n,r,h,e[l+13],5,-1444681467),h=a(h,i,n,r,e[l+2],9,-51403784),r=a(r,h,i,n,e[l+7],14,1735328473),i=o(i,n=a(n,r,h,i,e[l+12],20,-1926607734),r,h,e[l+5],4,-378558),h=o(h,i,n,r,e[l+8],11,-2022574463),r=o(r,h,i,n,e[l+11],16,1839030562),n=o(n,r,h,i,e[l+14],23,-35309556),i=o(i,n,r,h,e[l+1],4,-1530992060),h=o(h,i,n,r,e[l+4],11,1272893353),r=o(r,h,i,n,e[l+7],16,-155497632),n=o(n,r,h,i,e[l+10],23,-1094730640),i=o(i,n,r,h,e[l+13],4,681279174),h=o(h,i,n,r,e[l+0],11,-358537222),r=o(r,h,i,n,e[l+3],16,-722521979),n=o(n,r,h,i,e[l+6],23,76029189),i=o(i,n,r,h,e[l+9],4,-640364487),h=o(h,i,n,r,e[l+12],11,-421815835),r=o(r,h,i,n,e[l+15],16,530742520),i=c(i,n=o(n,r,h,i,e[l+2],23,-995338651),r,h,e[l+0],6,-198630844),h=c(h,i,n,r,e[l+7],10,1126891415),r=c(r,h,i,n,e[l+14],15,-1416354905),n=c(n,r,h,i,e[l+5],21,-57434055),i=c(i,n,r,h,e[l+12],6,1700485571),h=c(h,i,n,r,e[l+3],10,-1894986606),r=c(r,h,i,n,e[l+10],15,-1051523),n=c(n,r,h,i,e[l+1],21,-2054922799),i=c(i,n,r,h,e[l+8],6,1873313359),h=c(h,i,n,r,e[l+15],10,-30611744),r=c(r,h,i,n,e[l+6],15,-1560198380),n=c(n,r,h,i,e[l+13],21,1309151649),i=c(i,n,r,h,e[l+4],6,-145523070),h=c(h,i,n,r,e[l+11],10,-1120210379),r=c(r,h,i,n,e[l+2],15,718787259),n=c(n,r,h,i,e[l+9],21,-343485551),i=d(i,u),n=d(n,f),r=d(r,p),h=d(h,g)}return Array(i,n,r,h)}(function(e){for(var t=Array(),i=255,n=0;n<8*e.length;n+=8)t[n>>5]|=(e.charCodeAt(n/8)&i)<<n%32;return t}(e),8*e.length))}function r(e,t,i,n,r,s){return d((a=d(d(t,e),d(n,s)))<<(o=r)|a>>>32-o,i);var a,o}function s(e,t,i,n,s,a,o){return r(t&i|~t&n,e,t,s,a,o)}function a(e,t,i,n,s,a,o){return r(t&n|i&~n,e,t,s,a,o)}function o(e,t,i,n,s,a,o){return r(t^i^n,e,t,s,a,o)}function c(e,t,i,n,s,a,o){return r(i^(t|~n),e,t,s,a,o)}function d(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}let h={};var l={set(e,t){h[e]=t},get:e=>h[e]};function u(e){let t=e;t?l.set("options",t):t=l.get("options");let i=(new Date).getTime(),r=t.appKey,s=t.appSecret,a=new Array(i,r,s,"1.0"),o=((c=a).sort(),n(c.join("")).toUpperCase());var c;l.set("secretSign",`api_appKey=${r}&signSecret=${s}&api_sign=${o}&api_timestamp=${i}&api_version=1.0&associatedId=${t.associatedId}`),l.set("userId",t.userId),l.set("appId","wxe3d2a6ab8dd5b49b")}[{key:"baseUrl",defaultValue:"https://api.leshiguang.com",desc:"请求url"},{key:"secretSign",defaultValue:"2a6bfL45*2219cZi44c7f78231e3cF80ensea13072eSb672_!",desc:"ajax请求签名key"}].forEach((({key:e,defaultValue:t})=>{l.set(e,t)}));let f=console;const p="LS-BLE";var g={constructor(){this.isOtaing=!1},debugMode:()=>!0,isPrintValueChange(){return!(!f||!f.printValueChange)||null!=this.printValueChange&&null!=this.printValueChange&&this.printValueChange},setOtaing(e){this.isOtaing=e},setPrintValueChange(e){this.printValueChange=e},isPrintWrite(){return null==this.printWrite||this.printWrite},setPrintWrite(e){this.printWrite=e},debug(...e){this.isOtaing||(e.unshift(m(),p),f.debug(...e))},debugValueChange(...e){this.isPrintValueChange()&&e.unshift(m(),p),this.isPrintValueChange()&&f.debug(...e)},info(...e){this.isOtaing||(e.unshift(m(),p),f.info(...e))},warn(...e){e.unshift(m(),p),f.warn(...e)},error(...e){e.unshift(m(),p),f.error(...e)},logE(...e){e.unshift(m(),p),f.error(...e)},log(...e){this.isOtaing||(e.unshift(m(),p),f.info(...e))},logIos(...e){e.unshift(m(),p),f.error(...e)},logBle(...e){e.unshift(m(),"<ble>"),f.warn(...e)},logBleError(...e){e.unshift(m(),"<ble>"),f.error(...e)},setLogger(e){f=e}};const v=e=>(e=e.toString())[1]?e:"0"+e;function m(){const e=new Date;return"["+[e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()].map(v).join(":")+"]"}function w(e){switch(e){case 0:return"成功";case 1:return"未连接";case 2:return"没有特征服务";case 3:return"超时";case 4:return"丢弃";case 13:return"用户取消了绑定";case 14:return"手环已绑定";case 5:return"设备报错";case 6:return"蓝牙库报错";case 8:return"文件不支持";case 15:return"参数错误";case 16:return"内存不足";case 9:return"电量低";case 12:case 19:return"未发现设备";case 11:return"鉴权失败";case 10:return"不支持";case 7:return"工作繁忙";case 30:return"写数据错误";case 20:return"未开启定位权限";case 21:return"没有蓝牙权限";case 25:return"为实现申请deviceId方法";default:return"未知错误"}}var S={success:function(e=null,t=null,i=0){return{success:!0,msg:"success",value:t,originResponse:e,data:e,code:i}},fail:function(e="",t=null,i=null){return{success:!1,msg:e,value:i,originResponse:t,data:t}},failCode:function(e=-1,t="",i=null,n=null,r=null){return{success:!1,msg:t,value:n,originResponse:i,data:i,extra:r,code:e}},errorCode:function(e=0,t=null,i=null,n=null){return{success:0===e,msg:w(e),value:i,originResponse:t,data:t,extra:n,code:e}}};class I{constructor({uuid:e,isPrimary:t}){this.uuid=e.toUpperCase(),this.isPrimary=t,this.characteristics=[]}}function C(e,t){if(!e)return"";if("string"==typeof e)return e;let i=Array.prototype.map.call(new Uint8Array(e),(function(e){return("00"+e.toString(16)).slice(-2)}));if(t){let e=[];for(let t=0;t<i.length;t++)e.push(i[i.length-1-t]);return e.join("")}return i.join("")}let k=wx.getSystemInfoSync();function y(){return k.platform.toLowerCase().indexOf("ios")>-1}function D(e){return e&&e.length>8?e.toString().substring(4,8):e}const M="0000180A-0000-1000-8000-00805F9B34FB",A="00002A25-0000-1000-8000-00805F9B34FB";class b{constructor(e,t,i,n,r){this.completion=[],this.count=1,this.deviceId=e,this.connector=t,this.disConnector=i,this.connectMode=n,this.sid=Math.random(),this.timeout=r+1e3}async start(){this.resetTimeout();try{0===this.connectMode?(await this.connector(this.deviceId,this.timeout-1e3),this.callback(S.errorCode(0,"连接成功3"))):(await this.disConnector(this.deviceId),this.callback(S.errorCode(0,"断开连接")))}catch(e){this.callback(e)}}resetTimeout(){this._clearTimeout();let e=this;this.timeoutId=setTimeout((()=>{e.callback(S.errorCode(3,"超时"))}),this.timeout)}_clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}callback(e){this._clearTimeout(),this.completion&&(e.sid=this.sid,this.completion.forEach((t=>{t(e)})),this.completion=null),this.isClear=!0}clear(){this.disConnector(this.deviceId),this.callback(S.errorCode(4))}}var x=new class{constructor(){this.sessionList=new Array}connect(e,t,i){g.debug("deviceId",e);let n=this.findSession(e);n&&0===n.connectMode&&0===n.connectMode?n.completion.push(i):(this.sessionList.push(this.createSession(e,0,i,t)),this.dispatchNextAction())}disConnect(e,t,i){let n=this.findSession(e);n&&1===n.connectMode?n.completion.push(i):(this.sessionList.push(this.createSession(e,1,i,t)),this.dispatchNextAction())}dispatchNextAction(){if(!this.workingSession&&this.sessionList.length>0){let e=this.sessionList[0];this.sessionList.shift(),this.workingSession=e,e.start()}else this.workingSession}cancelCurrentSession(){this.workingSession&&(this.workingSession.clear(),this.workingSession=null)}createSession(e,t,i,n){let r=new b(e,this.connector,this.disConnector,t,n),s=this;return r.completion.push((e=>{s.workingSession&&(s.workingSession=null),i&&i(e),s.dispatchNextAction()})),r}findSession(e){let t=null;this.workingSession&&this.workingSession.deviceId===e&&(t=this.workingSession);for(let i=0;i<this.sessionList.length;i++){let n=this.sessionList[i];if(n.deviceId===e){t=n;break}}return t}clear(){try{this.workingSession&&(this.workingSession.clear(),this.workingSession=null),this.sessionList.forEach((e=>{e.callback(S.errorCode(4))})),this.sessionList.length=0}catch(e){g.warn("操作取消",e)}}};const P=new Map,B=new Map,T=new Map,W=new Map,L=new Map,E=new Map;var R=null,U=null;const _="ble-next";function V(e,t){B.set(e,t)}function N(e,t){P.set(e,t)}function j(e,t,i){let n=E.get(t);n||(n=new Map,E.set(t,n)),n.set(e,i)}function O(e){let t=L.get(e);t&&t.forEach((t=>{t&&t({deviceId:e,connected:!1})})),P.forEach((t=>{t({deviceId:e,connected:!1})}))}class ${constructor(e){this.isConnectingAndReadDeviceInfo=!1,this.deviceInfo=new Map,this.serviceMap=new Map,this.readTimeoutMap=new Map,this.clientDataChangeListener=new Map,this.writBufferQueue=[],this.deviceId=e,this.performance={},this.isRecycle=!1,this.deviceInfoCharacteristics=[],this.setDefaultDataChange()}recycle(){this.resetState()}setDefaultDataChange(){let e=this;j("_c",this.deviceId,(t=>{t.serviceId===M&&e.deviceInfo.set(t.characteristicId,t.value),e.clientDataChangeListener.forEach(((i,n)=>{i(t)&&e.clientDataChangeListener.delete(n)}))})),function(e,t,i){let n=L.get(t);n||(n=new Map,L.set(t,n)),n.set(e,i)}("_c",this.deviceId,(t=>{e.connected=t.connected,t.connected||e.resetState()}))}connect(e=1e4){return this.writing=!1,new Promise(((t,i)=>{let n=this;x.connect(this.deviceId,e,(e=>{e.success?(n.connected=!0,t(e)):(n.connected=!1,i(e))}))}))}disconnect(){let e=this.deviceId;this.connected=!1;let t=this;return this.resetState(),g.info("disconnect",this.deviceId),new Promise(((i,n)=>{x.disConnect(e,0,(e=>{t.connected=!1,i(S.errorCode(0))}))}))}discoverServices(e){return g.logBle("discoverServices",this.deviceId),this.performance.getServicesStart=new Date,new Promise((async(t,i)=>{var n;0!=e&&await(n=e,new Promise(((e,t)=>{setTimeout((()=>{e(null)}),n)})));let r=this;wx.getBLEDeviceServices({deviceId:this.deviceId,success:async e=>{if(!e||!e.services||0===e.services.length)return g.error("获取服务为空"),r.disconnect(),r.callbackDisConnectStateChanged(),void i(S.errorCode(6));let n=[];for(let t=0;t<e.services.length;t++){let i=(s=e.services[t].uuid).length>16?s:`0000${s}-0000-1000-8000-00805F9B34FB`;if(-1!=i.indexOf("1801"))continue;let a=new I(e.services[t]);n.push(a),r.serviceMap.set(i,a);let o=await r.discoverCharacteristic(i);a.characteristics=o.originResponse}var s;r.services=n,r.isServiceDiscoveredFinished=!0,setTimeout((()=>{t(S.success(e))}),0)},fail:e=>{g.error("获取服务失败: ",r.deviceId,e,r.services),10006===e.code?(r.disconnect(),r.callbackDisConnectStateChanged(),i(S.errorCode(1))):i(S.errorCode(6))},complete:e=>{try{let e=new Date;r.performance.getServicesEnd=e,r.performance.getCharacteristicsStart=e,r.performance.getServiceTime=e.getTime()-this.performance.getServicesStart.getTime()}catch(e){}}})}))}makeBluetoothPair(e){return g.debug("makeBluetoothPair",e),new Promise(((e,t)=>{if(wx.makeBluetoothPair)wx.makeBluetoothPair({deviceId:this.deviceId,success:t=>{g.debug("makeBluetoothPair success",t),e(S.success(t))},fail:e=>{g.error("makeBluetoothPair fail",e),t(S.errorCode(6,e))}});else try{wx.sendNativeEvent("makeBluetoothPair",{deviceId:this.deviceId},(i=>{g.debug("makeBluetoothPair ret",i),i&&200===i.code?e(S.success(i)):t(S.errorCode(10,i))}))}catch(e){t(S.errorCode(10,e))}}))}discoverCharacteristic(e){let t=this.deviceId,i=this;return new Promise(((n,r)=>{wx.getBLEDeviceCharacteristics({deviceId:t,serviceId:e,success:t=>{g.logBle("discover char",D(e)),n(S.success(t.characteristics))},fail:n=>{g.error("discover fail: ",t,e,n),10006===n.code?(i.disconnect(),i.callbackDisConnectStateChanged(),r(S.errorCode(1))):r(S.errorCode(6))}})}))}enable(e,t){let i=this,n=this.deviceId;return g.warn("enable ",this.deviceId,D(e),D(t)),new Promise(((r,s)=>{wx.notifyBLECharacteristicValueChange({state:!0,deviceId:n,serviceId:e,characteristicId:t,success:i=>{g.debug("打开通道成功",e,t,i),r(S.success(i))},fail:t=>{g.error("打开通道失败:",e,n,t),10006===t.code?(i.disconnect(),i.callbackDisConnectStateChanged(),s(S.errorCode(1))):s(S.errorCode(6))}})}))}disable(e,t){let i=this;return g.warn("disable ",this.deviceId,D(e),D(t)),new Promise(((n,r)=>{wx.notifyBLECharacteristicValueChange({state:!1,deviceId:this.deviceId,serviceId:e,characteristicId:t,success:e=>{n(S.success(e))},fail:e=>{g.error("disable fail: ",this.deviceId,e),10006===e.code?(i.disconnect(),i.callbackDisConnectStateChanged(),r(S.errorCode(1))):r(S.errorCode(6))}})}))}read(e,t){let i=this;return new Promise(((n,r)=>{i.clearReadTimeout(t),j(t,i.deviceId,(r=>{r.serviceId===e&&r.characteristicId===t&&(i.clearReadTimeout(t),setTimeout((()=>{n(S.success(r))}),0))}));let s=setTimeout((()=>{i.clearReadTimeout(t),r(S.errorCode(3))}),3e3);i.readTimeoutMap.set(t,s),g.warn("读数据",D(t)),wx.readBLECharacteristicValue({deviceId:this.deviceId,serviceId:e,characteristicId:t,success:e=>{},fail:e=>{g.error("read fail: ",this.deviceId,e),10006===e.code?(i.disconnect(),i.callbackDisConnectStateChanged(),r(S.errorCode(1))):r(S.errorCode(6))}})}))}writeList(e,t,i){if(i&&!(i.length<1)){for(let n=0;n<i.length;n++){let r={};r.byte=i[n],r.characteristicId=t,r.serviceId=e,this.writBufferQueue.push(r)}this.writing||this.handWriteQueue()}}handWriteQueue(){if(this.writBufferQueue.length>0){let e=this.writBufferQueue.shift();this.write(e.serviceId,e.characteristicId,e.byte).then((e=>{this.handWriteQueue()})).catch((e=>{g.error("WriteQueue error",e),this.handWriteQueue()}))}}write(e,t,i){return new Promise(((n,r)=>{this.doWxWrite(e,t,i,n,0,r)}))}doWxWrite(e,t,i,n,r,s){this.writing=!0;let a=this;e.indexOf("A700")>=0||g.isPrintValueChange()&&g.info("try write Data","["+D(t)+"]",C(i),a.deviceId),wx.writeBLECharacteristicValue({deviceId:this.deviceId,serviceId:e,characteristicId:t,value:i,success(e){n(S.success(e))},fail:o=>{10008===(o.errCode||o.code)&&r<3?(g.error("write: retryCount: ",r,a.deviceId,t,o),setTimeout((()=>{a.doWxWrite(e,t,i,n,++r,s)}),100)):(g.error("write error: ",this.deviceId,"["+D(t)+"]",o),10006===o.code?s(S.errorCode(30)):s(S.errorCode(6)))},complete:()=>{this.writing=!1}})}setMtu(e,t){return new Promise(((i,n)=>{if(wx.setBLEMTU)if(2===t)i(S.success({mtu:158}));else{let t=setTimeout((()=>{g.error("setBLEMTU timeout"),i(S.success({mtu:23}))}),1500);g.info("setBLEMTU ",e),wx.setBLEMTU({deviceId:this.deviceId,mtu:e,success:n=>{t&&clearTimeout(t);let r=n.mtu;r||(r=e),g.info("setBLEMTU success",n,r),i(S.success({mtu:r}))},fail:e=>{t&&clearTimeout(t),g.error("setMtu fail: ",this.deviceId,e),i(S.success({mtu:23}))}})}else g.error("setMtu fail: wx.setBLEMTU 未实现 "),i(S.success({mtu:23}))}))}async connectAndDiscoverServices(e){try{return g.warn("connectAndDiscoverServices",this.deviceId),await this.connect(e),await this.discoverServices(0),Promise.resolve(S.success("连接与发现服务成功"))}catch(e){return g.error("connnectAndDiscoverServices",e),Promise.reject(S.fail("连接与发现服务失败"))}}async connectAndReadDeviceInfo(e=!0,t){if(!e&&this.isConnectingAndReadDeviceInfo&&this.deviceInfo&&this.deviceInfo.size>0)return Promise.resolve(S.success(this.deviceInfo));this.isConnectingAndReadDeviceInfo=!0;try{await this.connectAndDiscoverServices(1e4)}catch(e){return Promise.reject(e)}return this.readDeviceInfo(t)}async readDeviceInfo(e){try{g.debug("readDeviceInfo",e);let t=M;if(e&&e.length>0){for(let i=0;i<e.length;i++){let n=e[i];await this.read(t,n)}return this.isConnectingAndReadDeviceInfo=!1,Promise.resolve(S.success(this.deviceInfo))}if(null==e){let e=this.serviceMap.get(t);if(e&&e.characteristics)for(let i=0;i<e.characteristics.length;i++){let n=e.characteristics[i];await this.read(t,n.uuid)}}return this.isConnectingAndReadDeviceInfo=!1,Promise.resolve(S.success(this.deviceInfo))}catch(e){return g.logBleError(e,"获取deviceInfo失败",this.deviceInfo.size),this.isConnectingAndReadDeviceInfo=!1,Promise.reject(e)}}clearReadTimeout(e){let t=this.readTimeoutMap.get(e);t&&(clearTimeout(t),this.readTimeoutMap.delete(e))}callbackDisConnectStateChanged(){O(this.deviceId)}resetState(){this.connected=!1,this.isServiceDiscoveredFinished=!1,this.isConnectingAndReadDeviceInfo=!1,this.writing=!1,this.writBufferQueue.length=0,this.clientDataChangeListener.clear()}}var F;!function(e){e[e.ALL=0]="ALL",e[e.Normal=1]="Normal",e[e.ConnectAndNormal=2]="ConnectAndNormal"}(F||(F={}));let z=new Map;const K=[],Q=[],H=[];function J(e){for(let t of e){let e="";e="string"==typeof t?t.toUpperCase():t.uuid.toUpperCase();for(let t=0;t<K.length;t++)if(e&&e.indexOf(K[t].uuid)>-1)return K[t]}g.error("不支持的设备",e)}function q(e,t){z.set(e,t)}function G(e){return z.get(e)}let Z=new Map,X=new Map;var Y,ee={wx:{Adapter:class{constructor(){this.available=!1,this.scanning=!1,this.readingMac=!1,this.scanCallbacks=new Map,this.connectStateListerner=new Map,this.connectedMap=new Map,this.connectResoveMap=new Map;let e=this;V("_a",(t=>{e.available=t.available,!1===t.available&&(e.connectedMap.forEach(((t,i)=>{g.debug("设备连接",i,t);let n=e.getClient(i);O(n.deviceId),n.recycle()})),e.clear()),e.available=t.available})),x.connector=(e,t)=>this.connect(e,t),x.disConnector=e=>this.disconnect(e),function(e,t){W.set(e,t)}("_a",(t=>{t&&t.devices&&t.devices.forEach((t=>{let i=e.getClient(t.deviceId);i.name=t.name,i.advertisementData=t,i.isSystemConnect=!1,i.services=i.advertisementData.advertisServiceUUIDs,setTimeout((()=>{e.callbackScanResult(i)}),0)}))})),N("_a",(t=>{let i=t.deviceId;t.connected?(e.connectedMap.set(t.deviceId,this.getClient(i)),setTimeout((t=>{let n=e.connectResoveMap.get(i);n&&(e.connectResoveMap.delete(i),n.resolve(S.success("连接成功1")))}),2e3)):e.connectedMap.delete(t.deviceId)})),x.connector=(e,t)=>this.connect(e,t),x.disConnector=e=>this.disconnect(e)}openBLEAdapter(){return new Promise(((e,t)=>{let i=(i,n)=>{i?e(S.success()):t(S.fail("打开适配器失败",n))};wx.openBluetoothAdapter({success:()=>{g.debug("开启蓝牙适配器"),this.getBLEAdapterState(i)},fail:t=>{g.error("开启蓝牙适配器失败",t.errCode,t.errMsg),this.getBLEAdapterState((t=>{t?e(S.success()):this.reopenBLEAdapter(i)}))}})}))}startScan(e,t,i,n,r){if(!this.available)return void(this.scanning=!1);this.scanCallbacks.set(e,n);let s=this;var a;((r===F.ALL||r===F.ConnectAndNormal)&&Q.length>0&&(this.readingMac||(this.readingMac=!0,wx.getConnectedBluetoothDevices({success(e){g.warn("getConnectedBluetoothDevices",e);let t=e.devices.length,i=e=>{e<=0&&(s.readingMac=!1)};for(let r=0;r<e.devices.length;r++){let a=e.devices[r];g.debug("system client",a);let o=s.getClient(a.deviceId);if(o.name=a.name,y()){let e=X.get(a.deviceId);e&&e.get(A)?(o.deviceInfo=e,o.isSystemConnect=!0,t-=1,i(t),s.callbackScanResult(o)):o.connectAndReadDeviceInfo(!1,[A]).then((e=>{e.originResponse&&(X.set(a.deviceId,e.originResponse),o.isSystemConnect=!0,t-=1,i(t),n(o))})).catch((e=>{g.warn("read mac error",e),t-=1,i(t),s.callbackScanResult(o)}))}else o.isSystemConnect=!1,t-=1,i(t),s.callbackScanResult(o)}},fail(e){s.readingMac=!1,g.warn("getConnectedBluetoothDevices error",e)},services:Q}))),r===F.ALL&&wx.getBluetoothDevices({success(e){e.devices.forEach((async e=>{if(e.deviceId){let t=s.getClient(e.deviceId);if(t.name=e.name,e.advertisServiceUUIDs&&e.advertisServiceUUIDs.length>0)setTimeout((()=>{t.advertisementData=e,t.isSystemConnect=!1,t.services=e.advertisServiceUUIDs||t.advertisementData.advertisServiceUUIDs||t.services,s.callbackScanResult(t)}),1e3);else{let i=X.get(e.deviceId);i?(t.deviceInfo=i,t.isSystemConnect=!0,n(t)):y()||n(t)}}}))}}),this.scanning&&this.available)?g.debug("正在搜索中"):0!==this.scanCallbacks.size?(this.stopScanTime(),this.scanning=!0,this.scanTimeout=setTimeout((()=>{s.stopScan()}),6e4),(a={services:t,allowDuplicatesKey:i,success:()=>{this.scanning=!0,g.logBle("开始扫描......",JSON.stringify(e))},fail:e=>{this.scanning=!1,g.logBleError("扫描失败",JSON.stringify(e))}}).unikey=_,R?R(a):wx.startBluetoothDevicesDiscovery(a)):g.debug("没有回调")}stopScan(e){var t;e?this.scanCallbacks.delete(e):this.scanCallbacks.clear(),g.debug("stopScan",e,this.scanCallbacks.size),e||(g.debug("stopScan all",e,this.scanCallbacks.size),this.scanning=!1,this.readingMac=!1,(t={success(e){},complete:e=>{g.logBle("停止扫描",JSON.stringify(e)),this.scanning=!1}}).unikey=_,U?U(t):wx.stopBluetoothDevicesDiscovery(t))}getClient(e){if(!e)return g.error("wx deviceId",e),null;let t=Z.get(e);return t||(t=new $(e),Z.set(e,t)),t}reopenBLEAdapter(e){g.info("重启蓝牙适配器"),this.clear(),x.clear(),wx.closeBluetoothAdapter({success(){},complete:()=>{wx.openBluetoothAdapter({success(){},complete:()=>{g.info("重启完成"),this.getBLEAdapterState(e)}})}})}getBLEAdapterState(e){wx.getBluetoothAdapterState({success:t=>{this.available=t.available,e&&e(this.available,t)},fail:t=>{this.available=!1,g.error("getBluetoothAdapterState失败",t),e&&e(!1,t)}})}stopScanTime(){this.scanTimeout&&(clearTimeout(this.scanTimeout),this.scanTimeout=null)}clear(){this.scanning=!1,this.stopScanTime(),this.readingMac=!1,this.scanCallbacks.clear()}callbackScanResult(e){this.scanCallbacks.size>0&&this.scanCallbacks.forEach((t=>t&&t(e)))}connect(e,t=1e4){return g.warn("createBLEConnection",e,t),this.available?new Promise(((i,n)=>{let r=this;this.connectResoveMap.set(e,{resolve:i,reject:n}),wx.createBLEConnection({deviceId:e,timeout:t,success:t=>{r.connectResoveMap.delete(e),g.warn("connect success1"),i(S.success("连接成功2"))},fail:t=>{if(-1===t.errCode||-1===t.code)return g.logBle("重复连接: ",e,t),r.connectResoveMap.delete(e),void i(S.success(t));g.error("蓝牙连接失0: ",e,JSON.stringify(t)),r.connectResoveMap.delete(e),wx.closeBLEConnection({deviceId:e,success(e){setTimeout((e=>{n(S.errorCode(6))}),0)},fail(e){setTimeout((e=>{n(S.errorCode(6))}),0)}})}})})):Promise.reject(S.errorCode(21))}disconnect(e){return g.warn("closeBLE",e),this.available?(this.connectResoveMap.delete(e),new Promise(((t,i)=>{wx.closeBLEConnection({deviceId:e,success(e){t(S.errorCode(0))},fail(e){i(S.errorCode(0))}})}))):Promise.reject(S.errorCode(21))}},Client:$}};function te(e){if(!e||e.length<12)return"";let t=function(e){if(!e||0===e.length)return new ArrayBuffer(0);let t=e.length/2;if(t<1)return new ArrayBuffer(0);let i=new ArrayBuffer(t),n=new DataView(i);for(let i=0;i<t;i++){let t=e.substr(2*i,2),r=parseInt(t,16);n.setUint8(i,r)}return n.buffer}(e),i=new DataView(t),n=(i.getUint8(0)<<16)+(i.getUint8(1)<<8)+i.getUint8(2),r=(i.getUint8(3)<<16)+(i.getUint8(4)<<8)+i.getUint8(5);return n.toString(10).padStart(8,"0")+r.toString(10).padStart(8,"0")}!function(e){e[e.None=0]="None",e[e.Scan=1]="Scan",e[e.Connecting=2]="Connecting",e[e.Connected=3]="Connected",e[e.Worked=4]="Worked",e[e.Disconnected=5]="Disconnected"}(Y||(Y={}));const ie=new Map,ne=new Map;class re{constructor(){this.connectStatus=Y.None,this.workMode=0}get isWorking(){return!(this.connectStatus>Y.Worked||this.connectStatus===Y.None)}updateDeviceInfo(e){e&&(this.name=e.name,this.deviceId=e.deviceId,e.serialId&&(this.serialId=e.serialId),e.hardwareVersion&&(this.hardwareVersion=e.hardwareVersion),e.softwareVersion&&(this.softwareVersion=e.softwareVersion),e.firmwareVersion&&(this.firmwareVersion=e.firmwareVersion),this.updateDeviceId(e.lzDeviceId),!this.mac&&e.mac&&(this.mac=e.mac),this.localName||(this.localName=this.name),e.model&&(this.protoName&&this.protoName.indexOf("A6")>=0&&this.model&&0!==this.model.length||(this.model=e.model)),this.mac&&ie.set(this.mac,this))}updateAdvertisement(e){e&&e.mac&&(this.isRegister=e.isRegister,this.mac=e.mac,this.deviceId=e.deviceId,this.localName=e.localName,this.name=this.localName,this.RSSI=e.RSSI,e.model&&(this.model=e.model),this.mac&&ie.set(this.mac,this))}updateDeviceId(e){e&&(this.sn=te(e),this.lzDeviceId=e.toLowerCase(),this.id=e,this.mac&&ie.set(this.mac,this))}updateBleDeviceId(e){e&&(this.deviceId=e,this.mac&&(ie.set(this.mac,this),ne.set(e,this)))}updateClient(e){if(this.deviceId=e.deviceId,this.name=e.name,this.mac){let t=G(this.mac);t||(t=J(e.services),t?q(this.mac,t):g.error("proto 为nil",e.services)),this.protoName=t.name,ie.set(this.mac,this),ne.set(e.deviceId,this)}}updateA5DeviceInfo(e){this.model=e.model,this.softwareVersion=e.softVersion,this.hardwareVersion=e.hardwareVersion,this.mac&&ie.set(this.mac,this)}updateConnectStatus(e,t){g.info("更新状态",e,this.mac,t),this.connectStatus!=e&&(this.connectStatus=e),this.mac&&ie.set(this.mac,this)}}function se(e,t){let i=ne.get(e.deviceId);if(i){let t=G(i.mac);if(!t){if(t=J(e.services),!t)return g.warn("找不到对应的设置服务",e.deviceId,e.name),i;i.protoName=t.name,q(i.mac,t)}if(ne.set(e.deviceId,i),e.isSystemConnect)try{let n=t.parser.parseDeviceInfo(e,e.deviceInfo);i.updateDeviceInfo(n)}catch(e){g.warn("解析设备数据出错2",e,i)}else try{let n=t.parser.parseAdvertisementData(e,e.advertisementData);i.updateAdvertisement(n)}catch(e){g.warn("解析广播数据出错",e,i)}}else{if(!e.services)return null;let t=J(e.services);if(t){let i=new re;if(i.deviceId=e.deviceId,e.isSystemConnect)try{let n=t.parser.parseDeviceInfo(e,e.deviceInfo);i.updateDeviceInfo(n)}catch(e){g.warn("解析设备数据出错1",e,i)}else try{let n=t.parser.parseAdvertisementData(e,e.advertisementData);i.updateAdvertisement(n)}catch(e){g.warn("解析广播数据出错",e,i)}return g.debug("create new lzDevice",i.mac,i),i.mac&&(q(i.mac,t),i.protoName=t.name,ie.set(i.mac,i),ne.set(e.deviceId,i)),i}g.warn("找不到对应的服务",e.deviceId,e.name)}return i}function ae(e){let t=ie.get(e);return t||(t=new re,g.debug("create new lzDevice ------",t.mac,t),t.mac=e,ie.set(e,t)),t}function oe(e){return ne.get(e)}class ce{constructor(e,t,i=1001,n=100){this.actions=e,this.context=t,this.priority=i,this.id=n}}class de{constructor(e,t,i=1e3,n=200){this.priority=1e3;let r=[];this.priority=i,this.context=t,this.id=n,e.forEach((e=>{let t={name:"push",actionType:1,pushData:()=>e};r.push(t)})),this.actions=r}}class he{constructor(e,t,i){this.currentIndx=0,this.isClear=!1,this.sid=Math.random(),this.mac=t,this.mutipAction=e,this.client=i}didReceive(e){let t=this.mutipAction.actions[this.currentIndx];if(t.await&&t.await.didReceive){let i=t.await.didReceive(e,this.mutipAction.context);const n=typeof i;return"function"===n||i&&"object"===n?(i.success?(this._clearTimeout(),this.next()):this.callback(i),!0):(i&&this.resetTimeout(),!1)}}async doAction(e){if(!this.isClear)try{if(e.when&&!1===e.when(this.mutipAction.context))return void this.next();e.await?(this.timeout=e.await.timeout||4e3,this.resetTimeout(),this.tryExcuteAction(e)):(this._clearTimeout(),await this.tryExcuteAction(e),this.next())}catch(e){this.callback(e)}}async tryExcuteAction(e){if(e.ignoreError&&e.ignoreError(this.mutipAction.context)){try{await this.excuteAction(e)}catch(e){g.info("忽略错误",e)}return Promise.resolve()}return this.excuteAction(e)}async excuteAction(e){switch(e.actionType){case 0:return Promise.resolve();case 1:let t=e.pushData(this.mutipAction.context);return t instanceof Promise&&(t=await t),this.pusher(t);case 2:return this.client.enable(e.serviceId,e.characteristicId);case 3:return this.client.disable(e.serviceId,e.characteristicId);case 4:return this.client.read(e.serviceId,e.characteristicId)}}async next(){if(this.isClear)return g.warn("已经释放"),void this.callback(S.errorCode(4));this.currentIndx+=1,this.checkFinish()?this.mutipAction.responseData?this.callback(this.mutipAction.responseData):this.callback(S.errorCode(0,this.mutipAction.id)):await this.doAction(this.mutipAction.actions[this.currentIndx])}checkFinish(){return this.mutipAction.actions.length<=this.currentIndx}start(){this.currentIndx=0;try{this.doAction(this.mutipAction.actions[0])}catch(e){this.callback(S.errorCode(5))}}resetTimeout(){this._clearTimeout();let e=this;this.timeoutId=setTimeout((()=>{let t=e.mutipAction.actions[e.currentIndx];g.debug("timeout ",t.name),t&&t.await&&t.await.onTimeout&&t.await.onTimeout(e.mutipAction.context)?e.next():e.callback(S.errorCode(3,e.mutipAction.actions))}),this.timeout)}_clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}callback(e){g.debug("callback",e),e.originResponse=this.mutipAction.id,this._clearTimeout(),this.completion&&(e.sid=this.sid,this.completion(e),this.completion=null),this.isClear=!0}clear(){this.isClear=!0,this.callback(S.errorCode(1))}}class le{constructor(e,t){this.sessionList=new Array,this.sessionMap=new Map,this.workingSessionMap=new Map,this.mac=e,this.client=t}execute(e,t){let i=this.getSessionList(e.serviceId),n=this.getWorkingSession(e.serviceId);if(n&&n.mutipAction.id===e.id&&e.priority<=0)t&&t(S.errorCode(4));else{for(let t=0;t<i.length;t++){if(i[t].mutipAction.id===e.id){this.sessionList.splice(t,1);break}}i.push(this.createSession(e,t)),this.sessionList.sort(((e,t)=>t.mutipAction.priority-e.mutipAction.priority)),this.dispatchNextAction(e.serviceId)}}didReceive(e){return this.workingSession&&this.workingSession.didReceive(e),this.workingSessionMap.forEach(((t,i)=>{try{t.didReceive(e)}catch(e){g.error("error",e)}})),!0}dispatchNextAction(e){let t=this.getWorkingSession(e),i=this.getSessionList(e);if(!t||!1!==t.isClear)if(i.length>0){let t=i[0];i.shift(),e&&e.length>0?this.workingSessionMap.set(e,t):this.workingSession=t,t.start()}else g.debug("没有工作了",this.mac)}getSessionList(e){if(e&&e.length>0){let t=this.sessionMap.get(e);return t||(t=[],this.sessionMap.set(e,t),t)}return this.sessionList}getWorkingSession(e){return e&&e.length>0?this.workingSessionMap.get(e):this.workingSession}cancelCurrentSession(){this.workingSessionMap.forEach(((e,t)=>{e.clear()})),this.workingSessionMap.clear(),this.workingSession&&(this.workingSession.clear(),this.workingSession=null)}deleteWorkingSession(e){e&&e.length>0?this.workingSessionMap.delete(e):this.workingSession=null}createSession(e,t){let i=new he(e,this.mac,this.client);i.pusher=this.pusher;let n=this,r=e.serviceId;return i.completion=e=>{n.deleteWorkingSession(r),t&&t(e),n.dispatchNextAction(r)},i}stopTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}clear(){try{this.workingSession&&(this.workingSession.clear(),this.workingSession=null),this.workingSessionMap.forEach(((e,t)=>{e.clear()})),this.workingSessionMap.clear(),this.sessionMap.clear(),this.sessionList.length=0}catch(e){g.warn("操作取消",this.mac,e)}}}class ue{constructor(e,t,i){this.isOtaing=!1,this.sessionMap=new Map,this.mac=e,this.proto=t,this.context=i}async bind(e,t){if(this.isClear)return g.warn("bind 被释放了"),Promise.reject(S.errorCode(4));if(this.isWorking)return void g.warn("重复调用");this.context=e,this._initMutipleActionManager(e),this.workMode=1,this.isWorking=!0;let i=this.proto.bind.actions,n=new ce(i,e,1250),r=this;this.mutipActionManager.execute(n,(i=>{i.success?(r.didBinded(e),t(r.mac,0)):(r.isWorking=!1,r.workStateChanged&&this.workStateChanged(i),r.unWorked(),t(r.mac,i.code))}))}async sync(e,t){if(this.isClear)return void g.warn("sync 被释放了");if(this.isWorked){if(this.proto&&this.proto.dataParser.syncDataMutipleAction&&this.proto.dataParser.shouldIntervalSyncData){let e=this.proto.dataParser.syncDataMutipleAction(this.context),t=this.proto.dataParser.shouldIntervalSyncData(this.context);e&&!t&&this.excuteMutipAction(e)}return}g.info("sync",this.mac),this._initMutipleActionManager(e),this.workMode=0,this.isWorking=!0;let i=this.proto.sync.actions,n=new ce(i,e,1250),r=this;this.mutipActionManager.execute(n,(i=>{i.success?(r.didWorked(e),t(r.mac,0)):(r.isWorking=!1,r.workStateChanged&&r.workStateChanged(i),r.unWorked(),t(r.mac,i.code))}))}ota(e){if(this.proto.dataParser.otaAction){let t=this,i=e.onUpgradeComplete,n=(e,n)=>{g.debug("ota 完成"),t.isOtaing=!1,i&&i(e,n)};e.onUpgradeComplete=n;let r=this.proto.dataParser.otaAction(this.context,e);if(r)return this.isOtaing=!0,this.excuteMutipAction(r)}return e.onUpgradeComplete&&e.onUpgradeComplete(10,"不支持ota升级"),Promise.reject(S.errorCode(10))}pushSetting(e){if(this.isClear)return g.warn("pushSetting 被释放了",e),this._disconnect(),Promise.reject(S.errorCode(4));if(!this.proto.dataParser.checkPushData)return this._pushSetting(e);switch(this.proto.dataParser.checkPushData(this.context,e)){case-1:return Promise.reject(S.errorCode(15));case-2:return Promise.reject(S.errorCode(10));case 0:let t=new de([e],{},1e3);return this.excuteMutipAction(t);case 1:if(this.proto.dataParser.tryToExchangeMutipleAction){let t=this.proto.dataParser.tryToExchangeMutipleAction(this.context,e);if(t)return this.excuteMutipAction(t)}return Promise.reject(S.errorCode(10));case 2:return this.context.userInfo||(this.context.userInfo=this.userInfo),this._reBind(this.context);default:return this._pushSetting(e)}}getSetting(e){if(this.isClear)return g.warn("getSetting 被释放了"),Promise.reject(S.errorCode(4));let t=this;if(!this.proto.dataParser.getSettingMutipleAction)return Promise.reject(S.errorCode(10));let i=this.proto.dataParser.getSettingMutipleAction(this.context,e);return i?new Promise((async(e,n)=>{try{e((await t.excuteMutipAction(i)).data)}catch(e){n(e)}})):Promise.reject(S.errorCode(10))}cancelSetting(){g.warn("cancelSetting"),this.isOtaing&&(this._disconnect(),g.info("Ota中取消操作，直接中断连接")),this.mutipActionManager.cancelCurrentSession(),this.sessionMap.forEach(((e,t)=>{g.warn("value clear",e.context.deviceInfo.mac),e.clear()}))}excuteMutipAction(e){if(this.isClear)return g.warn("excuteMutipAction 被释放了",e),this._disconnect(),Promise.reject(S.errorCode(4));let t=this;return new Promise(((i,n)=>{t.mutipActionManager.execute(e,(e=>{e.success?i(e):n(e)}))}))}clear(){try{this.mergeDataManager&&this.mergeDataManager.callbackAllData(),this.isClear=!0,this.unWorked(),this._clearSyncTime(),this.mutipActionManager.clear(),this.isWorking=!1,this.isWorked=!1,this.workMode=0,this.sessionMap.forEach(((e,t)=>{e.clear()})),this.sessionMap.clear()}catch(e){}}async updateUserInfo(e){if(this.userInfo=e,this.proto.dataParser.syncUserInfoAction){let t=this.proto.dataParser.syncUserInfoAction(this.context,e);if(t)return this.excuteMutipAction(t)}}async didBinded(e){if(this.isClear)return g.warn("didBinded 被释放了",e),Promise.reject(S.errorCode(4));if(e.deviceInfo.isBinded=!0,g.info("didBinded"),this.proto.dataParser.reStartSyncAction){let e=this.proto.dataParser.reStartSyncAction(this.context);if(e)try{g.info("重新同步数据"),await this.excuteMutipAction(e)}catch(t){return g.warn("重新同步数据 出错了",t,e,this.mac),void(this.workStateChanged&&this.workStateChanged(t))}}if(this.proto.dataParser.defaultSettingAction){let e=this.proto.dataParser.defaultSettingAction(this.context);if(e)try{g.info("设置默认"),await this.excuteMutipAction(e)}catch(t){return g.warn("默认设置失败了",e,this.mac),void(this.workStateChanged&&this.workStateChanged(t))}}this.didWorked(e)}async didWorked(e){if(this.isClear)return g.warn("didWorked 被释放了",e),Promise.reject(S.errorCode(4));if(this.isWorked=!0,this._initMergeDataManager(e),this.workMode=0,e.deviceInfo.workMode=0,this.proto.dataParser.workedDefaultAction){let e=this.proto.dataParser.workedDefaultAction(this.context);if(e)try{await this.excuteMutipAction(e)}catch(t){g.warn("默认设置失败了",e,this.mac)}}if(this.proto&&this.proto.dataParser.makeBluetoothPairPin){let t=this.proto.dataParser.makeBluetoothPairPin(e);if(null!=t&&null!=t)try{await this.context.client.makeBluetoothPair(t)}catch(e){g.error("配对失败",e)}g.warn("pin",t)}try{this.updateUserInfo(this.userInfo)}catch(e){g.warn("同步用户信息失败",e)}g.info("didWorked"),this.workStateChanged&&this.workStateChanged(S.errorCode(0)),setTimeout((()=>{this._reStartSyncTime(e)}),1e3)}unWorked(){this._clearSyncTime()}disconnect(){this._disconnect()}getSessionManager(e,t){let i=this.proto.uuid;t&&(i=t);let n=this.sessionMap.get(i);if(!n){let t=this;n=this.proto.dataParser.createSession(i,e),n&&(n.sender=(t,i)=>e.client.write(i.serviceId,i.charId,t),n.listener=n=>{if(n.success)try{let r=t.proto.dataParser.parseData(n,i,e);t._handlerNewData(r)}catch(e){g.error("捕捉到解析失败",e,n,i)}},this.sessionMap.set(i,n))}return n}_pushSetting(e){g.info("pushSetting",this.mac,e);let t=this.getSessionManager(this.context,e.serviceId);return t?t.sendData(e.getBytes(this.context.deviceInfo),e.tag):Promise.reject(S.errorCode(10))}_clearSyncTime(){this.syncTime&&(clearInterval(this.syncTime),this.syncTime=null)}_reStartSyncTime(e){if(this._clearSyncTime(),this.isClear)g.warn("_reStartSyncTime 已经被释放");else if(this.proto&&this.proto.dataParser.syncDataMutipleAction&&this.proto.dataParser.shouldIntervalSyncData){let t=this.proto.dataParser.syncDataMutipleAction(e),i=this.proto.dataParser.shouldIntervalSyncData(e);if(t){let n=this;this.excuteMutipAction(t),i&&(n.syncTime=setInterval((()=>{try{n.excuteMutipAction(t)}catch(e){g.warn("同步数据失败",e)}}),this.proto.dataParser.loopTime&&this.proto.dataParser.loopTime(e)||2e4))}}}_reBind(e){let t=this;return new Promise((async(i,n)=>{try{let n=this.proto.dataParser.reStartBindAction(e);if(n){let r=await t.excuteMutipAction(n);return setTimeout((()=>{t.didBinded(e)})),i(r)}throw"需要实现 reStartBindAction"}catch(e){n(e)}}))}_initMutipleActionManager(e){this.mutipActionManager=new le(this.mac,e.client);let t=this.mac+"worker",i=this;j(t,e.client.deviceId,(t=>{if(t.serviceId===M)return;let n=i.getSessionManager(e,t.serviceId);if(n)n.didReceiveData(t);else try{let n=i.proto.dataParser.parseData(S.errorCode(0,t.characteristicId,t.value),t.serviceId,e);i._handlerNewData(n)}catch(e){g.error("捕捉到解析失败",e,t)}return!1})),this.mutipActionManager.pusher=e=>this._pushSetting(e)}_initMergeDataManager(e){if(this.proto.dataParser.getMergeDataManager){let t=this.proto.dataParser.getMergeDataManager(e);if(t){this.mergeDataManager=t;let e=this;t.lister=t=>{e.mutipActionManager.didReceive(t),e.lister&&e.lister(e.context.deviceInfo,t),g.info("data merged",e.context.deviceInfo,t)}}}}async _handlerNewData(e){if(e&&e.dataType){if(this.proto.dataParser.shouldSendConform){let t=this.proto.dataParser.shouldSendConform(this.context,e);if(t)try{await this._pushSetting(t)}catch(e){return void g.error("发送确认数据 error",e)}}if(this.mergeDataManager){if(this.mergeDataManager.receiveAndHandle(e,this.context))return}this.mutipActionManager.didReceive(e),"finish"===e.dataType||(g.info("data",this.mac,e),this.lister&&this.lister(this.context.deviceInfo,e))}}_disconnect(){if(this.proto.dataParser.disConnect)try{let e=this.proto.dataParser.disConnect(this.context);if(e){let t=this;t.mutipActionManager.execute(e,(e=>{})),setTimeout((()=>{t.context.client.disconnect(),t.context.deviceInfo.updateConnectStatus(Y.Disconnected,"_disconnect1")}),0)}else this.context.client.disconnect(),this.context.deviceInfo.updateConnectStatus(Y.Disconnected,"_disconnect2")}catch(e){g.warn("断开蓝牙失败",e)}else this.context.client.disconnect(),this.context.deviceInfo.updateConnectStatus(Y.Disconnected,"_disconnect3")}}var fe=new class extends class{constructor(){this.listenerMap=new Map}$on(e,t,i){this.listenerMap.has(e)||this.listenerMap.set(e,new Map),this.listenerMap.get(e).set(t,i)}$off(e,t){if(this.listenerMap.has(e)){let i=this.listenerMap.get(e);i&&i.delete(t)}}printLog(e,...t){}$emit(e,...t){if(this.printLog(e,"$emit",e,...t),this.listenerMap.has(e)){let i=this.listenerMap.get(e);for(let n of i.keys()){let r=i.get(n);try{r&&r(...t)}catch(t){g.error("$emit fail "+e+" "+t)}}}}}{constructor(){super(),this.aerobicGPSStatus=0,this.getSettingTimeout=null,this.workerMap=new Map,this.cacheWorkerHandler=new Map,this.cacheFindDeviceTimeout=new Map,this.syncedDevice=new Map,this.errorCache=new Map,this.connectingDeviceMap=new Map}init(e){if(this.options=e,function(e){let t=e=>{g.info("onBLEConnectionStateChange:",e);let t=L.get(e.deviceId);t&&t.forEach((t=>{t&&t(e)})),P.forEach((t=>{t(e)}))};e.onBLEConnectionStateChange?e.onBLEConnectionStateChange(t):wx.onBLEConnectionStateChange(t);let i=e=>{g.info("onBluetoothAdapterStateChange:",e),B.forEach((t=>{t&&t(e)}))};e.onBluetoothAdapterStateChange?e.onBluetoothAdapterStateChange(i):wx.onBluetoothAdapterStateChange(i);let n=e=>{g.isPrintValueChange()&&g.info("Frame Data","["+D(e.characteristicId)+"]",C(e.value),e.deviceId);let t=E.get(e.deviceId);t&&t.forEach((t=>{t&&t(e)})),T.forEach((t=>{t&&t(e)}))};e.onBLECharacteristicValueChange?e.onBLECharacteristicValueChange(n):wx.onBLECharacteristicValueChange(n);let r=e=>{W.forEach((t=>{t(e)}))};e.onBluetoothDeviceFound?e.onBluetoothDeviceFound(r):wx.onBluetoothDeviceFound(r),R=e.startBluetoothDevicesDiscovery,U=e.stopBluetoothDevicesDiscovery}(e),e.logger&&g.setLogger(e.logger),!ee[e.platform])return void g.error("暂不支持该平台: ",ee.wx,e.platform);g.info("init 0.4.19");let{Adapter:t}=ee[e.platform];this.adapter=new t;let i=this;return V("_b",(e=>{!1===e.available&&(this.tryReleaseAdapter(),this.connectingDeviceMap.forEach(((e,t)=>{i.changeWorkState(t,Y.Disconnected,!0,!0)}))),setTimeout((()=>{this.$emit("adaptorState",e)}),0)})),N("_b",(e=>{let t=oe(e.deviceId);if(t&&0==e.connected&&t.connectStatus!=Y.Scan&&t.connectStatus!=Y.Connecting){this.changeWorkState(t.mac,Y.Disconnected,!0);let e=this.workerMap.get(t.mac);e&&(e.clear(),this.workerMap.delete(t.mac))}})),this.adapter.available?Promise.resolve(S.success()):this.adapter.openBLEAdapter()}updateUserInfo(e){this.userInfo=e;let t=this.getWorkedDevice(),i=this;t&&t.length>0&&t.forEach((t=>{let n=i.workerMap.get(t.mac);n&&n.updateUserInfo(e)}))}pushSetting(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.pushSetting(t):Promise.reject(S.errorCode(1))}cancelSetting(e){g.warn("cancelSetting",e,this.workerMap),e=e.toUpperCase();let t=this.workerMap.get(e);return t?t.cancelSetting():Promise.reject(S.errorCode(1))}getSetting(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.getSetting(t):Promise.reject(S.errorCode(1))}scanDevice(e,t,i=F.ALL){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));this.adapter.startScan(e,H,!0,(e=>{let i=se(e);i&&i.mac&&t(i)}),F.ALL)}stopScan(e){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));this.adapter.stopScan(e)}ota(e,t){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));e=e.toUpperCase();let i=this.workerMap.get(e);return i?i.ota(t):(t.onUpgradeComplete(1,"未连接"),Promise.reject(S.errorCode(1)))}async bind(e,t,i){if(!this.checkBluetoothAvailable())return Promise.reject(S.errorCode(21));e=e.toUpperCase();let n=this.workerMap.get(e),r=this;return n&&(n.clear(),this.workerMap.delete(e)),this.cacheWorkerHandler.set(e,i),new Promise((async(i,s)=>{try{await r.checkUserLocationAvailable();let a={...t};!a.userInfo&&this.userInfo&&(a.userInfo=this.userInfo),a.isSyncData=!1,ae(e).workMode=1,await this.tryToConnect(e,a);let o=G(e);n=new ue(e,o,a),n.lister=(e,t)=>{this.$emit("dataReport",e,t)},n.workStateChanged=t=>{t&&t.success?r.changeWorkState(e,Y.Worked,!0):(r.changeWorkState(e,Y.Disconnected,!0),r.cancelWork(e,!0))},n.userInfo=this.userInfo,this.workerMap.set(e,n),n.bind(a,((t,n)=>{0!=n?s(S.errorCode(n)):o.dataParser.bindSuccessShouldDisconnect&&o.dataParser.bindSuccessShouldDisconnect(a)?(r.changeWorkState(e,Y.Worked,!0),setTimeout((t=>{r.cancelWork(e,!0),r.syncData(e,a,((e,t)=>{}))}),100),i(S.errorCode(0))):i(S.errorCode(0))}))}catch(e){return s(e)}}))}async syncData(e,t,i){if(!this.checkBluetoothAvailable())return i&&i(e,Y.Disconnected),Promise.reject(S.errorCode(21));e=e.toUpperCase(),this.cacheWorkerHandler.set(e,i);let n=ae(e);if(n.connectStatus===Y.None||n.connectStatus>=Y.Disconnected){this.changeWorkState(e,Y.Scan);let i={...t};!i.userInfo&&this.userInfo&&(i.userInfo=this.userInfo);let n=this.errorCache.get(e);i.isSyncData=!0,n&&(i.preErrorCode=n);let r=this.workerMap.get(e);r&&(r.clear(),this.workerMap.delete(e));let s=this;try{await s.tryToConnect(e,i);let t=G(e);r=new ue(e,t,i),r.userInfo=s.userInfo,s.workerMap.set(e,r),r.lister=(e,t)=>{s.$emit("dataReport",e,t)},r.workStateChanged=t=>{t&&t.success?s.changeWorkState(e,Y.Worked,!0):(s.changeWorkState(e,Y.Disconnected,!0),s.cancelWork(e,!0))},r.sync(i,((e,t)=>{0===t&&s.syncedDevice.set(e,i.deviceInfo),s.errorCache.set(e,t)}))}catch(t){g.error("尝试去连接的时候出现了错误",t,e)}}}cancelWork(e,t=!0){let i=ae(e=e.toUpperCase());if(g.info("cancelWork",e,t,i),1===i.workMode&&!t)return;i.workMode=0;let n=this.workerMap.get(e);if(n&&(n.clear(),this.workerMap.delete(e)),i&&i.deviceId){this.adapter.getClient(i.deviceId).disconnect()}i.updateConnectStatus(Y.Disconnected,"cancelWork")}getConnectionState(e){return ae(e=e.toUpperCase()).connectStatus}getDeviceInfo(e){return ae(e)}getWorkedDevice(){let e=[];return this.workerMap.forEach(((t,i)=>{if(!t.isClear&&t.isWorking){let t=ae(i);t&&t.connectStatus===Y.Worked&&e.push(t)}})),e}getConnectedDevice(){let e=[];return this.workerMap.forEach(((t,i)=>{let n=ae(i);n&&n.connectStatus===Y.Worked&&e.push(n)})),e}disconnectDevice(e){g.info("disconnectDevice",e),this.adapter.getClient(e).disconnect();let t=oe(e);t&&t.updateConnectStatus(Y.Disconnected,"disconnectDevice")}changeWorkState(e,t,i=!1,n=!0){let r=ae(e);r&&(t!=Y.None&&t!=Y.Disconnected?this.connectingDeviceMap.set(e,r):this.connectingDeviceMap.delete(e),r.updateConnectStatus(t,"changeWorkState"),n&&(g.info("changeWorkState",e,t,r),this.$emit("connectionState",e,t),this.$emit("deviceStateChange",r)));let s=this.cacheWorkerHandler.get(e);s&&(s(e,t),i&&this.cacheWorkerHandler.delete(e))}findDevice(e,t=F.ALL,i=15){let n=ae(e=e.toUpperCase());if(n&&n.deviceId){let e=this.adapter.getClient(n.deviceId);if(e.connected)return g.debug("发现已连接设备",e),Promise.resolve(!0)}let r=this;return new Promise(((n,s)=>{let a=r.cacheFindDeviceTimeout.get(e);if(a&&clearTimeout(a),a=setTimeout((()=>{g.debug("超时搜索"),r.stopScan(e),s(!1)}),i),r.cacheFindDeviceTimeout.set(e,a),!r.adapter.available)return g.warn("蓝牙不可用，无法扫描"),Promise.reject(S.fail("蓝牙不可用，无法扫描"));this.adapter.startScan(e,H,!0,(t=>{let i=se(t);if(i&&i.mac===e){g.debug("搜索到设备",i,t),r.stopScan(e);let s=this.cacheFindDeviceTimeout.get(e);return s&&(clearTimeout(s),r.cacheFindDeviceTimeout.delete(e)),void n(!0)}}),t)}))}async tryToConnect(e,t,i=1){if(!this.adapter.available)return g.debug("try To Connect failed"),this.changeWorkState(e,Y.Disconnected,!0),Promise.reject(S.errorCode(21));let n=this;return g.debug("try To Connect",i),new Promise((async(r,s)=>{let a,o,c=!1,d=!0;if(!c){try{g.debug("搜索设备",e),y()?await n.findDevice(e,F.ALL,t.searchTimeout||15e3):await n.findDevice(e,F.Normal,t.searchTimeout||15e3),a=ae(e),o=n.adapter.getClient(a.deviceId)}catch(t){return g.warn("未发现设备",e,t),n.changeWorkState(e,Y.Disconnected,!0),n.cancelWork(e,!0),d=!1,void s(S.errorCode(12))}if(!d)return;try{g.debug("搜索后连接",e),n.changeWorkState(e,Y.Connecting),await o.connectAndDiscoverServices(t.connectTimeout||16e3),a.updateClient(o),c=!0}catch(t){g.warn("搜索后连接 error",t,e,i),d=!1,n.changeWorkState(e,Y.Disconnected,!0),n.cancelWork(e,!0),s(S.errorCode(1))}}if(d){try{g.debug("更新设备信息",e);let i=G(e),r=null;if(i.dataParser.deviceInfoCharacteristics&&(r=i.dataParser.deviceInfoCharacteristics(t)),await o.readDeviceInfo(r),o.isSystemConnect=!0,function(e,t){se(e)}(o),t.deviceInfo=ae(e),t.listeners&&t.listeners.onReadDeviceInfo){let e={...t.deviceInfo};t.listeners.onReadDeviceInfo(e)}t.client=o,n.changeWorkState(e,Y.Connected)}catch(t){g.debug("更新设备信息 error",t,e),n.changeWorkState(e,Y.Disconnected,!0),n.cancelWork(e,!0),d=!1,s(S.errorCode(1))}if(d){if(t.listeners&&t.listeners.onDeviceAuth)try{if(!await t.listeners.onDeviceAuth({...t}))return n.changeWorkState(e,Y.Disconnected,!0),n.cancelWork(e,!0),d=!1,void s(S.errorCode(11))}catch(t){return n.changeWorkState(e,Y.Disconnected,!0),n.cancelWork(e,!0),d=!1,void s(S.errorCode(11))}d&&r(S.success())}}}))}tryReleaseAdapter(){return new Promise(((e,t)=>{this.adapter.reopenBLEAdapter(((i,n)=>{i?e(S.errorCode(0)):t(S.errorCode(6))}))}))}connectDevice(e){g.warn("connectDevice 弃用，外部不需要调用此方法")}bindDevice(e,t){g.warn("bindDevice 弃用，请使用bind(mac, context, callback)");let i=oe(e);return this.bind(i.mac,t,null)}async send(e,t){let i=oe(e);return this.pushSetting(i.mac,t)}checkBluetoothAvailable(){return this.adapter.available}checkUserLocationAvailable(){return new Promise(((e,t)=>{let{locationEnabled:i,locationAuthorized:n,platform:r}=wx.getSystemInfoSync();r.indexOf("android")>-1?i&&n?e(S.errorCode(0)):t(S.errorCode(20)):e(S.errorCode(0))}))}};function pe(){this.dataStore=[],this.add=ve,this.remove=me,this.size=we,this.union=Ce,this.contains=Ie,this.intersect=ke,this.subset=ye,this.difference=De,this.show=Se,this.clear=ge}function ge(){this.dataStore.length=0}function ve(e){return this.dataStore.indexOf(e)<0&&(this.dataStore.push(e),!0)}function me(e){var t=this.dataStore.indexOf(e);return t>-1&&(this.dataStore.splice(t,1),!0)}function we(){return this.dataStore.length}function Se(){return"["+this.dataStore+"]"}function Ie(e){return this.dataStore.indexOf(e)>-1}function Ce(e){for(var t=new pe,i=0;i<this.dataStore.length;++i)t.add(this.dataStore[i]);for(i=0;i<e.dataStore.length;++i)t.contains(e.dataStore[i])||t.dataStore.push(e.dataStore[i]);return t}function ke(e){for(var t=new pe,i=0;i<this.dataStore.length;++i)e.contains(this.dataStore[i])&&t.add(this.dataStore[i]);return t}function ye(e){if(this.size()>e.size())return!1;for(var t in this.dataStore)if(!e.contains(t))return!1;return!0}function De(e){for(var t=new pe,i=0;i<this.dataStore.length;++i)e.contains(this.dataStore[i])||t.add(this.dataStore[i]);return t}let Me,Ae=new pe,be=new pe,xe=new pe,Pe=!0,Be=null,Te=!1,We=!0;function Le(e,t){Be=e,We=t,Te=!1,fe.$on("connectionState","_monitor",((e,t)=>{4===t?(be.add(e),xe.remove(e)):3===t?(xe.add(e),be.remove(e)):t>=5?(be.remove(e),xe.remove(e)):(be.remove(e),xe.add(e))})),fe.$on("adaptorState","_monitor",(e=>{e.available?!0===Pe||(Pe=e.available,je()):(Pe=e.available,Me&&clearTimeout(Me))}))}async function Ee(e){if(Array.isArray(e))e.forEach((async e=>{await Ne(e)&&Ae.add(e.mac)}));else{await Ne(e)&&Ae.add(e.mac)}je()}function Re(e){Ae.clear(),Ee(e)}function Ue(e){Array.isArray(e)?device.forEach((async e=>{Ae.add(e.mac)})):Ae.add(e.mac),je()}function _e(e){Ae.remove(e.mac),je()}function Ve(){Ae.clear(),je()}async function Ne(e){return new Promise((async(t,n)=>{let r="lsdeviceAuth."+e.mac+Be,s=wx.getStorageSync(r);if(s)200===s?(console.debug("设备鉴权成功"),t(!0)):(console.debug("设备鉴权失败",s,r),n(!1));else try{let s={artifactId:"@ls/ble-next",serviceId:"device-activate",serviceVersion:"1.0",platform:3,appId:Be,mac:e.mac,model:e.model},a=await(e=>i({path:"/rbac-web/auth/app",data:e}))(s),o=a.code;wx.setStorageSync(r,o),200===o?t(!0):n(!1)}catch(t){console.warn("鉴权失败",t,e),n(!1)}}))}function je(){if(Me&&clearTimeout(Me),!Pe||Te)return;if(Me=setTimeout((()=>{Me=null,je()}),1e4),We){let e=be.union(xe).difference(Ae).dataStore;e.length>0&&e.forEach((e=>{fe.cancelWork(e,!1)}))}let e=Ae.difference(be).dataStore;if(console.debug("needToConnect",e),e.length>0){let i={onApplyRegisterId:e=>new Promise(((i,n)=>{console.log("plugin","onApplyRegisterId",e);let r=e.deviceInfo.model,s=e.deviceInfo.hardwareVersion,a=e.deviceInfo.softwareVersion,o=e.deviceInfo.mac;t({mac:o,model:r,hardwareVersion:s,softwareVersion:a}).then((t=>{200===t.code&&t.data.deviceId?i(t.data.deviceId):(n("请求third deviceId 失败"),callback({mac:o,deviceInfo:e.deviceInfo,bindState:BINDSTATE_Failure}))})).catch((t=>{n(t),callback({mac:o,deviceInfo:e.deviceInfo,bindState:BINDSTATE_Failure})}))})),onDeviceAuth:e=>(console.warn("onDeviceAuth",e.deviceInfo),Ne({mac:e.deviceInfo.mac,model:e.deviceInfo.model}))},n={listeners:i};e.forEach((e=>{fe.syncData(e,n)}))}}module.exports={monitorInit:Le,addMonitorDevice:Ee,setMonitorDevice:Re,setMonitorDeviceWithoutAuth:function(e){Ae.clear(),Ue(e)},addMonitorDeviceWithoutAuth:Ue,deleteMonitorDevice:_e,deleteAllMonitorDevice:Ve,deviceAuthing:Ne};let Oe={appId:""};function $e(){if(!Oe.appId||0==Oe.appId.length)throw"未初始化或appId 无效"}function Fe(){return"1.0.12"}function ze(e){e.appKey&&e.appKey.length>0&&(e.appId=e.appKey),Oe=e,fe.init({platform:"wx",printScanResult:!1,discoverDelay:0,...e}),e.needUI?(u(e),Le(e.appKey,!1)):Le(e.appId,!0)}function Ke(e){$e(),fe.scanDevice("startScanning",e,0)}function Qe(){$e(),fe.stopScan("startScanning")}async function He(e){$e();let i=e.mac,n=e.callback,r={onApplyRegisterId:e=>new Promise(((r,s)=>{console.log("plugin","onApplyRegisterId",e);let a=e.deviceInfo.model,o=e.deviceInfo.hardwareVersion,c=e.deviceInfo.softwareVersion;t({mac:i,model:a,hardwareVersion:o,softwareVersion:c}).then((t=>{200===t.code&&t.data.deviceId?r(t.data.deviceId):(s("请求third deviceId 失败"),n({mac:i,deviceInfo:e.deviceInfo,bindState:5}))})).catch((t=>{s(t),n({mac:i,deviceInfo:e.deviceInfo,bindState:5})}))})),onInputRandomNum:e=>{this.pageStatus=3,this.randomNum=e,n({mac:i,deviceInfo:rt(i),bindState:0})},onReadDeviceId:e=>{},onReadDeviceInfo:e=>{},onWaitUserSelect:e=>{console.log("plugin","onWaitUserSelect")},onDeviceAuth:e=>Ne({mac:i,model:e.deviceInfo.model})},s={listeners:r,userInfo:{height:170,weight:60}};fe.bind(i,s,((e,t)=>{switch(t){case 0:case 1:case 2:case 3:break;case 4:Ue({mac:e}),n({mac:e,deviceInfo:rt(e),bindState:4});break;default:console.log("绑定状态变化",t)}})).catch((e=>{console.log("绑定失败",e),n({mac:i,deviceInfo:rt(i),bindState:5,errorCode:e.code})}))}function Je(e){$e(),fe.cancelWork(e.mac,!0)}function qe(e){$e();let t={fileBuffer:e.fileBuffer,model:e.model,onUpgradeProcess:e.onUpgradeProcess,onUpgradeComplete:e.onUpgradeComplete};try{return fe.ota(e.mac,t)}catch(e){console.debug("error",e)}}function Ge(e){$e(),fe.cancelSetting(e.mac)}function Ze(e){return $e(),fe.getConnectionState(e.mac)}function Xe(){return $e(),fe.checkBluetoothAvailable()}function Ye(e){return $e(),fe.pushSetting(e.mac,e.setting)}function et(e){$e(),fe.$on(e.eventName,e.eventKey,e.callback)}function tt(e){fe.$off(e.eventName,e.eventKey)}function it(e){return $e(),fe.getSetting(e.mac,e.settingType)}function nt(e){return fe.cancelSetting(e)}function rt(e){return fe.getDeviceInfo(e)}function st(e){return fe.cancelWork(e,!0)}function at(e,t,i){return fe.syncData(e,t,i)}function ot(e){Ee(e)}function ct(e){Re(e)}function dt(){Ve()}function ht(e){_e(e)}function lt(e,t=null,i=null,n=null){return S.errorCode(e,t,i,n)}function ut(...e){return g.debug(...e)}function ft(...e){return g.info(...e)}function pt(...e){return g.warn(...e)}function gt(...e){return g.error(...e)}const vt={getVersion:Fe,init:ze,startScanning:Ke,stopScanning:Qe,bindDevice:He,cancelBind:Je,getConnectionState:Ze,isBluetoothAvailable:Xe,pushSetting:Ye,addMonitorDevice:ot,setMonitorDevice:ct,deleteAllMonitorDevice:dt,deleteMonitorDevice:ht,cancelSetting:nt,ota:qe,cancelOta:Ge,$on:et,$off:tt,getDeviceInfo:rt,getSetting:it,connectDevice:at,disconnect:st,regist:mt,errorCode:lt,Logger:{errorCode:lt,debug:ut,warn:pt,info:ft,error:gt}};function mt(e){e.setUtils(vt),function(e){H.push(e.uuid),e.serviceId&&!0===e.serviceId&&Q.push(e.uuid),K.push(e)}(e)}module.exports=vt,e.$off=tt,e.$on=et,e._utils=vt,e.addMonitorDevice=ot,e.bindDevice=He,e.cancelBind=Je,e.cancelOta=Ge,e.cancelSetting=nt,e.connectDevice=at,e.debug=ut,e.default=vt,e.deleteAllMonitorDevice=dt,e.deleteMonitorDevice=ht,e.disconnect=st,e.error=gt,e.errorCode=lt,e.getConnectionState=Ze,e.getDeviceInfo=rt,e.getSetting=it,e.getVersion=Fe,e.info=ft,e.init=ze,e.isBluetoothAvailable=Xe,e.ota=qe,e.pushSetting=Ye,e.regist=mt,e.setMonitorDevice=ct,e.startScanning=Ke,e.stopScanning=Qe,e.warn=pt,Object.defineProperty(e,"__esModule",{value:!0})}));

}, function(modId) {var map = {}; return __REQUIRE__(map[modId], modId); })
return __REQUIRE__(1646653978715);
})()
//miniprogram-npm-outsideDeps=[]
//# sourceMappingURL=index.js.map
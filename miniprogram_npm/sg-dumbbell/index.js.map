{"version":3,"sources":["index.js"],"names":[],"mappings":";;;;;;;AAAA;AACA","file":"index.js","sourcesContent":["!function(e,t){\"object\"==typeof exports&&\"undefined\"!=typeof module?module.exports=t():\"function\"==typeof define&&define.amd?define(t):(e=\"undefined\"!=typeof globalThis?globalThis:e||self).RollupLearn=t()}(this,(function(){const e=\"0000FFF0-0000-1000-8000-00805F9B34FB\",t=\"0000FFF4-0000-1000-8000-00805F9B34FB\";var i;var s={errorCode:function(e,t,s,n){return i.errorCode(e,t,s,n)},getDeviceInfo:function(e){return i.getDeviceInfo(e)},Logger:{debug:function(...e){i.Logger.debug(...e)},info:function(...e){i.Logger.info(...e)},warn:function(...e){i.Logger.warn(...e)},error:function(...e){i.Logger.error(...e)}}};class n{constructor(){this.size=0,this.values=[]}build(){let e=new ArrayBuffer(this.size),t=new DataView(e);return this.values.forEach((({byteOffset:e,method:i,value:s,littleEndian:n,limitSize:r})=>{if(\"setBuffer\"===i){let i=new DataView(s),n=i.byteLength;r&&(n=Math.min(r,n));for(let s=0;s<n;s++)t.setUint8(e+s,i.getUint8(s))}else\"setUint8\"===i?t[i](e,s):\"setInt8\"===i?s>0?t.setUint8(e,255&s):t.setUint8(e,s+256&255):\"setUint24\"===i?n?t.setUint32(e,s):t.setUint32(e,s<<8,!1):t[i](e,s,n)})),e}appendUint8(e){return this.values.push({byteOffset:this.size,method:\"setUint8\",value:e}),this.size++,this}appendUint16(e,t){return this.values.push({byteOffset:this.size,method:\"setUint16\",value:e,littleEndian:t}),this.size+=2,this}appendUint32(e,t){return this.values.push({byteOffset:this.size,method:\"setUint32\",value:e,littleEndian:t}),this.size+=4,this}appendBuffer(e,t){return this.values.push({byteOffset:this.size,method:\"setBuffer\",value:e,limitSize:t}),this.size+=t||e.byteLength,this}appendUint24(e,t){return this.values.push({byteOffset:this.size,method:\"setUint24\",value:e,littleEndian:t}),this.size+=3,this}appendInt8(e){return this.values.push({byteOffset:this.size,method:\"setInt8\",value:e}),this.size++,this}appendInt16(e,t){return this.values.push({byteOffset:this.size,method:\"setInt16\",value:e,littleEndian:t}),this.size+=2,this}appendFloat32(e,t){return this.values.push({byteOffset:this.size,method:\"setFloat32\",value:e,littleEndian:t}),this.size+=4,this}}class r{constructor(e,t){this.dataType=\"LoginReq\",this.tag=t}}class a{constructor(){this.tag=173}getBytes(){return(new n).build()}}function h(e){return new Promise(((t,i)=>{setTimeout((()=>{t(null)}),e)}))}var o=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{o(s.next(e))}catch(e){r(e)}}function h(e){try{o(s.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,h)}o((s=s.apply(e,t||[])).next())}))},u=[{name:\"EnableCharacteristic\",serviceId:e,characteristicId:t,actionType:2,await:{timeout:5e3,didReceive:(e,t)=>(s.Logger.error(\"收到数据\"),\"LoginReq\"===e.dataType&&s.errorCode(0))}},{name:\"loginResp\",actionType:1,pushData(e){return o(this,void 0,void 0,(function*(){return s.Logger.error(\"发送数据\"),yield h(400),new a}))}}],d=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{o(s.next(e))}catch(e){r(e)}}function h(e){try{o(s.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,h)}o((s=s.apply(e,t||[])).next())}))},l=[{name:\"EnableCharacteristic\",serviceId:e,characteristicId:t,actionType:2,await:{timeout:5e3,didReceive:(e,t)=>\"LoginReq\"===e.dataType&&s.errorCode(0)}},{name:\"loginResp\",actionType:1,pushData(e){return d(this,void 0,void 0,(function*(){return yield h(400),new a}))}}];function c(e){if(!e||0===e.byteLength)return\"\";let t=new DataView(e),i=\"\";for(let e=0;e<t.byteLength;e++)i+=t.getUint8(e).toString(16).padStart(2,\"0\").toUpperCase();return i}function f(e){return function(e){if(!e)return\"\";let t=new Uint8Array(e);var i,s,n,r,a,h;i=\"\",n=t.length,s=0;for(;s<n;)switch((r=t[s++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:i+=String.fromCharCode(r);break;case 12:case 13:a=t[s++],i+=String.fromCharCode((31&r)<<6|63&a);break;case 14:a=t[s++],h=t[s++],i+=String.fromCharCode((15&r)<<12|(63&a)<<6|(63&h)<<0)}return i}(e)}function g(e,t,i){return e?(t.getUint8(i+2)<<16)+(t.getUint8(i+1)<<8)+t.getUint8(i):(t.getUint8(i)<<16)+(t.getUint8(i+1)<<8)+t.getUint8(i+2)}wx.getSystemInfoSync();class p{constructor(e,t=0){this.values=[],this.parseSize=0,this.originalBuffer=e,this.index=t,this.parseSize=0,this.dataView=new DataView(e),this.index=t}build(e){if(!this.originalBuffer||this.originalBuffer.byteLength<=0)return null;e||(e={});let t=this.dataView;return this.values.forEach((({byteOffset:i,method:s,key:n,size:r,parseKey:a,littleEndian:h})=>{i+=this.parseSize;try{if(\"getHexString\"===s)e[n]=function(e,t){if(!e)return\"\";if(\"string\"==typeof e)return e;let i=Array.prototype.map.call(new Uint8Array(e),(function(e){return(\"00\"+e.toString(16)).slice(-2)}));if(t){let e=[];for(let t=0;t<i.length;t++)e.push(i[i.length-1-t]);return e.join(\"\")}return i.join(\"\")}(this.originalBuffer.slice(i,i+r));else if(\"getStringByParse\"===s){let t=e[a];this.parseSize+=t,e[n]=f(this.originalBuffer.slice(i,i+t))}else if(\"getString\"===s)e[n]=f(this.originalBuffer.slice(i,i+r));else if(\"getBuffer\"===s)e[n]=this.originalBuffer.slice(i,i+r);else if(\"getUint8\"===s)e[n]=t.getUint8(i);else if(\"Uint24\"===s)e[n]=g(h,t,i);else if(\"Uint8Array\"===s)e[n]=[].slice.call(new Uint8Array(this.originalBuffer.slice(i,i+r)));else if(\"Uint16Array\"===s){let t=[].slice.call(new Uint16Array(this.originalBuffer.slice(i,i+r)));e[n]=h?t:function(e){if(e&&e.length>0){let t=[];for(let i=0;i<e.length;i++){let s=e[i];s=((255&s)<<8)+(s>>8&255),t.push(s)}return t}return[]}(t)}else if(\"SFloat\"===s){let s=t.getUint8(i),r=((15&s)<<8)+t.getUint8(i+1),a=(240&s)>>>4,h=a;(8&a)>0&&(h=a-16);let o=Math.pow(10,h);e[n]=r*o}else if(\"Float\"===s){let s=t.getUint8(i),r=g(h,t,i+1),a=Math.pow(10,(15&s)-16);e[n]=r*a}else e[n]=t[s](i,h)}catch(e){}})),e}getUint24(e,t=!1){return this.values.push({byteOffset:this.index,method:\"Uint24\",key:e,littleEndian:t}),this.index+=3,this}getSFloat(e){return this.values.push({byteOffset:this.index,method:\"SFloat\",key:e}),this.index+=2,this}getFloat(e,t=!1){return this.values.push({byteOffset:this.index,method:\"Float\",key:e,littleEndian:t}),this.index+=4,this}getUint8Array(e,t){return this.values.push({byteOffset:this.index,size:t,method:\"Uint8Array\",key:e}),this.index+=t,this}getUint16Array(e,t,i=!1){return this.values.push({byteOffset:this.index,size:t,method:\"Uint16Array\",key:e,littleEndian:i}),this.index+=t,this}getUint8(e){return this.values.push({byteOffset:this.index,method:\"getUint8\",key:e}),this.index++,this}getInt8(e){return this.values.push({byteOffset:this.index,method:\"getInt8\",key:e}),this.index++,this}getUint16(e,t=!1){return this.values.push({byteOffset:this.index,method:\"getUint16\",key:e,littleEndian:t}),this.index+=2,this}getUint32(e,t=!1){return this.values.push({byteOffset:this.index,method:\"getUint32\",key:e,littleEndian:t}),this.index+=4,this}getBuffer(e,t){return this.values.push({byteOffset:this.index,size:t,method:\"getBuffer\",key:e}),this.index+=t,this}getByteOffset(){return this.index}getString(e,t){return this.values.push({byteOffset:this.index,size:t,method:\"getString\",key:e}),this.index+=t,this}getHexString(e,t){return this.values.push({byteOffset:this.index,size:t,method:\"getHexString\",key:e}),this.index+=t,this}getStringSizeByParse(e,t){return this.values.push({byteOffset:this.index,parseKey:t,method:\"getStringByParse\",key:e}),this}getIndex(){return this.index}readInt8(){let e=this.index;return this.index+=1,this.dataView.getInt8(e)}readUint8(){let e=this.index;return this.index+=1,this.dataView.getUint8(e)}readUint16(e=!1){let t=this.index;return this.index+=2,this.dataView.getUint16(t,e)}readInt16(e=!1){let t=this.index;return this.index+=2,this.dataView.getInt16(t,e)}readUint24(e=!1){let t=this.index;return this.index+=3,g(e,this.dataView,t)}readUint32(e=!1){let t=this.index;return this.index+=4,this.dataView.getUint32(t,e)}readInt32(e=!1){let t=this.index;return this.index+=4,this.dataView.getInt32(t,e)}readSfloat(){let e=this.index,t=this.dataView;this.index+=2;let i=t.getUint8(e),s=(240&i)>>>4,n=s;return(8&s)>0&&(n=s-16),(((15&i)<<8)+t.getUint8(e+1))*Math.pow(10,n)}readFloat(e=!1){let t=this.index;this.index+=4;let i=this.dataView.getUint8(t);return g(e,this.dataView,t+1)*Math.pow(10,(15&i)-16)}readString(e){return f(this.readBuffer(e))}readBuffer(e){let t=this.index;return this.index+=e,this.dataView.buffer.slice(t,t+e)}}const m=\"00002A29-0000-1000-8000-00805F9B34FB\",v=\"00002A24-0000-1000-8000-00805F9B34FB\",y=\"00002A25-0000-1000-8000-00805F9B34FB\",w=\"00002A27-0000-1000-8000-00805F9B34FB\",S=\"00002A26-0000-1000-8000-00805F9B34FB\",x=\"00002A28-0000-1000-8000-00805F9B34FB\",U=\"00002A23-0000-1000-8000-00805F9B34FB\";var b=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{o(s.next(e))}catch(e){r(e)}}function h(e){try{o(s.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,h)}o((s=s.apply(e,t||[])).next())}))};class I{constructor(e,t){this.buf=e,this.isClear=!1,this.timeout=5e3,this.sid=t||Math.random(),this.trySender=(e,t)=>b(this,void 0,void 0,(function*(){try{return this.sender(e,t)}catch(e){if(this.isClear)return s.errorCode(4);this.callback(e)}}))}didReceiveData(e){}start(){}resetTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.timeoutId=setTimeout((()=>{this.callback(s.errorCode(3,this.tag))}),this.timeout)}clear(){this.isClear=!0,this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.callback(s.errorCode(4))}callback(e){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.completion&&(e.sid=this.sid,this.completion(e),this.completion=null)}}class F extends I{constructor(e,t){super(e),this.needAck=!1,this.tag=t}start(){return b(this,void 0,void 0,(function*(){let e=this.decodeToFrames(this.buf);if(e&&e.length<1)return void this.callback(s.errorCode(4,this.tag));this.resetTimeout();let t=this.sendChar;for(let i=0;i<e.length;i++){let n=e[i];try{yield this.trySender(n,t)}catch(e){return void this.callback(s.errorCode(1,this.tag))}}this.needAck||this.callback(s.errorCode(0,this.tag))}))}decodeToFrames(e){let t=e.byteLength,i=Math.ceil(t/this.mtu),s=[];for(let t=0;t<i;t++){let i=t*this.mtu;s.push(e.slice(i,i+this.mtu))}return s}}class B extends I{didReceiveData(e){this.receiveBuf=e.value,this.callback(s.errorCode(0,this.tag,this.receiveBuf))}start(){this.didReceiveData({value:this.buf})}checkFinished(){if(!this.receiveBuf)return!1;if(this.firstFrame.len&&this.firstFrame.len<=this.receiveBuf.byteLength)return!0;if(this.firstFrame.totalFrames){if(1==this.firstFrame.totalFrames)return!0;if(this.preFrame&&this.preFrame.index===this.firstFrame.totalFrames-1)return!0}return!1}decodeFirstFrame(e){throw new Error(\"如果使用默认的逻辑，则需要实现这个逻辑\")}decodeOtherFrame(e){throw new Error(\"如果使用默认的逻辑，则需要实现这个逻辑\")}}class D extends B{didReceiveData(e){let t=new p(e.value);this.tag=t.readUint8();let i=t.readUint8();this.receiveBuf=t.readBuffer(i),this.callback(s.errorCode(0,this.tag,this.receiveBuf))}}class z extends F{constructor(){super(...arguments),this.sendChar={serviceId:e,charId:\"0000FFF3-0000-1000-8000-00805F9B34FB\",writeType:0}}decodeToFrames(e){let t=e.byteLength,i=function(e,...t){let i=0;if(e){let t=new DataView(e);for(let e=0;e<t.byteLength;e++)i+=255&t.getUint8(e)}if(t)for(let e=0;e<t.length;e++)i+=255&t[e];return 255&i}(e,this.tag,t),s=new n;return s.appendUint8(this.tag),s.appendUint8(t),s.appendBuffer(e),s.appendUint8(i),[s.build()]}}class k extends class{constructor(e){this.sendSessions=[],this.filterServiceIds=[],this.mtu=20,this.context=e}sendData(e,t,i,s){let n=this.createSenderSession(e,t,i);return n.sender=this.sender,n.mtu=this.mtu,n.tag=t,new Promise(((e,t)=>{n.completion=i=>{this.sendingSession=null,s&&s(i),this.tryToDispatchSession(),i.success?e(i):t(i)},this.sendSessions.push(n),this.tryToDispatchSession()}))}clear(){try{this.sendSessions.forEach((e=>{e.clear()})),this.sendSessions.length=0,this.sendingSession&&(this.sendingSession.clear(),this.sendingSession=null)}catch(e){}}updateMtu(e){this.mtu=e}didReceiveData(e){if(this.receiveringSession)this.receiveringSession.didReceiveData(e);else{this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender;let t=this;this.receiveringSession.completion=e=>{t.receiveringSession&&t.receiveringSession.sid===e.sid&&(t.receiveringSession=null),t.tryToDispatchSession(),t.listener&&t.listener(e)},this.receiveringSession.start()}}createSenderSession(e,t,i){return new F(e,t)}createReceiveSession(e){return new B(e)}tryToDispatchSession(){if(this.sendingSession||0===this.sendSessions.length||this.receiveringSession)return;let e=this.sendSessions.shift();e&&(this.sendingSession=e,e.start())}}{didReceiveData(e){let t=this.createReceiveSession(e.value);t.mtu=this.mtu,t.sender=this.sender;let i=this;t.completion=e=>{i.listener&&i.listener(e)},t.start()}createSenderSession(e,t){return new z(e,t)}createReceiveSession(e){return new D(e)}}class T{constructor(e,t){this.dataType=\"moveData\",this.tag=t;let i=new p(e);this.weight=i.readUint8(),i.readUint8(),this.yaw=i.readInt8(),this.roll=i.readInt8(),this.pitch=i.readInt8(),this.ax=parseInt((i.readInt16(!0)/100).toFixed(0)+\"\"),this.ay=parseInt((i.readInt16(!0)/100).toFixed(0)+\"\"),this.az=parseInt((i.readInt16(!0)/100).toFixed(0)+\"\"),this.gx=parseInt((i.readInt16(!0)/100).toFixed(0)+\"\"),this.gy=parseInt((i.readInt16(!0)/100).toFixed(0)+\"\"),this.gz=parseInt((i.readInt16(!0)/100).toFixed(0)+\"\")}}class O{constructor(e,t,i=1e3,s=200){this.priority=1e3;let n=[];this.priority=i,this.context=t,this.id=s,e.forEach((e=>{let t={name:\"push\",actionType:1,pushData:()=>e};n.push(t)})),this.actions=n}}class C{constructor(){this.tag=172}getBytes(){return(new n).build()}}const A={uuid:e,name:\"dumbbell\",bind:{protocolType:0,actions:u},sync:{protocolType:1,actions:l},parser:new class extends class{parseAdvertisementData(e,t){return{name:e.name,localName:t.localName,deviceId:e.deviceId,manufacturerData:t.advertisData,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:undefined,isSystemPaired:!1,timestamp:new Date,isRegister:!0}}parseDeviceInfo(e,t){let i={};return i.deviceId=e.deviceId,i.name=e.name,t&&t.size>0&&t.forEach(((e,t)=>{switch(t){case y:e&&e.byteLength>=12&&(i.mac=f(e.slice(0,12)));break;case S:i.firmwareVersion=f(e);break;case w:i.hardwareVersion=f(e);break;case m:i.manufacture=f(e);break;case x:i.softwareVersion=f(e);break;case v:i.model=f(e);break;case U:e&&e.byteLength>=6&&(i.lzDeviceId=c(e.slice(0,6)))}})),i}}{parseAdvertisementData(e,t){let i=e.name,s=t.localName,n=e.deviceId,r=t.advertisData,a=c(new p(r,3).readBuffer(6));return{name:i,localName:s,deviceId:n,manufacturerData:r,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:a,isSystemPaired:!1,timestamp:new Date,model:\"DB01\"}}parseDeviceInfo(e,t){return Object.assign(Object.assign({},super.parseDeviceInfo(e,t)),{model:\"DB01\"})}},dataParser:new class{parseData(e,t,i){let s=e.data,n=e.value;switch(s){case 173:return new r(n,s);case 170:return new T(n,s);default:throw new Error(\"未知数据, 没有处理\"+s)}}createSession(e){return new k}syncDataMutipleAction(e){return new O([new C],e,1e3,1)}syncDataIntervalTime(e){return 6e4}shouldIntervalSyncData(e){return!0}},setUtils:function(e){i=e}};var R={settingFactory:{},proto:A};return module.exports={settingFactory:{},proto:A},R}));\n"]}
{"version":3,"sources":["index.js"],"names":[],"mappings":";;;;;;;AAAA;AACA","file":"index.js","sourcesContent":["!function(e,t){\"object\"==typeof exports&&\"undefined\"!=typeof module?module.exports=t(require(\"sg-ble\")):\"function\"==typeof define&&define.amd?define([\"sg-ble\"],t):(e=\"undefined\"!=typeof globalThis?globalThis:e||self).RollupLearn=t(e.SG)}(this,(function(e){function t(e){return e&&\"object\"==typeof e&&\"default\"in e?e:{default:e}}var i=t(e);const s=\"0000A610-0000-1000-8000-00805F9B34FB\",n=\"0000A640-0000-1000-8000-00805F9B34FB\",r=\"00001880-0000-1000-8000-00805F9B34FB\",a=\"00001530-1212-EFDE-1523-785FEABCD123\";function o(e,t){if(!e)return\"\";if(\"string\"==typeof e)return e;let i=Array.prototype.map.call(new Uint8Array(e),(function(e){return(\"00\"+e.toString(16)).slice(-2)}));if(t){let e=[];for(let t=0;t<i.length;t++)e.push(i[i.length-1-t]);return e.join(\"\")}return i.join(\"\")}function c(e){let t=e.toString(2);if(e<128)return e.toString(16);if(e<2048){t=(\"00000000000000000\"+t).slice(-11);const e=parseInt(\"110\"+t.substring(0,5),2),i=parseInt(\"10\"+t.substring(5),2);return e.toString(16)+\",\"+i.toString(16)}{t=(\"00000000000000000\"+t).slice(-16);const e=parseInt(\"1110\"+t.substring(0,4),2),i=parseInt(\"10\"+t.substring(4,10),2),s=parseInt(\"10\"+t.substring(10),2);return e.toString(16)+\",\"+i.toString(16)+\",\"+s.toString(16)}}let d=wx.getSystemInfoSync();function h(){return d.platform.toLowerCase().indexOf(\"ios\")>-1}function u(e){return e.length>16?e:`0000${e}-0000-1000-8000-00805F9B34FB`}function l(e,t){return 1==(1&e>>t)}function f(e){return function(e){if(!e)return\"\";let t=new Uint8Array(e);var i,s,n,r,a,o;i=\"\",n=t.length,s=0;for(;s<n;)switch((r=t[s++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:i+=String.fromCharCode(r);break;case 12:case 13:a=t[s++],i+=String.fromCharCode((31&r)<<6|63&a);break;case 14:a=t[s++],o=t[s++],i+=String.fromCharCode((15&r)<<12|(63&a)<<6|(63&o)<<0)}return i}(e)}class g{constructor(e,t){if(this.dataType=\"bloodpressure\",this.cmd=t,!e)return;let i=0,s=new DataView(e);this.remainCount=s.getUint16(i),i+=2;let n=s.getUint32(i);i+=4,this.unit=1&n,this.systolic=s.getUint16(i),i+=2,this.diastolic=s.getUint16(i),i+=2,this.meanPressure=s.getUint16(i),i+=2;let r=s.getUint16(i);if(i+=2,n>>=1,l(n,0)&&(this.pulseRate=s.getUint16(i),i+=2),l(n,1)&&(this.userId=s.getUint8(i)<0?s.getUint8(i)+256:s.getUint8(i),i++),l(n,2)&&(this.utc=12622752e5+1e3*s.getUint32(i),i+=4),l(n,3)&&(this.bodyMovementDetection=l(r,0)),l(n,4)&&(this.cuffFitDetection=l(r,1)),l(n,5)&&(this.irregularPulseDetection=l(r,2)),this.pulseOut=l(r,3),l(n,6)&&(this.measurementPositionDetection=l(r,4)),this.rebind=l(r,5),this.hsd=l(r,6),l(n,7)&&(this.timeZone=s.getUint8(i),i++),l(n,8)){let t=e.slice(i,i+7);this.timeStamp=o(t),i+=7}}}var p=Object.freeze({__proto__:null,ResetReq:class{constructor(){this.tag=65535,this.serviceId=r}getBytes(){let e=new ArrayBuffer(6),t=new DataView(e);t.setUint8(0,241),t.setUint8(1,0),t.setUint8(2,9),t.setUint8(3,0);let i=new ArrayBuffer(2);new DataView(i).setUint8(0,9);let s=this.getA6CRC16(i),n=new DataView(s);return t.setUint8(4,n.getUint8(0)),t.setUint8(5,n.getUint8(1)),e}getA6CRC16(e){let t=65535,i=new DataView(e);for(let e=0;e<i.byteLength;e++){t^=i.getUint8(e);for(let e=0;e<8;e++)1&t?(t>>>=1,t^=40961):t>>>=1}let s=new ArrayBuffer(2);return new DataView(s).setUint16(0,t,!0),s}},BPScaleData:g});class m{constructor(){this.size=0,this.values=[]}build(){let e=new ArrayBuffer(this.size),t=new DataView(e);return this.values.forEach((({byteOffset:e,method:i,value:s,littleEndian:n,limitSize:r})=>{if(\"setBuffer\"===i){let i=new DataView(s),n=i.byteLength;r&&(n=Math.min(r,n));for(let s=0;s<n;s++)t.setUint8(e+s,i.getUint8(s))}else\"setUint8\"===i?t[i](e,s):\"setInt8\"===i?s>0?t.setUint8(e,255&s):t.setUint8(e,s+256&255):\"setUint24\"===i?n?t.setUint32(e,s):t.setUint32(e,s<<8,!1):t[i](e,s,n)})),e}appendUint8(e){return this.values.push({byteOffset:this.size,method:\"setUint8\",value:e}),this.size++,this}appendUint16(e,t){return this.values.push({byteOffset:this.size,method:\"setUint16\",value:e,littleEndian:t}),this.size+=2,this}appendUint32(e,t){return this.values.push({byteOffset:this.size,method:\"setUint32\",value:e,littleEndian:t}),this.size+=4,this}appendBuffer(e,t){return this.values.push({byteOffset:this.size,method:\"setBuffer\",value:e,limitSize:t}),this.size+=t||e.byteLength,this}appendUint24(e,t){return this.values.push({byteOffset:this.size,method:\"setUint24\",value:e,littleEndian:t}),this.size+=3,this}appendInt8(e){return this.values.push({byteOffset:this.size,method:\"setInt8\",value:e}),this.size++,this}appendInt16(e,t){return this.values.push({byteOffset:this.size,method:\"setInt16\",value:e,littleEndian:t}),this.size+=2,this}appendFloat32(e,t){return this.values.push({byteOffset:this.size,method:\"setFloat32\",value:e,littleEndian:t}),this.size+=4,this}}const y=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];function v(e,t){if(6==e.byteLength&&6==t.byteLength){let i=new DataView(e),s=new DataView(t),n=\"\";for(let t=0;t<e.byteLength;t++){n+=(255&(s.getUint8(t)^i.getUint8(t))).toString(16).padStart(2,\"0\")}return n.toLowerCase()}return\"\"}function w(e){if(!e||e.length<12)return\"\";let t=b(e),i=new DataView(t),s=(i.getUint8(0)<<16)+(i.getUint8(1)<<8)+i.getUint8(2),n=(i.getUint8(3)<<16)+(i.getUint8(4)<<8)+i.getUint8(5);return s.toString(10).padStart(8,\"0\")+n.toString(10).padStart(8,\"0\")}function b(e){if(!e||0===e.length)return new ArrayBuffer(0);let t=e.length/2;if(t<1)return new ArrayBuffer(0);let i=new ArrayBuffer(t),s=new DataView(i);for(let i=0;i<t;i++){let t=e.substr(2*i,2),n=parseInt(t,16);s.setUint8(i,n)}return s.buffer}function U(e){if(!e||0===e.byteLength)return\"\";let t=new DataView(e),i=\"\";for(let e=0;e<t.byteLength;e++)i+=t.getUint8(e).toString(16).padStart(2,\"0\").toUpperCase();return i}class I{constructor(e){this.tag=1,this.deviceId=e}getBytes(){let e=(new m).appendUint16(this.tag),t=b(this.deviceId);return e.appendBuffer(t),e.appendUint8(1),e.build()}}class S{constructor(e,t){this.dataType=\"RegisterResp\";let i=new DataView(e);this.isSuccess=1===i.getUint8(0)}}class B{constructor(e,t){this.tag=3,this.userNumber=e,this.result=t}getBytes(){return(new m).appendUint16(this.tag).appendUint8(this.userNumber).appendUint8(this.result).build()}}class D{constructor(e,t){this.dataType=\"BindResp\";let i=new DataView(e);this.isSuccess=1===i.getUint8(0)}}function F(e,t,i){return e?(t.getUint8(i+2)<<16)+(t.getUint8(i+1)<<8)+t.getUint8(i):(t.getUint8(i)<<16)+(t.getUint8(i+1)<<8)+t.getUint8(i+2)}class R{constructor(e,t=0){this.values=[],this.parseSize=0,this.originalBuffer=e,this.index=t,this.parseSize=0,this.dataView=new DataView(e),this.index=t}build(e){if(!this.originalBuffer||this.originalBuffer.byteLength<=0)return null;e||(e={});let t=this.dataView;return this.values.forEach((({byteOffset:i,method:s,key:n,size:r,parseKey:a,littleEndian:c})=>{i+=this.parseSize;try{if(\"getHexString\"===s)e[n]=o(this.originalBuffer.slice(i,i+r));else if(\"getStringByParse\"===s){let t=e[a];this.parseSize+=t,e[n]=f(this.originalBuffer.slice(i,i+t))}else if(\"getString\"===s)e[n]=f(this.originalBuffer.slice(i,i+r));else if(\"getBuffer\"===s)e[n]=this.originalBuffer.slice(i,i+r);else if(\"getUint8\"===s)e[n]=t.getUint8(i);else if(\"Uint24\"===s)e[n]=F(c,t,i);else if(\"Uint8Array\"===s)e[n]=[].slice.call(new Uint8Array(this.originalBuffer.slice(i,i+r)));else if(\"Uint16Array\"===s){let t=[].slice.call(new Uint16Array(this.originalBuffer.slice(i,i+r)));e[n]=c?t:function(e){if(e&&e.length>0){let t=[];for(let i=0;i<e.length;i++){let s=e[i];s=((255&s)<<8)+(s>>8&255),t.push(s)}return t}return[]}(t)}else if(\"SFloat\"===s){let s=t.getUint8(i),r=((15&s)<<8)+t.getUint8(i+1),a=(240&s)>>>4,o=a;(8&a)>0&&(o=a-16);let c=Math.pow(10,o);e[n]=r*c}else if(\"Float\"===s){let s=t.getUint8(i),r=F(c,t,i+1),a=Math.pow(10,(15&s)-16);e[n]=r*a}else e[n]=t[s](i,c)}catch(e){}})),e}getUint24(e,t=!1){return this.values.push({byteOffset:this.index,method:\"Uint24\",key:e,littleEndian:t}),this.index+=3,this}getSFloat(e){return this.values.push({byteOffset:this.index,method:\"SFloat\",key:e}),this.index+=2,this}getFloat(e,t=!1){return this.values.push({byteOffset:this.index,method:\"Float\",key:e,littleEndian:t}),this.index+=4,this}getUint8Array(e,t){return this.values.push({byteOffset:this.index,size:t,method:\"Uint8Array\",key:e}),this.index+=t,this}getUint16Array(e,t,i=!1){return this.values.push({byteOffset:this.index,size:t,method:\"Uint16Array\",key:e,littleEndian:i}),this.index+=t,this}getUint8(e){return this.values.push({byteOffset:this.index,method:\"getUint8\",key:e}),this.index++,this}getUint16(e,t=!1){return this.values.push({byteOffset:this.index,method:\"getUint16\",key:e,littleEndian:t}),this.index+=2,this}getUint32(e,t=!1){return this.values.push({byteOffset:this.index,method:\"getUint32\",key:e,littleEndian:t}),this.index+=4,this}getBuffer(e,t){return this.values.push({byteOffset:this.index,size:t,method:\"getBuffer\",key:e}),this.index+=t,this}getByteOffset(){return this.index}getString(e,t){return this.values.push({byteOffset:this.index,size:t,method:\"getString\",key:e}),this.index+=t,this}getHexString(e,t){return this.values.push({byteOffset:this.index,size:t,method:\"getHexString\",key:e}),this.index+=t,this}getStringSizeByParse(e,t){return this.values.push({byteOffset:this.index,parseKey:t,method:\"getStringByParse\",key:e}),this}getIndex(){return this.index}readUint8(){let e=this.index;return this.index+=1,this.dataView.getUint8(e)}readUint16(e=!1){let t=this.index;return this.index+=2,this.dataView.getUint16(t,e)}readInt16(e=!1){let t=this.index;return this.index+=2,this.dataView.getInt16(t,e)}readUint24(e=!1){let t=this.index;return this.index+=3,F(e,this.dataView,t)}readUint32(e=!1){let t=this.index;return this.index+=4,this.dataView.getUint32(t,e)}readInt32(e=!1){let t=this.index;return this.index+=4,this.dataView.getInt32(t,e)}readSfloat(){let e=this.index,t=this.dataView;this.index+=2;let i=t.getUint8(e),s=(240&i)>>>4,n=s;return(8&s)>0&&(n=s-16),(((15&i)<<8)+t.getUint8(e+1))*Math.pow(10,n)}readFloat(e=!1){let t=this.index;this.index+=4;let i=this.dataView.getUint8(t);return F(e,this.dataView,t+1)*Math.pow(10,(15&i)-16)}readString(e){return f(this.readBuffer(e))}readBuffer(e){let t=this.index;return this.index+=e,this.dataView.buffer.slice(t,t+e)}}class C{constructor(e,t){this.dataType=\"LoginReq\";let i=new R(e);this.code=i.readBuffer(6),this.userNumber=i.readUint8(),this.battery=i.readUint8()}}class x{constructor(e,t,i,s){this.tag=8,this.isSuccess=e,this.code=t,this.workType=i,this.platform=s}getBytes(){return(new m).appendUint16(this.tag).appendUint8(this.isSuccess?1:0).appendBuffer(this.code).appendUint8(this.workType).appendUint8(this.platform).build()}}class T extends class{constructor(e,t,i,s){this.tag=4098,this.flag=e,this.utc=t,this.timezone=i,s&&(this.timeStamp=s)}getBytes(){let e=(new m).appendUint16(this.tag).appendUint8(this.flag);return(1&this.flag)>0&&e.appendUint32(this.utc),(2&this.flag)>0&&e.appendUint8(this.timezone),(4&this.flag)>0&&e.appendBuffer(this.timeStamp),e.build()}}{constructor(){super(...arguments),this.tag=4354}}function A(){return((new Date).getTime()-12622752e5)/1e3}function L(e){return new Promise(((t,i)=>{setTimeout((()=>{t(null)}),e)}))}var k=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{c(s.next(e))}catch(e){r(e)}}function o(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))},z=[{name:\"DisableCharacteristic\",serviceId:u(\"A610\"),characteristicId:u(\"A621\"),actionType:3},{name:\"EnableCharacteristic\",serviceId:u(\"A610\"),characteristicId:u(\"A620\"),actionType:2},{name:\"EnableCharacteristic\",serviceId:u(\"A610\"),characteristicId:u(\"A625\"),actionType:2},{name:\"EnableCharacteristic\",serviceId:u(\"A610\"),characteristicId:u(\"A621\"),actionType:2,when:e=>!e.deviceInfo.isRegister},{name:\"RegisterReq\",actionType:1,when:e=>!e.deviceInfo.isRegister,pushData(e){return k(this,void 0,void 0,(function*(){yield L(300);let t=yield e.listeners.onApplyRegisterId(Object.assign({},e));i.default.Logger.info(\"申请registerId\",t);let s=new I(t);return t&&(e.deviceInfo.lzDeviceId=t,e.deviceInfo.id=t,e.deviceInfo.sn=w(t)),s}))},await:{dataType:\"RegisterResp\",timeout:15e3,didReceive(e,t){if(\"RegisterResp\"===e.dataType){return e.isSuccess?i.default.errorCode(0):i.default.errorCode(5)}return!0}}},{name:\"WaitLoginReq\",when:e=>!e.deviceInfo.isRegister,actionType:0,await:{dataType:\"LoginReq\",didReceive(e,t){if(\"LoginReq\"===e.dataType){let s=e;t.loginReq=s;let n=t.deviceInfo.mac,r=v(s.code,b(n));return r&&(t.deviceInfo.lzDeviceId=r,t.deviceInfo.id=r,t.deviceInfo.sn=w(r)),t.userNumber=s.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(r),i.default.errorCode(0)}return!0}}},{name:\"EnableCharacteristic\",serviceId:u(\"A610\"),characteristicId:u(\"A621\"),actionType:2,when:e=>e.deviceInfo.isRegister,await:{dataType:\"LoginReq\",didReceive(e,t){if(\"LoginReq\"===e.dataType){let s=e;t.loginReq=s;let n=t.deviceInfo.mac,r=v(s.code,b(n));return r&&(t.deviceInfo.lzDeviceId=r,t.deviceInfo.id=r,t.deviceInfo.sn=w(r)),t.deviceInfo.battery=s.battery,t.userNumber=s.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(r),i.default.errorCode(0)}return!0}}},{name:\"LoginResp\",actionType:1,pushData:e=>(e.deviceInfo.isRegister=!0,new x(!0,e.loginReq.code,1,h()?1:2))},{name:\"SyncTime\",actionType:1,pushData:e=>new T(1,A())},{name:\"BindResult\",actionType:1,pushData:e=>new B(1,1),await:{dataType:\"BindResp\",didReceive(e,t){if(\"BindResp\"===e.dataType){return e.isSuccess?i.default.errorCode(0):i.default.errorCode(5)}return!0}}}];class O extends class{constructor(e,t=1){this.tag=18433,this.userNumber=e,this.result=t}getBytes(){return(new m).appendUint16(this.tag).appendUint8(this.userNumber).appendUint8(this.result).build()}}{constructor(){super(...arguments),this.tag=18689}}var V=[{name:\"DisableCharacteristic\",serviceId:s,characteristicId:u(\"A621\"),actionType:3},{name:\"EnableCharacteristic\",serviceId:s,characteristicId:u(\"A620\"),actionType:2},{name:\"EnableCharacteristic\",serviceId:s,characteristicId:u(\"A625\"),actionType:2},{name:\"EnableCharacteristic\",serviceId:s,characteristicId:u(\"A621\"),actionType:2,when:e=>e.deviceInfo.isRegister,await:{dataType:\"LoginReq\",didReceive(e,t){if(\"LoginReq\"===e.dataType){let s=e;t.loginReq=s;let n=t.deviceInfo.mac,r=v(s.code,b(n));return t.deviceInfo.deviceId=r,t.deviceInfo.id=r,t.userNumber=s.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(r),i.default.errorCode(0)}}}},{name:\"LoginResp\",actionType:1,pushData:e=>new x(!0,e.loginReq.code,0,h()?1:2)},{name:\"SyncTime\",actionType:1,pushData:e=>new T(1,A())},{name:\"SyncData\",actionType:1,pushData:e=>new O(e.userNumber)},{name:\"获取电量\",actionType:4,serviceId:s,characteristicId:n,await:{didReceive:(e,t)=>\"Battery\"!==e.dataType||i.default.errorCode(0)}}];const P=\"00002A29-0000-1000-8000-00805F9B34FB\",E=\"00002A24-0000-1000-8000-00805F9B34FB\",q=\"00002A25-0000-1000-8000-00805F9B34FB\",N=\"00002A27-0000-1000-8000-00805F9B34FB\",M=\"00002A26-0000-1000-8000-00805F9B34FB\",$=\"00002A28-0000-1000-8000-00805F9B34FB\",j=\"00002A23-0000-1000-8000-00805F9B34FB\";class W{parseAdvertisementData(e,t){return{name:e.name,localName:t.localName,deviceId:e.deviceId,manufacturerData:t.advertisData,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:undefined,isSystemPaired:!1,timestamp:new Date,isRegister:!0}}parseDeviceInfo(e,t){let i={};return i.deviceId=e.deviceId,i.name=e.name,t&&t.size>0&&t.forEach(((e,t)=>{switch(t){case q:e&&e.byteLength>=12&&(i.mac=f(e.slice(0,12)));break;case M:i.firmwareVersion=f(e);break;case N:i.hardwareVersion=f(e);break;case P:i.manufacture=f(e);break;case $:i.softwareVersion=f(e);break;case E:i.model=f(e);break;case j:e&&e.byteLength>=6&&(i.lzDeviceId=U(e.slice(0,6)))}})),i}}class _{constructor(e,t,i=1001,s=100){this.actions=e,this.context=t,this.priority=i,this.id=s}}class H{constructor(e,t,i=1e3,s=200){this.priority=1e3;let n=[];this.priority=i,this.context=t,this.id=s,e.forEach((e=>{let t={name:\"push\",actionType:1,pushData:()=>e};n.push(t)})),this.actions=n}}class K{constructor(e,t){this.priority=2e3,this.id=255,this.serviceId=e;let s=this;this.actions=[{name:\"获取设置项\",actionType:4,serviceId:e,characteristicId:t,await:{timeout:3e3,didReceive:(e,t)=>\"Battery\"!==e.dataType||(s.responseData=i.default.errorCode(0,e),s.responseData)}}]}}class G{constructor(e,t){this.dataType=\"InitReq\";let i=new R(e);this.flag=i.readUint8(),1&this.flag&&(this.mtu=i.readUint8()),2&this.flag&&(this.slaveLatency=i.readUint8()),4&this.flag&&(this.supervisoryTimeout=i.readUint8())}}var Z=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{c(s.next(e))}catch(e){r(e)}}function o(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};class J{constructor(e,t){this.buf=e,this.isClear=!1,this.timeout=5e3,this.sid=t||Math.random(),this.trySender=(e,t)=>Z(this,void 0,void 0,(function*(){try{return this.sender(e,t)}catch(e){if(this.isClear)return i.default.errorCode(4);this.callback(e)}}))}didReceiveData(e){}start(){}resetTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.timeoutId=setTimeout((()=>{this.callback(i.default.errorCode(3,this.tag))}),this.timeout)}clear(){this.isClear=!0,this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.callback(i.default.errorCode(4))}callback(e){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.completion&&(e.sid=this.sid,this.completion(e),this.completion=null)}}class Q extends J{constructor(e,t){super(e),this.needAck=!1,this.tag=t}start(){return Z(this,void 0,void 0,(function*(){let e=this.decodeToFrames(this.buf);if(e&&e.length<1)return void this.callback(i.default.errorCode(4,this.tag));this.resetTimeout();let t=this.sendChar;for(let s=0;s<e.length;s++){let n=e[s];try{yield this.trySender(n,t)}catch(e){return void this.callback(i.default.errorCode(1,this.tag))}}this.needAck||this.callback(i.default.errorCode(0,this.tag))}))}decodeToFrames(e){let t=e.byteLength,i=Math.ceil(t/this.mtu),s=[];for(let t=0;t<i;t++){let i=t*this.mtu;s.push(e.slice(i,i+this.mtu))}return s}}class X extends J{didReceiveData(e){this.receiveBuf=e.value,this.callback(i.default.errorCode(0,this.tag,this.receiveBuf))}start(){this.didReceiveData({value:this.buf})}checkFinished(){if(!this.receiveBuf)return!1;if(this.firstFrame.len&&this.firstFrame.len<=this.receiveBuf.byteLength)return!0;if(this.firstFrame.totalFrames){if(1==this.firstFrame.totalFrames)return!0;if(this.preFrame&&this.preFrame.index===this.firstFrame.totalFrames-1)return!0}return!1}decodeFirstFrame(e){throw new Error(\"如果使用默认的逻辑，则需要实现这个逻辑\")}decodeOtherFrame(e){throw new Error(\"如果使用默认的逻辑，则需要实现这个逻辑\")}}class Y{constructor(e){this.sendSessions=[],this.filterServiceIds=[],this.mtu=20,this.context=e}sendData(e,t,i,s){let n=this.createSenderSession(e,t,i);return n.sender=this.sender,n.mtu=this.mtu,n.tag=t,new Promise(((e,t)=>{n.completion=i=>{this.sendingSession=null,s&&s(i),this.tryToDispatchSession(),i.success?e(i):t(i)},this.sendSessions.push(n),this.tryToDispatchSession()}))}clear(){try{this.sendSessions.forEach((e=>{e.clear()})),this.sendSessions.length=0,this.sendingSession&&(this.sendingSession.clear(),this.sendingSession=null)}catch(e){}}updateMtu(e){this.mtu=e}didReceiveData(e){if(this.receiveringSession)this.receiveringSession.didReceiveData(e);else{this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender;let t=this;this.receiveringSession.completion=e=>{t.receiveringSession&&t.receiveringSession.sid===e.sid&&(t.receiveringSession=null),t.tryToDispatchSession(),t.listener&&t.listener(e)},this.receiveringSession.start()}}createSenderSession(e,t,i){return new Q(e,t)}createReceiveSession(e){return new X(e)}tryToDispatchSession(){if(this.sendingSession||0===this.sendSessions.length||this.receiveringSession)return;let e=this.sendSessions.shift();e&&(this.sendingSession=e,e.start())}}var ee=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{c(s.next(e))}catch(e){r(e)}}function o(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};class te extends X{didReceiveData(e){let t=new DataView(e.value);if(this.checkIsFirstFrame(t))this.firstFrame=this.decodeFirstFrame(t),this.receiveBuf=this.firstFrame.buf;else{let e=this.decodeOtherFrame(t);if(this.preFrame){if(this.preFrame.index!==e.index-1)return void this.callback(i.default.errorCode(5,this.tag));this.preFrame=e}else this.preFrame=e;this.receiveBuf=function(...e){if(!e)return new ArrayBuffer(0);let t=0;for(let i=0;i<e.length;i++)t+=e[i].byteLength;let i=new ArrayBuffer(t),s=new DataView(i),n=0;for(let i=0;i<e.length;i++){let r=e[i],a=new DataView(r);for(let e=0;e<r.byteLength&&n<t;e++)s.setUint8(n,a.getUint8(e)),n+=1}return i}(this.receiveBuf,e.buf)}this.checkFinished()?this.sendAck():this.resetTimeout()}checkIsFirstFrame(e){return 0==(15&e.getUint8(0))}decodeFirstFrame(e){let t=new R(e.buffer),i=t.readUint8()>>4&15;t.readUint8();let s=t.readUint16(),n=t.readBuffer(this.mtu-3);return this.tag=s,{cmd:s,totalFrames:i,buf:n}}decodeOtherFrame(e){let t=new R(e.buffer),i=15&t.readUint8();return t.readUint8(),{index:i,buf:t.readBuffer(this.mtu-2)}}sendAck(){return ee(this,void 0,void 0,(function*(){try{let e=(new m).appendUint8(0).appendUint8(1).appendUint8(1);yield this.trySender(e.build(),this.sendChar)}catch(e){return void this.callback(i.default.errorCode(1,this.tag))}let e=i.default.errorCode(0,this.tag,this.receiveBuf);this.callback(e)}))}}class ie extends Q{constructor(){super(...arguments),this.needSettingResultConfirm=!1,this.needAck=!0}didReceiveData(e){1===new DataView(e.value).getUint8(2)&&(this.needSettingResultConfirm?i.default.Logger.warn(\"需要等待设置的确认回包，不需要处理\",this.tag):this.callback(i.default.errorCode(0,this.tag)))}didReceiveSettingConfrim(e){let t=new DataView(e),s=t.getUint16(0),n=t.getUint8(2);s===this.tag?1==n?this.callback(i.default.errorCode(0,this.tag)):this.callback(i.default.errorCode(5,this.tag)):i.default.Logger.warn(\"设置项命令不一致\",s,this.tag)}decodeToFrames(e){let t=this.mtu-2,i=e.byteLength;if(i<=t){let t=16,i=new m;return i.appendUint8(t),i.appendUint8(e.byteLength),i.appendBuffer(e),[i.build()]}{let t=[],s=this.mtu-2,n=Math.ceil((i+4)/s),r=function(e,t=0){let i=0,s=4294967295&t;if(null==e)return s;let n=new Uint8Array(e);for(i=0;i<e.byteLength;i++){let e=255&(s^n[i]);s=y[e]^s>>>8}return(4294967295&s)>>>0}(e),a=new m;a.appendBuffer(e).appendUint32(r),a.build();for(let r=0;r<n;r++){let a=new m,o=Math.min(i+4-this.mtu*r,this.mtu),c=s*r;a.appendUint8(n<<4+r),a.appendUint8(o),a.appendBuffer(e.slice(c,c+o)),t.push(a.build())}return t}}}class se extends Y{didReceiveData(e){if(\"0000A625-0000-1000-8000-00805F9B34FB\"==e.characteristicId)this.sendingSession?this.sendingSession.didReceiveData(e):i.default.Logger.warn(\"cValue数据丢弃\",e);else if(\"0000A621-0000-1000-8000-00805F9B34FB\"==e.characteristicId||\"0000A620-0000-1000-8000-00805F9B34FB\"==e.characteristicId){0==(15&new DataView(e.value).getUint8(0))?(this.receiveringSession=this.createReceiveSession(e.value),this.receiveringSession.mtu=this.mtu,this.receiveringSession.sender=this.sender,this.receiveringSession.completion=e=>{if(i.default.Logger.warn(\"sessionManager \",e),this.receiveringSession&&this.receiveringSession.sid===e.sid&&(this.receiveringSession=null),4096===e.data||4352===e.data){if(this.sendingSession){let t=this.sendingSession;e&&e.value&&t.needSettingResultConfirm&&t.didReceiveSettingConfrim(e.value)}this.tryToDispatchSession()}else this.tryToDispatchSession(),this.listener&&e.success&&this.listener(e)},this.receiveringSession.start()):this.receiveringSession&&this.receiveringSession.didReceiveData(e)}else e.characteristicId===n&&this.listener&&this.listener(i.default.errorCode(0,e.characteristicId,e.value))}}class ne extends te{constructor(){super(...arguments),this.sendChar={serviceId:s,charId:\"0000A622-0000-1000-8000-00805F9B34FB\",writeType:0}}}class re extends ie{constructor(){super(...arguments),this.sendChar={serviceId:s,charId:\"0000A624-0000-1000-8000-00805F9B34FB\",writeType:1}}}class ae extends se{constructor(){super(...arguments),this.settings=[4354]}createSenderSession(e,t){let i=new re(e),s=!1;return this.settings&&this.settings.indexOf(t)>=0&&(s=!0),i.needSettingResultConfirm=s,i}createReceiveSession(e){return new ne(e)}}class oe extends Q{constructor(){super(...arguments),this.sendChar={serviceId:r,charId:\"00001881-0000-1000-8000-00805F9B34FB\",writeType:1}}}class ce extends Y{createSenderSession(e,t){return new oe(e)}}var de=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{c(s.next(e))}catch(e){r(e)}}function o(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};class he extends Q{constructor(){super(...arguments),this.sendChar={serviceId:a,charId:\"00001531-1212-EFDE-1523-785FEABCD123\",writeType:0},this.sendPackageChar={serviceId:a,charId:\"00001532-1212-EFDE-1523-785FEABCD123\",writeType:0},this.numberOfpacket=6,this.tag=255}start(){return de(this,void 0,void 0,(function*(){this.sendOpCode(1)}))}didReceiveData(e){let t=new R(e.value),s=t.readUint8();if(17===s){let e=t.readUint32(!0);this.currentBinInfo.sendOffset=e;let i=this.otaParse.getUpgradeProgress(this.currentBinInfo.sendOffset);this.otaParse.onUpgradeProcess&&this.otaParse.onUpgradeProcess(100*i),this.currentBinInfo.sendOffset<this.currentBinInfo.frameSize&&this.sendPackage()}else if(16===s){let e=t.readUint8();if(1!=t.readUint8())return void this.callback(i.default.errorCode(5,this.tag));switch(e){case 1:this.sendOpCode(8);break;case 3:this.otaParse.addDoneSize(this.currentBinInfo.frameSize),this.sendOpCode(4);break;case 4:this.sendOpCode(1)}}}callback(e){this.timeoutId&&clearTimeout(this.timeoutId),this.completion&&(this.otaParse.onUpgradeComplete&&this.otaParse.onUpgradeComplete(e.code,e.msg),this.completion(e),this.completion=null)}sendStartBin(){return de(this,void 0,void 0,(function*(){if(this.currentBinInfo=this.otaParse.getNextBinInfo(),this.currentBinInfo){let e=(new m).appendUint8(1).appendUint8(this.currentBinInfo.code).build();yield this.trySender(e,this.sendChar),yield L(1),this.sendImageSize()}else this.sendOpCode(5),this.callback(i.default.errorCode(0,this.tag))}))}sendImageSize(){return de(this,void 0,void 0,(function*(){let e=this.currentBinInfo,t=new ArrayBuffer(14),i=new DataView(t),s=0;i.setUint32(s,e.upgradeFileSize,!0),s+=4;let n=this.otaParse.model;for(let e=n.length;e<8;e++)n+=\" \";n=n.substring(0,8);let r=function(e){if(!e||0==e.length)return new ArrayBuffer(0);let t=\"\";for(let i=0;i<e.length;i++)t+=\",\"+c(e.charCodeAt(i));return new Uint8Array(t.match(/[\\da-f]{2}/gi).map((function(e){return parseInt(e,16)}))).buffer}(n),a=new DataView(r);for(let e=0;e<4;e++)i.setUint8(e+s,a[e]);s+=4;let o=new DataView(e.version);for(let e=0;e<4;e++)i.setUint8(e+s,o.getUint8(e));s+=4,i.setUint16(s,e.crcBuffer,!0),s+=2,yield this.trySender(t,this.sendPackageChar),this.resetTimeout()}))}sendOpCode(e){return de(this,void 0,void 0,(function*(){switch(e){case 1:yield this.sendStartBin();break;case 8:yield this.receiptNotificationReq(),yield this.sendOpCode(3),this.sendPackage();break;default:let t=(new m).appendUint8(e).build();yield this.trySender(t,this.sendChar)}}))}receiptNotificationReq(){let e=(new m).appendUint8(8).appendUint16(this.numberOfpacket,!0).build();return this.trySender(e,this.sendChar)}sendPackage(){return de(this,void 0,void 0,(function*(){let e=this.currentBinInfo.sendOffset;for(let t=e;t<e+this.numberOfpacket;t++){let e=this.currentBinInfo.imageList[t];e&&(this.currentBinInfo.sendOffset+=1,yield this.trySender(e,this.sendPackageChar))}this.currentBinInfo.sendOffset+=e,this.resetTimeout()}))}}class ue extends Y{didReceiveData(e){this.sendingSession&&this.sendingSession.didReceiveData(e)}createSenderSession(e,t,i){let s=new he(e);return s.otaParse=t,s}}const le=[{binInfoOffset:32,code:4},{binInfoOffset:64,code:8},{binInfoOffset:96,code:9}];class fe{constructor(e){this.onUpgradeComplete=e.onUpgradeComplete,this.onUpgradeProcess=e.onUpgradeProcess,this.model=e.model;let t=e.fileBuffer;this.binIndex=-1,this.doneFrameSize=0;let s=new DataView(t),n=0,r=t.slice(n,n+4);n+=4;let a=t.slice(n,n+4);n+=4;let c=s.getUint32(n,!1);n+=4;let d=s.getUint32(n,!1);n+=4;let h=t.slice(n,n+16),u=0,l=[];for(let e=0;e<le.length;e++){let i=this.createBinInfo(t,le[e]);i&&(l.push(i),u+=i.upgradeFileSize)}this.magic=r,this.version=a,this.size=c,this.binWithCrc12Size=u,this.binInfoList=l,this.md5=h,this.binWithCrc12FrameSize=u/20,i.default.Logger.info(`OTA总大小:${c} binWithCrc12Size${u} version:${o(a)} utc:${d} binInfoList size:${l.length}`)}addDoneSize(e){this.doneFrameSize+=e}getNextBinInfo(){return this.binIndex++,i.default.Logger.info(\"获取下一个固件包\",this.binIndex),this.binInfoList[this.binIndex]}getUpgradeProgress(e){return(this.doneFrameSize+e)/this.binWithCrc12FrameSize}createBinInfo(e,t){let s=t.binInfoOffset,n=t.code,r=new DataView(e),a=e.slice(s,s+4),c=r.getUint32(s+4,!1),d=r.getUint32(s+8,!1);if(0===d||0===c)return i.default.Logger.info(`固件类型:${n} 无数据 `),null;let h=r.getUint32(s+12,!1);e.slice(s+12,s+12+4);let u=e.slice(s+16,s+16+1),l=e.slice(d,d+c),f=new ArrayBuffer(4);new DataView(f).setUint32(0,h,!0);let g=function(e,t){let i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i.buffer}(l,f);i.default.Logger.info(\"crc16小端\"+o(f));let p=g.byteLength,m=[],y=0;for(;y<p-20;)m.push(g.slice(y,y+=20));p!==y&&m.push(g.slice(y,p));let v={imageList:m,upgradeFileSize:l.byteLength,sendOffset:0,frameSize:m.length,crcBuffer:h,version:a,md5:u,code:n,buf:g};return i.default.Logger.info(`固件类型:${n} 大小(包括crc4字节):${v.upgradeFileSize} 地址：${d}  crc:${h} frameSize: ${m.length}`),v}}class ge{constructor(e,t){this.tag=e,this.serviceId=t}getBytes(){return(new m).build()}}class pe{constructor(e,t,i){if(this.dataType=\"Battery\",this.cmd=t,e.byteLength>=1){let t=new DataView(e);this.battery=t.getUint8(0),i.battery=this.battery}}}var me=[{name:\"EnableCharacteristic\",serviceId:s,characteristicId:u(\"A621\"),actionType:2,when:e=>e.deviceInfo.isRegister,await:{dataType:\"LoginReq\",didReceive(e,t){if(\"LoginReq\"===e.dataType){let s=e;t.loginReq=s;let n=t.deviceInfo.mac,r=v(s.code,b(n));return r&&(t.deviceInfo.lzDeviceId=r,t.deviceInfo.id=r,t.deviceInfo.sn=w(r)),t.userNumber=s.userNumber,t.listeners&&t.listeners.onReadDeviceId&&t.listeners.onReadDeviceId(r),i.default.errorCode(0)}}}},{name:\"LoginResp\",actionType:1,pushData:e=>new x(!0,e.loginReq.code,0,h()?1:2)},{name:\"SyncTime\",actionType:1,pushData:e=>new T(1,A())},{name:\"SyncData\",actionType:1,pushData:e=>new O(e.userNumber)},{name:\"获取电量\",actionType:4,serviceId:s,characteristicId:n,await:{didReceive:(e,t)=>\"Battery\"!==e.dataType||i.default.errorCode(0)}}];const ye={uuid:s,name:\"bloodpressure\",bind:{protocolType:0,actions:z},sync:{protocolType:1,actions:V},parser:new class{constructor(){this.normalParser=new W}parseAdvertisementData(e,t){let i,s=e.name,n=t.localName,r=e.deviceId,a=!1,o=t.advertisData;if(o&&o.byteLength>=6){let e=new DataView(o),t=o.byteLength;i=U(o.slice(t-6,t)).toUpperCase(),a=1===e.getUint8(t-7)}return{name:s,localName:n,deviceId:r,manufacturerData:o,serviceUUIDs:t.advertisServiceUUIDs,serviceData:t.serviceData,RSSI:t.RSSI,mac:i,isSystemPaired:!1,timestamp:new Date,isRegister:a,model:n}}parseDeviceInfo(e,t){let i=this.normalParser.parseDeviceInfo(e,t),s=t.get(u(\"2A25\"));return s.byteLength>=6&&(s=function(e){if(!e||0===e.byteLength)return;let t=new DataView(e),i=new ArrayBuffer(e.byteLength),s=new DataView(i);for(let i=0;i<e.byteLength;i++){let n=e.byteLength-i-1;s.setUint8(i,t.getUint8(n))}return s.buffer}(s.slice(0,6)),i.mac=U(s)),i}},dataParser:new class{parseData(e,t,s){let r=e.data,a=e.value;switch(i.default.Logger.debug(\"parse data\",e,r,o(a)),r){case 18690:return new g(a,r);case 2:return new S(a,r);case 4:return new D(a,r);case 7:return new C(a,r);case 9:return new G(a,r);case 8198:return null;case n:return new pe(a,r,s.deviceInfo);default:return i.default.Logger.warn(\"未知数据, 没有处理\"+r),null}}createSession(e){return e===s?new ae:e===r?new ce:e===a?new ue:void 0}otaAction(e,t){t.model=e.deviceInfo.model;let i=new fe(t),s=new ge(i,a);return new H([s],e,1100)}reStartSyncAction(e){return new _(me,e,1250)}getSettingMutipleAction(e,t){if(255===t)return new K(s,n);i.default.Logger.error(\"为实现\")}bindSuccessShouldDisconnect(e){return!0}}};var ve={settingFactory:p,proto:ye};return module.exports={proto:ye,settingFactory:p},ve}));\n"]}